<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR ‚Äì ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ò‡∏µ‡∏°"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ &amp; ‡∏£‡∏ñ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content pb-5">
      <div class="container py-4">
        <div class="d-flex justify-content-between align-items-end mb-4 mt-2">
          <div>
            <h1 class="h4 mb-1 fw-bold text-dark">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</h1>
            <p class="small text-muted mb-0">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏ñ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°
            </p>
          </div>
          <div class="text-end">
            <span class="badge bg-white text-dark border shadow-sm px-3 py-2 rounded-pill fw-normal" id="openBillTodayLabel">
              <i class="bi bi-calendar-event me-1 text-success"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            </span>
          </div>
        </div>

        <form id="openBillForm" novalidate>
          
          <section class="mb-4">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-transparent border-0 pt-3 pb-0">
                <h2 class="h6 fw-bold text-success mb-0">
                  <i class="bi bi-person-vcard me-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏ñ
                </h2>
              </div>
              <div class="card-body pt-2 pb-4">
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label for="jobDate" class="form-label small text-muted mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar3"></i></span>
                        <input type="date" class="form-control border-start-0 ps-0" id="jobDate" required />
                    </div>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="customerName" class="form-label small text-muted mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="customerName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà..." list="customerNameDatalist" required />
                        <button class="btn btn-light border-start-0 border text-muted" type="button" onclick="document.getElementById('customerName').value='';"><i class="bi bi-x"></i></button>
                    </div>
                    <datalist id="customerNameDatalist"></datalist>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="customerPhone" class="form-label small text-muted mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-telephone"></i></span>
                        <input type="tel" class="form-control border-start-0 ps-0" id="customerPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081xxxxxxx" />
                    </div>
                  </div>

                  <div class="col-12"><hr class="my-1 border-light"></div>

                  <div class="col-6 col-md-3">
                    <label for="plate" class="form-label small text-muted mb-1">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm bg-light fw-semibold text-primary" id="plate" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" list="plateDatalist" required />
                    <datalist id="plateDatalist"></datalist>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</div>
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="brand" class="form-label small text-muted mb-1">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label>
                    <input type="text" class="form-control form-control-sm" id="brand" placeholder="Honda, Yamaha..." />
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="model" class="form-label small text-muted mb-1">‡∏£‡∏∏‡πà‡∏ô</label>
                    <input type="text" class="form-control form-control-sm" id="model" placeholder="Wave, PCX..." />
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="mileage" class="form-label small text-muted mb-1">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (‡∏Å‡∏°.)</label>
                    <input type="number" min="0" class="form-control form-control-sm" id="mileage" placeholder="0" />
                  </div>

                  <div class="col-12 col-md-8">
                    <label for="problem" class="form-label small text-muted mb-1">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</label>
                    <textarea id="problem" class="form-control form-control-sm" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏≤‡∏á..." required></textarea>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="priority" class="form-label small text-muted mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
                    <select id="priority" class="form-select form-select-sm">
                      <option value="normal" selected>üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                      <option value="high">üî¥ ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
                      <option value="low">‚ö™ ‡πÑ‡∏°‡πà‡∏î‡πà‡∏ß‡∏ô</option>
                    </select>
                  </div>
                </div>
                
                <div class="d-flex align-items-center mt-3 p-2 bg-info bg-opacity-10 rounded-3 border border-info-subtle">
                    <i class="bi bi-info-circle-fill text-info me-2 fs-5"></i>
                    <p class="small text-muted mb-0 lh-sm">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏ñ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </p>
                </div>
              </div>
            </div>
          </section>
		  <section class="mb-4">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
                <h2 class="h6 fw-bold text-warning mb-0">
                    <i class="bi bi-box-seam me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
                </h2>
                <button class="btn btn-sm btn-light border text-success fw-medium rounded-pill px-3 shadow-sm hover-elevate" type="button" id="addPartRowBtn">
                  <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
                </button>
              </div>
              <div class="card-body pt-0">
                <div id="stockLoadingState" class="alert alert-light border small py-2 mb-2 rounded-3 text-center text-muted">
                  <div class="spinner-border spinner-border-sm me-2" role="status"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å...
                </div>

                <div class="table-responsive rounded-3 border">
                  <table class="table table-sm align-middle mb-0 bm-bill-table table-hover">
                    <thead class="bg-light text-secondary">
                      <tr class="text-muted small text-uppercase">
                        <th class="ps-3 py-2 fw-normal" style="min-width: 220px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th>
                        <th class="text-center py-2 fw-normal" style="width: 120px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="text-end py-2 fw-normal" style="width: 120px;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th class="text-end py-2 fw-normal" style="width: 120px;">‡∏£‡∏ß‡∏° (‡∏ø)</th>
                        <th class="text-center py-2 fw-normal" style="width: 50px;"><i class="bi bi-trash"></i></th>
                      </tr>
                    </thead>
                    <tbody id="partsTbody" class="bg-white">
                      </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section class="mb-4">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
                <h2 class="h6 fw-bold text-info mb-0">
                    <i class="bi bi-wrench me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á
                </h2>
                <button class="btn btn-sm btn-light border text-success fw-medium rounded-pill px-3 shadow-sm hover-elevate" type="button" id="addLaborRowBtn">
                  <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á
                </button>
              </div>
              <div class="card-body pt-0">
                <div class="table-responsive rounded-3 border">
                  <table class="table table-sm align-middle mb-0 bm-bill-table table-hover">
                    <thead class="bg-light text-secondary">
                      <tr class="text-muted small text-uppercase">
                        <th class="ps-3 py-2 fw-normal">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</th>
                        <th class="text-end py-2 fw-normal" style="width: 150px;">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</th>
                        <th class="text-center py-2 fw-normal" style="width: 50px;"><i class="bi bi-trash"></i></th>
                      </tr>
                    </thead>
                    <tbody id="laborTbody" class="bg-white">
                      </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section class="mb-5">
            <div class="card border-0 shadow rounded-4 bg-gradient" style="background-color: #f8fafc;">
              <div class="card-body p-4">
                
                <div class="row align-items-center mb-3">
                  <div class="col-12 col-md-6 mb-3 mb-md-0">
                    <div class="d-flex flex-column gap-1">
                        <div class="d-flex justify-content-between text-muted small" style="max-width: 300px;">
                            <span>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà:</span>
                            <span class="fw-semibold text-dark" id="partsTotalDisplay">0.00 ‡∏ø</span>
                        </div>
                        <div class="d-flex justify-content-between text-muted small" style="max-width: 300px;">
                            <span>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á:</span>
                            <span class="fw-semibold text-dark" id="laborTotalDisplay">0.00 ‡∏ø</span>
                        </div>
                    </div>
                  </div>
                  
                  <div class="col-12 col-md-6 text-md-end">
                    <div class="small text-muted text-uppercase fw-bold ls-1 mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                    <div class="display-5 fw-bold text-success" id="grandTotalDisplay">0.00 ‡∏ø</div>
                  </div>
                </div>

                <hr class="my-4 text-muted opacity-25">

                <div class="row g-3 justify-content-end align-items-center mb-4 bg-white p-3 rounded-3 border mx-0">
                    <div class="col-12 col-sm-auto text-end">
                        <label class="col-form-label col-form-label-sm fw-bold text-success">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤:</label>
                    </div>
                    <div class="col-12 col-sm-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-success bg-opacity-10 text-success border-success fw-bold">‡∏ø</span>
                            <input type="number" id="receivedAmountInput" class="form-control form-control-sm border-success fw-bold text-end" placeholder="0.00" min="0">
                        </div>
                    </div>
                    <div class="col-12 col-sm-auto text-end">
                        <label class="col-form-label col-form-label-sm fw-bold text-danger">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:</label>
                    </div>
                    <div class="col-12 col-sm-3">
                        <input type="text" id="changeAmountDisplay" class="form-control form-control-sm bg-light text-end fw-bold text-danger" value="0.00" readonly>
                    </div>
                </div>

                <div class="d-flex flex-column flex-md-row justify-content-end gap-3">
                  <button type="button" class="btn btn-outline-secondary rounded-pill px-4 py-2" id="resetFormBtn">
                    <i class="bi bi-arrow-counterclockwise me-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                  </button>
                  <button type="submit" class="btn btn-success rounded-pill px-5 py-2 shadow-sm fw-bold" id="saveBillBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="saveBillSpinner" role="status" aria-hidden="true"></span>
                    <span id="saveBillBtnText"><i class="bi bi-save2 me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°</span>
                  </button>
                </div>
              </div>
            </div>
          </section>
        </form>

        <div style="height: 3rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow-lg rounded-4 border-0 p-2" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2 active fw-bold" type="button" id="fabOpenBillBtn">
              <span class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-2 d-flex"><i class="bi bi-receipt-cutoff"></i></span>
              ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddTxnBtn">
              <span class="bg-success bg-opacity-10 text-success rounded-circle p-2 me-2 d-flex"><i class="bi bi-cash-coin"></i></span>
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabStockInBtn">
              <span class="bg-warning bg-opacity-10 text-warning rounded-circle p-2 me-2 d-flex"><i class="bi bi-box-seam"></i></span>
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddVehicleBtn">
              <span class="bg-info bg-opacity-10 text-info rounded-circle p-2 me-2 d-flex"><i class="bi bi-truck-front"></i></span>
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom shadow-lg">
      <div class="container-fluid px-0 h-100">
        <div class="row g-0 w-100 h-100 text-center small">
          <div class="col h-100">
            <a href="dashboard.html" class="bm-bottom-nav-link h-100 d-flex flex-column justify-content-center text-decoration-none">
              <i class="bi bi-speedometer2 d-block fs-5 mb-1"></i>
              <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
            </a>
          </div>
          <div class="col h-100">
            <a href="open-bill.html" class="bm-bottom-nav-link active h-100 d-flex flex-column justify-content-center text-decoration-none">
              <i class="bi bi-receipt-cutoff d-block fs-5 mb-1"></i>
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</span>
            </a>
          </div>
          <div class="col h-100">
            <a href="jobs.html" class="bm-bottom-nav-link h-100 d-flex flex-column justify-content-center text-decoration-none">
              <i class="bi bi-wrench-adjustable-circle d-block fs-5 mb-1"></i>
              <span>‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</span>
            </a>
          </div>
          <div class="col h-100">
            <a href="vehicles.html" class="bm-bottom-nav-link h-100 d-flex flex-column justify-content-center text-decoration-none">
              <i class="bi bi-truck-front d-block fs-5 mb-1"></i>
              <span>‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>
            </a>
          </div>
          <div class="col h-100">
            <a href="stock.html" class="bm-bottom-nav-link h-100 d-flex flex-column justify-content-center text-decoration-none">
              <i class="bi bi-box-seam d-block fs-5 mb-1"></i>
              <span>‡∏™‡∏ï‡πä‡∏≠‡∏Å</span>
            </a>
          </div>
          <div class="col h-100">
            <a href="finance.html" class="bm-bottom-nav-link h-100 d-flex flex-column justify-content-center text-decoration-none">
              <i class="bi bi-cash-coin d-block fs-5 mb-1"></i>
              <span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1080;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex px-3 py-2">
          <div class="toast-body fw-medium" id="mainToastBody">
            </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="‡∏õ‡∏¥‡∏î"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
	<script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where, orderBy, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // Form
      const openBillForm = document.getElementById("openBillForm");
      const jobDateInput = document.getElementById("jobDate");
      const openBillTodayLabel = document.getElementById("openBillTodayLabel");
      const customerNameInput = document.getElementById("customerName");
      const customerPhoneInput = document.getElementById("customerPhone");
      const plateInput = document.getElementById("plate");
      const brandInput = document.getElementById("brand");
      const modelInput = document.getElementById("model");
      const mileageInput = document.getElementById("mileage");
      const problemInput = document.getElementById("problem");
      const prioritySelect = document.getElementById("priority");
      const customerNameDatalist = document.getElementById("customerNameDatalist");
      const plateDatalist = document.getElementById("plateDatalist");

      // Items
      const stockLoadingState = document.getElementById("stockLoadingState");
      const partsTbody = document.getElementById("partsTbody");
      const addPartRowBtn = document.getElementById("addPartRowBtn");
      const laborTbody = document.getElementById("laborTbody");
      const addLaborRowBtn = document.getElementById("addLaborRowBtn");

      // Summary & Actions
      const partsTotalDisplay = document.getElementById("partsTotalDisplay");
      const laborTotalDisplay = document.getElementById("laborTotalDisplay");
      const grandTotalDisplay = document.getElementById("grandTotalDisplay");
      const receivedAmountInput = document.getElementById("receivedAmountInput");
      const changeAmountDisplay = document.getElementById("changeAmountDisplay");
      
      const resetFormBtn = document.getElementById("resetFormBtn");
      const saveBillBtn = document.getElementById("saveBillBtn");
      const saveBillSpinner = document.getElementById("saveBillSpinner");
      const saveBillBtnText = document.getElementById("saveBillBtnText");

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      let currentUser = null;
      let currentUserProfile = null;
      const stockMap = {};
      let stockOptionsHtml = "";
      let historyRecords = [];
      let isSavingBill = false;

      // --- Helpers ---
      function showToast(msg, variant="primary") {
        if(mainToastEl && mainToastBody) {
            mainToastEl.className = `toast align-items-center text-bg-${variant} border-0 shadow-lg rounded-pill`;
            mainToastBody.innerHTML = `<i class="bi bi-info-circle-fill me-2"></i>${msg}`;
            mainToast.show();
        } else alert(msg);
      }
      function formatNumber(v) { return Number(v||0).toLocaleString("th-TH",{minimumFractionDigits:2,maximumFractionDigits:2}); }
      function formatDateThai(date) { return date.toLocaleDateString("th-TH", {day:"numeric", month:"long", year:"numeric"}); }
      function getTodayISO() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

      // --- Theme & Profile ---
      async function ensureUserProfile(user) {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()) return { id: snap.id, ...snap.data() };
        
        const q = query(collection(db,"users"), limit(1));
        const role = (await getDocs(q)).empty ? "admin" : "staff";
        const data = { displayName: user.displayName||user.email.split("@")[0], role, createdAt: serverTimestamp(), branchId: null, theme: "light", disabled: false };
        await setDoc(ref, data);
        return { id: user.uid, ...data };
      }

      function applyTheme(theme) {
        const t = theme==="dark"?"dark":"light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-"+t);
      }

      // --- Table Row Creation ---
      function createPartRow() {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <select class="form-select form-select-sm part-stock-select rounded-3 border-secondary-subtle">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà --</option>
              ${stockOptionsHtml}
            </select>
          </td>
          <td class="text-center">
            <div class="input-group input-group-sm flex-nowrap justify-content-center">
              <button class="btn btn-light border part-qty-decrease bm-qty-btn" type="button"><i class="bi bi-dash"></i></button>
              <input type="number" class="form-control text-center part-qty-input border-secondary-subtle" value="1" min="1" style="max-width: 50px;" />
              <button class="btn btn-light border part-qty-increase bm-qty-btn" type="button"><i class="bi bi-plus"></i></button>
            </div>
          </td>
          <td class="text-end">
            <input type="number" class="form-control form-control-sm text-end part-unit-price-input rounded-3 border-secondary-subtle" placeholder="0.00" min="0" step="0.01" />
          </td>
          <td class="text-end align-middle fw-semibold text-dark">
            <span class="part-line-total-text">0.00</span>
          </td>
          <td class="text-center align-middle">
            <button class="btn btn-sm btn-link text-danger part-remove-row-btn p-0" type="button"><i class="bi bi-trash-fill"></i></button>
          </td>
        `;
        return tr;
      }

      function createLaborRow() {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="text" class="form-control form-control-sm labor-name-input rounded-3 border-secondary-subtle" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á..." /></td>
          <td class="text-end"><input type="number" class="form-control form-control-sm text-end labor-price-input rounded-3 border-secondary-subtle" placeholder="0.00" min="0" step="0.01" /></td>
          <td class="text-center align-middle"><button class="btn btn-sm btn-link text-danger labor-remove-row-btn p-0" type="button"><i class="bi bi-trash-fill"></i></button></td>
        `;
        return tr;
      }

      // --- Calculations ---
      function recalcTotals() {
        let parts=0, labor=0;
        
        partsTbody.querySelectorAll("tr").forEach(tr => {
           const qty = parseFloat(tr.querySelector(".part-qty-input")?.value)||0;
           const price = parseFloat(tr.querySelector(".part-unit-price-input")?.value)||0;
           const total = qty * price;
           tr.querySelector(".part-line-total-text").textContent = formatNumber(total);
           parts += total;
        });

        laborTbody.querySelectorAll("tr").forEach(tr => {
           labor += parseFloat(tr.querySelector(".labor-price-input")?.value)||0;
        });

        const grand = parts + labor;
        partsTotalDisplay.textContent = formatNumber(parts)+" ‡∏ø";
        laborTotalDisplay.textContent = formatNumber(labor)+" ‡∏ø";
        grandTotalDisplay.textContent = formatNumber(grand)+" ‡∏ø";
        
        // Calculate Change
        const received = parseFloat(receivedAmountInput.value)||0;
        const change = received - grand;
        changeAmountDisplay.value = formatNumber(Math.max(0, change));
      }

      // --- Data Loading ---
      async function loadStock(branchId) {
        try {
           const q = query(collection(db,"stock"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]), orderBy("name"));
           const snap = await getDocs(q);
           stockOptionsHtml="";
           snap.forEach(d => {
              const v = d.data();
              stockMap[d.id] = v;
              stockOptionsHtml += `<option value="${d.id}" data-price="${v.salePrice}">${v.code?v.code+" - ":""}${v.name}</option>`;
           });
           stockLoadingState.className="d-none";
           
           if(!partsTbody.querySelector("tr")) partsTbody.appendChild(createPartRow());
           else { // Refresh dropdowns if already exist
              partsTbody.querySelectorAll(".part-stock-select").forEach(sel => {
                 const val = sel.value;
                 sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà --</option>${stockOptionsHtml}`;
                 sel.value = val;
              });
           }
        } catch(e){ console.error(e); stockLoadingState.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; stockLoadingState.className="alert alert-danger small py-1"; }
      }

      async function loadHistory(branchId) {
         try {
            const q = query(collection(db,"jobs"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]), orderBy("createdAt","desc"), limit(50));
            const snap = await getDocs(q);
            const names=new Set(), plates=new Set();
            historyRecords = [];
            snap.forEach(d=>{
               const v=d.data();
               historyRecords.push(v);
               if(v.customerName) names.add(v.customerName);
               if(v.plate) plates.add(v.plate);
            });
            customerNameDatalist.innerHTML = Array.from(names).map(n=>`<option value="${n}">`).join("");
            plateDatalist.innerHTML = Array.from(plates).map(p=>`<option value="${p}">`).join("");
         } catch(e){ console.error(e); }
      }

      function autoFill(type, val) {
         val = val.trim(); if(!val) return;
         const rec = historyRecords.find(r => type==="plate"?r.plate===val:r.customerName===val);
         if(rec) {
            if(type==="plate") {
               if(rec.customerName) customerNameInput.value=rec.customerName;
               if(rec.customerPhone) customerPhoneInput.value=rec.customerPhone;
               if(rec.brand) brandInput.value=rec.brand;
               if(rec.model) modelInput.value=rec.model;
            } else {
               if(rec.customerPhone) customerPhoneInput.value=rec.customerPhone;
            }
         }
      }

      // --- Saving ---
      async function saveBill(e) {
         e.preventDefault();
         if(isSavingBill) return;
         
         const date = jobDateInput.value;
         const name = customerNameInput.value.trim();
         const plate = plateInput.value.trim();
         const problem = problemInput.value.trim();
         
         if(!date || !name || !plate || !problem) { showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£)","warning"); return; }

         isSavingBill=true;
         saveBillSpinner.classList.remove("d-none");
         saveBillBtn.disabled=true;

         try {
            const parts=[], labor=[];
            let partsTot=0, laborTot=0;

            partsTbody.querySelectorAll("tr").forEach(tr=>{
               const sId = tr.querySelector("select").value;
               const qty = parseFloat(tr.querySelector(".part-qty-input").value)||0;
               const pr = parseFloat(tr.querySelector(".part-unit-price-input").value)||0;
               if(sId && qty>0) {
                  const item = { stockId:sId, stockName:stockMap[sId]?.name||"", qty, unitPrice:pr, lineTotal:qty*pr };
                  parts.push(item);
                  partsTot+=item.lineTotal;
               }
            });

            laborTbody.querySelectorAll("tr").forEach(tr=>{
               const nm = tr.querySelector(".labor-name-input").value.trim();
               const pr = parseFloat(tr.querySelector(".labor-price-input").value)||0;
               if(nm && pr>0) {
                  labor.push({ name:nm, price:pr });
                  laborTot+=pr;
               }
            });

            if(parts.length===0 && labor.length===0) throw new Error("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

            const branchId = currentUserProfile.branchId;
            const jobData = {
               date, customerName:name, customerPhone:customerPhoneInput.value.trim(),
               plate, brand:brandInput.value.trim(), model:modelInput.value.trim(), mileage:mileageInput.value,
               problem, priority:prioritySelect.value, status:"repairing",
               items:parts, laborItems:labor, partsTotal:partsTot, laborTotal:laborTot, totalAmount:partsTot+laborTot,
               createdBy:currentUser.uid, createdByName:currentUserProfile.displayName, branchId, isDeleted:false,
               createdAt: serverTimestamp()
            };

            const docRef = await addDoc(collection(db,"jobs"), jobData);
            
            // Cut Stock
            for(const p of parts) {
               const sRef = doc(db,"stock",p.stockId);
               const curr = stockMap[p.stockId];
               const newQty = Math.max(0, (Number(curr.qty)||0) - p.qty);
               await updateDoc(sRef, { qty: newQty, updatedAt:serverTimestamp() });
            }

            // Transaction & Log
            await addDoc(collection(db,"transactions"), {
               date, type:"income", category:"‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°", description:`‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏° ${plate} (${name})`,
               amount:partsTot+laborTot, sourceType:"job", sourceId:docRef.id, branchId, isDeleted:false,
               createdAt:serverTimestamp(), createdBy:currentUser.uid
            });
            
            await addDoc(collection(db,"activityLogs"), {
               type:"job_created", message:`‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏° ${plate} ‡∏¢‡∏≠‡∏î ${formatNumber(partsTot+laborTot)}`,
               refId:docRef.id, branchId, createdAt:serverTimestamp(), createdBy:currentUser.uid, createdByName:currentUserProfile.displayName
            });

            showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","success");
            openBillForm.reset();
            jobDateInput.value = getTodayISO();
            partsTbody.innerHTML=""; laborTbody.innerHTML="";
            partsTbody.appendChild(createPartRow()); laborTbody.appendChild(createLaborRow());
            recalcTotals();
            loadHistory(branchId);

         } catch(err) {
            console.error(err);
            showToast(err.message||"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","danger");
         } finally {
            isSavingBill=false;
            saveBillSpinner.classList.add("d-none");
            saveBillBtn.disabled=false;
         }
      }

      // --- Initialization ---
      onAuthStateChanged(auth, async (user) => {
        if(!user) return window.location.href="index.html";
        try {
           const profile = await ensureUserProfile(user);
           currentUser = user; currentUserProfile = profile;
           
           const name = profile.displayName||"‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
           if(userDisplayNameText) userDisplayNameText.textContent = name;
           if(document.getElementById("userDisplayNameTextMobile")) document.getElementById("userDisplayNameTextMobile").textContent = name;
           if(userAvatarInitial) userAvatarInitial.textContent = name.charAt(0).toUpperCase();
           if(userRoleText) userRoleText.textContent = profile.role==="admin"?"Admin":"Staff";
           if(profile.role!=="admin" && settingsMenuItem) settingsMenuItem.classList.add("d-none");

           const t = localStorage.getItem("bm-theme-"+user.uid)||profile.theme||"light";
           applyTheme(t);

           jobDateInput.value = getTodayISO();
           if(openBillTodayLabel) openBillTodayLabel.innerHTML = `<i class="bi bi-calendar-event me-1 text-primary"></i> ${new Date().toLocaleDateString('th-TH')}`;

           setupEventListeners();
           await loadStock(profile.branchId);
           loadHistory(profile.branchId);
           
           if(!partsTbody.querySelector("tr")) partsTbody.appendChild(createPartRow());
           if(!laborTbody.querySelector("tr")) laborTbody.appendChild(createLaborRow());

        } catch(e) { console.error(e); showToast("Init Failed","danger"); }
      });

      function setupEventListeners() {
         logoutBtn.addEventListener("click", ()=>signOut(auth).then(()=>window.location.href="index.html"));
         themeToggleBtn.addEventListener("click", ()=>{
            const isDark = bodyEl.classList.contains("bm-theme-dark");
            const t = isDark?"light":"dark";
            applyTheme(t); localStorage.setItem("bm-theme-"+currentUser.uid, t);
         });

         // Table Events
         addPartRowBtn.addEventListener("click", ()=>partsTbody.appendChild(createPartRow()));
         addLaborRowBtn.addEventListener("click", ()=>laborTbody.appendChild(createLaborRow()));

         partsTbody.addEventListener("click", e=>{
            if(e.target.closest(".part-remove-row-btn")) { e.target.closest("tr").remove(); recalcTotals(); }
            if(e.target.closest(".part-qty-increase")) {
               const inp = e.target.closest("tr").querySelector(".part-qty-input");
               inp.value = Number(inp.value)+1; recalcTotals();
            }
            if(e.target.closest(".part-qty-decrease")) {
               const inp = e.target.closest("tr").querySelector(".part-qty-input");
               if(inp.value>1) inp.value = Number(inp.value)-1; recalcTotals();
            }
         });
         
         partsTbody.addEventListener("change", e=>{
            if(e.target.classList.contains("part-stock-select")) {
               const pr = e.target.selectedOptions[0]?.dataset.price;
               if(pr) e.target.closest("tr").querySelector(".part-unit-price-input").value = pr;
               recalcTotals();
            }
         });
         
         partsTbody.addEventListener("input", recalcTotals);
         
         laborTbody.addEventListener("click", e=>{
            if(e.target.closest(".labor-remove-row-btn")) { e.target.closest("tr").remove(); recalcTotals(); }
         });
         laborTbody.addEventListener("input", recalcTotals);

         // Form
         receivedAmountInput.addEventListener("input", recalcTotals);
         openBillForm.addEventListener("submit", saveBill);
         resetFormBtn.addEventListener("click", ()=>{ 
            openBillForm.reset(); 
            partsTbody.innerHTML=""; laborTbody.innerHTML="";
            partsTbody.appendChild(createPartRow()); laborTbody.appendChild(createLaborRow());
            jobDateInput.value = getTodayISO();
            recalcTotals();
         });

         // Auto-fill
         plateInput.addEventListener("blur", ()=>autoFill("plate", plateInput.value));
         customerNameInput.addEventListener("blur", ()=>autoFill("name", customerNameInput.value));

         // FAB
         fabOpenBillBtn?.addEventListener("click", ()=>window.scrollTo({top:0,behavior:'smooth'}));
         fabAddTxnBtn?.addEventListener("click", ()=>window.location.href="finance.html");
         fabStockInBtn?.addEventListener("click", ()=>window.location.href="stock.html");
         fabAddVehicleBtn?.addEventListener("click", ()=>window.location.href="vehicles.html");
      }
    </script>
  </body>
</html>