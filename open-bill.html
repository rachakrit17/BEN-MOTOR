<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR ‚Äì ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">

    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ò‡∏µ‡∏°"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ &amp; ‡∏£‡∏ñ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content pb-5">
      <div class="container py-4">
        <div class="d-flex justify-content-between align-items-end mb-4 mt-2">
          <div>
            <h1 class="h4 mb-1 fw-bold text-dark">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</h1>
            <p class="small text-muted mb-0">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏ñ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°
            </p>
          </div>
          <div class="text-end">
            <span class="badge bg-white text-dark border shadow-sm px-3 py-2 rounded-pill fw-normal" id="openBillTodayLabel">
              <i class="bi bi-calendar-event me-1 text-primary"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            </span>
          </div>
        </div>

        <form id="openBillForm" novalidate>
          
          <section class="mb-4">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-transparent border-0 pt-3 pb-0">
                <h2 class="h6 fw-bold text-primary mb-0">
                  <i class="bi bi-person-vcard me-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏ñ
                </h2>
              </div>
              <div class="card-body pt-2 pb-4">
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label for="jobDate" class="form-label small text-muted mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar3"></i></span>
                        <input type="date" class="form-control border-start-0 ps-0" id="jobDate" required />
                    </div>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="customerName" class="form-label small text-muted mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="customerName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà..." list="customerNameDatalist" required />
                    </div>
                    <datalist id="customerNameDatalist"></datalist>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="customerPhone" class="form-label small text-muted mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-telephone"></i></span>
                        <input type="tel" class="form-control border-start-0 ps-0" id="customerPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081xxxxxxx" />
                    </div>
                  </div>

                  <div class="col-12"><hr class="my-1 border-light"></div>

                  <div class="col-6 col-md-3">
                    <label for="plate" class="form-label small text-muted mb-1">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm bg-light fw-semibold text-primary" id="plate" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" list="plateDatalist" required />
                    <datalist id="plateDatalist"></datalist>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</div>
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="brand" class="form-label small text-muted mb-1">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label>
                    <input type="text" class="form-control form-control-sm" id="brand" placeholder="Honda, Yamaha..." />
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="model" class="form-label small text-muted mb-1">‡∏£‡∏∏‡πà‡∏ô</label>
                    <input type="text" class="form-control form-control-sm" id="model" placeholder="Wave, PCX..." />
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="mileage" class="form-label small text-muted mb-1">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (‡∏Å‡∏°.)</label>
                    <input type="number" min="0" class="form-control form-control-sm" id="mileage" placeholder="0" />
                  </div>

                  <div class="col-12 col-md-8">
                    <label for="problem" class="form-label small text-muted mb-1">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</label>
                    <textarea id="problem" class="form-control form-control-sm" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏≤‡∏á..." required></textarea>
                    <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="priority" class="form-label small text-muted mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
                    <select id="priority" class="form-select form-select-sm">
                      <option value="normal" selected>üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
                      <option value="high">üî¥ ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
                      <option value="low">‚ö™ ‡πÑ‡∏°‡πà‡∏î‡πà‡∏ß‡∏ô</option>
                    </select>
                  </div>
                </div>
                
                <div class="d-flex align-items-center mt-3 p-2 bg-info bg-opacity-10 rounded-3">
                    <i class="bi bi-magic text-info me-2 fs-5"></i>
                    <p class="small text-muted mb-0 lh-sm">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏ñ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </p>
                </div>
              </div>
            </div>
          </section>

          <section class="mb-4">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
                <h2 class="h6 fw-bold text-warning mb-0">
                    <i class="bi bi-box-seam me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
                </h2>
                <button class="btn btn-sm btn-light border text-primary fw-medium rounded-pill px-3" type="button" id="addPartRowBtn">
                  <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
                </button>
              </div>
              <div class="card-body pt-0">
                <div id="stockLoadingState" class="alert alert-light border small py-2 mb-2 rounded-3 text-center text-muted">
                  <div class="spinner-border spinner-border-sm me-2" role="status"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å...
                </div>

                <div class="table-responsive rounded-3 border">
                  <table class="table table-sm align-middle mb-0 bm-bill-table">
                    <thead class="bg-light text-secondary">
                      <tr class="text-muted small">
                        <th class="ps-3 py-2 fw-normal" style="min-width: 200px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th>
                        <th class="text-end py-2 fw-normal" style="width: 140px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="text-end py-2 fw-normal" style="width: 120px;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th class="text-end py-2 fw-normal" style="width: 120px;">‡∏£‡∏ß‡∏° (‡∏ø)</th>
                        <th class="text-center py-2 fw-normal" style="width: 50px;"><i class="bi bi-trash"></i></th>
                      </tr>
                    </thead>
                    <tbody id="partsTbody" class="bg-white">
                      </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section class="mb-4">
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3">
                <h2 class="h6 fw-bold text-info mb-0">
                    <i class="bi bi-wrench me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á
                </h2>
                <button class="btn btn-sm btn-light border text-primary fw-medium rounded-pill px-3" type="button" id="addLaborRowBtn">
                  <i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á
                </button>
              </div>
              <div class="card-body pt-0">
                <div class="table-responsive rounded-3 border">
                  <table class="table table-sm align-middle mb-0 bm-bill-table">
                    <thead class="bg-light text-secondary">
                      <tr class="text-muted small">
                        <th class="ps-3 py-2 fw-normal">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</th>
                        <th class="text-end py-2 fw-normal" style="width: 150px;">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</th>
                        <th class="text-center py-2 fw-normal" style="width: 50px;"><i class="bi bi-trash"></i></th>
                      </tr>
                    </thead>
                    <tbody id="laborTbody" class="bg-white">
                      </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section class="mb-5">
            <div class="card border-0 shadow rounded-4 bg-gradient" style="background-color: #f8fafc;">
              <div class="card-body p-4">
                <div class="row align-items-center">
                  <div class="col-12 col-md-6 mb-3 mb-md-0">
                    <div class="d-flex gap-4">
                        <div>
                            <div class="small text-muted mb-1">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</div>
                            <div class="h5 mb-0 fw-semibold text-dark" id="partsTotalDisplay">0.00 ‡∏ø</div>
                        </div>
                        <div class="border-start mx-2"></div>
                        <div>
                            <div class="small text-muted mb-1">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á</div>
                            <div class="h5 mb-0 fw-semibold text-dark" id="laborTotalDisplay">0.00 ‡∏ø</div>
                        </div>
                    </div>
                  </div>
                  
                  <div class="col-12 col-md-6 text-md-end">
                    <div class="small text-muted text-uppercase fw-bold ls-1 mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                    <div class="display-6 fw-bold text-primary" id="grandTotalDisplay">0.00 ‡∏ø</div>
                  </div>
                </div>

                <hr class="my-4 text-muted opacity-25">

                <div class="d-flex flex-column flex-md-row justify-content-end gap-3">
                  <button type="button" class="btn btn-outline-secondary rounded-pill px-4 py-2" id="resetFormBtn">
                    <i class="bi bi-arrow-counterclockwise me-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                  </button>
                  <button type="submit" class="btn btn-primary rounded-pill px-5 py-2 shadow-sm" id="saveBillBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="saveBillSpinner" role="status" aria-hidden="true"></span>
                    <span id="saveBillBtnText" class="fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°</span>
                  </button>
                </div>
              </div>
            </div>
          </section>
        </form>

        <div style="height: 3rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">
        <button
          class="btn btn-primary rounded-circle shadow-lg bm-fab-btn"
          type="button"
          id="fabDropdownButton"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="bi bi-plus-lg"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow rounded-4 border-0 p-2" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2 active" type="button" id="fabOpenBillBtn">
              <span class="bg-white bg-opacity-25 rounded-circle p-1 me-2 d-flex"><i class="bi bi-receipt-cutoff text-primary"></i></span>
              ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddTxnBtn">
              <span class="bg-success bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-cash-coin text-success"></i></span>
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabStockInBtn">
              <span class="bg-warning bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-box-seam text-warning"></i></span>
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddVehicleBtn">
              <span class="bg-info bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-truck-front text-info"></i></span>
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block fs-5"></i>
              <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link active">
              <i class="bi bi-receipt-cutoff d-block fs-5"></i>
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block fs-5"></i>
              <span>‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block fs-5"></i>
              <span>‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block fs-5"></i>
              <span>‡∏™‡∏ï‡πä‡∏≠‡∏Å</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block fs-5"></i>
              <span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1080;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex px-2">
          <div class="toast-body" id="mainToastBody">
            </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="‡∏õ‡∏¥‡∏î"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      // ============================================================
      // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Firebase SDK
      // ============================================================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        sendPasswordResetEmail
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        limit,
        startAfter,
        serverTimestamp,
        onSnapshot
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ============================================================
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
      // ============================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ============================================================
      // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DOM
      // ============================================================
      const bodyEl = document.body;

      // Topbar
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•
      const openBillForm = document.getElementById("openBillForm");
      const jobDateInput = document.getElementById("jobDate");
      const openBillTodayLabel = document.getElementById("openBillTodayLabel");
      const customerNameInput = document.getElementById("customerName");
      const customerPhoneInput = document.getElementById("customerPhone");
      const plateInput = document.getElementById("plate");
      const brandInput = document.getElementById("brand");
      const modelInput = document.getElementById("model");
      const mileageInput = document.getElementById("mileage");
      const problemInput = document.getElementById("problem");
      const prioritySelect = document.getElementById("priority");
      const customerNameDatalist = document.getElementById("customerNameDatalist");
      const plateDatalist = document.getElementById("plateDatalist");

      // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
      const stockLoadingState = document.getElementById("stockLoadingState");
      const partsTbody = document.getElementById("partsTbody");
      const addPartRowBtn = document.getElementById("addPartRowBtn");

      // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á
      const laborTbody = document.getElementById("laborTbody");
      const addLaborRowBtn = document.getElementById("addLaborRowBtn");

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
      const partsTotalDisplay = document.getElementById("partsTotalDisplay");
      const laborTotalDisplay = document.getElementById("laborTotalDisplay");
      const grandTotalDisplay = document.getElementById("grandTotalDisplay");
      const resetFormBtn = document.getElementById("resetFormBtn");
      const saveBillBtn = document.getElementById("saveBillBtn");
      const saveBillSpinner = document.getElementById("saveBillSpinner");
      const saveBillBtnText = document.getElementById("saveBillBtnText");

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // ============================================================
      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      // ============================================================
      let currentUser = null;
      let currentUserProfile = null;
      const stockMap = {};
      let stockOptionsHtml = "";
      let historyRecords = [];
      let isSavingBill = false;

      // ============================================================
      // Helpers
      // ============================================================
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className =
          "toast align-items-center text-bg-" + variant + " border-0 shadow-lg rounded-pill";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      function formatNumber(value) {
        if (typeof value !== "number" || isNaN(value)) return "0.00";
        return value.toLocaleString("th-TH", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function formatDateThaiFromString(dateStr) {
        if (!dateStr) return "-";
        const [year, month, day] = dateStr.split("-").map((v) => parseInt(v, 10));
        if (!year || !month || !day) return dateStr;
        const d = new Date(year, month - 1, day);
        const thaiMonths = [
          "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.",
          "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ.",
        ];
        const thaiYear = d.getFullYear() + 543;
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${thaiYear}`;
      }

      function getTodayISODateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // ============================================================
      // Theme
      // ============================================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);

        const icon = themeToggleBtn.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-sun", normalized === "dark");
          icon.classList.toggle("bi-moon", normalized === "light");
        }
      }

      function saveThemeForUser(uid, theme) {
        if (!uid) return;
        try {
          localStorage.setItem("bm-theme-" + uid, theme);
        } catch (e) {
          console.warn("Theme save error", e);
        }
      }

      function readThemeForUser(uid, fallbackTheme) {
        if (!uid) return fallbackTheme || "light";
        try {
          const stored = localStorage.getItem("bm-theme-" + uid);
          return stored || fallbackTheme || "light";
        } catch (e) {
          return fallbackTheme || "light";
        }
      }

      // ============================================================
      // User Profile
      // ============================================================
      async function ensureUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          return { id: snap.id, ...snap.data() };
        }
        const usersCol = collection(db, "users");
        const qUsers = query(usersCol, limit(1));
        const existingSnap = await getDocs(qUsers);

        const isFirstUser = existingSnap.empty;
        const role = isFirstUser ? "admin" : "staff";
        const defaultDisplayName =
          user.displayName || (user.email ? user.email.split("@")[0] : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà");

        const newUserData = {
          displayName: defaultDisplayName,
          role,
          createdAt: serverTimestamp(),
          branchId: null,
          theme: "light",
          disabled: false,
        };
        await setDoc(userRef, newUserData);
        return { id: user.uid, ...newUserData };
      }

      // ============================================================
      // Table Row Creators (Enhanced HTML)
      // ============================================================
      function createPartRow() {
        const tr = document.createElement("tr");
        // Adjusted HTML for better look
        tr.innerHTML = `
          <td>
            <select class="form-select form-select-sm part-stock-select rounded-3 border-secondary-subtle">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà --</option>
              ${stockOptionsHtml}
            </select>
          </td>
          <td class="text-end">
            <div class="input-group input-group-sm flex-nowrap justify-content-end">
              <button class="btn btn-light border part-qty-decrease" type="button"><i class="bi bi-dash"></i></button>
              <input type="number" class="form-control text-center part-qty-input" value="1" min="1" style="max-width: 60px;" />
              <button class="btn btn-light border part-qty-increase" type="button"><i class="bi bi-plus"></i></button>
            </div>
          </td>
          <td class="text-end">
            <input type="number" class="form-control form-control-sm text-end part-unit-price-input rounded-3" placeholder="0.00" min="0" step="0.01" />
          </td>
          <td class="text-end align-middle fw-semibold text-dark">
            <span class="part-line-total-text">0.00</span>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-link text-danger part-remove-row-btn p-0" type="button" aria-label="‡∏•‡∏ö">
              <i class="bi bi-x-circle-fill fs-6"></i>
            </button>
          </td>
        `;
        return tr;
      }

      function createLaborRow() {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <input type="text" class="form-control form-control-sm labor-name-input rounded-3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á..." />
          </td>
          <td class="text-end">
            <input type="number" class="form-control form-control-sm text-end labor-price-input rounded-3" placeholder="0.00" min="0" step="0.01" />
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-link text-danger labor-remove-row-btn p-0" type="button" aria-label="‡∏•‡∏ö">
              <i class="bi bi-x-circle-fill fs-6"></i>
            </button>
          </td>
        `;
        return tr;
      }

      // ============================================================
      // Logic: Calculations & Form Handling
      // ============================================================
      function recalcTotals() {
        let partsTotal = 0;
        let laborTotal = 0;

        partsTbody.querySelectorAll("tr").forEach((tr) => {
          const select = tr.querySelector(".part-stock-select");
          const qtyInput = tr.querySelector(".part-qty-input");
          const priceInput = tr.querySelector(".part-unit-price-input");
          const totalSpan = tr.querySelector(".part-line-total-text");

          const stockId = select ? select.value : "";
          let qty = qtyInput ? parseFloat(qtyInput.value) : 0;
          let unitPrice = priceInput ? parseFloat(priceInput.value) : 0;

          if (!stockId || isNaN(qty) || qty <= 0 || isNaN(unitPrice) || unitPrice < 0) {
            if (totalSpan) totalSpan.textContent = "0.00";
            return;
          }

          const lineTotal = qty * unitPrice;
          partsTotal += lineTotal;
          if (totalSpan) totalSpan.textContent = formatNumber(lineTotal);
        });

        laborTbody.querySelectorAll("tr").forEach((tr) => {
          const nameInput = tr.querySelector(".labor-name-input");
          const priceInput = tr.querySelector(".labor-price-input");
          const name = nameInput ? nameInput.value.trim() : "";
          const price = priceInput ? parseFloat(priceInput.value) : 0;

          if (!name || isNaN(price) || price <= 0) return;
          laborTotal += price;
        });

        const grandTotal = partsTotal + laborTotal;

        if (partsTotalDisplay) partsTotalDisplay.textContent = formatNumber(partsTotal) + " ‡∏ø";
        if (laborTotalDisplay) laborTotalDisplay.textContent = formatNumber(laborTotal) + " ‡∏ø";
        if (grandTotalDisplay) grandTotalDisplay.textContent = formatNumber(grandTotal) + " ‡∏ø";

        return { partsTotal, laborTotal, grandTotal };
      }

      function collectPartItemsForSave() {
        const items = [];
        let partsTotal = 0;
        partsTbody.querySelectorAll("tr").forEach((tr) => {
          const select = tr.querySelector(".part-stock-select");
          const qtyInput = tr.querySelector(".part-qty-input");
          const priceInput = tr.querySelector(".part-unit-price-input");
          if (!select || !qtyInput || !priceInput) return;

          const stockId = select.value;
          const qty = parseFloat(qtyInput.value);
          const unitPrice = parseFloat(priceInput.value);

          if (!stockId || isNaN(qty) || qty <= 0 || isNaN(unitPrice) || unitPrice < 0) return;

          const lineTotal = qty * unitPrice;
          partsTotal += lineTotal;
          const stockData = stockMap[stockId] || {};
          const stockName = stockData.name || (select.options[select.selectedIndex]?.textContent || "");

          items.push({ stockId, stockName, qty, unitPrice, lineTotal });
        });
        return { items, partsTotal };
      }

      function collectLaborItemsForSave() {
        const laborItems = [];
        let laborTotal = 0;
        laborTbody.querySelectorAll("tr").forEach((tr) => {
          const nameInput = tr.querySelector(".labor-name-input");
          const priceInput = tr.querySelector(".labor-price-input");
          if (!nameInput || !priceInput) return;

          const name = nameInput.value.trim();
          const price = parseFloat(priceInput.value);

          if (!name || isNaN(price) || price <= 0) return;
          laborItems.push({ name, price });
          laborTotal += price;
        });
        return { laborItems, laborTotal };
      }

      function setSaveBillButtonLoading(isLoading) {
        isSavingBill = isLoading;
        if (!saveBillBtn || !saveBillSpinner || !saveBillBtnText) return;
        if (isLoading) {
          saveBillBtn.disabled = true;
          saveBillSpinner.classList.remove("d-none");
          saveBillBtnText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        } else {
          saveBillBtn.disabled = false;
          saveBillSpinner.classList.add("d-none");
          saveBillBtnText.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°";
        }
      }

      function resetOpenBillForm() {
        if (!openBillForm) return;
        openBillForm.reset();
        const today = getTodayISODateString();
        if (jobDateInput) jobDateInput.value = today;
        if (openBillTodayLabel) {
           openBillTodayLabel.innerHTML = `<i class="bi bi-calendar-event me-1 text-primary"></i> ` + formatDateThaiFromString(today);
        }

        partsTbody.innerHTML = "";
        laborTbody.innerHTML = "";
        if (stockOptionsHtml) partsTbody.appendChild(createPartRow());
        laborTbody.appendChild(createLaborRow());

        customerNameInput.classList.remove("is-invalid");
        plateInput.classList.remove("is-invalid");
        problemInput.classList.remove("is-invalid");
        jobDateInput.classList.remove("is-invalid");
        recalcTotals();
      }

      async function loadStockForParts(branchId) {
        try {
          const stockCol = collection(db, "stock");
          const constraints = [where("isDeleted", "==", false)];
          if (branchId) constraints.push(where("branchId", "==", branchId));
          const stockQueryRef = query(stockCol, ...constraints, orderBy("name"), limit(200));
          const snap = await getDocs(stockQueryRef);

          Object.keys(stockMap).forEach((k) => delete stockMap[k]);
          let optionsHtml = "";
          snap.forEach((docSnap) => {
            const data = docSnap.data();
            stockMap[docSnap.id] = data;
            const name = data.name || "-";
            const code = data.code || "";
            const salePrice = Number(data.salePrice) || 0;
            const label = code ? `${code} - ${name}` : name;
            optionsHtml += `<option value="${docSnap.id}" data-sale-price="${salePrice}">${label}</option>`;
          });
          stockOptionsHtml = optionsHtml;

          if (stockLoadingState) {
            if (snap.empty) {
              stockLoadingState.className = "alert alert-warning border small py-2 mb-2 rounded-3";
              stockLoadingState.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å";
            } else {
              stockLoadingState.className = "d-none";
            }
          }

          if (!partsTbody.querySelector("tr") && stockOptionsHtml) {
            partsTbody.appendChild(createPartRow());
          } else {
            partsTbody.querySelectorAll(".part-stock-select").forEach((select) => {
              const currentValue = select.value;
              select.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà --</option>${stockOptionsHtml}`;
              if (currentValue && stockMap[currentValue]) select.value = currentValue;
            });
          }
        } catch (error) {
          console.error("Load Stock Error:", error);
          if (stockLoadingState) {
             stockLoadingState.className = "alert alert-danger border small py-2 mb-2";
             stockLoadingState.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
          }
        }
      }

      async function loadAutocompleteHistory(branchId) {
        const recordsMap = new Map();
        try {
          const jobsCol = collection(db, "jobs");
          const jobsConstraints = [where("isDeleted", "==", false)];
          if (branchId) jobsConstraints.push(where("branchId", "==", branchId));
          const jobsQueryRef = query(jobsCol, ...jobsConstraints, orderBy("createdAt", "desc"), limit(30));
          const jobsSnap = await getDocs(jobsQueryRef);

          jobsSnap.forEach((docSnap) => {
            const data = docSnap.data();
            const key = `${data.customerName || ""}|${data.customerPhone || ""}|${data.plate || ""}`;
            if (!recordsMap.has(key)) {
              recordsMap.set(key, {
                customerName: data.customerName || "",
                customerPhone: data.customerPhone || "",
                plate: data.plate || "",
                brand: data.brand || "",
                model: data.model || "",
              });
            }
          });

          const vehiclesCol = collection(db, "vehicles");
          const vehiclesConstraints = [where("isDeleted", "==", false)];
          if (branchId) vehiclesConstraints.push(where("branchId", "==", branchId));
          const vehiclesQueryRef = query(vehiclesCol, ...vehiclesConstraints, orderBy("createdAt", "desc"), limit(30));
          const vehiclesSnap = await getDocs(vehiclesQueryRef);

          vehiclesSnap.forEach((docSnap) => {
            const data = docSnap.data();
            const key = `| |${data.plate || ""}`;
            if (!recordsMap.has(key)) {
              recordsMap.set(key, {
                customerName: "",
                customerPhone: "",
                plate: data.plate || "",
                brand: data.brand || "",
                model: data.model || "",
              });
            }
          });

          historyRecords = Array.from(recordsMap.values());
          const nameSet = new Set();
          const plateSet = new Set();
          historyRecords.forEach((r) => {
            if (r.customerName) nameSet.add(r.customerName);
            if (r.plate) plateSet.add(r.plate);
          });

          if (customerNameDatalist) {
            customerNameDatalist.innerHTML = "";
            nameSet.forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              customerNameDatalist.appendChild(opt);
            });
          }
          if (plateDatalist) {
            plateDatalist.innerHTML = "";
            plateSet.forEach((plate) => {
              const opt = document.createElement("option");
              opt.value = plate;
              plateDatalist.appendChild(opt);
            });
          }
        } catch (error) {
          console.error("Autocomplete Error:", error);
        }
      }

      function autoFillFromHistoryByPlate(plateValue) {
        const plate = (plateValue || "").trim();
        if (!plate || historyRecords.length === 0) return;
        const record = historyRecords.find((r) => r.plate === plate);
        if (!record) return;
        if (record.brand && brandInput) brandInput.value = record.brand;
        if (record.model && modelInput) modelInput.value = record.model;
        if (record.customerName && customerNameInput) customerNameInput.value = record.customerName;
        if (record.customerPhone && customerPhoneInput) customerPhoneInput.value = record.customerPhone;
      }

      function autoFillFromHistoryByCustomerName(nameValue) {
        const name = (nameValue || "").trim();
        if (!name || historyRecords.length === 0) return;
        const record = historyRecords.find((r) => r.customerName === name);
        if (!record) return;
        if (record.customerPhone && customerPhoneInput) customerPhoneInput.value = record.customerPhone;
        if (record.plate && plateInput) {
           plateInput.value = record.plate;
           autoFillFromHistoryByPlate(record.plate);
        }
      }

      async function saveNewJobBill() {
        if (!currentUser || !currentUserProfile) {
          showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", "danger");
          return;
        }
        if (isSavingBill) return;

        jobDateInput.classList.remove("is-invalid");
        customerNameInput.classList.remove("is-invalid");
        plateInput.classList.remove("is-invalid");
        problemInput.classList.remove("is-invalid");

        const jobDate = jobDateInput.value || "";
        const customerName = customerNameInput.value.trim();
        const customerPhone = customerPhoneInput.value.trim();
        const plate = plateInput.value.trim();
        const brand = brandInput.value.trim();
        const model = modelInput.value.trim();
        const mileageStr = mileageInput.value.trim();
        const problem = problemInput.value.trim();
        const priority = prioritySelect.value || "normal";

        let hasError = false;
        if (!jobDate) { jobDateInput.classList.add("is-invalid"); hasError = true; }
        if (!customerName) { customerNameInput.classList.add("is-invalid"); hasError = true; }
        if (!plate) { plateInput.classList.add("is-invalid"); hasError = true; }
        if (!problem) { problemInput.classList.add("is-invalid"); hasError = true; }

        const mileage = mileageStr ? parseFloat(mileageStr) : null;
        if (mileageStr && (isNaN(mileage) || mileage < 0)) {
          mileageInput.classList.add("is-invalid");
          hasError = true;
        }

        const { items, partsTotal } = collectPartItemsForSave();
        const { laborItems, laborTotal } = collectLaborItemsForSave();
        const totalAmount = partsTotal + laborTotal;

        if (items.length === 0 && laborItems.length === 0) {
          showToast("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "warning");
          hasError = true;
        }

        if (hasError) {
          showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "warning");
          return;
        }

        setSaveBillButtonLoading(true);
        const branchId = currentUserProfile.branchId || null;

        try {
          const jobDocRef = await addDoc(collection(db, "jobs"), {
            createdAt: serverTimestamp(),
            updatedAt: null,
            date: jobDate,
            createdBy: currentUser.uid,
            createdByName: currentUserProfile.displayName || "",
            customerName,
            customerPhone,
            plate,
            brand,
            model,
            mileage: mileage !== null ? mileage : null,
            problem,
            status: "repairing",
            priority,
            partsTotal,
            laborTotal,
            totalAmount,
            items,
            laborItems,
            isDeleted: false,
            branchId,
          });

          const jobId = jobDocRef.id;

          for (const item of items) {
            const stockId = item.stockId;
            const qtyUsed = item.qty;
            if (!stockId || !stockMap[stockId]) continue;
            const stockData = stockMap[stockId];
            const currentQty = Number(stockData.qty) || 0;
            const currentFastMoving = Number(stockData.fastMovingScore) || 0;
            const newQty = Math.max(0, currentQty - qtyUsed);
            const newFastMoving = currentFastMoving + qtyUsed;

            const stockRef = doc(db, "stock", stockId);
            await updateDoc(stockRef, {
              qty: newQty,
              fastMovingScore: newFastMoving,
              updatedAt: serverTimestamp(),
            });
            stockData.qty = newQty;
            stockData.fastMovingScore = newFastMoving;
          }

          const txnDescription = `‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ ${plate} (${customerName})`;
          await addDoc(collection(db, "transactions"), {
            date: jobDate,
            createdAt: serverTimestamp(),
            updatedAt: null,
            type: "income",
            category: "‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°",
            description: txnDescription,
            amount: totalAmount,
            method: "cash",
            sourceType: "job",
            sourceId: jobId,
            createdBy: currentUser.uid,
            createdByName: currentUserProfile.displayName || "",
            isDeleted: false,
            branchId,
          });

          const logMessage = `‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà ${customerName} (${plate}) ‡∏¢‡∏≠‡∏î ${formatNumber(totalAmount)} ‡∏ø`;
          await addDoc(collection(db, "activityLogs"), {
            createdAt: serverTimestamp(),
            createdBy: currentUser.uid,
            createdByName: currentUserProfile.displayName || "",
            type: "job_created",
            message: logMessage,
            refType: "job",
            refId: jobId,
            branchId,
          });

          showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
          resetOpenBillForm();
          loadAutocompleteHistory(branchId);
        } catch (error) {
          console.error("Save Job Error:", error);
          showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "danger");
        } finally {
          setSaveBillButtonLoading(false);
        }
      }

      async function handleLogout() {
        try {
          await signOut(auth);
          window.location.href = "index.html";
        } catch (error) {
          console.error("Logout Error:", error);
        }
      }

      // ============================================================
      // Event Listeners
      // ============================================================
      function setupEventListenersForPage() {
        if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
        
        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", async () => {
            const currentTheme = bodyEl.classList.contains("bm-theme-dark") ? "dark" : "light";
            const nextTheme = currentTheme === "dark" ? "light" : "dark";
            applyTheme(nextTheme);
            if (currentUser) {
              saveThemeForUser(currentUser.uid, nextTheme);
              try { await updateDoc(doc(db, "users", currentUser.uid), { theme: nextTheme }); } catch(e){}
            }
          });
        }

        if (fabOpenBillBtn) fabOpenBillBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
        if (fabAddTxnBtn) fabAddTxnBtn.addEventListener("click", () => window.location.href = "finance.html");
        if (fabStockInBtn) fabStockInBtn.addEventListener("click", () => window.location.href = "stock.html");
        if (fabAddVehicleBtn) fabAddVehicleBtn.addEventListener("click", () => window.location.href = "vehicles.html");

        if (addPartRowBtn) {
          addPartRowBtn.addEventListener("click", () => {
            if (!stockOptionsHtml) {
              showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å", "warning");
              return;
            }
            partsTbody.appendChild(createPartRow());
          });
        }

        partsTbody.addEventListener("click", (event) => {
          const target = event.target;
          const removeBtn = target.closest(".part-remove-row-btn");
          if (removeBtn) {
            const tr = removeBtn.closest("tr");
            tr.remove();
            if (!partsTbody.querySelector("tr") && stockOptionsHtml) partsTbody.appendChild(createPartRow());
            recalcTotals();
            return;
          }
          const decBtn = target.closest(".part-qty-decrease");
          const incBtn = target.closest(".part-qty-increase");
          if (decBtn || incBtn) {
            const tr = target.closest("tr");
            const qtyInput = tr.querySelector(".part-qty-input");
            let qty = parseFloat(qtyInput.value) || 0;
            if (decBtn) qty = Math.max(1, qty - 1);
            else if (incBtn) qty = qty + 1;
            qtyInput.value = qty;
            recalcTotals();
          }
        });

        partsTbody.addEventListener("input", (event) => {
          const target = event.target;
          if (target.classList.contains("part-stock-select")) {
            const stockId = target.value;
            const tr = target.closest("tr");
            const priceInput = tr.querySelector(".part-unit-price-input");
            if (stockId && stockMap[stockId] && priceInput) {
              const salePrice = Number(stockMap[stockId].salePrice) || 0;
              if (!priceInput.value || parseFloat(priceInput.value) <= 0) {
                priceInput.value = salePrice > 0 ? salePrice : "";
              }
            }
          }
          recalcTotals();
        });

        if (addLaborRowBtn) {
          addLaborRowBtn.addEventListener("click", () => laborTbody.appendChild(createLaborRow()));
        }

        laborTbody.addEventListener("click", (event) => {
          const removeBtn = event.target.closest(".labor-remove-row-btn");
          if (removeBtn) {
            removeBtn.closest("tr").remove();
            if (!laborTbody.querySelector("tr")) laborTbody.appendChild(createLaborRow());
            recalcTotals();
          }
        });
        laborTbody.addEventListener("input", recalcTotals);

        if (resetFormBtn) {
          resetFormBtn.addEventListener("click", () => {
            resetOpenBillForm();
            showToast("‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß", "info");
          });
        }

        if (plateInput) {
          plateInput.addEventListener("change", () => autoFillFromHistoryByPlate(plateInput.value));
          plateInput.addEventListener("blur", () => autoFillFromHistoryByPlate(plateInput.value));
        }

        if (customerNameInput) {
          customerNameInput.addEventListener("change", () => autoFillFromHistoryByCustomerName(customerNameInput.value));
          customerNameInput.addEventListener("blur", () => autoFillFromHistoryByCustomerName(customerNameInput.value));
        }

        if (openBillForm) {
          openBillForm.addEventListener("submit", (event) => {
            event.preventDefault();
            recalcTotals();
            saveNewJobBill();
          });
        }
      }

      // ============================================================
      // Initialization
      // ============================================================
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        currentUser = user;
        try {
          const userProfile = await ensureUserProfile(user);
          currentUserProfile = userProfile;
          if (userProfile.disabled) {
            await signOut(auth);
            window.location.href = "index.html";
            return;
          }

          if (userDisplayNameText) userDisplayNameText.textContent = userProfile.displayName || "-";
          if (userRoleText) userRoleText.textContent = userProfile.role === "admin" ? "Admin" : "Staff";
          if (userAvatarInitial) userAvatarInitial.textContent = (userProfile.displayName || "U").trim().charAt(0).toUpperCase();

          if (settingsMenuItem) {
            if (userProfile.role === "admin") settingsMenuItem.classList.remove("d-none");
            else settingsMenuItem.classList.add("d-none");
          }

          const themeToUse = readThemeForUser(user.uid, userProfile.theme || "light");
          applyTheme(themeToUse);

          const today = getTodayISODateString();
          if (jobDateInput) jobDateInput.value = today;
          if (openBillTodayLabel) openBillTodayLabel.innerHTML = `<i class="bi bi-calendar-event me-1 text-primary"></i> ` + formatDateThaiFromString(today);

          setupEventListenersForPage();
          await loadStockForParts(userProfile.branchId || null);
          loadAutocompleteHistory(userProfile.branchId || null);

          if (!partsTbody.querySelector("tr") && stockOptionsHtml) partsTbody.appendChild(createPartRow());
          if (!laborTbody.querySelector("tr")) laborTbody.appendChild(createLaborRow());

          recalcTotals();
        } catch (error) {
          console.error("Init Error:", error);
          showToast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "danger");
        }
      });
    </script>
  </body>
</html>