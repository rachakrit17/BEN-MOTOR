<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – สต๊อกอะไหล่</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-4">
        
        <div class="row align-items-center mb-4 mt-2">
          <div class="col-12 col-md-8">
            <h1 class="h5 mb-1 fw-bold text-dark">
              <i class="bi bi-box-seam-fill text-success me-2"></i>สต๊อกอะไหล่
            </h1>
            <p class="small text-muted mb-0">
              บริหารจัดการคลังสินค้า ตรวจสอบมูลค่าคงเหลือ และบันทึกรับเข้า
            </p>
          </div>
        </div>

        <section class="mb-4">
           <div class="bm-dashboard-grid">
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">สินค้าในสต๊อก</div>
                 <div class="bm-stat-value text-dark" id="stockTotalItemsText">0</div>
                 <div class="bm-stat-sub text-muted">รายการ</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">สินค้าใกล้หมด</div>
                 <div class="bm-stat-value text-warning" id="stockLowItemsText">0</div>
                 <div class="bm-stat-sub text-muted">รายการ</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">มูลค่าต้นทุนรวม</div>
                 <div class="bm-stat-value text-secondary" id="stockTotalCostValueText">0.00</div>
                 <div class="bm-stat-sub text-muted">บาท</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">มูลค่าขายรวม</div>
                 <div class="bm-stat-value text-success" id="stockTotalSaleValueText">0.00</div>
                 <div class="bm-stat-sub text-muted">บาท</div>
              </div>
           </div>
        </section>

        <section class="mb-4">
          <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0 d-flex justify-content-between align-items-center">
                <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center fw-semibold text-success" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddStock" aria-expanded="false" id="toggleStockFormBtn">
                  <i class="bi bi-plus-circle-fill me-2 fs-5"></i> <span id="stockFormTitleText">เพิ่มสินค้าใหม่</span>
                  <i class="bi bi-chevron-down ms-2 small"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm d-none rounded-pill px-3"
                  id="cancelEditStockBtn"
                >
                  <i class="bi bi-x-lg me-1"></i>ยกเลิกแก้ไข
                </button>
            </div>
            <div class="collapse" id="collapseAddStock">
              <div class="card-body pt-2">
                <form id="stockItemForm" class="row g-3">
                  <input type="hidden" id="stockItemIdInput" />

                  <div class="col-6 col-md-3">
                    <label for="stockCodeInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-upc-scan me-1"></i>รหัสสินค้า
                    </label>
                    <input type="text" class="form-control bg-light" id="stockCodeInput" placeholder="เช่น OIL-10W40" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="stockNameInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-tag me-1"></i>ชื่อสินค้า
                    </label>
                    <input type="text" class="form-control" id="stockNameInput" placeholder="เช่น น้ำมันเครื่อง" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="stockCategoryInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-bookmarks me-1"></i>หมวดหมู่
                    </label>
                    <input type="text" class="form-control" id="stockCategoryInput" list="categoryList" placeholder="เลือกหรือพิมพ์ใหม่" required />
                    <datalist id="categoryList"></datalist>
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="stockUnitInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-box me-1"></i>หน่วยนับ
                    </label>
                    <input type="text" class="form-control" id="stockUnitInput" placeholder="เช่น ชิ้น, ขวด, ลิตร" required />
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="stockQtyInput" class="form-label small mb-1 text-primary fw-semibold">
                      <i class="bi bi-layers me-1"></i>คงเหลือปัจจุบัน
                    </label>
                    <input type="number" min="0" class="form-control border-primary" id="stockQtyInput" placeholder="0" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="stockMinQtyInput" class="form-label small mb-1 text-warning fw-semibold">
                      <i class="bi bi-exclamation-triangle me-1"></i>ขั้นต่ำ (แจ้งเตือน)
                    </label>
                    <input type="number" min="0" class="form-control border-warning" id="stockMinQtyInput" placeholder="0" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="stockCostPriceInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-coin me-1"></i>ราคาทุน (บาท)
                    </label>
                    <input type="number" min="0" step="0.01" class="form-control" id="stockCostPriceInput" placeholder="0.00" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="stockSalePriceInput" class="form-label small mb-1 text-success fw-semibold">
                      <i class="bi bi-cash-coin me-1"></i>ราคาขาย (บาท)
                    </label>
                    <input type="number" min="0" step="0.01" class="form-control border-success" id="stockSalePriceInput" placeholder="0.00" required />
                  </div>

                  <div class="col-12 mt-3 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary px-4 shadow-sm" id="saveStockItemBtn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" id="saveStockItemSpinner" role="status"></span>
                      <i class="bi bi-save2 me-2"></i><span id="saveStockItemBtnText">บันทึกสินค้า</span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-4">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                 <h2 class="h6 fw-bold text-success mb-0">
                   <i class="bi bi-funnel-fill me-2"></i> ค้นหาและจัดการ
                 </h2>
                 <button class="btn btn-sm btn-outline-success rounded-pill px-3" id="exportCsvBtn">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> ส่งออก CSV
                 </button>
              </div>

              <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6">
                    <label class="form-label small text-muted mb-1">ค้นหา (รหัส, ชื่อสินค้า)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchStockInput" class="form-control bg-light border-start-0 ps-0" placeholder="พิมพ์คำค้น..." />
                    </div>
                </div>
                <div class="col-6 col-md-4">
                    <label class="form-label small text-muted mb-1">หมวดหมู่</label>
                    <select id="stockCategoryFilter" class="form-select form-select-sm bg-light">
                      <option value="all" selected>ทั้งหมด</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 d-flex align-items-center justify-content-end pb-1">
                    <div class="small text-muted" id="stockLoadingState">
                        <span class="spinner-grow spinner-grow-sm text-primary me-1" role="status"></span> โหลด...
                    </div>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3 pt-3 border-top">
                <input type="radio" class="btn-check" name="stockFilterMode" id="stockFilterModeAll" value="all" checked>
                <label class="btn btn-sm btn-light rounded-pill px-3 border" for="stockFilterModeAll">ทั้งหมด</label>

                <input type="radio" class="btn-check" name="stockFilterMode" id="stockFilterModeLow" value="low">
                <label class="btn btn-sm btn-light rounded-pill px-3 border text-warning-emphasis" for="stockFilterModeLow">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>ใกล้หมด
                </label>

                <input type="radio" class="btn-check" name="stockFilterMode" id="stockFilterModeFast" value="fast">
                <label class="btn btn-sm btn-light rounded-pill px-3 border text-success-emphasis" for="stockFilterModeFast">
                    <i class="bi bi-graph-up-arrow me-1"></i>ขายดี
                </label>
                
                <span class="ms-auto small text-muted align-self-center" id="stockCountInfo">
                   <span id="stockCountNumber" class="fw-bold text-dark">0</span> รายการ
                </span>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-3">
          <div class="card shadow-sm border-0 overflow-hidden rounded-4">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light text-secondary small text-uppercase">
                    <tr>
                      <th class="ps-4 py-3 text-nowrap" style="min-width: 100px;">รหัส</th>
                      <th class="py-3" style="min-width: 180px;">ชื่อสินค้า</th>
                      <th class="py-3 text-nowrap" style="min-width: 120px;">หมวดหมู่</th>
                      <th class="py-3 text-end text-nowrap" style="min-width: 130px;">คงเหลือ / ขั้นต่ำ</th>
                      <th class="py-3 text-end text-nowrap" style="min-width: 110px;">ราคาขาย</th>
                      <th class="py-3 text-center" style="min-width: 100px;">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="stockTableBody" class="border-top-0">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-5 text-center">
          <button
            type="button"
            class="btn btn-white border shadow-sm rounded-pill px-4 py-2 text-muted d-none"
            id="loadMoreStockBtn"
          >
            <span class="spinner-border spinner-border-sm me-2 d-none" id="loadMoreStockSpinner"></span>
            <span id="loadMoreStockBtnText">โหลดเพิ่มเติม</span> <i class="bi bi-chevron-down ms-1"></i>
          </button>
        </section>

        <div style="height: 4.5rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow-lg border-0" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabOpenBillBtn">
              <i class="bi bi-receipt-cutoff me-3 text-primary"></i> เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabAddTxnBtn">
              <i class="bi bi-cash-coin me-3 text-success"></i> เพิ่มรายการเงิน
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2 fw-semibold" type="button" id="fabStockInBtn">
              <i class="bi bi-box-seam me-3 text-warning"></i> บันทึกซื้ออะไหล่
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link active">
              <i class="bi bi-box-seam d-block"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="modal fade"
      id="stockInModal"
      tabindex="-1"
      aria-labelledby="stockInModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow border-0 rounded-4">
          <div class="modal-header border-bottom-0 pb-0">
            <h1 class="modal-title fs-5 fw-bold" id="stockInModalLabel">
              <i class="bi bi-box-arrow-in-down me-2 text-primary"></i>บันทึกซื้ออะไหล่เข้า
            </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
          </div>
          <div class="modal-body pt-3">
            <div id="stockInLoadingState" class="text-center py-4 d-none">
              <span class="spinner-border spinner-border-sm me-2"></span>กำลังโหลด...
            </div>

            <div class="card border-0 bg-light rounded-4 mb-3">
               <div class="card-body">
                   <div class="d-flex justify-content-between align-items-center mb-1">
                       <span class="badge bg-white text-dark border" id="stockInItemCodeText">-</span>
                       <small class="text-muted"><span id="stockInItemCategoryText">-</span></small>
                   </div>
                   <h5 class="fw-bold text-dark mb-1" id="stockInItemNameText">-</h5>
                   <div class="text-muted small">
                       คงเหลือปัจจุบัน: <span id="stockInItemQtyText" class="fw-bold text-primary">-</span>
                   </div>
                   <div class="text-muted small">
                       ทุนเฉลี่ยล่าสุด: <span id="stockInItemAvgCostText">-</span>
                   </div>
               </div>
            </div>

            <form id="stockInForm" class="row g-3">
                <div class="col-6">
                  <label class="form-label small mb-1">วันที่ซื้อเข้า</label>
                  <input type="date" class="form-control" id="stockInDateInput" />
                </div>
                <div class="col-6">
                  <label class="form-label small mb-1 fw-bold text-success">+ จำนวนเพิ่ม</label>
                  <input type="number" min="1" class="form-control border-success" id="stockInQtyInput" placeholder="ระบุจำนวน" />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label small mb-1">ต้นทุนต่อหน่วย (บาท)</label>
                  <input type="number" min="0" step="0.01" class="form-control" id="stockInCostPerUnitInput" placeholder="0.00" />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label small mb-1 text-muted">รวมเป็นเงิน (โดยประมาณ)</label>
                  <div class="form-control bg-light border-0 fw-bold text-end" id="stockInTotalCostPreview">0.00 ฿</div>
                </div>
                
                <div class="col-12">
                   <div class="alert alert-info d-flex align-items-center small py-2 mb-0">
                      <i class="bi bi-calculator me-2 fs-5"></i>
                      <div>
                         <div class="fw-semibold">ระบบจะคำนวณต้นทุนเฉลี่ยใหม่</div>
                         <div class="text-xs">Weighted Average Cost จะถูกบันทึกเมื่อยืนยัน</div>
                      </div>
                   </div>
                </div>
            </form>
          </div>
          <div class="modal-footer border-top-0 pt-0 pb-3">
            <button type="button" class="btn btn-secondary btn-sm px-4 rounded-pill" data-bs-dismiss="modal">ยกเลิก</button>
            <button type="button" class="btn btn-primary btn-sm px-4 shadow-sm rounded-pill" id="stockInSaveBtn">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="stockInSaveSpinner"></span>
              <span id="stockInSaveBtnText">ยืนยันการรับเข้า</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1090;">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
        <div class="d-flex px-2">
          <div class="toast-body d-flex align-items-center" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="ปิด"></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc,
        query, where, orderBy, limit, startAfter, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");

      // Stats
      const stockTotalItemsText = document.getElementById("stockTotalItemsText");
      const stockLowItemsText = document.getElementById("stockLowItemsText");
      const stockTotalCostValueText = document.getElementById("stockTotalCostValueText");
      const stockTotalSaleValueText = document.getElementById("stockTotalSaleValueText");

      // Form
      const stockItemForm = document.getElementById("stockItemForm");
      const toggleStockFormBtn = document.getElementById("toggleStockFormBtn");
      const collapseAddStock = document.getElementById("collapseAddStock");
      const cancelEditStockBtn = document.getElementById("cancelEditStockBtn");
      const stockFormTitleText = document.getElementById("stockFormTitleText");
      
      const stockItemIdInput = document.getElementById("stockItemIdInput");
      const stockCodeInput = document.getElementById("stockCodeInput");
      const stockNameInput = document.getElementById("stockNameInput");
      const stockCategoryInput = document.getElementById("stockCategoryInput");
      const categoryList = document.getElementById("categoryList");
      const stockUnitInput = document.getElementById("stockUnitInput");
      const stockQtyInput = document.getElementById("stockQtyInput");
      const stockMinQtyInput = document.getElementById("stockMinQtyInput");
      const stockCostPriceInput = document.getElementById("stockCostPriceInput");
      const stockSalePriceInput = document.getElementById("stockSalePriceInput");
      const saveStockItemBtn = document.getElementById("saveStockItemBtn");
      const saveStockItemSpinner = document.getElementById("saveStockItemSpinner");
      const saveStockItemBtnText = document.getElementById("saveStockItemBtnText");

      // Filters
      const searchStockInput = document.getElementById("searchStockInput");
      const stockCategoryFilter = document.getElementById("stockCategoryFilter");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      const stockLoadingState = document.getElementById("stockLoadingState");
      const stockCountInfo = document.getElementById("stockCountInfo");
      const stockCountNumber = document.getElementById("stockCountNumber");

      // Table
      const stockTableBody = document.getElementById("stockTableBody");
      const loadMoreStockBtn = document.getElementById("loadMoreStockBtn");
      
      // Stock In Modal
      const stockInModalEl = document.getElementById("stockInModal");
      const stockInModal = bootstrap.Modal.getOrCreateInstance(stockInModalEl);
      const stockInItemCodeText = document.getElementById("stockInItemCodeText");
      const stockInItemCategoryText = document.getElementById("stockInItemCategoryText");
      const stockInItemNameText = document.getElementById("stockInItemNameText");
      const stockInItemQtyText = document.getElementById("stockInItemQtyText");
      const stockInItemAvgCostText = document.getElementById("stockInItemAvgCostText");
      const stockInDateInput = document.getElementById("stockInDateInput");
      const stockInQtyInput = document.getElementById("stockInQtyInput");
      const stockInCostPerUnitInput = document.getElementById("stockInCostPerUnitInput");
      const stockInTotalCostPreview = document.getElementById("stockInTotalCostPreview");
      const stockInSaveBtn = document.getElementById("stockInSaveBtn");
      const stockInSaveSpinner = document.getElementById("stockInSaveSpinner");
      const stockInSaveBtnText = document.getElementById("stockInSaveBtnText");

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // --- Variables ---
      let currentUser = null;
      let currentUserProfile = null;
      const PAGE_SIZE = 25;
      let stockLastVisible = null;
      let isLoadingStock = false;
      let stockItems = []; // All loaded items for client-side filtering support
      let isEditing = false;
      let currentStockInItem = null;
      let isSavingStockIn = false;
      let stockFilterMode = "all";

      // --- Helpers ---
      function showToast(message, variant = "primary") {
         mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0 shadow-lg rounded-pill";
         mainToastBody.innerHTML = message;
         mainToast.show();
      }
      function formatNumber(val) {
         return (typeof val === "number" && !isNaN(val)) ? val.toLocaleString("th-TH", {minimumFractionDigits:2, maximumFractionDigits:2}) : "0.00";
      }
      function getTodayISO() {
         return new Date().toISOString().split("T")[0];
      }
      function applyTheme(theme) {
         bodyEl.className = theme === "dark" ? "bm-theme-dark" : "bm-theme-light";
         themeToggleBtn.querySelector("i").className = theme === "dark" ? "bi bi-sun fs-5" : "bi bi-moon fs-5";
      }

      // --- Stats & UI Updates ---
      function updateStats() {
         let totalItems = 0, lowItems = 0, costVal = 0, saleVal = 0;
         const uniqueCats = new Set();
         
         stockItems.forEach(item => {
             totalItems++;
             const qty = Number(item.qty)||0;
             const min = Number(item.minQty)||0;
             if(qty <= min) lowItems++;
             costVal += qty * (Number(item.costPrice)||0);
             saleVal += qty * (Number(item.salePrice)||0);
             if(item.category) uniqueCats.add(item.category.trim());
         });

         stockTotalItemsText.textContent = totalItems.toLocaleString();
         stockLowItemsText.textContent = lowItems.toLocaleString();
         stockTotalCostValueText.textContent = formatNumber(costVal);
         stockTotalSaleValueText.textContent = formatNumber(saleVal);

         // Update Datalist & Filter
         const currentFilterVal = stockCategoryFilter.value;
         let filterHtml = `<option value="all">ทั้งหมด</option>`;
         let datalistHtml = "";
         Array.from(uniqueCats).sort().forEach(c => {
             filterHtml += `<option value="${c}" ${c===currentFilterVal?'selected':''}>${c}</option>`;
             datalistHtml += `<option value="${c}">`;
         });
         stockCategoryFilter.innerHTML = filterHtml;
         categoryList.innerHTML = datalistHtml;
      }

      function renderTable() {
         const search = (searchStockInput.value || "").toLowerCase();
         const cat = stockCategoryFilter.value;
         
         const filtered = stockItems.filter(item => {
             const matchSearch = (item.code||"").toLowerCase().includes(search) || (item.name||"").toLowerCase().includes(search);
             const matchCat = cat === "all" || item.category === cat;
             let matchMode = true;
             
             const q = Number(item.qty)||0;
             const m = Number(item.minQty)||0;
             const score = Number(item.fastMovingScore)||0;

             if(stockFilterMode === "low") matchMode = q <= m;
             if(stockFilterMode === "fast") matchMode = score >= 10;

             return matchSearch && matchCat && matchMode;
         });

         stockTableBody.innerHTML = "";
         if(filtered.length === 0) {
             stockTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">ไม่พบข้อมูล</td></tr>`;
         } else {
             filtered.forEach(item => {
                 const q = Number(item.qty)||0;
                 const m = Number(item.minQty)||0;
                 const isLow = q <= m;
                 
                 const tr = document.createElement("tr");
                 tr.innerHTML = `
                   <td class="ps-4 text-nowrap"><span class="badge bg-light text-dark border fw-normal">${item.code}</span></td>
                   <td class="fw-medium text-dark">${item.name}</td>
                   <td>${item.category}</td>
                   <td class="text-end ${isLow?'text-danger fw-bold':''}">${q.toLocaleString()} <span class="text-muted fw-normal text-xs">/ ${m}</span></td>
                   <td class="text-end">${formatNumber(item.salePrice)}</td>
                   <td class="text-center">
                      <div class="dropdown">
                        <button class="btn btn-sm btn-light border rounded-circle" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                           <li><button class="dropdown-item py-2 stock-in-btn" data-id="${item.id}"><i class="bi bi-box-arrow-in-down me-2 text-primary"></i>ซื้อเข้า</button></li>
                           <li><button class="dropdown-item py-2 edit-btn" data-id="${item.id}"><i class="bi bi-pencil me-2 text-warning"></i>แก้ไข</button></li>
                           <li><a class="dropdown-item py-2" href="activity-log.html?search=${item.code}"><i class="bi bi-clock-history me-2 text-info"></i>ประวัติ</a></li>
                           <li><hr class="dropdown-divider"></li>
                           <li><button class="dropdown-item py-2 text-danger delete-btn" data-id="${item.id}"><i class="bi bi-trash me-2"></i>ลบ</button></li>
                        </ul>
                      </div>
                   </td>
                 `;
                 stockTableBody.appendChild(tr);
             });
         }
         
         if(stockCountInfo) {
             stockCountInfo.classList.remove("d-none");
             stockCountNumber.textContent = filtered.length;
         }
      }

      // --- Data Loading ---
      async function loadStock(reset = false) {
         if(isLoadingStock) return;
         if(!currentUserProfile) return;

         if(reset) {
             stockItems = [];
             stockLastVisible = null;
         }
         
         isLoadingStock = true;
         stockLoadingState.innerHTML = `<span class="spinner-border spinner-border-sm text-primary"></span>`;
         if(loadMoreStockBtn) loadMoreStockBtn.classList.add("d-none");

         try {
             const constraints = [where("isDeleted", "==", false)];
             if(currentUserProfile.branchId) constraints.push(where("branchId", "==", currentUserProfile.branchId));
             
             let q = query(collection(db, "stock"), ...constraints, orderBy("name", "asc"), limit(PAGE_SIZE));
             if(!reset && stockLastVisible) {
                 q = query(collection(db, "stock"), ...constraints, orderBy("name", "asc"), startAfter(stockLastVisible), limit(PAGE_SIZE));
             }

             const snap = await getDocs(q);
             snap.forEach(d => stockItems.push({ id: d.id, ...d.data() }));

             if(!snap.empty) stockLastVisible = snap.docs[snap.docs.length-1];
             
             if(snap.size === PAGE_SIZE) loadMoreStockBtn.classList.remove("d-none");
             else loadMoreStockBtn.classList.add("d-none");

             updateStats();
             renderTable();

         } catch(e) {
             console.error(e);
             showToast("โหลดข้อมูลล้มเหลว", "danger");
         } finally {
             isLoadingStock = false;
             stockLoadingState.textContent = "";
         }
      }

      // --- Actions ---
      async function handleSaveStock(e) {
         e.preventDefault();
         const btn = saveStockItemBtn;
         btn.disabled = true; saveStockItemSpinner.classList.remove("d-none");

         try {
             const data = {
                 code: stockCodeInput.value.trim(),
                 name: stockNameInput.value.trim(),
                 category: stockCategoryInput.value.trim(),
                 unit: stockUnitInput.value.trim(),
                 qty: parseFloat(stockQtyInput.value)||0,
                 minQty: parseFloat(stockMinQtyInput.value)||0,
                 costPrice: parseFloat(stockCostPriceInput.value)||0,
                 salePrice: parseFloat(stockSalePriceInput.value)||0,
                 branchId: currentUserProfile.branchId,
                 updatedAt: serverTimestamp()
             };

             if(isEditing) {
                 const id = stockItemIdInput.value;
                 await updateDoc(doc(db, "stock", id), data);
                 // Update Local
                 const idx = stockItems.findIndex(i => i.id === id);
                 if(idx !== -1) stockItems[idx] = { ...stockItems[idx], ...data };
                 
// ...
await addDoc(collection(db, "activityLogs"), {
   type: "stock_updated", message: `แก้ไขสินค้า ${data.name}`, refId: id, refType: "stock",
   branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), 
   createdBy: currentUser.uid,
   createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่ม
});
// ...
                 showToast("แก้ไขสำเร็จ", "success");
                 resetForm();
             } else {
                 data.createdAt = serverTimestamp();
                 data.isDeleted = false;
                 data.fastMovingScore = 0;
                 const ref = await addDoc(collection(db, "stock"), data);
                 stockItems.push({ id: ref.id, ...data });
                 
// ...
await addDoc(collection(db, "activityLogs"), {
   type: "stock_created", message: `เพิ่มสินค้าใหม่ ${data.name}`, refId: ref.id, refType: "stock",
   branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), 
   createdBy: currentUser.uid,
   createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่ม
});
// ...
                 showToast("เพิ่มสินค้าสำเร็จ", "success");
                 e.target.reset();
             }
             updateStats();
             renderTable();

         } catch(err) {
             console.error(err);
             showToast("บันทึกไม่สำเร็จ", "danger");
         } finally {
             btn.disabled = false; saveStockItemSpinner.classList.add("d-none");
         }
      }

      async function handleDelete(id) {
         if(!confirm("ต้องการลบสินค้านี้ใช่หรือไม่? (Soft Delete)")) return;
         try {
             await updateDoc(doc(db, "stock", id), { isDeleted: true, updatedAt: serverTimestamp() });
             stockItems = stockItems.filter(i => i.id !== id);
             updateStats();
             renderTable();
             showToast("ลบสินค้าเรียบร้อย", "success");
         } catch(e) {
             showToast("ลบไม่สำเร็จ", "danger");
         }
      }

      function startEdit(id) {
          const item = stockItems.find(i => i.id === id);
          if(!item) return;
          isEditing = true;
          stockItemIdInput.value = item.id;
          stockCodeInput.value = item.code;
          stockNameInput.value = item.name;
          stockCategoryInput.value = item.category;
          stockUnitInput.value = item.unit;
          stockQtyInput.value = item.qty;
          stockMinQtyInput.value = item.minQty;
          stockCostPriceInput.value = item.costPrice;
          stockSalePriceInput.value = item.salePrice;
          
          stockFormTitleText.textContent = "แก้ไขข้อมูลสินค้า";
          saveStockItemBtnText.textContent = "อัปเดตข้อมูล";
          cancelEditStockBtn.classList.remove("d-none");
          
          const bsCollapse = new bootstrap.Collapse(collapseAddStock, { toggle: false });
          bsCollapse.show();
          stockItemForm.scrollIntoView({ behavior: "smooth" });
      }

      function resetForm() {
          isEditing = false;
          stockItemForm.reset();
          stockItemIdInput.value = "";
          stockFormTitleText.textContent = "เพิ่มสินค้าใหม่";
          saveStockItemBtnText.textContent = "บันทึกสินค้า";
          cancelEditStockBtn.classList.add("d-none");
          const bsCollapse = new bootstrap.Collapse(collapseAddStock, { toggle: false });
          bsCollapse.hide();
      }

      // Stock In Logic
      function openStockIn(id) {
          const item = stockItems.find(i => i.id === id);
          if(!item) return;
          currentStockInItem = item;
          
          stockInItemCodeText.textContent = item.code;
          stockInItemNameText.textContent = item.name;
          stockInItemCategoryText.textContent = item.category;
          stockInItemQtyText.textContent = formatNumber(item.qty) + " " + item.unit;
          stockInItemAvgCostText.textContent = formatNumber(item.costPrice) + " ฿";
          
          stockInDateInput.value = getTodayISO();
          stockInQtyInput.value = "";
          stockInCostPerUnitInput.value = item.costPrice || ""; // default to current cost
          stockInTotalCostPreview.textContent = "0.00 ฿";
          
          stockInModal.show();
      }

      async function handleStockIn() {
          const qtyAdd = parseFloat(stockInQtyInput.value);
          const newCost = parseFloat(stockInCostPerUnitInput.value);
          const date = stockInDateInput.value;
          
          if(!qtyAdd || qtyAdd <= 0 || isNaN(newCost)) {
              showToast("กรุณาระบุจำนวนและต้นทุนให้ถูกต้อง", "warning"); return;
          }
          
          isSavingStockIn = true;
          stockInSaveBtn.disabled = true;
          stockInSaveSpinner.classList.remove("d-none");

          try {
              const oldQty = Number(currentStockInItem.qty)||0;
              const oldCost = Number(currentStockInItem.costPrice)||0;
              const totalOldVal = oldQty * oldCost;
              const totalNewVal = qtyAdd * newCost;
              const finalQty = oldQty + qtyAdd;
              const avgCost = finalQty > 0 ? (totalOldVal + totalNewVal) / finalQty : newCost;

              await updateDoc(doc(db, "stock", currentStockInItem.id), {
                  qty: finalQty,
                  costPrice: avgCost,
                  updatedAt: serverTimestamp()
              });
              
              await addDoc(collection(db, "transactions"), {
                  type: "expense", category: "ซื้ออะไหล่", description: `ซื้อ ${currentStockInItem.name}`,
                  amount: totalNewVal, date: date, sourceType: "stock", sourceId: currentStockInItem.id,
                  branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), isDeleted: false
              });

// ...
await addDoc(collection(db, "activityLogs"), {
    type: "stock_in", message: `รับเข้า ${currentStockInItem.name} +${qtyAdd}`, 
    refId: currentStockInItem.id, refType: "stock",
    branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), 
    createdBy: currentUser.uid,
    createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่ม
});
// ...

              // Update Local
              const idx = stockItems.findIndex(i => i.id === currentStockInItem.id);
              if(idx !== -1) {
                  stockItems[idx].qty = finalQty;
                  stockItems[idx].costPrice = avgCost;
              }
              
              showToast("บันทึกรับเข้าเรียบร้อย", "success");
              stockInModal.hide();
              updateStats();
              renderTable();

          } catch(e) {
              console.error(e);
              showToast("บันทึกไม่สำเร็จ", "danger");
          } finally {
              isSavingStockIn = false;
              stockInSaveBtn.disabled = false;
              stockInSaveSpinner.classList.add("d-none");
          }
      }

      function exportToCSV() {
         if(!stockItems.length) { showToast("ไม่มีข้อมูล", "warning"); return; }
         let csv = "\uFEFFรหัส,ชื่อสินค้า,หมวดหมู่,คงเหลือ,ราคาทุน,ราคาขาย\n";
         stockItems.forEach(i => {
             csv += `"${i.code}","${i.name}","${i.category}",${i.qty},${i.costPrice},${i.salePrice}\n`;
         });
         const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
         const link = document.createElement("a");
         link.href = URL.createObjectURL(blob);
         link.download = `stock_${getTodayISO()}.csv`;
         link.click();
      }

      // --- Setup ---
      function setupEvents() {
         toggleStockFormBtn.onclick = () => resetForm(); // Open creates new clean state
         cancelEditStockBtn.onclick = () => resetForm();
         stockItemForm.onsubmit = handleSaveStock;
         
         // Realtime search & filter
         searchStockInput.addEventListener("keyup", renderTable);
         stockCategoryFilter.addEventListener("change", renderTable);
         document.querySelectorAll('input[name="stockFilterMode"]').forEach(r => {
             r.addEventListener("change", (e) => {
                 stockFilterMode = e.target.value;
                 renderTable();
             });
         });
         
         // Stock In Preview
         const calcPreview = () => {
             const q = parseFloat(stockInQtyInput.value)||0;
             const c = parseFloat(stockInCostPerUnitInput.value)||0;
             stockInTotalCostPreview.textContent = formatNumber(q*c) + " ฿";
         };
         stockInQtyInput.oninput = calcPreview;
         stockInCostPerUnitInput.oninput = calcPreview;
         stockInSaveBtn.onclick = handleStockIn;

         // Load More
         loadMoreStockBtn.onclick = () => loadStock(false);

         // Table Actions
         stockTableBody.onclick = (e) => {
             const btnIn = e.target.closest(".stock-in-btn");
             if(btnIn) openStockIn(btnIn.dataset.id);

             const btnEdit = e.target.closest(".edit-btn");
             if(btnEdit) startEdit(btnEdit.dataset.id);

             const btnDel = e.target.closest(".delete-btn");
             if(btnDel) handleDelete(btnDel.dataset.id);
         };

         // FAB & Nav
         fabOpenBillBtn.onclick = () => window.location.href="open-bill.html";
         fabAddTxnBtn.onclick = () => window.location.href="finance.html";
         fabStockInBtn.onclick = () => {
             document.getElementById("searchStockInput").focus();
             window.scrollTo({top:0, behavior:"smooth"});
         };
         exportCsvBtn.onclick = exportToCSV;
         logoutBtn.onclick = () => signOut(auth).then(() => window.location.href="index.html");
         
         if(themeToggleBtn) themeToggleBtn.onclick = () => {
             const t = bodyEl.classList.contains("bm-theme-dark") ? "light" : "dark";
             applyTheme(t);
             localStorage.setItem("bm-theme-" + currentUser.uid, t);
         };
      }

      // --- Main ---
      onAuthStateChanged(auth, async (user) => {
         if(!user) { window.location.href = "index.html"; return; }
         currentUser = user;
         
         const userRef = doc(db, "users", user.uid);
         const snap = await getDoc(userRef);
         if(snap.exists()) currentUserProfile = { id: snap.id, ...snap.data() };
         else currentUserProfile = { role: "staff", branchId: null, theme: "light" };

         if(currentUserProfile.disabled) { signOut(auth); return; }

         userDisplayNameText.textContent = currentUserProfile.displayName || user.email;
         userRoleText.textContent = currentUserProfile.role === 'admin' ? "Admin" : "Staff";
         userAvatarInitial.textContent = (currentUserProfile.displayName||"U")[0].toUpperCase();
         if(settingsMenuItem) settingsMenuItem.classList.toggle("d-none", currentUserProfile.role !== 'admin');
         
         applyTheme(localStorage.getItem("bm-theme-"+user.uid) || currentUserProfile.theme);

         setupEvents();
         loadStock(true);
      });
    </script>
  </body>
</html>