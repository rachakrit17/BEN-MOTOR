<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – รถรับซื้อเข้า / ขายออก</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-4">
        
        <div class="row align-items-end mb-4 mt-2">
          <div class="col-12 col-md-8">
            <h1 class="h5 mb-1 fw-bold text-dark">
              <i class="bi bi-truck-front-fill text-primary me-2"></i>รถรับซื้อเข้า / ขายออก
            </h1>
            <p class="small text-muted mb-0">
              จัดการสต๊อกรถมอเตอร์ไซค์ บันทึกการซื้อเข้า-ขายออก และดูผลกำไร
            </p>
          </div>
        </div>

        <section class="mb-4">
          <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0">
                <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center fw-semibold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddVehicle" aria-expanded="false">
                  <i class="bi bi-plus-circle-fill me-2 fs-5"></i> บันทึกรถรับซื้อเข้าใหม่
                  <i class="bi bi-chevron-down ms-2 small"></i>
                </button>
            </div>
            <div class="collapse show" id="collapseAddVehicle">
              <div class="card-body pt-2">
                <form id="addVehicleForm" class="row g-3">
                  <div class="col-6 col-md-3">
                    <label for="buyDateInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-calendar-event me-1"></i>วันที่ซื้อเข้า
                    </label>
                    <input type="date" class="form-control" id="buyDateInput" required />
                  </div>
                  <div class="col-6 col-md-3">
                      <label for="plateInput" class="form-label small mb-1 text-muted">
                        <i class="bi bi-card-heading me-1"></i>ทะเบียนรถ
                      </label>
                      <input type="text" class="form-control" id="plateInput" placeholder="เช่น 1กข 1234" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="brandInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-tag me-1"></i>ยี่ห้อ
                    </label>
                    <input type="text" class="form-control" id="brandInput" placeholder="เช่น Honda" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="modelInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-bicycle me-1"></i>รุ่นรถ
                    </label>
                    <input type="text" class="form-control" id="modelInput" placeholder="เช่น Click 125i" required />
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="mileageInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-speedometer2 me-1"></i>เลขไมล์ (กม.)
                    </label>
                    <input type="number" min="0" class="form-control" id="mileageInput" placeholder="ระบุเลขไมล์" />
                  </div>
                  <div class="col-6 col-md-3">
                    <label for="buyPriceInput" class="form-label small mb-1 text-primary fw-semibold">
                      <i class="bi bi-cash me-1"></i>ราคาซื้อเข้า (บาท)
                    </label>
                    <input type="number" min="0" class="form-control border-primary" id="buyPriceInput" placeholder="0.00" required />
                  </div>
                  <div class="col-12 col-md-6">
                    <label for="noteInput" class="form-label small mb-1 text-muted">
                      <i class="bi bi-sticky me-1"></i>หมายเหตุ
                    </label>
                    <textarea id="noteInput" class="form-control" rows="1" placeholder="รายละเอียดเพิ่มเติม เช่น สภาพรถ, รอยตำหนิ"></textarea>
                  </div>

                  <div class="col-12 d-flex justify-content-end align-items-center pt-2">
                    <button type="submit" class="btn btn-primary px-4 shadow-sm" id="addVehicleBtn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" id="addVehicleSpinner" role="status" aria-hidden="true"></span>
                      <i class="bi bi-save2 me-2"></i><span id="addVehicleBtnText">บันทึกรถเข้าสต๊อก</span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-4">
           <div class="bm-dashboard-grid">
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">รถในสต๊อก (In Stock)</div>
                 <div class="bm-stat-value text-dark" id="vehicleInStockCount">0</div>
                 <div class="bm-stat-sub text-muted">คัน</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">ขายแล้ว (Sold)</div>
                 <div class="bm-stat-value text-success" id="vehicleSoldCount">0</div>
                 <div class="bm-stat-sub text-muted">คัน</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">กำไรรวม (เฉพาะที่ขาย)</div>
                 <div class="bm-stat-value text-primary" id="vehicleTotalProfit">0.00</div>
                 <div class="bm-stat-sub text-muted">บาท</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">จำนวนที่แสดงผล</div>
                 <div class="bm-stat-value text-secondary" id="vehiclesCountNumber">0</div>
                 <div class="bm-stat-sub text-muted">รายการ</div>
              </div>
           </div>
        </section>

        <section class="mb-4">
          <div class="card border-0 shadow-sm rounded-4">
             <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                   <h2 class="h6 fw-bold text-primary mb-0">
                      <i class="bi bi-funnel-fill me-2"></i> ตัวกรองค้นหา
                   </h2>
                   <button class="btn btn-sm btn-outline-success rounded-pill px-3" id="exportCsvBtn">
                      <i class="bi bi-file-earmark-spreadsheet me-1"></i> ส่งออก CSV
                   </button>
                </div>

                <div class="row g-3 align-items-end">
                   <div class="col-6 col-md-3">
                      <label class="form-label small text-muted mb-1">ตั้งแต่วันที่</label>
                      <input type="date" class="form-control form-control-sm bg-light" id="filterStartDate">
                   </div>
                   <div class="col-6 col-md-3">
                      <label class="form-label small text-muted mb-1">ถึงวันที่</label>
                      <input type="date" class="form-control form-control-sm bg-light" id="filterEndDate">
                   </div>
                   <div class="col-6 col-md-2">
                      <label class="form-label small text-muted mb-1">สถานะ</label>
                      <select id="vehicleStatusFilter" class="form-select form-select-sm bg-light">
                          <option value="all">ทั้งหมด</option>
                          <option value="in_stock" selected>พร้อมขาย</option>
                          <option value="sold">ขายแล้ว</option>
                      </select>
                   </div>
                   <div class="col-12 col-md-4">
                      <label class="form-label small text-muted mb-1">ค้นหา (ทะเบียน, ยี่ห้อ, รุ่น)</label>
                      <div class="input-group input-group-sm">
                         <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                         <input type="text" class="form-control bg-light border-start-0 ps-0" id="searchTextInput" placeholder="พิมพ์คำค้น...">
                         <button class="btn btn-primary" type="button" id="searchBtn">ค้นหา</button>
                      </div>
                   </div>
                </div>

                <div class="d-flex justify-content-end mt-3 pt-2 border-top">
                    <div class="d-flex align-items-center gap-2">
                        <span class="small text-muted me-1">มุมมอง:</span>
                        <div class="btn-group btn-group-sm bg-light p-1 rounded-pill border" role="group">
                            <button type="button" class="btn btn-sm btn-light rounded-pill border-0 px-3 active text-primary fw-bold" id="tableViewBtn">
                                <i class="bi bi-table"></i> ตาราง
                            </button>
                            <button type="button" class="btn btn-sm btn-light rounded-pill border-0 px-3 text-secondary" id="cardViewBtn">
                                <i class="bi bi-grid-fill"></i> การ์ด
                            </button>
                        </div>
                    </div>
                </div>
             </div>
          </div>
        </section>

        <div id="vehiclesLoadingState" class="text-center py-3 d-none">
           <span class="spinner-grow spinner-grow-sm text-primary me-2" role="status" aria-hidden="true"></span>
           <span class="text-muted small">กำลังโหลดข้อมูล...</span>
        </div>

        <section id="vehiclesTableView" class="mb-3">
          <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light text-secondary small text-uppercase">
                    <tr>
                      <th class="ps-3 py-3 fw-normal" style="min-width: 100px;">วันที่ซื้อ</th>
                      <th class="py-3 fw-normal" style="min-width: 160px;">ยี่ห้อ / รุ่น</th>
                      <th class="py-3 fw-normal" style="min-width: 100px;">ทะเบียน</th>
                      <th class="py-3 fw-normal text-end" style="min-width: 100px;">ซื้อเข้า</th>
                      <th class="py-3 fw-normal text-end" style="min-width: 100px;">ขายออก</th>
                      <th class="py-3 fw-normal text-center" style="min-width: 100px;">สถานะ</th>
                      <th class="py-3 fw-normal text-end" style="min-width: 100px;">กำไร</th>
                      <th class="py-3 fw-normal text-center" style="min-width: 120px;">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="vehiclesTableBody" class="border-top-0">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <section id="vehiclesCardView" class="mb-3 d-none">
           <div id="vehiclesCardContainer" class="row g-3">
              </div>
        </section>

        <section class="mb-5 text-center">
          <button
            type="button"
            class="btn btn-white border shadow-sm rounded-pill px-4 py-2 text-muted d-none"
            id="loadMoreVehiclesBtn"
          >
            <span class="spinner-border spinner-border-sm me-2 d-none" id="loadMoreVehiclesSpinner"></span>
            <span id="loadMoreVehiclesBtnText">โหลดเพิ่มเติม</span> <i class="bi bi-chevron-down ms-1"></i>
          </button>
        </section>

        <div style="height: 4.5rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow-lg border-0" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabOpenBillBtn">
              <i class="bi bi-receipt-cutoff me-3 text-primary"></i> เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabAddTxnBtn">
              <i class="bi bi-cash-coin me-3 text-success"></i> เพิ่มรายการเงิน
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabStockInBtn">
              <i class="bi bi-box-seam me-3 text-warning"></i> บันทึกซื้ออะไหล่
            </button>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2 fw-semibold" type="button" id="fabAddVehicleBtn">
              <i class="bi bi-truck-front me-3 text-info"></i> เพิ่มรถรับซื้อเข้า
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link active">
              <i class="bi bi-truck-front d-block"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="modal fade"
      id="sellVehicleModal"
      tabindex="-1"
      aria-labelledby="sellVehicleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-md modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow border-0 rounded-4">
          <div class="modal-header border-bottom-0 pb-0">
            <h1 class="modal-title fs-5 fw-bold" id="sellVehicleModalLabel">
              <i class="bi bi-card-text me-2 text-primary"></i>รายละเอียดรถ
            </h1>
            <div class="ms-auto">
               <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle me-1" id="vehicleEditBtn" title="แก้ไขข้อมูล">
                  <i class="bi bi-pencil"></i>
               </button>
               <button
                 type="button"
                 class="btn-close"
                 data-bs-dismiss="modal"
                 aria-label="ปิด"
               ></button>
            </div>
          </div>
          <div class="modal-body pt-3">
            <div id="sellVehicleLoadingState" class="text-center py-4 d-none">
              <span class="spinner-border spinner-border-sm me-2"></span>กำลังโหลด...
            </div>

            <div id="vehicleViewMode">
                <div class="bg-light p-3 rounded-4 mb-3 border">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                     <h2 class="h6 fw-bold text-secondary mb-0">ข้อมูลทั่วไป</h2>
                     <span class="badge bg-secondary rounded-pill" id="sellVehiclePlateText">-</span>
                  </div>
                  <div class="small text-dark">
                    <div class="row g-2">
                        <div class="col-12">
                            <span class="text-muted w-25 d-inline-block">รุ่น:</span> 
                            <span id="sellVehicleBrandModelText" class="fw-medium">-</span>
                        </div>
                        <div class="col-12">
                            <span class="text-muted w-25 d-inline-block">เลขไมล์:</span> 
                            <span id="sellVehicleMileageText">-</span>
                        </div>
                        <div class="col-12 mt-2 pt-2 border-top">
                             <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">วันที่ซื้อ:</span>
                                <span id="sellVehicleBuyDateText" class="fw-medium">-</span>
                             </div>
                             <div class="d-flex justify-content-between align-items-center mt-1">
                                <span class="text-muted">ราคาซื้อเข้า:</span>
                                <span id="sellVehicleBuyPriceText" class="fw-bold text-dark">-</span>
                             </div>
                        </div>
                        <div class="col-12 mt-2">
                            <span class="text-muted small d-block">หมายเหตุ:</span>
                            <div id="sellVehicleNoteText" class="p-2 bg-white rounded border-start border-3 border-secondary text-muted small fst-italic">
                                -
                            </div>
                        </div>
                    </div>
                  </div>
                </div>

                <section class="mb-2" id="sellVehicleFormSection">
                  <div class="card border-primary shadow-sm rounded-4 overflow-hidden">
                      <div class="card-header bg-primary text-white py-2">
                          <h2 class="h6 fw-semibold mb-0"><i class="bi bi-cash-coin me-2"></i>บันทึกการขาย</h2>
                      </div>
                      <div class="card-body">
                          <form id="sellVehicleForm" class="row g-2">
                            <div class="col-6">
                              <label class="form-label small mb-1 fw-medium">วันที่ขาย</label>
                              <input type="date" class="form-control form-control-sm" id="sellVehicleDateInput"/>
                            </div>
                            <div class="col-6">
                              <label class="form-label small mb-1 fw-medium text-success">ราคาขาย (บาท)</label>
                              <input type="number" min="0" class="form-control form-control-sm border-success" id="sellVehiclePriceInput" placeholder="0.00"/>
                            </div>
                            <div class="col-12 mt-3">
                              <div class="alert alert-light border d-flex justify-content-between align-items-center py-2 mb-0" id="sellVehicleProfitPreview">
                                 <span class="small text-muted">กำไรโดยประมาณ:</span>
                                 <span class="fw-bold text-success">0.00 ฿</span>
                              </div>
                            </div>
                          </form>
                      </div>
                  </div>
                </section>

                <section class="mb-2 d-none" id="sellVehicleSoldInfoSection">
                  <div class="card border-success shadow-sm rounded-4 overflow-hidden">
                      <div class="card-header bg-success text-white py-2">
                          <h2 class="h6 fw-semibold mb-0"><i class="bi bi-check-circle-fill me-2"></i>ขายแล้ว</h2>
                      </div>
                      <div class="card-body bg-success-subtle">
                          <div class="row g-2 small">
                            <div class="col-6">
                                <span class="text-secondary d-block">วันที่ขาย</span>
                                <span id="sellVehicleSoldDateText" class="fw-bold fs-6">-</span>
                            </div>
                            <div class="col-6 text-end">
                                <span class="text-secondary d-block">ราคาขาย</span>
                                <span id="sellVehicleSoldPriceText" class="fw-bold fs-6 text-success">-</span>
                            </div>
                            <div class="col-12"><hr class="my-1 border-secondary opacity-25"></div>
                            <div class="col-12 text-center py-2">
                                <span class="text-secondary me-2">กำไรสุทธิ:</span>
                                <span id="sellVehicleSoldProfitText" class="h4 fw-bold text-success mb-0">-</span>
                            </div>
                          </div>
                      </div>
                  </div>
                </section>
            </div>

            <div id="vehicleEditMode" class="d-none">
                <form id="vehicleEditForm" class="row g-3">
                   <div class="col-6">
                      <label class="form-label small">ทะเบียน</label>
                      <input type="text" class="form-control form-control-sm" id="editPlateInput">
                   </div>
                   <div class="col-6">
                      <label class="form-label small">เลขไมล์</label>
                      <input type="number" class="form-control form-control-sm" id="editMileageInput">
                   </div>
                   <div class="col-6">
                      <label class="form-label small">ยี่ห้อ</label>
                      <input type="text" class="form-control form-control-sm" id="editBrandInput">
                   </div>
                   <div class="col-6">
                      <label class="form-label small">รุ่น</label>
                      <input type="text" class="form-control form-control-sm" id="editModelInput">
                   </div>
                   <div class="col-12">
                      <label class="form-label small text-primary fw-bold">ราคาซื้อเข้า (Admin เท่านั้น)</label>
                      <input type="number" class="form-control form-control-sm border-primary" id="editBuyPriceInput" readonly>
                   </div>
                   <div class="col-12">
                      <label class="form-label small">หมายเหตุ</label>
                      <textarea class="form-control form-control-sm" id="editNoteInput" rows="2"></textarea>
                   </div>
                </form>
            </div>

          </div>
          <div class="modal-footer border-top-0 pt-0 pb-3">
            <div id="vehicleViewButtons" class="w-100 d-flex justify-content-end gap-2">
                 <button
                   type="button"
                   class="btn btn-link text-danger text-decoration-none btn-sm me-auto d-none"
                   id="vehicleDeleteBtn"
                 >
                   <i class="bi bi-trash"></i> ลบรถ
                 </button>
                <button type="button" class="btn btn-secondary btn-sm px-4 rounded-pill" data-bs-dismiss="modal">ปิด</button>
                <button type="button" class="btn btn-primary btn-sm px-4 shadow-sm rounded-pill" id="sellVehicleSaveBtn">
                  <span class="spinner-border spinner-border-sm me-2 d-none" id="sellVehicleSaveSpinner"></span>
                  <span id="sellVehicleSaveBtnText">ยืนยันการขาย</span>
                </button>
            </div>
            <div id="vehicleEditButtons" class="w-100 d-flex justify-content-end gap-2 d-none">
                <button type="button" class="btn btn-secondary btn-sm px-4 rounded-pill" id="cancelEditBtn">ยกเลิก</button>
                <button type="button" class="btn btn-primary btn-sm px-4 shadow-sm rounded-pill" id="saveEditBtn">
                   <span class="spinner-border spinner-border-sm me-2 d-none" id="saveEditSpinner"></span>
                   บันทึกแก้ไข
                </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1090;">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
        <div class="d-flex px-2">
          <div class="toast-body d-flex align-items-center" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="ปิด"></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc,
        query, where, orderBy, limit, startAfter, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // Filters
      const filterStartDate = document.getElementById("filterStartDate");
      const filterEndDate = document.getElementById("filterEndDate");
      const vehicleStatusFilter = document.getElementById("vehicleStatusFilter");
      const searchTextInput = document.getElementById("searchTextInput");
      const searchBtn = document.getElementById("searchBtn");
      const exportCsvBtn = document.getElementById("exportCsvBtn");

      // Views
      const tableViewBtn = document.getElementById("tableViewBtn");
      const cardViewBtn = document.getElementById("cardViewBtn");
      const vehiclesTableView = document.getElementById("vehiclesTableView");
      const vehiclesCardView = document.getElementById("vehiclesCardView");
      const vehiclesTableBody = document.getElementById("vehiclesTableBody");
      const vehiclesCardContainer = document.getElementById("vehiclesCardContainer");
      
      const vehiclesLoadingState = document.getElementById("vehiclesLoadingState");
      const loadMoreVehiclesBtn = document.getElementById("loadMoreVehiclesBtn");
      
      // Stats
      const vehicleInStockCount = document.getElementById("vehicleInStockCount");
      const vehicleSoldCount = document.getElementById("vehicleSoldCount");
      const vehicleTotalProfit = document.getElementById("vehicleTotalProfit");
      const vehiclesCountNumber = document.getElementById("vehiclesCountNumber");

      // Add Form
      const addVehicleForm = document.getElementById("addVehicleForm");
      
      // Modal
      const sellVehicleModalEl = document.getElementById("sellVehicleModal");
      const sellVehicleModal = bootstrap.Modal.getOrCreateInstance(sellVehicleModalEl);
      const vehicleEditBtn = document.getElementById("vehicleEditBtn");
      const vehicleViewMode = document.getElementById("vehicleViewMode");
      const vehicleEditMode = document.getElementById("vehicleEditMode");
      const vehicleViewButtons = document.getElementById("vehicleViewButtons");
      const vehicleEditButtons = document.getElementById("vehicleEditButtons");
      const vehicleDeleteBtn = document.getElementById("vehicleDeleteBtn");
      
      // Modal: View Inputs
      const sellVehiclePlateText = document.getElementById("sellVehiclePlateText");
      const sellVehicleBrandModelText = document.getElementById("sellVehicleBrandModelText");
      const sellVehicleMileageText = document.getElementById("sellVehicleMileageText");
      const sellVehicleBuyDateText = document.getElementById("sellVehicleBuyDateText");
      const sellVehicleBuyPriceText = document.getElementById("sellVehicleBuyPriceText");
      const sellVehicleNoteText = document.getElementById("sellVehicleNoteText");
      
      // Modal: Sell Form
      const sellVehicleFormSection = document.getElementById("sellVehicleFormSection");
      const sellVehicleSoldInfoSection = document.getElementById("sellVehicleSoldInfoSection");
      const sellVehicleDateInput = document.getElementById("sellVehicleDateInput");
      const sellVehiclePriceInput = document.getElementById("sellVehiclePriceInput");
      const sellVehicleProfitPreview = document.getElementById("sellVehicleProfitPreview");
      const sellVehicleSaveBtn = document.getElementById("sellVehicleSaveBtn");
      const sellVehicleSaveSpinner = document.getElementById("sellVehicleSaveSpinner");

      // Modal: Sold Info
      const sellVehicleSoldDateText = document.getElementById("sellVehicleSoldDateText");
      const sellVehicleSoldPriceText = document.getElementById("sellVehicleSoldPriceText");
      const sellVehicleSoldProfitText = document.getElementById("sellVehicleSoldProfitText");

      // Modal: Edit Form
      const vehicleEditForm = document.getElementById("vehicleEditForm");
      const editPlateInput = document.getElementById("editPlateInput");
      const editBrandInput = document.getElementById("editBrandInput");
      const editModelInput = document.getElementById("editModelInput");
      const editMileageInput = document.getElementById("editMileageInput");
      const editBuyPriceInput = document.getElementById("editBuyPriceInput");
      const editNoteInput = document.getElementById("editNoteInput");
      const saveEditBtn = document.getElementById("saveEditBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // --- Variables ---
      let currentUser = null;
      let currentUserProfile = null;
      const PAGE_SIZE = 25;
      let vehiclesLastVisible = null;
      let isLoadingVehicles = false;
      let loadedVehicles = [];
      let currentFilter = { startDate: "", endDate: "", status: "in_stock", searchText: "" };
      let currentSellVehicleId = null;
      let currentSellVehicleData = null;

      // --- Helpers ---
      function showToast(message, variant = "primary") {
         mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0 shadow-lg rounded-pill";
         mainToastBody.innerHTML = message;
         mainToast.show();
      }
      function formatNumber(val) {
         return (typeof val === "number" && !isNaN(val)) ? val.toLocaleString("th-TH", {minimumFractionDigits:2, maximumFractionDigits:2}) : "0.00";
      }
      function formatDateThai(dateStr) {
         if (!dateStr) return "-";
         const [y, m, d] = dateStr.split("-").map(Number);
         if (!y) return dateStr;
         const months = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
         return `${d} ${months[m-1]} ${y+543}`;
      }
      function getTodayISO() {
         return new Date().toISOString().split("T")[0];
      }
      function applyTheme(theme) {
         bodyEl.className = theme === "dark" ? "bm-theme-dark" : "bm-theme-light";
         const icon = themeToggleBtn.querySelector("i");
         icon.className = theme === "dark" ? "bi bi-sun fs-5" : "bi bi-moon fs-5";
      }

      // --- Stats Logic ---
      function calculateStats(vehicles) {
         let inStock = 0, sold = 0, profit = 0;
         vehicles.forEach(v => {
            if(v.status === 'sold') {
               sold++;
               profit += (Number(v.profit) || 0);
            } else {
               inStock++;
            }
         });
         vehicleInStockCount.textContent = inStock.toLocaleString();
         vehicleSoldCount.textContent = sold.toLocaleString();
         vehicleTotalProfit.textContent = formatNumber(profit);
         vehiclesCountNumber.textContent = vehicles.length.toLocaleString();
      }

      // --- Render Logic ---
      function renderVehicles() {
         // Filter by search text on client side for loaded batch
         const kw = (currentFilter.searchText || "").toLowerCase();
         const displayList = loadedVehicles.filter(v => 
            (v.plate||"").toLowerCase().includes(kw) || 
            (v.brand||"").toLowerCase().includes(kw) || 
            (v.model||"").toLowerCase().includes(kw)
         );

         calculateStats(displayList);

         // Render Table
         vehiclesTableBody.innerHTML = "";
         if(displayList.length === 0) {
            vehiclesTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-5 text-muted">ไม่พบข้อมูล</td></tr>`;
         } else {
            displayList.forEach(v => {
               const isSold = v.status === "sold";
               const profitClass = (v.profit || 0) >= 0 ? "text-success" : "text-danger";
               const tr = document.createElement("tr");
               tr.innerHTML = `
                  <td class="ps-3 text-muted small">${formatDateThai(v.buyDate)}</td>
                  <td class="fw-medium">${v.brand} ${v.model}</td>
                  <td><span class="badge bg-light text-dark border fw-normal">${v.plate}</span></td>
                  <td class="text-end text-muted small">${formatNumber(v.buyPrice)}</td>
                  <td class="text-end fw-medium ${isSold?'text-success':''}">${isSold ? formatNumber(v.sellPrice) : '-'}</td>
                  <td class="text-center"><span class="badge rounded-pill ${isSold?'bg-success-subtle text-success':'bg-primary-subtle text-primary'} border border-${isSold?'success':'primary'}-subtle">${isSold?'ขายแล้ว':'พร้อมขาย'}</span></td>
                  <td class="text-end fw-bold ${profitClass}">${isSold ? formatNumber(v.profit) : '-'}</td>
                  <td class="text-center">
                     <button class="btn btn-sm btn-light border text-primary rounded-circle detail-btn" data-id="${v.id}"><i class="bi bi-chevron-right"></i></button>
                  </td>
               `;
               vehiclesTableBody.appendChild(tr);
            });
         }

         // Render Cards (Mobile)
         vehiclesCardContainer.innerHTML = "";
         if(displayList.length === 0) {
             vehiclesCardContainer.innerHTML = `<div class="col-12 text-center text-muted py-5">ไม่พบข้อมูล</div>`;
         } else {
             displayList.forEach(v => {
                const isSold = v.status === "sold";
                const profitClass = (v.profit || 0) >= 0 ? "text-success" : "text-danger";
                const col = document.createElement("div");
                col.className = "col-12 col-md-6 col-lg-4";
                col.innerHTML = `
                   <div class="card h-100 border shadow-sm rounded-4 bm-list-card detail-btn cursor-pointer position-relative overflow-hidden" data-id="${v.id}" style="cursor:pointer">
                      <div class="card-body p-3">
                         <div class="d-flex justify-content-between align-items-start mb-2">
                             <h6 class="fw-bold text-primary mb-0 fs-5">${v.plate}</h6>
                             <span class="badge rounded-pill ${isSold?'bg-success-subtle text-success':'bg-primary-subtle text-primary'}">${isSold?'ขายแล้ว':'พร้อมขาย'}</span>
                         </div>
                         <div class="small text-dark fw-medium mb-1">${v.brand} ${v.model}</div>
                         <div class="d-flex justify-content-between text-muted small mt-2">
                             <span>ซื้อ: ${formatNumber(v.buyPrice)}</span>
                             ${isSold ? `<span class="fw-bold ${profitClass}">กำไร: ${formatNumber(v.profit)}</span>` : ''}
                         </div>
                      </div>
                   </div>
                `;
                vehiclesCardContainer.appendChild(col);
             });
         }
      }

      // --- Data Loading ---
      async function loadVehicles(reset = false) {
         if(isLoadingVehicles) return;
         if(!currentUserProfile) return;

         if(reset) {
            loadedVehicles = [];
            vehiclesLastVisible = null;
            currentFilter.startDate = filterStartDate.value;
            currentFilter.endDate = filterEndDate.value;
            currentFilter.status = vehicleStatusFilter.value;
            currentFilter.searchText = searchTextInput.value;
         }

         isLoadingVehicles = true;
         vehiclesLoadingState.classList.remove("d-none");
         if(reset && loadMoreVehiclesBtn) loadMoreVehiclesBtn.classList.add("d-none");

         try {
            const constraints = [where("isDeleted", "==", false)];
            if(currentUserProfile.branchId) constraints.push(where("branchId", "==", currentUserProfile.branchId));
            
            // Apply Filters (Date & Status)
            if(currentFilter.status !== "all") constraints.push(where("status", "==", currentFilter.status));
            if(currentFilter.startDate) constraints.push(where("buyDate", ">=", currentFilter.startDate));
            if(currentFilter.endDate) constraints.push(where("buyDate", "<=", currentFilter.endDate));

            let q = query(collection(db, "vehicles"), ...constraints, orderBy("buyDate", "desc"), limit(PAGE_SIZE));
            if(!reset && vehiclesLastVisible) {
               q = query(collection(db, "vehicles"), ...constraints, orderBy("buyDate", "desc"), startAfter(vehiclesLastVisible), limit(PAGE_SIZE));
            }

            const snap = await getDocs(q);
            const items = [];
            snap.forEach(d => items.push({ id: d.id, ...d.data() }));

            if(reset) loadedVehicles = items;
            else loadedVehicles = loadedVehicles.concat(items);

            if(!snap.empty) vehiclesLastVisible = snap.docs[snap.docs.length-1];

            if(snap.size === PAGE_SIZE) loadMoreVehiclesBtn.classList.remove("d-none");
            else loadMoreVehiclesBtn.classList.add("d-none");

            renderVehicles();

         } catch(e) {
            console.error(e);
            showToast("โหลดข้อมูลไม่สำเร็จ (อาจต้องสร้าง Index)", "danger");
         } finally {
            isLoadingVehicles = false;
            vehiclesLoadingState.classList.add("d-none");
         }
      }

      // --- Actions ---
      async function handleAddVehicle(e) {
         e.preventDefault();
         const btn = document.getElementById("addVehicleBtn");
         const spinner = document.getElementById("addVehicleSpinner");
         
         const brand = document.getElementById("brandInput").value.trim();
         const model = document.getElementById("modelInput").value.trim();
         const plate = document.getElementById("plateInput").value.trim();
         const buyPrice = parseFloat(document.getElementById("buyPriceInput").value);
         const buyDate = document.getElementById("buyDateInput").value;
         
         if(!brand || !model || !plate || !buyPrice) { showToast("กรุณากรอกข้อมูลให้ครบ", "warning"); return; }

         btn.disabled = true; spinner.classList.remove("d-none");

         try {
            const data = {
               brand, model, plate, buyPrice, buyDate,
               mileage: parseInt(document.getElementById("mileageInput").value)||0,
               note: document.getElementById("noteInput").value.trim(),
               status: "in_stock", isDeleted: false,
               createdAt: serverTimestamp(), createdBy: currentUser.uid,
               branchId: currentUserProfile.branchId
            };

            const ref = await addDoc(collection(db, "vehicles"), data);
            
            // Transaction & Log
            await addDoc(collection(db, "transactions"), {
               date: buyDate, type: "expense", category: "ซื้อรถ", amount: buyPrice,
               description: `ซื้อรถ ${plate}`, sourceType: "vehicle", sourceId: ref.id,
               branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), isDeleted: false
            });
await addDoc(collection(db, "activityLogs"), {
   type: "vehicle_buy", message: `รับซื้อรถ ${plate}`, refId: ref.id, refType: "vehicle",
   branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), 
   createdBy: currentUser.uid,
   createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่ม
});

            showToast("เพิ่มรถสำเร็จ", "success");
            e.target.reset();
            document.getElementById("buyDateInput").value = getTodayISO();
            loadVehicles(true);

         } catch(err) {
            console.error(err);
            showToast("บันทึกไม่สำเร็จ", "danger");
         } finally {
            btn.disabled = false; spinner.classList.add("d-none");
         }
      }

      async function openDetailModal(id) {
         currentSellVehicleId = id;
         currentSellVehicleData = loadedVehicles.find(v => v.id === id);
         if(!currentSellVehicleData) return;
         
         // Set Data to View
         const v = currentSellVehicleData;
         sellVehiclePlateText.textContent = v.plate;
         sellVehicleBrandModelText.textContent = `${v.brand} ${v.model}`;
         sellVehicleMileageText.textContent = (v.mileage || 0).toLocaleString();
         sellVehicleBuyDateText.textContent = formatDateThai(v.buyDate);
         sellVehicleBuyPriceText.textContent = formatNumber(v.buyPrice);
         sellVehicleNoteText.textContent = v.note || "-";

         // Reset Modes
         vehicleViewMode.classList.remove("d-none");
         vehicleViewButtons.classList.remove("d-none");
         vehicleEditMode.classList.add("d-none");
         vehicleEditButtons.classList.add("d-none");

         // Status Logic
         if(v.status === "sold") {
             sellVehicleFormSection.classList.add("d-none");
             sellVehicleSoldInfoSection.classList.remove("d-none");
             sellVehicleSaveBtn.classList.add("d-none");
             
             sellVehicleSoldDateText.textContent = formatDateThai(v.sellDate);
             sellVehicleSoldPriceText.textContent = formatNumber(v.sellPrice);
             sellVehicleSoldProfitText.textContent = formatNumber(v.profit);
         } else {
             sellVehicleFormSection.classList.remove("d-none");
             sellVehicleSoldInfoSection.classList.add("d-none");
             sellVehicleSaveBtn.classList.remove("d-none");
             
             sellVehicleDateInput.value = getTodayISO();
             sellVehiclePriceInput.value = "";
             sellVehicleProfitPreview.innerHTML = `<span class="small text-muted">กำไรโดยประมาณ:</span><span class="fw-bold text-success">0.00 ฿</span>`;
         }

         // Admin Delete Btn
         if(currentUserProfile.role === 'admin') {
             vehicleDeleteBtn.classList.remove("d-none");
         }

         sellVehicleModal.show();
      }

      function enableEditMode() {
         const v = currentSellVehicleData;
         if(!v) return;

         editPlateInput.value = v.plate;
         editBrandInput.value = v.brand;
         editModelInput.value = v.model;
         editMileageInput.value = v.mileage;
         editNoteInput.value = v.note;
         editBuyPriceInput.value = v.buyPrice;

         // Admin check for buy price editing
         editBuyPriceInput.readOnly = (currentUserProfile.role !== 'admin');

         vehicleViewMode.classList.add("d-none");
         vehicleViewButtons.classList.add("d-none");
         vehicleEditMode.classList.remove("d-none");
         vehicleEditButtons.classList.remove("d-none");
      }

      async function saveEdit() {
         const btn = document.getElementById("saveEditBtn");
         const spinner = document.getElementById("saveEditSpinner");
         btn.disabled = true; spinner.classList.remove("d-none");

         try {
             const updates = {
                 plate: editPlateInput.value.trim(),
                 brand: editBrandInput.value.trim(),
                 model: editModelInput.value.trim(),
                 mileage: parseInt(editMileageInput.value)||0,
                 note: editNoteInput.value.trim(),
                 updatedAt: serverTimestamp()
             };
             
             if(currentUserProfile.role === 'admin') {
                 updates.buyPrice = parseFloat(editBuyPriceInput.value) || 0;
                 // Recalculate profit if already sold
                 if(currentSellVehicleData.status === 'sold') {
                     updates.profit = (currentSellVehicleData.sellPrice || 0) - updates.buyPrice;
                 }
             }

             await updateDoc(doc(db, "vehicles", currentSellVehicleId), updates);
             
             // Update Local
             Object.assign(currentSellVehicleData, updates);
             // Re-render modal view
             openDetailModal(currentSellVehicleId); // refresh view
             loadVehicles(true); // refresh list
             showToast("แก้ไขข้อมูลเรียบร้อย", "success");

         } catch(e) {
             console.error(e);
             showToast("แก้ไขไม่สำเร็จ", "danger");
         } finally {
             btn.disabled = false; spinner.classList.add("d-none");
         }
      }

      async function deleteVehicle() {
         if(!confirm("ต้องการลบรถคันนี้ใช่หรือไม่? (Soft Delete)")) return;
         try {
             await updateDoc(doc(db, "vehicles", currentSellVehicleId), {
                 isDeleted: true, updatedAt: serverTimestamp()
             });
await addDoc(collection(db, "activityLogs"), {
    type: "vehicle_delete", message: `ลบรถ ${currentSellVehicleData.plate}`, 
    refId: currentSellVehicleId, refType: "vehicle", branchId: currentUserProfile.branchId,
    createdAt: serverTimestamp(), 
    createdBy: currentUser.uid,
    createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่ม
});
             showToast("ลบข้อมูลเรียบร้อย", "success");
             sellVehicleModal.hide();
             loadVehicles(true);
         } catch(e) {
             showToast("ลบไม่สำเร็จ", "danger");
         }
      }

      async function sellVehicle() {
         const sellPrice = parseFloat(sellVehiclePriceInput.value);
         const sellDate = sellVehicleDateInput.value;
         if(!sellPrice || !sellDate) { showToast("กรุณาระบุราคาและวันที่", "warning"); return; }
         
         sellVehicleSaveBtn.disabled = true; sellVehicleSaveSpinner.classList.remove("d-none");
         
         try {
             const profit = sellPrice - (currentSellVehicleData.buyPrice || 0);
             await updateDoc(doc(db, "vehicles", currentSellVehicleId), {
                 status: "sold", sellPrice, sellDate, profit, updatedAt: serverTimestamp()
             });
             
             await addDoc(collection(db, "transactions"), {
                 date: sellDate, type: "income", category: "ขายรถ", amount: sellPrice,
                 description: `ขายรถ ${currentSellVehicleData.plate}`, sourceType: "vehicle", sourceId: currentSellVehicleId,
                 branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), isDeleted: false
             });
             
await addDoc(collection(db, "activityLogs"), {
    type: "vehicle_sell", message: `ขายรถ ${currentSellVehicleData.plate}`, refId: currentSellVehicleId, refType: "vehicle",
    branchId: currentUserProfile.branchId, createdAt: serverTimestamp(), 
    createdBy: currentUser.uid,
    createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่ม
});

             showToast("บันทึกการขายสำเร็จ", "success");
             sellVehicleModal.hide();
             loadVehicles(true);
         } catch(e) {
             console.error(e);
             showToast("บันทึกไม่สำเร็จ", "danger");
         } finally {
             sellVehicleSaveBtn.disabled = false; sellVehicleSaveSpinner.classList.add("d-none");
         }
      }

      function exportToCSV() {
         if(!loadedVehicles.length) { showToast("ไม่มีข้อมูลให้ส่งออก", "warning"); return; }
         let csv = "\uFEFFวันที่ซื้อ,ยี่ห้อ/รุ่น,ทะเบียน,ราคาซื้อ,ราคาขาย,กำไร,สถานะ\n";
         loadedVehicles.forEach(v => {
             csv += `${v.buyDate},"${v.brand} ${v.model}","${v.plate}",${v.buyPrice},${v.sellPrice||0},${v.profit||0},${v.status}\n`;
         });
         const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
         const link = document.createElement("a");
         link.href = URL.createObjectURL(blob);
         link.download = `vehicles_export_${getTodayISO()}.csv`;
         link.click();
      }

      // --- Setup ---
      function setupEvents() {
         // View Toggles
         tableViewBtn.onclick = () => {
             tableViewBtn.classList.add("active","text-primary","fw-bold"); tableViewBtn.classList.remove("text-secondary");
             cardViewBtn.classList.remove("active","text-primary","fw-bold"); cardViewBtn.classList.add("text-secondary");
             vehiclesTableView.classList.remove("d-none"); vehiclesCardView.classList.add("d-none");
         };
         cardViewBtn.onclick = () => {
             cardViewBtn.classList.add("active","text-primary","fw-bold"); cardViewBtn.classList.remove("text-secondary");
             tableViewBtn.classList.remove("active","text-primary","fw-bold"); tableViewBtn.classList.add("text-secondary");
             vehiclesCardView.classList.remove("d-none"); vehiclesTableView.classList.add("d-none");
         };

         // Listeners
         searchBtn.onclick = () => loadVehicles(true);
         loadMoreVehiclesBtn.onclick = () => loadVehicles(false);
         addVehicleForm.onsubmit = handleAddVehicle;
         exportCsvBtn.onclick = exportToCSV;
         
         // Filters
         vehicleStatusFilter.onchange = () => loadVehicles(true);
         filterStartDate.onchange = () => loadVehicles(true);
         filterEndDate.onchange = () => loadVehicles(true);
         searchTextInput.addEventListener("keyup", (e) => {
             if(e.key === 'Enter') loadVehicles(true);
         });

         // Modal delegation
         const handleDetailClick = (e) => {
             const btn = e.target.closest(".detail-btn");
             if(btn) openDetailModal(btn.dataset.id);
         };
         vehiclesTableBody.onclick = handleDetailClick;
         vehiclesCardContainer.onclick = handleDetailClick;

         // Modal Actions
         vehicleEditBtn.onclick = enableEditMode;
         cancelEditBtn.onclick = () => openDetailModal(currentSellVehicleId); // Reset to view
         saveEditBtn.onclick = saveEdit;
         vehicleDeleteBtn.onclick = deleteVehicle;
         sellVehicleSaveBtn.onclick = sellVehicle;
         
         // Profit Calc Preview
         sellVehiclePriceInput.addEventListener("input", () => {
             const price = parseFloat(sellVehiclePriceInput.value) || 0;
             const buy = currentSellVehicleData ? currentSellVehicleData.buyPrice : 0;
             const p = price - buy;
             sellVehicleProfitPreview.innerHTML = `<span class="small text-muted">กำไรโดยประมาณ:</span><span class="fw-bold ${p>=0?'text-success':'text-danger'}">${formatNumber(p)} ฿</span>`;
         });

         // Nav
         logoutBtn.onclick = () => signOut(auth).then(() => window.location.href="index.html");
         if(themeToggleBtn) themeToggleBtn.onclick = () => {
             const t = bodyEl.classList.contains("bm-theme-dark") ? "light" : "dark";
             applyTheme(t);
             localStorage.setItem("bm-theme-" + currentUser.uid, t);
         };
         
         // FAB
         fabOpenBillBtn.onclick = () => window.location.href="open-bill.html";
         fabAddTxnBtn.onclick = () => window.location.href="finance.html";
         fabStockInBtn.onclick = () => window.location.href="stock.html";
         fabAddVehicleBtn.onclick = () => {
             document.getElementById("addVehicleForm").scrollIntoView({behavior:"smooth"});
             document.getElementById("collapseAddVehicle").classList.add("show");
         };
      }

      // --- Main Execution ---
      onAuthStateChanged(auth, async (user) => {
         if(!user) { window.location.href = "index.html"; return; }
         currentUser = user;
         
         const userRef = doc(db, "users", user.uid);
         const snap = await getDoc(userRef);
         if(snap.exists()) currentUserProfile = { id: snap.id, ...snap.data() };
         else currentUserProfile = { role: 'staff', branchId: null, theme: 'light' }; // fallback

         if(currentUserProfile.disabled) { signOut(auth); return; }

         // UI Init
         userDisplayNameText.textContent = currentUserProfile.displayName || user.email;
         userRoleText.textContent = currentUserProfile.role === 'admin' ? "Admin" : "Staff";
         userAvatarInitial.textContent = (currentUserProfile.displayName||"U")[0].toUpperCase();
         if(settingsMenuItem) settingsMenuItem.classList.toggle("d-none", currentUserProfile.role !== 'admin');
         
         applyTheme(localStorage.getItem("bm-theme-"+user.uid) || currentUserProfile.theme);
         
         document.getElementById("buyDateInput").value = getTodayISO();
         
         setupEvents();
         loadVehicles(true);
      });
    </script>
  </body>
</html>