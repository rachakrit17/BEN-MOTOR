<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – แดชบอร์ดภาพรวม</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">

    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content pb-5">
      <div class="container py-4">
        
        <div class="d-flex justify-content-between align-items-end mb-4 mt-2">
          <div>
            <h1 class="h4 mb-1 fw-bold text-dark">แดชบอร์ดภาพรวม</h1>
            <p class="small text-muted mb-0">
              สรุปสถานะการเงิน งานซ่อม และสต๊อกประจำวัน
            </p>
          </div>
          <div class="text-end">
            <span class="badge bg-white text-dark border shadow-sm px-3 py-2 rounded-pill fw-normal" id="dashboardTodayLabel">
              <i class="bi bi-calendar-event me-1 text-primary"></i> วันนี้
            </span>
          </div>
        </div>

        <section class="mb-4">
          <div class="row g-3">
            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-between">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="bm-stat-label">เงินคงเหลือ</span>
                    <div class="bg-primary bg-opacity-10 p-2 rounded-circle">
                       <i class="bi bi-wallet2 text-primary fs-5"></i>
                    </div>
                  </div>
                  <div>
                    <p class="bm-stat-value mb-0 text-dark" id="statTotalBalance">-</p>
                    <p class="bm-stat-sub text-muted mb-0 text-truncate" id="statTotalBalanceNote">
                      กำลังโหลด...
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-between">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="bm-stat-label">รายได้วันนี้</span>
                    <div class="bg-success bg-opacity-10 p-2 rounded-circle">
                      <i class="bi bi-graph-up-arrow text-success fs-5"></i>
                    </div>
                  </div>
                  <div>
                    <p class="bm-stat-value mb-0 text-success" id="statIncomeToday">-</p>
                    <p class="bm-stat-sub text-muted mb-0 text-truncate" id="statIncomeTodayNote">
                      กำลังโหลด...
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-between">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="bm-stat-label">รายจ่ายวันนี้</span>
                    <div class="bg-danger bg-opacity-10 p-2 rounded-circle">
                      <i class="bi bi-cart-dash text-danger fs-5"></i>
                    </div>
                  </div>
                  <div>
                    <p class="bm-stat-value mb-0 text-danger" id="statExpenseToday">-</p>
                    <p class="bm-stat-sub text-muted mb-0 text-truncate" id="statExpenseTodayNote">
                      กำลังโหลด...
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-between">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="bm-stat-label">กำไรวันนี้</span>
                    <div class="bg-warning bg-opacity-10 p-2 rounded-circle">
                       <i class="bi bi-coin text-warning fs-5"></i>
                    </div>
                  </div>
                  <div>
                    <p class="bm-stat-value mb-0" id="statProfitToday">-</p>
                    <p class="bm-stat-sub text-muted mb-0 text-truncate" id="statProfitTodayNote">
                      กำลังโหลด...
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-4">
          <div class="row g-2 g-md-3">
            <div class="col-6 col-md-4 col-lg-2">
              <div class="card h-100 border shadow-sm rounded-4">
                <div class="card-body p-3 text-center">
                  <div class="small text-muted mb-1">งานซ่อมวันนี้</div>
                  <h3 class="fw-bold text-dark mb-0" id="statJobsToday">-</h3>
                  <span class="badge bg-primary-subtle text-primary rounded-pill mt-1 px-2">งาน</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="card h-100 border shadow-sm rounded-4">
                <div class="card-body p-3 text-center">
                  <div class="small text-muted mb-1">รถค้างในอู่</div>
                  <h3 class="fw-bold text-dark mb-0" id="statJobsInGarage">-</h3>
                  <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill mt-1 px-2">คัน</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="card h-100 border shadow-sm rounded-4">
                <div class="card-body p-3 text-center">
                  <div class="small text-muted mb-1">รับซื้อรถ</div>
                  <h3 class="fw-bold text-dark mb-0" id="statVehiclesBoughtToday">-</h3>
                  <span class="badge bg-info-subtle text-info-emphasis rounded-pill mt-1 px-2">คัน</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="card h-100 border shadow-sm rounded-4">
                <div class="card-body p-3 text-center">
                  <div class="small text-muted mb-1">ขายรถออก</div>
                  <h3 class="fw-bold text-dark mb-0" id="statVehiclesSoldToday">-</h3>
                  <span class="badge bg-success-subtle text-success rounded-pill mt-1 px-2">คัน</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="card h-100 border shadow-sm rounded-4">
                <div class="card-body p-3 text-center">
                  <div class="small text-muted mb-1">ซื้ออะไหล่เข้า</div>
                  <h3 class="fw-bold text-dark mb-0" id="statStockInToday">-</h3>
                  <span class="badge bg-secondary-subtle text-secondary rounded-pill mt-1 px-2">รายการ</span>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2 d-none d-lg-block">
               </div>
          </div>
        </section>

        <section class="mb-5">
          <div class="row g-4">
            
            <div class="col-12 col-lg-7">
              <div class="card h-100 shadow-sm border-0 rounded-4">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 pb-0">
                  <h2 class="h6 mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-bar-chart-line me-2 text-primary"></i> กราฟรายรับ/รายจ่าย (7 วัน)
                  </h2>
                  <span class="badge bg-light text-secondary border fw-normal" id="chartDateRangeLabel">
                    -
                  </span>
                </div>
                <div class="card-body pt-2">
                  <div class="position-relative w-100" style="min-height: 240px;">
                    <canvas id="incomeExpenseChart" class="w-100" height="240"></canvas>
                    <div id="chartEmptyState" class="text-center text-muted small position-absolute top-50 start-50 translate-middle">
                      <i class="bi bi-inbox fs-4 d-block mb-1"></i>
                      ไม่มีข้อมูลสำหรับแสดงกราฟ
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-5">
              <div class="d-flex flex-column gap-3 h-100">
                
                <div class="card shadow-sm border-0 rounded-4 flex-fill">
                  <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 pb-2">
                    <h2 class="h6 mb-0 fw-bold text-danger">
                      <i class="bi bi-exclamation-triangle me-2"></i> สต๊อกใกล้หมด
                    </h2>
                    <a href="stock.html" class="btn btn-sm btn-light rounded-pill px-3 py-0 small text-muted">
                      ดูทั้งหมด
                    </a>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small text-uppercase">
                          <tr>
                            <th class="ps-3 fw-normal">รหัส</th>
                            <th class="fw-normal">ชื่ออะไหล่</th>
                            <th class="text-end fw-normal">คงเหลือ</th>
                            <th class="text-end pe-3 fw-normal">ขั้นต่ำ</th>
                          </tr>
                        </thead>
                        <tbody id="lowStockTbody" class="border-top-0">
                          <tr>
                            <td colspan="4" class="text-center small text-muted py-3">
                              กำลังโหลด...
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="card shadow-sm border-0 rounded-4 flex-fill">
                  <div class="card-header bg-transparent border-0 pt-3 pb-2">
                    <h2 class="h6 mb-0 fw-bold text-dark">
                      <i class="bi bi-activity me-2 text-info"></i> ความเคลื่อนไหวล่าสุด
                    </h2>
                  </div>
                  <div class="card-body p-0">
                    <ul class="list-group list-group-flush rounded-bottom-4" id="activityLogsList">
                      <li class="list-group-item small text-muted text-center py-3">
                        กำลังโหลด...
                      </li>
                    </ul>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </section>

        <div style="height: 3rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">
        <button
          class="btn btn-primary rounded-circle shadow-lg bm-fab-btn"
          type="button"
          id="fabDropdownButton"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="bi bi-plus-lg"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow rounded-4 border-0 p-2" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabOpenBillBtn">
              <span class="bg-primary bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-receipt-cutoff text-primary"></i></span>
              เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddTxnBtn">
              <span class="bg-success bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-cash-coin text-success"></i></span>
              เพิ่มรายการเงิน
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabStockInBtn">
              <span class="bg-warning bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-box-seam text-warning"></i></span>
              บันทึกซื้ออะไหล่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddVehicleBtn">
              <span class="bg-info bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-truck-front text-info"></i></span>
              เพิ่มรถรับซื้อเข้า
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link active">
              <i class="bi bi-speedometer2 d-block fs-5"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block fs-5"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block fs-5"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block fs-5"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block fs-5"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block fs-5"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1080;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex px-2">
          <div class="toast-body" id="mainToastBody">
            </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="ปิด"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      // ============================================================
      // นำเข้า Firebase SDK
      // ============================================================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        query,
        where,
        orderBy,
        limit,
        startAfter,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ============================================================
      // ตั้งค่า Firebase
      // ============================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ============================================================
      // ตัวแปรอ้างอิง DOM
      // ============================================================
      // Topbar
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarCircle = document.getElementById("userAvatarCircle");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // FAB ปุ่มด่วน
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // ตัวเลขสรุปการเงิน
      const statTotalBalance = document.getElementById("statTotalBalance");
      const statTotalBalanceNote = document.getElementById("statTotalBalanceNote");
      const statIncomeToday = document.getElementById("statIncomeToday");
      const statIncomeTodayNote = document.getElementById("statIncomeTodayNote");
      const statExpenseToday = document.getElementById("statExpenseToday");
      const statExpenseTodayNote = document.getElementById("statExpenseTodayNote");
      const statProfitToday = document.getElementById("statProfitToday");
      const statProfitTodayNote = document.getElementById("statProfitTodayNote");

      // ตัวเลขสรุปย่อย
      const statJobsToday = document.getElementById("statJobsToday");
      const statJobsInGarage = document.getElementById("statJobsInGarage");
      const statVehiclesBoughtToday = document.getElementById("statVehiclesBoughtToday");
      const statVehiclesSoldToday = document.getElementById("statVehiclesSoldToday");
      const statStockInToday = document.getElementById("statStockInToday");
      const dashboardTodayLabel = document.getElementById("dashboardTodayLabel");

      // ตารางสต๊อกใกล้หมด
      const lowStockTbody = document.getElementById("lowStockTbody");

      // ความเคลื่อนไหวล่าสุด
      const activityLogsList = document.getElementById("activityLogsList");

      // กราฟ
      const incomeExpenseChartCanvas = document.getElementById("incomeExpenseChart");
      const chartEmptyState = document.getElementById("chartEmptyState");
      const chartDateRangeLabel = document.getElementById("chartDateRangeLabel");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // ============================================================
      // ฟังก์ชันช่วย
      // ============================================================
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className =
          "toast align-items-center text-bg-" + variant + " border-0 shadow-lg rounded-pill";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      function formatNumber(value) {
        if (typeof value !== "number" || isNaN(value)) return "0";
        return value.toLocaleString("th-TH", {
          maximumFractionDigits: 2,
        });
      }

      function formatDateThaiFromString(dateStr) {
        if (!dateStr) return "-";
        const [year, month, day] = dateStr.split("-").map((v) => parseInt(v, 10));
        if (!year || !month || !day) return dateStr;
        const d = new Date(year, month - 1, day);
        const thaiMonths = [
          "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
          "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค.",
        ];
        const thaiYear = d.getFullYear() + 543;
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${thaiYear}`;
      }

      function getTodayISODateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function getPastISODateString(daysAgo) {
        const now = new Date();
        now.setDate(now.getDate() - daysAgo);
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function getLastNDates(n) {
        const dates = [];
        for (let i = n - 1; i >= 0; i--) {
          dates.push(getPastISODateString(i));
        }
        return dates;
      }

      // ============================================================
      // ธีม
      // ============================================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);

        const icon = themeToggleBtn.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-sun", normalized === "dark");
          icon.classList.toggle("bi-moon", normalized === "light");
        }
      }

      function saveThemeForUser(uid, theme) {
        if (!uid) return;
        try {
          localStorage.setItem("bm-theme-" + uid, theme);
        } catch (e) {
          console.warn("ไม่สามารถบันทึกธีมใน localStorage ได้", e);
        }
      }

      function readThemeForUser(uid, fallbackTheme) {
        if (!uid) return fallbackTheme || "light";
        try {
          const stored = localStorage.getItem("bm-theme-" + uid);
          return stored || fallbackTheme || "light";
        } catch (e) {
          return fallbackTheme || "light";
        }
      }

      // ============================================================
      // User Logic
      // ============================================================
      async function ensureUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          return { id: snap.id, ...snap.data() };
        }
        const usersCol = collection(db, "users");
        const q = query(usersCol, limit(1));
        const existingSnap = await getDocs(q);
        const isFirstUser = existingSnap.empty;
        const role = isFirstUser ? "admin" : "staff";
        const defaultDisplayName =
          user.displayName || (user.email ? user.email.split("@")[0] : "ผู้ใช้ใหม่");
        const newUserData = {
          displayName: defaultDisplayName,
          role,
          createdAt: serverTimestamp(),
          branchId: null,
          theme: "light",
          disabled: false,
        };
        await setDoc(userRef, newUserData);
        return { id: user.uid, ...newUserData };
      }

      // ============================================================
      // กราฟ (Canvas 2D)
      // ============================================================
      function drawIncomeExpenseChart(canvas, dataPoints, labels) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        const width = canvas.width;
        const height = canvas.height;
        ctx.clearRect(0, 0, width, height);

        const incomeValues = dataPoints.map((p) => p.income);
        const expenseValues = dataPoints.map((p) => p.expense);
        const allValues = incomeValues.concat(expenseValues);
        const maxValue = Math.max(...allValues, 0);
        const padding = 30;

        if (maxValue === 0) return;

        const chartHeight = height - padding * 2;
        const chartWidth = width - padding * 2;
        const stepX = chartWidth / Math.max(labels.length - 1, 1);
        const valueToY = (val) => padding + chartHeight - (val / maxValue) * chartHeight;

        ctx.lineWidth = 1;
        ctx.strokeStyle = "#e5e7eb"; // สีเส้นตารางจางๆ
        ctx.fillStyle = "#6b7280";
        ctx.font = "10px Kanit, sans-serif";

        labels.forEach((dateStr, index) => {
          const x = padding + index * stepX;
          ctx.beginPath();
          ctx.moveTo(x, padding);
          ctx.lineTo(x, padding + chartHeight);
          ctx.stroke();

          const [year, month, day] = dateStr.split("-");
          const label = `${Number(day)}/${Number(month)}`;
          ctx.save();
          ctx.translate(x, padding + chartHeight + 15);
          ctx.fillText(label, -8, 0); // จัดกึ่งกลาง label
          ctx.restore();
        });

        // Income Line
        ctx.beginPath();
        dataPoints.forEach((point, index) => {
          const x = padding + index * stepX;
          const y = valueToY(point.income);
          if (index === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.strokeStyle = "#22c55e"; // --bm-primary
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.fillStyle = "#ffffff";
        dataPoints.forEach((point, index) => {
          const x = padding + index * stepX;
          const y = valueToY(point.income);
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = "#22c55e";
          ctx.stroke();
        });

        // Expense Line
        ctx.beginPath();
        dataPoints.forEach((point, index) => {
          const x = padding + index * stepX;
          const y = valueToY(point.expense);
          if (index === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.strokeStyle = "#ef4444"; // --bm-danger
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.fillStyle = "#ffffff";
        dataPoints.forEach((point, index) => {
          const x = padding + index * stepX;
          const y = valueToY(point.expense);
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = "#ef4444";
          ctx.stroke();
        });

        // Legend
        ctx.font = "11px Kanit, sans-serif";
        
        ctx.fillStyle = "#22c55e";
        ctx.fillRect(padding, 10, 10, 4);
        ctx.fillStyle = "#374151";
        ctx.fillText("รายรับ", padding + 15, 16);

        ctx.fillStyle = "#ef4444";
        ctx.fillRect(padding + 60, 10, 10, 4);
        ctx.fillStyle = "#374151";
        ctx.fillText("รายจ่าย", padding + 75, 16);
      }

      // ============================================================
      // โหลดข้อมูล Dashboard
      // ============================================================
      async function loadDashboardData(currentUser, userProfile) {
        const branchId = userProfile.branchId || null;
        const today = getTodayISODateString();
        const last7Dates = getLastNDates(7);
        const startDateFor7Days = last7Dates[0];

        if (dashboardTodayLabel) {
           // ใส่ icon ลงใน label ผ่าน innerHTML
           const icon = `<i class="bi bi-calendar-event me-1 text-primary"></i>`;
           dashboardTodayLabel.innerHTML = icon + " " + formatDateThaiFromString(today);
        }

        // 1) ยอดเงินคงเหลือ
        try {
          const constraintsAll = [];
          if (branchId) constraintsAll.push(where("branchId", "==", branchId));
          const txnQueryAll = query(collection(db, "transactions"), ...constraintsAll);
          const txnSnapAll = await getDocs(txnQueryAll);

          let totalIncome = 0;
          let totalExpense = 0;

          txnSnapAll.forEach((docSnap) => {
            const data = docSnap.data();
            const amount = Number(data.amount) || 0;
            if (data.type === "income") totalIncome += amount;
            if (data.type === "expense") totalExpense += amount;
          });

          const balance = totalIncome - totalExpense;

          if (statTotalBalance) statTotalBalance.textContent = formatNumber(balance) + " ฿";
          if (statTotalBalanceNote) {
            statTotalBalanceNote.textContent =
              "รับ " + formatNumber(totalIncome) + " / จ่าย " + formatNumber(totalExpense);
          }
        } catch (error) {
          console.error("Error loading balance:", error);
          if (statTotalBalanceNote) statTotalBalanceNote.textContent = "โหลดไม่ได้";
        }

        // 2) ธุรกรรมวันนี้ & กราฟ 7 วัน
        let incomeToday = 0;
        let expenseToday = 0;
        const dailySummary = {};
        last7Dates.forEach((d) => dailySummary[d] = { income: 0, expense: 0 });

        try {
          const constraints7Days = [
            where("date", ">=", startDateFor7Days),
            where("date", "<=", today),
          ];
          if (branchId) constraints7Days.push(where("branchId", "==", branchId));

          const txnQuery7Days = query(
            collection(db, "transactions"),
            ...constraints7Days,
            orderBy("date", "asc")
          );

          const txnSnap7Days = await getDocs(txnQuery7Days);
          let stockInTodayCount = 0;

          txnSnap7Days.forEach((docSnap) => {
            const data = docSnap.data();
            const dateStr = data.date;
            const amount = Number(data.amount) || 0;
            const type = data.type;

            if (dateStr === today) {
              if (type === "income") incomeToday += amount;
              if (type === "expense") expenseToday += amount;
              if (type === "expense" && data.category === "ซื้ออะไหล่") stockInTodayCount++;
            }

            if (dailySummary[dateStr]) {
              if (type === "income") dailySummary[dateStr].income += amount;
              else if (type === "expense") dailySummary[dateStr].expense += amount;
            }
          });

          const profitToday = incomeToday - expenseToday;

          if (statIncomeToday) statIncomeToday.textContent = formatNumber(incomeToday) + " ฿";
          if (statIncomeTodayNote) statIncomeTodayNote.textContent = incomeToday > 0 ? "ยอดรับวันนี้" : "ไม่มี";

          if (statExpenseToday) statExpenseToday.textContent = formatNumber(expenseToday) + " ฿";
          if (statExpenseTodayNote) statExpenseTodayNote.textContent = expenseToday > 0 ? "ยอดจ่ายวันนี้" : "ไม่มี";

          if (statProfitToday) {
            statProfitToday.textContent = formatNumber(profitToday) + " ฿";
            statProfitToday.classList.toggle("text-success", profitToday >= 0);
            statProfitToday.classList.toggle("text-danger", profitToday < 0);
          }
          if (statProfitTodayNote) statProfitTodayNote.textContent = "กำไรสุทธิวันนี้";

          if (statStockInToday) statStockInToday.textContent = String(stockInTodayCount);

          // Plot Graph
          const dataPoints = last7Dates.map((d) => ({
            date: d,
            income: dailySummary[d].income,
            expense: dailySummary[d].expense,
          }));
          const anyDataForChart = dataPoints.some((p) => p.income > 0 || p.expense > 0);

          if (chartDateRangeLabel) {
            chartDateRangeLabel.textContent =
              formatDateThaiFromString(startDateFor7Days) + " - " + formatDateThaiFromString(today);
          }

          if (anyDataForChart) {
            if (chartEmptyState) chartEmptyState.classList.add("d-none");
            if (incomeExpenseChartCanvas) {
              const rect = incomeExpenseChartCanvas.parentNode.getBoundingClientRect();
              incomeExpenseChartCanvas.width = rect.width;
              incomeExpenseChartCanvas.height = 240; 
            }
            drawIncomeExpenseChart(incomeExpenseChartCanvas, dataPoints, last7Dates);
          } else {
            if (chartEmptyState) chartEmptyState.classList.remove("d-none");
          }
        } catch (error) {
          console.error("Error loading 7 days:", error);
        }

        // 3) Jobs (งานซ่อม)
        try {
          const jobsCol = collection(db, "jobs");
          const constraintsJobsToday = [where("isDeleted", "==", false), where("date", "==", today)];
          const constraintsJobsInGarage = [where("isDeleted", "==", false), where("status", "!=", "picked_up")];

          if (branchId) {
            constraintsJobsToday.push(where("branchId", "==", branchId));
            constraintsJobsInGarage.push(where("branchId", "==", branchId));
          }

          const jobsTodayQuery = query(jobsCol, ...constraintsJobsToday);
          const jobsTodaySnap = await getDocs(jobsTodayQuery);
          if (statJobsToday) statJobsToday.textContent = String(jobsTodaySnap.size);

          const jobsInGarageQuery = query(jobsCol, ...constraintsJobsInGarage);
          const jobsInGarageSnap = await getDocs(jobsInGarageQuery);
          if (statJobsInGarage) statJobsInGarage.textContent = String(jobsInGarageSnap.size);
        } catch (error) {
          console.error("Error loading jobs:", error);
        }

        // 4) Vehicles
        try {
          const vehiclesCol = collection(db, "vehicles");
          const constraintsBuyToday = [where("buyDate", "==", today)];
          const constraintsSellToday = [where("sellDate", "==", today)];
          if (branchId) {
            constraintsBuyToday.push(where("branchId", "==", branchId));
            constraintsSellToday.push(where("branchId", "==", branchId));
          }

          const [buySnap, sellSnap] = await Promise.all([
            getDocs(query(vehiclesCol, ...constraintsBuyToday)),
            getDocs(query(vehiclesCol, ...constraintsSellToday)),
          ]);

          if (statVehiclesBoughtToday) statVehiclesBoughtToday.textContent = String(buySnap.size);
          if (statVehiclesSoldToday) statVehiclesSoldToday.textContent = String(sellSnap.size);
        } catch (error) {
          console.error("Error loading vehicles:", error);
        }

        // 5) Stock Low
        try {
          const stockCol = collection(db, "stock");
          const constraintsStock = [where("isDeleted", "==", false)];
          if (branchId) constraintsStock.push(where("branchId", "==", branchId));
          const stockQuery = query(stockCol, ...constraintsStock, orderBy("name"), limit(20));
          const stockSnap = await getDocs(stockQuery);

          if (lowStockTbody) lowStockTbody.innerHTML = "";
          let lowCount = 0;

          stockSnap.forEach((docSnap) => {
            const data = docSnap.data();
            const qty = Number(data.qty) || 0;
            const minQty = Number(data.minQty) || 0;

            if (qty <= minQty) {
              lowCount++;
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class="ps-3 small text-muted font-monospace">${data.code || "-"}</td>
                <td class="small fw-semibold text-dark">${data.name || "-"}</td>
                <td class="small text-end">
                  <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-2">
                    ${formatNumber(qty)}
                  </span>
                </td>
                <td class="small text-end pe-3 text-muted">${formatNumber(minQty)}</td>
              `;
              lowStockTbody.appendChild(tr);
            }
          });

          if (lowCount === 0 && lowStockTbody) {
            lowStockTbody.innerHTML = `
              <tr>
                <td colspan="4" class="text-center small text-muted py-4">
                  <i class="bi bi-check-circle text-success fs-5 d-block mb-1"></i>
                  สต๊อกปกติ ไม่มีรายการใกล้หมด
                </td>
              </tr>`;
          }
        } catch (error) {
          console.error("Error loading stock:", error);
          if(lowStockTbody) lowStockTbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger small">โหลดข้อมูลไม่ได้</td></tr>`;
        }

        // 6) Activity Logs
        try {
          const logsCol = collection(db, "activityLogs");
          const constraintsLogs = [];
          if (branchId) constraintsLogs.push(where("branchId", "==", branchId));
          const logsQuery = query(logsCol, ...constraintsLogs, orderBy("createdAt", "desc"), limit(10));
          const logsSnap = await getDocs(logsQuery);

          if (activityLogsList) activityLogsList.innerHTML = "";

          if (logsSnap.empty) {
            if (activityLogsList) activityLogsList.innerHTML = `<li class="list-group-item text-center small text-muted py-3">ยังไม่มีความเคลื่อนไหว</li>`;
          } else {
            logsSnap.forEach((docSnap) => {
              const data = docSnap.data();
              const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : null;
              let timePart = "-";
              if (createdAt) {
                timePart = `${String(createdAt.getHours()).padStart(2,"0")}:${String(createdAt.getMinutes()).padStart(2,"0")}`;
              }
              const msg = data.message || "-";
              const byName = data.createdByName || "ระบบ";

              const li = document.createElement("li");
              li.className = "list-group-item small d-flex align-items-start py-3";
              // สร้างจุด timeline
              li.innerHTML = `
                <div class="me-3 mt-1">
                  <div class="rounded-circle bg-primary bg-opacity-25" style="width:8px; height:8px;"></div>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="text-dark fw-medium">${msg}</span>
                    <span class="text-xs text-muted ms-2 bg-light border px-1 rounded">${timePart}</span>
                  </div>
                  <div class="text-xs text-muted">
                    <i class="bi bi-person me-1"></i>${byName}
                  </div>
                </div>
              `;
              activityLogsList.appendChild(li);
            });
          }
        } catch (error) {
          console.error("Error loading logs:", error);
        }
      }

      // ============================================================
      // Logout
      // ============================================================
      async function handleLogout() {
        try {
          await signOut(auth);
          showToast("ออกจากระบบแล้ว", "success");
          window.location.href = "index.html";
        } catch (error) {
          console.error("Logout error:", error);
        }
      }

      // ============================================================
      // Events
      // ============================================================
      function setupEventListeners(currentUser, userProfile) {
        if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
        
        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", async () => {
            const currentTheme = bodyEl.classList.contains("bm-theme-dark") ? "dark" : "light";
            const nextTheme = currentTheme === "dark" ? "light" : "dark";
            applyTheme(nextTheme);
            saveThemeForUser(currentUser.uid, nextTheme);
            try {
              await updateDoc(doc(db, "users", currentUser.uid), { theme: nextTheme });
            } catch (e) { console.error(e); }
          });
        }

        if (fabOpenBillBtn) fabOpenBillBtn.addEventListener("click", () => window.location.href = "open-bill.html");
        if (fabAddTxnBtn) fabAddTxnBtn.addEventListener("click", () => window.location.href = "finance.html");
        if (fabStockInBtn) fabStockInBtn.addEventListener("click", () => window.location.href = "stock.html");
        if (fabAddVehicleBtn) fabAddVehicleBtn.addEventListener("click", () => window.location.href = "vehicles.html");
      }

      // ============================================================
      // Auth Guard
      // ============================================================
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        try {
          const userProfile = await ensureUserProfile(user);
          if (userProfile.disabled) {
            await signOut(auth);
            window.location.href = "index.html";
            return;
          }

          if (userDisplayNameText) userDisplayNameText.textContent = userProfile.displayName || "-";
          // สำหรับ Mobile
          const mobName = document.getElementById("userDisplayNameTextMobile");
          if (mobName) mobName.textContent = userProfile.displayName || "ผู้ใช้งาน";

          if (userRoleText) {
            userRoleText.textContent = userProfile.role === "admin" ? "Admin" : "Staff";
          }
          if (userAvatarInitial) {
            const dn = userProfile.displayName || "U";
            userAvatarInitial.textContent = dn.trim().charAt(0).toUpperCase();
          }
          if (settingsMenuItem) {
            if (userProfile.role === "admin") settingsMenuItem.classList.remove("d-none");
            else settingsMenuItem.classList.add("d-none");
          }

          const themeToUse = readThemeForUser(user.uid, userProfile.theme || "light");
          applyTheme(themeToUse);

          setupEventListeners(user, userProfile);
          await loadDashboardData(user, userProfile);
        } catch (error) {
          console.error("Init Error:", error);
          showToast("โหลดข้อมูลผิดพลาด", "danger");
        }
      });
    </script>
  </body>
</html>