<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR ‚Äì ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
    <link rel="manifest" href="img/site.webmanifest" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ò‡∏µ‡∏°"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ &amp; ‡∏£‡∏ñ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content pb-5">
      <div class="container py-4">
        
        <div class="row align-items-center mb-4 mt-2 g-3">
          <div class="col-12 col-md-6">
            <h1 class="h4 mb-1 fw-bold text-dark">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="welcomeUserName" class="text-primary">...</span> üëã</h1>
            <p class="small text-muted mb-0">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="currentDateLabel" class="fw-medium text-dark">-</span></p>
          </div>
          <div class="col-12 col-md-6">
            <div class="d-flex gap-2 justify-content-md-end">
               <a href="open-bill.html" class="btn btn-primary rounded-pill px-4 shadow-sm btn-sm"><i class="bi bi-plus-lg me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</a>
               <a href="finance.html" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm btn-sm"><i class="bi bi-cash me-1"></i> ‡∏£‡∏±‡∏ö/‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</a>
               <button class="btn btn-light border rounded-circle shadow-sm btn-sm" id="refreshDashboardBtn" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="bi bi-arrow-clockwise text-muted"></i></button>
            </div>
          </div>
        </div>

        <section class="mb-4">
          <div class="row g-3">
            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0 bg-success bg-opacity-10 border-start border-4 border-success">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between mb-2"><span class="text-success small fw-bold">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><i class="bi bi-graph-up-arrow text-success opacity-50"></i></div>
                  <h4 class="fw-bold text-dark mb-0" id="statIncomeToday">-</h4>
                  <small class="text-muted text-xs">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÇ‡∏≠‡∏ô)</small>
                </div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0 bg-danger bg-opacity-10 border-start border-4 border-danger">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between mb-2"><span class="text-danger small fw-bold">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><i class="bi bi-cart-dash text-danger opacity-50"></i></div>
                  <h4 class="fw-bold text-dark mb-0" id="statExpenseToday">-</h4>
                  <small class="text-muted text-xs">‡∏£‡∏ß‡∏°‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</small>
                </div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0 bg-primary bg-opacity-10 border-start border-4 border-primary">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between mb-2"><span class="text-primary small fw-bold">‡∏Å‡∏≥‡πÑ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><i class="bi bi-piggy-bank text-primary opacity-50"></i></div>
                  <h4 class="fw-bold text-dark mb-0" id="statProfitToday">-</h4>
                  <small class="text-muted text-xs">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏´‡∏±‡∏Å ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</small>
                </div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0 bg-white border-start border-4 border-secondary">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between mb-2"><span class="text-secondary small fw-bold">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°</span><i class="bi bi-safe text-secondary opacity-50"></i></div>
                  <h4 class="fw-bold text-dark mb-0" id="statTotalBalance">-</h4>
                  <small class="text-muted text-xs">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                </div>
              </div>
            </div>
          </div>
        </section>
		<section class="mb-4">
          <div class="row g-4">
            
            <div class="col-12 col-lg-8">
              
              <div class="row g-2 mb-4">
                <div class="col-4 col-sm-2">
                  <div class="p-2 border rounded-3 text-center bg-white shadow-sm h-100">
                    <div class="text-muted text-xs mb-1">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</div>
                    <h5 class="fw-bold text-dark mb-0" id="statJobsToday">-</h5>
                  </div>
                </div>
                <div class="col-4 col-sm-2">
                  <div class="p-2 border rounded-3 text-center bg-white shadow-sm h-100">
                    <div class="text-muted text-xs mb-1">‡∏£‡∏ñ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
                    <h5 class="fw-bold text-warning mb-0" id="statJobsInGarage">-</h5>
                  </div>
                </div>
                <div class="col-4 col-sm-2">
                  <div class="p-2 border rounded-3 text-center bg-white shadow-sm h-100">
                    <div class="text-muted text-xs mb-1">‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ñ</div>
                    <h5 class="fw-bold text-info mb-0" id="statVehiclesBoughtToday">-</h5>
                  </div>
                </div>
                <div class="col-4 col-sm-2">
                  <div class="p-2 border rounded-3 text-center bg-white shadow-sm h-100">
                    <div class="text-muted text-xs mb-1">‡∏Ç‡∏≤‡∏¢‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å</div>
                    <h5 class="fw-bold text-success mb-0" id="statVehiclesSoldToday">-</h5>
                  </div>
                </div>
                <div class="col-4 col-sm-2">
                  <div class="p-2 border rounded-3 text-center bg-white shadow-sm h-100">
                    <div class="text-muted text-xs mb-1">‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</div>
                    <h5 class="fw-bold text-secondary mb-0" id="statStockInToday">-</h5>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm border-0 rounded-4 mb-4">
                <div class="card-header bg-white border-0 pt-3 d-flex justify-content-between align-items-center">
                  <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-bar-chart-line me-2"></i>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h6>
                </div>
                <div class="card-body">
                  <div class="position-relative w-100" style="min-height: 260px;">
                    <canvas id="incomeExpenseChart"></canvas>
                    <div id="chartEmptyState" class="text-center text-muted small position-absolute top-50 start-50 translate-middle d-none">
                      <i class="bi bi-inbox fs-4 d-block mb-1"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-white border-0 pt-3">
                  <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-activity me-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush rounded-bottom-4" id="activityLogsList">
                    <div class="text-center py-4 small text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                  </div>
                </div>
              </div>

            </div>

            <div class="col-12 col-lg-4">
              <div class="d-flex flex-column gap-4">
                
                <div class="card shadow-sm border-0 rounded-4">
                  <div class="card-header bg-white border-0 pt-3">
                    <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-pie-chart me-2"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h6>
                  </div>
                  <div class="card-body d-flex flex-column align-items-center justify-content-center pt-0">
                    <div style="height: 200px; width: 100%; position: relative;">
                      <canvas id="jobStatusChart"></canvas>
                    </div>
                    <div class="mt-3 text-center small text-muted">
                      *‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                    </div>
                  </div>
                </div>

                <div class="card shadow-sm border-0 rounded-4 flex-fill">
                  <div class="card-header bg-white border-0 pt-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h6>
                    <a href="stock.html" class="text-decoration-none text-xs fw-bold">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ></a>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0 small">
                        <thead class="bg-light text-muted">
                          <tr>
                            <th class="ps-3 fw-normal">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="text-end fw-normal">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th class="text-end pe-3 fw-normal">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                          </tr>
                        </thead>
                        <tbody id="lowStockTbody">
                          <tr><td colspan="3" class="text-center py-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </section>

        <div style="height: 4rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow-lg rounded-4 border-0 p-2" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item rounded-3 py-2" id="fabOpenBillBtn">
              <span class="bg-primary bg-opacity-10 rounded-circle p-1 me-2"><i class="bi bi-receipt-cutoff text-primary"></i></span> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà
            </button>
          </li>
          <li>
            <button class="dropdown-item rounded-3 py-2" id="fabAddTxnBtn">
              <span class="bg-success bg-opacity-10 rounded-circle p-1 me-2"><i class="bi bi-cash-coin text-success"></i></span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
            </button>
          </li>
          <li>
            <button class="dropdown-item rounded-3 py-2" id="fabStockInBtn">
              <span class="bg-warning bg-opacity-10 rounded-circle p-1 me-2"><i class="bi bi-box-seam text-warning"></i></span> ‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
            </button>
          </li>
          <li>
            <button class="dropdown-item rounded-3 py-2" id="fabAddVehicleBtn">
              <span class="bg-info bg-opacity-10 rounded-circle p-1 me-2"><i class="bi bi-truck-front text-info"></i></span> ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ñ
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link active">
              <i class="bi bi-speedometer2 d-block fs-5"></i>
              <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block fs-5"></i>
              <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block fs-5"></i>
              <span>‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block fs-5"></i>
              <span>‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block fs-5"></i>
              <span>‡∏™‡∏ï‡πä‡∏≠‡∏Å</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block fs-5"></i>
              <span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080">
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex px-2">
          <div class="toast-body" id="mainToastBody"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="‡∏õ‡∏¥‡∏î"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, where, orderBy, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");
      const welcomeUserName = document.getElementById("welcomeUserName");
      const currentDateLabel = document.getElementById("currentDateLabel");
      const refreshDashboardBtn = document.getElementById("refreshDashboardBtn");

      // Stats Cards
      const statTotalBalance = document.getElementById("statTotalBalance");
      const statIncomeToday = document.getElementById("statIncomeToday");
      const statExpenseToday = document.getElementById("statExpenseToday");
      const statProfitToday = document.getElementById("statProfitToday");
      
      // Operations Stats
      const statJobsToday = document.getElementById("statJobsToday");
      const statJobsInGarage = document.getElementById("statJobsInGarage");
      const statVehiclesBoughtToday = document.getElementById("statVehiclesBoughtToday");
      const statVehiclesSoldToday = document.getElementById("statVehiclesSoldToday");
      const statStockInToday = document.getElementById("statStockInToday");

      // Lists & Charts
      const lowStockTbody = document.getElementById("lowStockTbody");
      const activityLogsList = document.getElementById("activityLogsList");
      const incomeExpenseChartCanvas = document.getElementById("incomeExpenseChart");
      const jobStatusChartCanvas = document.getElementById("jobStatusChart");
      const chartEmptyState = document.getElementById("chartEmptyState");

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      let incomeChartInstance = null;
      let statusChartInstance = null;

      // --- Helpers ---
      function showToast(msg, variant="primary") {
        const toastEl = document.getElementById("mainToast");
        const body = document.getElementById("mainToastBody");
        toastEl.className = `toast align-items-center text-bg-${variant} border-0 shadow-lg rounded-pill`;
        body.innerHTML = msg;
        bootstrap.Toast.getOrCreateInstance(toastEl).show();
      }
      function formatNumber(v) { return Number(v||0).toLocaleString("th-TH",{minimumFractionDigits:2,maximumFractionDigits:2}); }
      function formatDateThai(date) { return date.toLocaleDateString("th-TH", {day:"numeric", month:"long", year:"numeric"}); }
      function getTodayISO() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
      
      function getLast7Days() {
        const dates = [];
        for(let i=6; i>=0; i--) {
          const d = new Date(); d.setDate(d.getDate()-i);
          dates.push(d.toISOString().split('T')[0]);
        }
        return dates;
      }

      // --- Theme & User ---
      async function ensureUserProfile(user) {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()) return { id: snap.id, ...snap.data() };
        
        const q = query(collection(db,"users"), limit(1));
        const role = (await getDocs(q)).empty ? "admin" : "staff";
        const data = { displayName: user.displayName||user.email.split("@")[0], role, createdAt: serverTimestamp(), branchId: null, theme: "light", disabled: false };
        await setDoc(ref, data);
        return { id: user.uid, ...data };
      }

      function applyTheme(theme) {
        const t = theme==="dark"?"dark":"light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-"+t);
        const icon = themeToggleBtn.querySelector("i");
        icon.className = t==="dark"?"bi bi-sun fs-5":"bi bi-moon fs-5";
      }

      // --- Chart Functions (Upgrade Feature) ---
      function renderIncomeChart(labels, incData, expData) {
        if(incomeChartInstance) incomeChartInstance.destroy();
        incomeChartInstance = new Chart(incomeExpenseChartCanvas, {
          type: 'line',
          data: {
            labels: labels.map(d => d.slice(5)),
            datasets: [
              { label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', data: incData, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', tension: 0.4, fill: true },
              { label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', data: expData, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', tension: 0.4, fill: true }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
        });
      }

      function renderStatusChart(rep, done, pick) {
        if(statusChartInstance) statusChartInstance.destroy();
        if(rep+done+pick === 0) return; // Empty state handles itself
        statusChartInstance = new Chart(jobStatusChartCanvas, {
          type: 'doughnut',
          data: {
            labels: ['‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à', '‡∏£‡∏±‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß'],
            datasets: [{
              data: [rep, done, pick],
              backgroundColor: ['#ffc107', '#0dcaf0', '#198754'],
              borderWidth: 0
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 11} } } }, cutout: '70%' }
        });
      }

      // --- Main Data Loading (Logic from Original) ---
      async function loadDashboardData(profile) {
        const branchId = profile.branchId;
        const today = getTodayISO();
        if(currentDateLabel) currentDateLabel.textContent = formatDateThai(new Date());

        try {
          // 1. Transactions & Balance (Logic ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≤‡∏ü)
          const dates7 = getLast7Days();
          const qTx = query(collection(db, "transactions"), where("isDeleted","==",false), where("date",">=",dates7[0]), ...(branchId?[where("branchId","==",branchId)]:[]));
          const txSnap = await getDocs(qTx);

          let incToday=0, expToday=0, stockInCount=0;
          const dailyMap = {}; dates7.forEach(d => dailyMap[d] = { inc: 0, exp: 0 });

          txSnap.forEach(doc => {
            const d = doc.data();
            const amt = Number(d.amount||0);
            if(d.date === today) {
              if(d.type==="income") incToday += amt;
              else { expToday += amt; if(d.category==="‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà") stockInCount++; }
            }
            if(dailyMap[d.date]) {
              if(d.type==="income") dailyMap[d.date].inc += amt;
              else dailyMap[d.date].exp += amt;
            }
          });

          // Balance Calculation (Query All for accuracy - as per original logic)
          let totalInc=0, totalExp=0;
          const qAllTx = query(collection(db, "transactions"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]));
          (await getDocs(qAllTx)).forEach(doc => {
             const d = doc.data();
             if(d.type==="income") totalInc += Number(d.amount||0);
             else totalExp += Number(d.amount||0);
          });

          statTotalBalance.textContent = formatNumber(totalInc - totalExp) + " ‡∏ø";
          statIncomeToday.textContent = formatNumber(incToday) + " ‡∏ø";
          statExpenseToday.textContent = formatNumber(expToday) + " ‡∏ø";
          const profit = incToday - expToday;
          statProfitToday.textContent = (profit>=0?"+":"") + formatNumber(profit) + " ‡∏ø";
          statProfitToday.className = `fw-bold mb-0 ${profit>=0?'text-primary':'text-danger'}`;
          statStockInToday.textContent = stockInCount;

          renderIncomeChart(dates7, dates7.map(d=>dailyMap[d].inc), dates7.map(d=>dailyMap[d].exp));

          // 2. Jobs
          const qJobs = query(collection(db,"jobs"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]));
          const jobsSnap = await getDocs(qJobs);
          let jobsToday=0, jobsGarage=0;
          let sRep=0, sDone=0, sPick=0;

          jobsSnap.forEach(doc => {
             const d = doc.data();
             if(d.date === today) jobsToday++;
             if(d.status !== "picked_up") jobsGarage++;
             
             if(d.status === "repairing") sRep++;
             else if(d.status === "done") sDone++;
             else if(d.status === "picked_up") sPick++;
          });
          statJobsToday.textContent = jobsToday;
          statJobsInGarage.textContent = jobsGarage;
          renderStatusChart(sRep, sDone, sPick);

          // 3. Vehicles
          const qVeh = query(collection(db,"vehicles"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]));
          const vehSnap = await getDocs(qVeh);
          let vBuy=0, vSold=0;
          vehSnap.forEach(doc => {
             const d = doc.data();
             if(d.buyDate === today) vBuy++;
             if(d.sellDate === today && d.status==="sold") vSold++;
          });
          statVehiclesBoughtToday.textContent = vBuy;
          statVehiclesSoldToday.textContent = vSold;

          // 4. Low Stock
          const qStock = query(collection(db,"stock"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]), orderBy("qty","asc"));
          const stockSnap = await getDocs(qStock);
          lowStockTbody.innerHTML = "";
          let lowCount=0;
          stockSnap.forEach(doc => {
             const d = doc.data();
             if(Number(d.qty) <= Number(d.minQty) && lowCount < 5) {
                lowCount++;
                lowStockTbody.innerHTML += `<tr><td class="ps-3"><div class="fw-bold">${d.name}</div></td><td class="text-end fw-bold text-danger">${d.qty}</td><td class="text-end pe-3 text-muted">${d.minQty}</td></tr>`;
             }
          });
          if(lowCount===0) lowStockTbody.innerHTML = `<tr><td colspan="3" class="text-center py-3 text-success small">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥</td></tr>`;

          // 5. Activity Logs
          const qLogs = query(collection(db,"activityLogs"), ...(branchId?[where("branchId","==",branchId)]:[]), orderBy("createdAt","desc"), limit(7));
          const logsSnap = await getDocs(qLogs);
          activityLogsList.innerHTML = "";
          if(logsSnap.empty) {
             activityLogsList.innerHTML = `<div class="text-center py-4 text-muted small">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>`;
          } else {
             logsSnap.forEach(doc => {
                const d = doc.data();
                const time = d.createdAt?.toDate().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) || "-";
                activityLogsList.innerHTML += `<div class="list-group-item border-0 px-3 py-2"><div class="d-flex justify-content-between"><span class="text-dark fw-bold small text-truncate" style="max-width:70%">${d.message}</span><span class="text-muted text-xs">${time}</span></div><div class="text-xs text-muted">${d.createdByName||"System"}</div></div>`;
             });
          }

        } catch (error) {
          console.error("Load Data Error:", error);
          showToast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "danger");
        }
      }

      // --- Initialization ---
      onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.href = "index.html";
        
        try {
           const profile = await ensureUserProfile(user);
           // Update UI
           const name = profile.displayName || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
           userDisplayNameText.textContent = name;
           if(document.getElementById("userDisplayNameTextMobile")) document.getElementById("userDisplayNameTextMobile").textContent = name;
           if(welcomeUserName) welcomeUserName.textContent = name;
           userAvatarInitial.textContent = name.charAt(0).toUpperCase();
           userRoleText.textContent = profile.role==="admin"?"Admin":"Staff";
           if(profile.role !== "admin") settingsMenuItem.classList.add("d-none");

           // Theme
           const t = localStorage.getItem("bm-theme-" + user.uid) || profile.theme || "light";
           applyTheme(t);

           // Events
           setupEventListeners(user, profile);
           
           // Load
           await loadDashboardData(profile);

        } catch (error) {
           console.error("Init Error", error);
           showToast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "danger");
        }
      });

      function setupEventListeners(user, profile) {
         logoutBtn.addEventListener("click", () => signOut(auth).then(()=>window.location.href="index.html"));
         
         themeToggleBtn.addEventListener("click", () => {
            const isDark = bodyEl.classList.contains("bm-theme-dark");
            const newTheme = isDark ? "light" : "dark";
            applyTheme(newTheme);
            localStorage.setItem("bm-theme-" + user.uid, newTheme);
            updateDoc(doc(db,"users",user.uid), {theme: newTheme}).catch(()=>{});
         });

         refreshDashboardBtn?.addEventListener("click", () => {
            loadDashboardData(profile);
            showToast("‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", "success");
         });

         // FAB & Quick Links
         fabOpenBillBtn?.addEventListener("click", () => window.location.href="open-bill.html");
         fabAddTxnBtn?.addEventListener("click", () => window.location.href="finance.html");
         fabStockInBtn?.addEventListener("click", () => window.location.href="stock.html");
         fabAddVehicleBtn?.addEventListener("click", () => window.location.href="vehicles.html");
      }
    </script>
  </body>
</html>