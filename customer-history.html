<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – ประวัติลูกค้า &amp; รถ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>
        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>
          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
            >
              <span class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm" id="userAvatarCircle">
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">Loading...</span><br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
               <li><a class="dropdown-item py-2" href="dashboard.html"><i class="bi bi-speedometer2 me-2"></i> แดชบอร์ด</a></li>
               <li><hr class="dropdown-divider" /></li>
               <li><button class="dropdown-item py-2 text-danger" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ</button></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        
        <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
          <div>
            <h1 class="h5 mb-1 fw-bold text-primary">
              <i class="bi bi-person-lines-fill me-2"></i>ประวัติลูกค้า &amp; รถ
            </h1>
            <p class="small text-muted mb-0">
              ค้นหาข้อมูล ดูประวัติซ่อม และวิเคราะห์การใช้บริการ
            </p>
          </div>
          <span class="badge text-bg-secondary shadow-sm">
            โหมดดูข้อมูล
          </span>
        </div>

        <section id="initialStateBox" class="mb-4">
          <div class="alert alert-info small mb-0 shadow-sm border-0 d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2 fs-5"></i>
            <div>
              พิมพ์ชื่อ, เบอร์โทร หรือทะเบียนรถของลูกค้า แล้วกด <strong>ค้นหา</strong> เพื่อดูประวัติย้อนหลังทั้งหมด
            </div>
          </div>
        </section>

        <section class="mb-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <form id="searchForm" class="row g-2 align-items-end">
                <div class="col-12 col-md-6 col-lg-7">
                  <label for="searchKeyword" class="form-label small mb-1 fw-bold text-muted">
                    คีย์เวิร์ดค้นหา
                  </label>
                  <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                      <i class="bi bi-search text-muted"></i>
                    </span>
                    <input
                      type="search"
                      class="form-control border-start-0 ps-0"
                      id="searchKeyword"
                      placeholder="เช่น 089xxxxxxx, สมชาย, 1กข1234"
                      autocomplete="off"
                    />
                  </div>
                </div>
                <div class="col-6 col-md-3 col-lg-2">
                  <button
                    type="submit"
                    class="btn btn-primary w-100"
                    id="searchBtn"
                  >
                    ค้นหา
                  </button>
                </div>
                <div class="col-6 col-md-3 col-lg-3">
                  <button
                    type="button"
                    class="btn btn-outline-secondary w-100"
                    id="resetBtn"
                  >
                    <i class="bi bi-arrow-counterclockwise me-1"></i> ล้างค่า
                  </button>
                </div>
              </form>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <p class="small text-muted mb-0 text-xs" id="searchHint">
                  <i class="bi bi-magic me-1"></i>ระบบจะค้นหาจาก <strong>เบอร์โทร, ทะเบียนรถ หรือชื่อ</strong> อัตโนมัติ
                </p>
              </div>
            </div>
          </div>
        </section>

        <section id="loadingState" class="mb-3 d-none">
          <div class="text-center py-4">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <div class="small text-muted">กำลังดึงข้อมูลประวัติทั้งหมด...</div>
          </div>
        </section>

        <section id="noResultBox" class="mb-3 d-none">
          <div class="alert alert-warning small mb-0 shadow-sm border-0 d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
            <div>
              ไม่พบข้อมูลลูกค้าตามคำค้นนี้ในระบบ กรุณาลองใช้ข้อมูลอื่น (เช่น ทะเบียนรถ)
            </div>
          </div>
        </section>

        <section id="customerSummarySection" class="mb-4 d-none">
          <div class="card bm-card-summary shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                <div class="d-flex align-items-center">
                  <div
                    class="rounded-circle bg-success text-white d-inline-flex align-items-center justify-content-center me-3 bm-avatar-circle-lg shadow-sm"
                  >
                    <span id="summaryAvatarInitial" class="fw-bold fs-4">C</span>
                  </div>
                  <div>
                    <div class="small text-muted mb-0">ชื่อลูกค้า</div>
                    <h2 class="h5 mb-1 fw-bold text-dark" id="summaryCustomerName">-</h2>
                    <div class="d-flex flex-wrap gap-2 align-items-center small text-muted">
                        <span><i class="bi bi-telephone me-1"></i><span id="summaryCustomerPhone">-</span></span>
                    </div>
                    <div class="small text-muted mt-1" id="summaryOtherPhonesRow" style="display: none;">
                      <span class="badge bg-light text-secondary border">เบอร์อื่น: <span id="summaryOtherPhones">-</span></span>
                    </div>
                  </div>
                </div>
                <div class="text-end small">
                  <span class="text-muted d-block mb-1">ผลการค้นหาจาก:</span>
                  <span id="summarySearchTypeLabel" class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle px-3 py-2 rounded-pill">
                    -
                  </span>
                </div>
              </div>

              <hr class="opacity-10 my-4" />

              <div class="row g-3">
                <div class="col-6 col-md-3">
                  <div class="p-3 bg-white rounded-3 border h-100 shadow-sm">
                    <div class="small text-muted mb-1">งานซ่อมทั้งหมด</div>
                    <div class="h4 mb-0 fw-bold text-primary" id="summaryJobsCount">0</div>
                    <div class="small text-muted">บิล</div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="p-3 bg-white rounded-3 border h-100 shadow-sm">
                    <div class="small text-muted mb-1">ยอดใช้จ่ายรวม</div>
                    <div class="h4 mb-0 fw-bold text-success" id="summaryTotalAmount">0 ฿</div>
                    <div class="small text-muted">บาท</div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="p-3 bg-white rounded-3 border h-100 shadow-sm">
                    <div class="small text-muted mb-1">เฉลี่ยต่อบิล</div>
                    <div class="h4 mb-0 fw-bold text-dark" id="summaryAveragePerJob">0 ฿</div>
                    <div class="small text-muted">บาท/ครั้ง</div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="p-3 bg-white rounded-3 border h-100 shadow-sm">
                    <div class="small text-muted mb-1">จำนวนรถ</div>
                    <div class="h4 mb-0 fw-bold text-info" id="summaryVehiclesCount">0</div>
                    <div class="small text-muted">คันที่เคยเข้า</div>
                  </div>
                </div>
              </div>

              <div class="row g-3 mt-2">
                <div class="col-12 col-md-6">
                  <div class="d-flex align-items-center p-2 bg-light rounded border">
                    <i class="bi bi-calendar-event me-2 text-muted"></i>
                    <div class="small">
                      <span class="text-muted">ครั้งแรก:</span>
                      <span class="fw-semibold ms-1" id="summaryFirstVisit">-</span>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="d-flex align-items-center p-2 bg-light rounded border">
                    <i class="bi bi-clock-history me-2 text-muted"></i>
                    <div class="small">
                      <span class="text-muted">ล่าสุด:</span>
                      <span class="fw-semibold ms-1" id="summaryLastVisit">-</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="historySection" class="mb-4 d-none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h6 mb-0 fw-bold text-dark">
              <i class="bi bi-clock-history me-2 text-primary"></i>ประวัติการทำรายการ
            </h2>
            <span class="badge bg-light text-dark border" id="historyCountLabel">-</span>
          </div>

          <div id="historyEmptyBox" class="alert alert-light border small d-none text-center py-4">
            <i class="bi bi-inbox fs-4 d-block mb-2 text-muted"></i>
            ยังไม่มีประวัติการใช้บริการสำหรับลูกค้าคนนี้
          </div>

          <ul class="list-group list-group-flush" id="historyTimeline">
            </ul>
        </section>

        <div style="height: 5rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow border-0" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabOpenBillBtn">
              <i class="bi bi-receipt-cutoff me-2 text-primary"></i> เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabAddTxnBtn">
              <i class="bi bi-cash-coin me-2 text-success"></i> เพิ่มรายการเงิน
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabStockInBtn">
              <i class="bi bi-box-seam me-2 text-warning"></i> บันทึกซื้ออะไหล่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabAddVehicleBtn">
              <i class="bi bi-truck-front me-2 text-info"></i> เพิ่มรถรับซื้อ
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1090;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex">
          <div class="toast-body fw-medium" id="mainToastBody">
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="ปิด"
          ></button>
        </div>
      </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
          <div class="modal-header border-bottom-0 pb-0">
            <h5 class="modal-title fw-bold text-primary" id="detailModalTitle">
              รายละเอียด
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="p-3 bg-light rounded-3 border mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge bg-white text-dark border shadow-sm" id="dmDateBadge">-</span>
                    <span class="badge bg-warning text-dark" id="dmStatusBadge">-</span>
                </div>
                <div class="h5 fw-bold mb-1" id="dmCarInfo">-</div>
                <div class="small text-muted"><i class="bi bi-person me-1"></i> <span id="dmCustomerName">-</span></div>
            </div>

            <div class="mb-3">
                <label class="small text-muted fw-bold">อาการที่แจ้ง / รายละเอียด</label>
                <div class="p-2 bg-white border rounded text-secondary small" id="dmProblem">
                    -
                </div>
            </div>

            <div class="mb-3">
                <label class="small text-muted fw-bold mb-1">รายการอะไหล่และค่าบริการ</label>
                <div class="table-responsive rounded border">
                    <table class="table table-sm table-striped mb-0 small" style="font-size: 0.8rem;">
                        <thead class="table-light">
                            <tr>
                                <th>รายการ</th>
                                <th class="text-end" style="width: 25%;">ราคา</th>
                            </tr>
                        </thead>
                        <tbody id="dmItemsTableBody">
                            </tbody>
                        <tfoot class="table-group-divider">
                            <tr>
                                <td class="text-end fw-bold">รวมสุทธิ</td>
                                <td class="text-end fw-bold text-success" id="dmTotalAmount">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

             <div class="d-flex justify-content-between text-muted text-xs border-top pt-2">
                <div>บันทึกโดย: <span id="dmBy">-</span></div>
                <div><span id="dmTimestamp">-</span></div>
            </div>
          </div>
          <div class="modal-footer border-top-0 pt-0">
            <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">ปิด</button>
            <a href="#" id="dmEditLink" class="btn btn-primary rounded-pill px-4">
                <i class="bi bi-pencil-square me-1"></i> แก้ไขบิล
            </a>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
	<script type="module">
      // ============================================================
      // Import Firebase SDK
      // ============================================================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        getDocs,
        query,
        where,
        orderBy,
        limit,
        setDoc
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ============================================================
      // Firebase Configuration
      // ============================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ============================================================
      // DOM Elements Reference
      // ============================================================
      const bodyEl = document.body;
      
      // Topbar
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // Search Section
      const searchForm = document.getElementById("searchForm");
      const searchKeywordInput = document.getElementById("searchKeyword");
      const searchBtn = document.getElementById("searchBtn");
      const resetBtn = document.getElementById("resetBtn");
      const initialStateBox = document.getElementById("initialStateBox");
      const loadingState = document.getElementById("loadingState");
      const noResultBox = document.getElementById("noResultBox");

      // Customer Summary Section
      const customerSummarySection = document.getElementById("customerSummarySection");
      const summaryAvatarInitial = document.getElementById("summaryAvatarInitial");
      const summaryCustomerName = document.getElementById("summaryCustomerName");
      const summaryCustomerPhone = document.getElementById("summaryCustomerPhone");
      const summaryOtherPhonesRow = document.getElementById("summaryOtherPhonesRow");
      const summaryOtherPhones = document.getElementById("summaryOtherPhones");
      const summarySearchTypeLabel = document.getElementById("summarySearchTypeLabel");
      const summaryJobsCount = document.getElementById("summaryJobsCount");
      const summaryTotalAmount = document.getElementById("summaryTotalAmount");
      const summaryAveragePerJob = document.getElementById("summaryAveragePerJob");
      const summaryVehiclesCount = document.getElementById("summaryVehiclesCount");
      const summaryFirstVisit = document.getElementById("summaryFirstVisit");
      const summaryLastVisit = document.getElementById("summaryLastVisit");

      // History Timeline Section
      const historySection = document.getElementById("historySection");
      const historyTimeline = document.getElementById("historyTimeline");
      const historyEmptyBox = document.getElementById("historyEmptyBox");
      const historyCountLabel = document.getElementById("historyCountLabel");

      // Modals
      const detailModalEl = document.getElementById("detailModal");
      const detailModal = new bootstrap.Modal(detailModalEl);
      
      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // Toasts
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // State Variables
      let currentUser = null;
      let currentUserProfile = null;
      let currentHistoryData = []; // Store fetched data for modal use

      // ============================================================
      // Helper Functions
      // ============================================================
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0 shadow";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      function formatNumber(value) {
        if (typeof value !== "number" || isNaN(value)) return "0";
        return value.toLocaleString("th-TH", { maximumFractionDigits: 2 });
      }

      function formatDateThaiFromString(dateStr) {
        if (!dateStr) return "-";
        const [year, month, day] = dateStr.split("-").map((v) => parseInt(v, 10));
        if (!year || !month || !day) return dateStr;
        const d = new Date(year, month - 1, day);
        const thaiMonths = [
          "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
          "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค.",
        ];
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${d.getFullYear() + 543}`;
      }

      function formatDateTimeThai(dateObj) {
        if (!(dateObj instanceof Date)) return "-";
        const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, "0")}-${String(dateObj.getDate()).padStart(2, "0")}`;
        const timeStr = `${String(dateObj.getHours()).padStart(2, "0")}:${String(dateObj.getMinutes()).padStart(2, "0")}`;
        return `${formatDateThaiFromString(dateStr)} ${timeStr} น.`;
      }

      // ============================================================
      // Theme Management
      // ============================================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);

        const icon = themeToggleBtn?.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-sun", normalized === "dark");
          icon.classList.toggle("bi-moon", normalized === "light");
        }
      }

      function saveThemeForUser(uid, theme) {
        if (!uid) return;
        try { localStorage.setItem("bm-theme-" + uid, theme); }
        catch (e) { console.warn("Theme storage error", e); }
      }

      function readThemeForUser(uid, fallbackTheme) {
        if (!uid) return fallbackTheme || "light";
        try { return localStorage.getItem("bm-theme-" + uid) || fallbackTheme || "light"; }
        catch (e) { return fallbackTheme || "light"; }
      }

      // ============================================================
      // User Profile Logic
      // ============================================================
      async function ensureUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          return { id: snap.id, ...snap.data() };
        }
        const usersCol = collection(db, "users");
        const q = query(usersCol, limit(1));
        const existingSnap = await getDocs(q);
        const isFirstUser = existingSnap.empty;
        const role = isFirstUser ? "admin" : "staff";
        const newUserData = {
          displayName: user.displayName || (user.email ? user.email.split("@")[0] : "ผู้ใช้ใหม่"),
          role,
          createdAt: new Date(),
          branchId: null,
          theme: "light",
          disabled: false,
        };
        await setDoc(userRef, newUserData);
        return { id: user.uid, ...newUserData };
      }

      // ============================================================
      // Search Logic
      // ============================================================
      function detectSearchType(keyword) {
        const trimmed = (keyword || "").trim();
        if (!trimmed) return null;
        // Clean spaces for plate detection
        const cleanPlate = trimmed.replace(/\s+/g, '');
        
        const onlyDigitsAndSymbol = /^[0-9+\-\s]+$/.test(trimmed);
        const hasDigit = /[0-9]/.test(trimmed);
        const hasLetter = /[A-Za-zก-ฮ]/.test(trimmed);

        if (onlyDigitsAndSymbol && trimmed.replace(/[^0-9]/g, "").length >= 6) return "phone";
        // Simple heuristic: if it has letters and digits, likely a plate (e.g. 1กข1234)
        if (hasDigit && hasLetter) return "plate"; 
        // If it has letters but no digits, likely a name
        if (hasLetter && !hasDigit) return "name";
        // Fallback: treat as plate if short
        if (cleanPlate.length < 8) return "plate";
        
        return "name"; // Default
      }

      function getSearchTypeLabel(type) {
        if (type === "phone") return "เบอร์โทรศัพท์";
        if (type === "plate") return "ทะเบียนรถ";
        if (type === "name") return "ชื่อลูกค้า";
        return "ทั่วไป";
      }

      function setLoading(isLoading) {
        if (isLoading) {
          loadingState.classList.remove("d-none");
          searchBtn.disabled = true;
          resetBtn.disabled = true;
        } else {
          loadingState.classList.add("d-none");
          searchBtn.disabled = false;
          resetBtn.disabled = false;
        }
      }

      function resetView() {
        initialStateBox.classList.remove("d-none");
        noResultBox.classList.add("d-none");
        customerSummarySection.classList.add("d-none");
        historySection.classList.add("d-none");
        historyEmptyBox.classList.add("d-none");
        historyTimeline.innerHTML = "";
        historyCountLabel.textContent = "-";
        currentHistoryData = [];
      }

      async function searchCustomerHistory(keyword) {
        const trimmed = (keyword || "").trim();
        if (!trimmed) {
          showToast("กรุณากรอกคีย์เวิร์ดก่อนค้นหา", "warning");
          return;
        }

        const searchType = detectSearchType(trimmed);
        if (!searchType) {
          showToast("รูปแบบคีย์เวิร์ดไม่ชัดเจน กรุณาลองใหม่", "warning");
          return;
        }

        resetView();
        initialStateBox.classList.add("d-none");
        noResultBox.classList.add("d-none");
        setLoading(true);

        const branchId = currentUserProfile?.branchId || null;

        try {
          // 1. Fetch Jobs
          const jobsCol = collection(db, "jobs");
          const jobsConstraints = [where("isDeleted", "==", false)];
          if (branchId) jobsConstraints.push(where("branchId", "==", branchId));

          if (searchType === "phone") {
              jobsConstraints.push(where("customerPhone", "==", trimmed));
          } else if (searchType === "plate") {
              // Try basic match. If needed, we might search multiple variants in real app, but here simple match
              jobsConstraints.push(where("plate", "==", trimmed)); 
          } else if (searchType === "name") {
              // Exact match for now (Firestore limits substring search). 
              // In production, we might use a separate search index (Algolia/Typesense).
              // Here we rely on exact name or try logical guesswork.
              jobsConstraints.push(where("customerName", "==", trimmed));
          }

          // Fetch limit to prevent overload (e.g., 200 items)
          const jobsQuery = query(jobsCol, ...jobsConstraints, orderBy("date", "desc"), limit(200));
          const jobsSnap = await getDocs(jobsQuery);
          
          const jobs = [];
          jobsSnap.forEach(doc => {
              jobs.push({ id: doc.id, ...doc.data() });
          });

          // 2. Fetch Vehicles
          // Logic: Find vehicles that match the plates found in jobs, OR match the search keyword directly
          const vehicles = [];
          const vehiclesCol = collection(db, "vehicles");
          const plateSet = new Set();
          
          jobs.forEach(j => { if (j.plate) plateSet.add(j.plate.trim()); });
          if (searchType === "plate") plateSet.add(trimmed);

          const plateList = Array.from(plateSet).filter(Boolean);

          // Chunk queries if too many plates (Firestore 'in' limit is 10)
          if (plateList.length > 0) {
            const chunkSize = 10;
            for (let i = 0; i < plateList.length; i += chunkSize) {
              const chunk = plateList.slice(i, i + chunkSize);
              const constraints = [where("plate", "in", chunk)];
              if (branchId) constraints.push(where("branchId", "==", branchId));
              const snap = await getDocs(query(vehiclesCol, ...constraints));
              snap.forEach(doc => vehicles.push({ id: doc.id, ...doc.data() }));
            }
          }

          // Special case: if searched by name, vehicles might not be linked by plate yet.
          // We can't easily search vehicles by ownerName without an index, so we rely on plates found in jobs.

          if (jobs.length === 0 && vehicles.length === 0) {
            setLoading(false);
            noResultBox.classList.remove("d-none");
            return;
          }

          // 3. Build UI
          buildCustomerSummary(jobs, vehicles, trimmed, searchType);
          buildHistoryTimeline(jobs, vehicles);

          setLoading(false);
        } catch (error) {
          console.error("Search error:", error);
          setLoading(false);
          // Handle index errors or permission errors gracefully
          if (error.message && error.message.includes("requires an index")) {
             showToast("ระบบกำลังสร้างดัชนีค้นหา (รอ 1-2 นาที)", "warning");
          } else {
             showToast("ค้นหาไม่สำเร็จ (" + (error.code || "unknown") + ")", "danger");
          }
        }
      }

      function buildCustomerSummary(jobs, vehicles, keyword, searchType) {
        customerSummarySection.classList.remove("d-none");

        const nameCount = {};
        const phoneCount = {};
        const allPhones = new Set();
        const allPlates = new Set();

        jobs.forEach(j => {
          const name = (j.customerName || "").trim();
          const phone = (j.customerPhone || "").trim();
          if (name) nameCount[name] = (nameCount[name] || 0) + 1;
          if (phone) { phoneCount[phone] = (phoneCount[phone] || 0) + 1; allPhones.add(phone); }
          if (j.plate) allPlates.add(j.plate.trim());
        });

        vehicles.forEach(v => { if (v.plate) allPlates.add(v.plate.trim()); });

        // Heuristic: Most frequent name/phone is likely the main one
        let selectedName = Object.entries(nameCount).sort((a,b) => b[1] - a[1])[0]?.[0] || "-";
        let selectedPhone = Object.entries(phoneCount).sort((a,b) => b[1] - a[1])[0]?.[0] || "-";
        
        // Override with search term if empty
        if (jobs.length === 0 && searchType === "phone") selectedPhone = keyword;
        if (jobs.length === 0 && searchType === "name") selectedName = keyword;

        summaryCustomerName.textContent = selectedName !== "-" ? selectedName : "ไม่พบชื่อ";
        summaryCustomerPhone.textContent = selectedPhone;
        summaryAvatarInitial.textContent = selectedName !== "-" ? selectedName.trim().charAt(0).toUpperCase() : "C";

        const otherPhones = Array.from(allPhones).filter(p => p !== selectedPhone);
        if (otherPhones.length > 0) {
          summaryOtherPhonesRow.style.display = "";
          summaryOtherPhones.textContent = otherPhones.join(", ");
        } else {
          summaryOtherPhonesRow.style.display = "none";
        }

        summarySearchTypeLabel.textContent = getSearchTypeLabel(searchType);

        // Stats Calculation
        const jobsCount = jobs.length;
        let totalAmount = 0;
        let dates = [];

        jobs.forEach(j => {
          totalAmount += Number(j.totalAmount) || 0;
          if (j.date) dates.push(j.date);
        });
        dates.sort(); // Sort strings YYYY-MM-DD works correctly

        summaryJobsCount.textContent = String(jobsCount);
        summaryTotalAmount.textContent = formatNumber(totalAmount) + " ฿";
        summaryAveragePerJob.textContent = formatNumber(jobsCount > 0 ? totalAmount / jobsCount : 0) + " ฿";
        summaryVehiclesCount.textContent = String(allPlates.size);
        summaryFirstVisit.textContent = dates.length > 0 ? formatDateThaiFromString(dates[0]) : "-";
        summaryLastVisit.textContent = dates.length > 0 ? formatDateThaiFromString(dates[dates.length - 1]) : "-";
      }

      function buildHistoryTimeline(jobs, vehicles) {
        historySection.classList.remove("d-none");
        historyTimeline.innerHTML = "";
        historyEmptyBox.classList.add("d-none");

        currentHistoryData = []; // Clear old data cache

        jobs.forEach(j => {
          let dateKey = j.date;
          if (!dateKey && j.createdAt?.toDate) dateKey = j.createdAt.toDate().toISOString().slice(0, 10);
          
          const item = {
            id: j.id,
            kind: "job", 
            dateKey, 
            rawDate: j.date,
            createdAt: j.createdAt?.toDate ? j.createdAt.toDate() : null,
            plate: j.plate || "-", 
            brand: j.brand || "", 
            model: j.model || "",
            problem: j.problem || "", 
            status: j.status || "repairing",
            totalAmount: Number(j.totalAmount) || 0, 
            createdByName: j.createdByName,
            customerName: j.customerName,
            items: j.items || [] // Store items for modal
          };
          currentHistoryData.push(item);
        });

        vehicles.forEach(v => {
          const brandModel = [v.brand, v.model].filter(Boolean).join(" ");
          // Buy Event
          if (v.buyDate) {
            currentHistoryData.push({
              id: v.id + "_buy",
              kind: "vehicle_buy", 
              dateKey: v.buyDate, 
              rawDate: v.buyDate,
              createdAt: v.createdAt?.toDate ? v.createdAt.toDate() : null,
              plate: v.plate || "-", 
              brandModel, 
              buyPrice: Number(v.buyPrice) || 0,
              createdByName: v.createdByName
            });
          }
          // Sell Event
          if (v.sellDate) {
            currentHistoryData.push({
              id: v.id + "_sell",
              kind: "vehicle_sell", 
              dateKey: v.sellDate, 
              rawDate: v.sellDate,
              createdAt: v.updatedAt?.toDate ? v.updatedAt.toDate() : null,
              plate: v.plate || "-", 
              brandModel, 
              sellPrice: Number(v.sellPrice) || 0,
              profit: v.profit, 
              createdByName: v.createdByName
            });
          }
        });

        if (currentHistoryData.length === 0) {
          historyEmptyBox.classList.remove("d-none");
          historyCountLabel.textContent = "0 รายการ";
          return;
        }

        // Sort: Newest first
        currentHistoryData.sort((a, b) => (b.dateKey || "") > (a.dateKey || "") ? 1 : -1);
        historyCountLabel.textContent = currentHistoryData.length + " รายการ";

        const frag = document.createDocumentFragment();

        currentHistoryData.forEach((entry, index) => {
          const li = document.createElement("li");
          // Add cursor pointer only for jobs to indicate clickability
          li.className = "list-group-item small p-3 " + (entry.kind === 'job' ? 'list-group-item-action' : '');
          if(entry.kind === 'job') li.style.cursor = "pointer";

          // Bind click event for Job details
          if (entry.kind === 'job') {
             li.onclick = () => openJobDetail(index);
          }

          const dateText = entry.rawDate ? formatDateThaiFromString(entry.rawDate) : "-";
          let htmlContent = "";
          
          if (entry.kind === "job") {
            const statusMap = {
              repairing: { text: "กำลังซ่อม", class: "bg-warning text-dark" },
              done: { text: "ซ่อมเสร็จ", class: "bg-info text-dark" },
              picked_up: { text: "รับรถแล้ว", class: "bg-success" },
              cancel: { text: "ยกเลิก", class: "bg-danger" }
            };
            const st = statusMap[entry.status] || { text: "ไม่ระบุ", class: "bg-secondary" };
            const brandModel = [entry.brand, entry.model].filter(Boolean).join(" ");
            const problemShort = (entry.problem || "-").length > 50 ? (entry.problem || "").substring(0, 50) + "..." : (entry.problem || "-");

            htmlContent = `
              <div class="d-flex align-items-start">
                <div class="me-3 mt-1 text-primary"><i class="bi bi-wrench-adjustable-circle fs-5"></i></div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <span class="fw-bold text-dark">งานซ่อม</span> <i class="bi bi-dot"></i> ทะเบียน <span class="fw-semibold">${entry.plate}</span>
                      <span class="badge ${st.class} ms-1 rounded-pill" style="font-size:0.65rem;">${st.text}</span>
                    </div>
                    <div class="text-end ms-2">
                       <span class="fw-bold text-success">${formatNumber(entry.totalAmount)} ฿</span>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mt-1">
                     <div class="text-muted text-truncate me-2" style="max-width: 200px;">
                        ${brandModel ? `<span class="badge bg-light text-secondary border me-1">${brandModel}</span>` : ""}
                        <span>${problemShort}</span>
                     </div>
                     <div class="text-muted text-xs text-nowrap">${dateText}</div>
                  </div>
                </div>
              </div>
            `;
          } else if (entry.kind === "vehicle_buy") {
             htmlContent = `
              <div class="d-flex align-items-start">
                <div class="me-3 mt-1 text-info"><i class="bi bi-truck-front fs-5"></i></div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <span class="fw-bold">ซื้อรถเข้า</span> - ทะเบียน ${entry.plate}
                    </div>
                    <div class="text-end ms-2">
                       <div class="fw-semibold">${dateText}</div>
                    </div>
                  </div>
                   <div class="text-muted mt-1 small">
                    <span class="me-2">${entry.brandModel || "-"}</span> | 
                    ราคาซื้อ: <span class="text-dark fw-medium">${formatNumber(entry.buyPrice)} ฿</span>
                  </div>
                </div>
              </div>
            `;
          } else if (entry.kind === "vehicle_sell") {
             const profitText = typeof entry.profit === "number" ? `<span class="text-success ms-2">(กำไร ${formatNumber(entry.profit)})</span>` : "";
             htmlContent = `
              <div class="d-flex align-items-start">
                <div class="me-3 mt-1 text-success"><i class="bi bi-truck-front-fill fs-5"></i></div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <span class="fw-bold">ขายรถออก</span> - ทะเบียน ${entry.plate}
                    </div>
                    <div class="text-end ms-2">
                       <div class="fw-semibold text-success">${dateText}</div>
                    </div>
                  </div>
                  <div class="text-muted mt-1 small">
                    <span class="me-2">${entry.brandModel || "-"}</span> | 
                    ราคาขาย: <span class="text-dark fw-medium">${formatNumber(entry.sellPrice)} ฿</span>
                    ${profitText}
                  </div>
                </div>
              </div>
            `;
          }

          const footer = `
            <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top text-muted text-xs">
              <div><i class="bi bi-person-circle me-1"></i>${entry.createdByName || "-"}</div>
              <div>${entry.kind === 'job' ? '<i class="bi bi-eye me-1"></i>ดูรายละเอียด' : ''}</div>
            </div>
          `;

          li.innerHTML = htmlContent + footer;
          frag.appendChild(li);
        });

        historyTimeline.appendChild(frag);
      }

      // ============================================================
      // Modal Logic
      // ============================================================
      window.openJobDetail = function(index) {
          const data = currentHistoryData[index];
          if (!data || data.kind !== 'job') return;

          // Populate Header
          document.getElementById('dmDateBadge').textContent = data.rawDate ? formatDateThaiFromString(data.rawDate) : "-";
          
          const statusMap = {
              repairing: { text: "กำลังซ่อม", class: "bg-warning text-dark" },
              done: { text: "ซ่อมเสร็จ", class: "bg-info text-dark" },
              picked_up: { text: "รับรถแล้ว", class: "bg-success text-white" },
              cancel: { text: "ยกเลิก", class: "bg-danger text-white" }
          };
          const st = statusMap[data.status] || { text: data.status, class: "bg-secondary text-white" };
          const badge = document.getElementById('dmStatusBadge');
          badge.textContent = st.text;
          badge.className = "badge " + st.class;

          const brandModel = [data.brand, data.model, data.plate].filter(Boolean).join(" ");
          document.getElementById('dmCarInfo').textContent = brandModel || "ไม่ระบุข้อมูลรถ";
          document.getElementById('dmCustomerName').textContent = data.customerName || "-";
          document.getElementById('dmProblem').textContent = data.problem || "ไม่มีรายละเอียดอาการ";

          // Populate Table
          const tbody = document.getElementById('dmItemsTableBody');
          tbody.innerHTML = "";
          
          if (data.items && data.items.length > 0) {
              data.items.forEach(item => {
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td>${item.name || "รายการ"} <span class="text-muted text-xs d-block">x${item.qty || 1} ${item.unit || ""}</span></td>
                    <td class="text-end">${formatNumber(Number(item.total) || 0)}</td>
                  `;
                  tbody.appendChild(tr);
              });
          } else {
              tbody.innerHTML = `<tr><td colspan="2" class="text-center text-muted py-3">ไม่มีรายการอะไหล่</td></tr>`;
          }

          document.getElementById('dmTotalAmount').textContent = formatNumber(data.totalAmount) + " ฿";
          document.getElementById('dmBy').textContent = data.createdByName || "-";
          document.getElementById('dmTimestamp').textContent = data.createdAt ? formatDateTimeThai(data.createdAt) : "-";

          // Setup Edit Link
          const editBtn = document.getElementById('dmEditLink');
          editBtn.href = `open-bill.html?jobId=${data.id}`;

          detailModal.show();
      };

      // ============================================================
      // Event Listeners
      // ============================================================
      function setupEventListeners() {
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try { await signOut(auth); window.location.href = "index.html"; }
            catch (error) { console.error(error); showToast("ออกจากระบบไม่สำเร็จ", "danger"); }
          });
        }

        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", async () => {
            const current = bodyEl.classList.contains("bm-theme-dark") ? "dark" : "light";
            const next = current === "dark" ? "light" : "dark";
            applyTheme(next);
            if (currentUser?.uid) {
              saveThemeForUser(currentUser.uid, next);
              try { await setDoc(doc(db, "users", currentUser.uid), { theme: next }, { merge: true }); }
              catch (e) {}
            }
          });
        }

        if (searchForm) {
          searchForm.addEventListener("submit", (e) => {
            e.preventDefault();
            searchCustomerHistory(searchKeywordInput.value);
            // Hide keyboard on mobile
            searchKeywordInput.blur();
          });
          resetBtn.addEventListener("click", () => {
            searchKeywordInput.value = "";
            resetView();
            searchKeywordInput.focus();
          });
        }

        // FAB Navigation
        if (fabOpenBillBtn) fabOpenBillBtn.addEventListener("click", () => window.location.href = "open-bill.html");
        if (fabAddTxnBtn) fabAddTxnBtn.addEventListener("click", () => window.location.href = "finance.html");
        if (fabStockInBtn) fabStockInBtn.addEventListener("click", () => window.location.href = "stock.html");
        if (fabAddVehicleBtn) fabAddVehicleBtn.addEventListener("click", () => window.location.href = "vehicles.html");
      }

      // ============================================================
      // Auth & Init
      // ============================================================
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "index.html"; return; }
        currentUser = user;

        try {
          // Check/Create User Profile
          let userProfile = null;
          try {
             userProfile = await ensureUserProfile(user);
          } catch(e) {
             console.log("Profile fetch/create logic fallback");
          }

          if (!userProfile) {
             const snap = await getDoc(doc(db, "users", user.uid));
             if (snap.exists()) userProfile = { id: snap.id, ...snap.data() };
          }

          if (!userProfile) {
            showToast("ไม่พบข้อมูลผู้ใช้", "danger");
            await signOut(auth); return;
          }

          currentUserProfile = userProfile;

          if (currentUserProfile.disabled) {
            await signOut(auth);
            showToast("บัญชีถูกระงับ", "danger");
            window.location.href = "index.html";
            return;
          }

          // Update UI
          if (userDisplayNameText) userDisplayNameText.textContent = currentUserProfile.displayName || "-";
          if (userRoleText) userRoleText.textContent = currentUserProfile.role === "admin" ? "Admin" : "Staff";
          if (userAvatarInitial) userAvatarInitial.textContent = (currentUserProfile.displayName || "U").trim().charAt(0).toUpperCase();
          
          if (settingsMenuItem) settingsMenuItem.classList.toggle("d-none", currentUserProfile.role !== "admin");

          applyTheme(readThemeForUser(user.uid, currentUserProfile.theme));
          setupEventListeners();

          // Auto search if query param exists (e.g. redirected from dashboard)
          const urlParams = new URLSearchParams(window.location.search);
          const q = urlParams.get('q');
          if(q) {
              searchKeywordInput.value = q;
              searchCustomerHistory(q);
          }

        } catch (error) {
          console.error("Init Error:", error);
          showToast("โหลดข้อมูลล้มเหลว: " + error.message, "danger");
        }
      });
    </script>
  </body>
</html>