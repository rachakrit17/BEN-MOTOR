<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – รายงานวิเคราะห์ธุรกิจ (Advanced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="stylesheet" href="css/style.css" />

    <style>
      @media print {
        .bm-topbar, .bm-bottom-nav, .bm-fab-container, #themeToggleBtn, .btn-no-print {
          display: none !important;
        }
        body { padding-top: 0; padding-bottom: 0; background-color: #fff; }
        .bm-main-content { min-height: auto; }
        .card { border: 1px solid #ddd !important; box-shadow: none !important; break-inside: avoid; }
        .nav-pills { display: none !important; }
        .tab-content > .tab-pane { display: block !important; opacity: 1 !important; margin-bottom: 2rem; }
        .bm-chart-container { height: 250px !important; }
      }
    </style>
  </head>

  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>
        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>
          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
            >
              <span class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm" id="userAvatarCircle">
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">Loading...</span><br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
               <li><a class="dropdown-item py-2" href="dashboard.html"><i class="bi bi-speedometer2 me-2"></i> แดชบอร์ด</a></li>
               <li><hr class="dropdown-divider" /></li>
               <li><button class="dropdown-item py-2 text-danger" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ</button></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        
        <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
          <div>
            <h1 class="h5 mb-1 fw-bold text-primary">
              <i class="bi bi-pie-chart-fill me-2"></i>รายงานวิเคราะห์ธุรกิจ
            </h1>
            <p class="small text-muted mb-0">
              วิเคราะห์รายได้, เปรียบเทียบยอดขาย, และพยากรณ์สต๊อก (Full Analytics)
            </p>
          </div>
          <button class="btn btn-outline-dark btn-sm rounded-pill btn-no-print" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> พิมพ์
          </button>
        </div>

        <section class="mb-4 btn-no-print">
          <div class="card border-0 shadow-sm">
            <div class="card-body small">
              <div class="row g-2 align-items-center mb-3">
                <div class="col-12 col-lg-8">
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="fw-semibold text-muted me-1"><i class="bi bi-calendar-range me-1"></i>เลือกช่วงเวลา:</span>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-outline-secondary btn-sm bm-report-range-preset-btn" data-range="today">วันนี้</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm bm-report-range-preset-btn" data-range="yesterday">เมื่อวาน</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm bm-report-range-preset-btn" data-range="7d">7 วัน</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm bm-report-range-preset-btn" data-range="30d">30 วัน</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm bm-report-range-preset-btn" data-range="thisMonth">เดือนนี้</button>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-4 text-lg-end">
                  <span class="badge bg-light text-dark border" id="reportsLoadingState">รอโหลดข้อมูล...</span>
                </div>
              </div>

              <div class="row g-2 align-items-end p-2 bg-light rounded-3 border">
                <div class="col-6 col-md-3">
                  <label class="form-label small mb-1 fw-bold text-muted">เริ่มต้น</label>
                  <input type="date" class="form-control form-control-sm" id="reportStartDateInput" />
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label small mb-1 fw-bold text-muted">สิ้นสุด</label>
                  <input type="date" class="form-control form-control-sm" id="reportEndDateInput" />
                </div>
                <div class="col-12 col-md-6 text-md-end">
                  <button type="button" class="btn btn-primary btn-sm px-4" id="loadReportBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="loadReportSpinner"></span>
                    <span id="loadReportBtnText"><i class="bi bi-search me-1"></i> ประมวลผลรายงาน</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <ul class="nav nav-pills mb-4 nav-fill gap-2 p-1 bg-white rounded-3 shadow-sm border" id="reportTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-pill" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button">
              <i class="bi bi-wallet2 me-1"></i> การเงิน & ภาพรวม
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations-pane" type="button">
              <i class="bi bi-wrench-adjustable me-1"></i> งานซ่อม & ลูกค้า
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-pane" type="button">
              <i class="bi bi-box-seam me-1"></i> สต๊อก & สินค้า
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill" id="profit-tab" data-bs-toggle="tab" data-bs-target="#profit-pane" type="button">
              <i class="bi bi-graph-up-arrow me-1"></i> กำไรสุทธิ
            </button>
          </li>
        </ul>

        <div class="tab-content" id="reportTabsContent">
          
          <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
            <div class="row g-3 mb-4">
              <div class="col-12 col-md-4">
                <div class="card bm-stat-card h-100 border-0 shadow-sm">
                  <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-arrow-down-circle-fill text-success me-2"></i>
                        <span class="text-muted small fw-semibold">รายรับรวม</span>
                      </div>
                      <span class="badge bg-light text-muted border rounded-pill" id="trendIncomeBadge">...%</span>
                    </div>
                    <div class="h3 mb-0 fw-bold text-success" id="reportMoneyIncomeText">0.00 ฿</div>
                    <div class="small text-muted mt-1" id="reportMoneyIncomePrevText">เทียบกับช่วงก่อน: 0.00 ฿</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card bm-stat-card h-100 border-0 shadow-sm">
                  <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-arrow-up-circle-fill text-danger me-2"></i>
                        <span class="text-muted small fw-semibold">รายจ่ายรวม</span>
                      </div>
                      <span class="badge bg-light text-muted border rounded-pill" id="trendExpenseBadge">...%</span>
                    </div>
                    <div class="h3 mb-0 fw-bold text-danger" id="reportMoneyExpenseText">0.00 ฿</div>
                    <div class="small text-muted mt-1" id="reportMoneyExpensePrevText">เทียบกับช่วงก่อน: 0.00 ฿</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card bm-stat-card h-100 border-0 shadow-sm bg-primary-subtle border-primary">
                  <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-wallet2 text-primary me-2"></i>
                        <span class="text-muted small fw-semibold">กระแสเงินสด (Net)</span>
                      </div>
                      <span class="badge bg-white text-primary border rounded-pill" id="trendNetBadge">...%</span>
                    </div>
                    <div class="h3 mb-0 fw-bold text-primary" id="reportMoneyNetText">0.00 ฿</div>
                     <div class="small text-primary text-opacity-75 mt-1" id="reportMoneyNetPrevText">เทียบกับช่วงก่อน: 0.00 ฿</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                   <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-bar-chart-line me-2"></i>แนวโน้มรายรับ-รายจ่ายรายวัน</h6>
                   <div class="btn-group btn-group-sm btn-no-print">
                      <button class="btn btn-outline-success" id="exportReportCsvBtn"><i class="bi bi-filetype-csv me-1"></i> CSV</button>
                      <button class="btn btn-outline-secondary" id="exportReportJsonBtn"><i class="bi bi-filetype-json me-1"></i> JSON</button>
                   </div>
                </div>
                <div class="bm-chart-container" style="position: relative; height: 320px; width: 100%;">
                  <canvas id="incomeExpenseChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="operations-pane" role="tabpanel">
            <div class="row g-4">
              
              <div class="col-12 col-lg-8">
                <h6 class="fw-bold text-dark mb-3"><i class="bi bi-wrench-adjustable-circle me-2"></i>ประสิทธิภาพงานซ่อม</h6>
                <div class="row g-3 mb-4">
                  <div class="col-12 col-md-4">
                    <div class="p-3 bg-white rounded-3 border shadow-sm h-100 text-center">
                      <div class="text-muted small mb-1">จำนวนบิลซ่อม</div>
                      <div class="h3 mb-0 fw-bold text-dark" id="reportJobsCountText">0</div>
                      <div class="text-xs text-muted">บิล</div>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <div class="p-3 bg-white rounded-3 border shadow-sm h-100 text-center">
                      <div class="text-muted small mb-1">รายได้งานซ่อมรวม</div>
                      <div class="h3 mb-0 fw-bold text-warning" id="reportJobsTotalText">0.00</div>
                      <div class="text-xs text-muted">บาท</div>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <div class="p-3 bg-white rounded-3 border shadow-sm h-100 text-center">
                      <div class="text-muted small mb-1">เฉลี่ยต่อบิล</div>
                      <div class="h3 mb-0 fw-bold text-info" id="reportJobsAvgText">0.00</div>
                      <div class="text-xs text-muted">บาท/บิล</div>
                    </div>
                  </div>
                </div>

                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-transparent border-0 pt-3 pb-2">
                    <h6 class="fw-bold mb-0 text-secondary"><i class="bi bi-people-fill me-2"></i>Top 5 ลูกค้าที่มียอดใช้จ่ายสูงสุด</h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0 small">
                        <thead class="bg-light text-secondary">
                          <tr>
                            <th class="ps-3">#</th>
                            <th>ชื่อลูกค้า</th>
                            <th class="text-center">จำนวนบิล</th>
                            <th class="text-end pe-3">ยอดรวม (บาท)</th>
                          </tr>
                        </thead>
                        <tbody id="topCustomersTbody">
                          <tr><td colspan="4" class="text-center text-muted py-3">ไม่มีข้อมูล</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-lg-4">
                 <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                      <h6 class="fw-bold text-center mb-3">โครงสร้างรายได้งานซ่อม</h6>
                      <div style="height: 220px; position: relative;">
                        <canvas id="jobStructureChart"></canvas>
                      </div>
                      <div class="mt-3 small">
                        <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                          <span class="text-muted"><i class="bi bi-circle-fill text-primary me-1" style="font-size: 8px;"></i>ค่าอะไหล่</span>
                          <span class="fw-bold" id="structPartsText">0.00 ฿</span>
                        </div>
                        <div class="d-flex justify-content-between">
                          <span class="text-muted"><i class="bi bi-circle-fill text-warning me-1" style="font-size: 8px;"></i>ค่าแรงช่าง</span>
                          <span class="fw-bold" id="structLaborText">0.00 ฿</span>
                        </div>
                      </div>
                    </div>
                 </div>
              </div>

              <div class="col-12">
                <h6 class="fw-bold text-info mb-3"><i class="bi bi-car-front-fill me-2"></i>สรุปธุรกิจซื้อ-ขายรถ</h6>
                <div class="row g-3">
                  <div class="col-6 col-md-3">
                    <div class="card shadow-sm border-0 bg-info-subtle">
                      <div class="card-body py-2 px-3">
                         <div class="small text-muted">ซื้อเข้า (คัน)</div>
                         <div class="h4 fw-bold text-dark mb-0" id="reportVehiclesBuyCountText">0</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="card shadow-sm border-0 bg-success-subtle">
                      <div class="card-body py-2 px-3">
                         <div class="small text-muted">ขายออก (คัน)</div>
                         <div class="h4 fw-bold text-dark mb-0" id="reportVehiclesSoldCountText">0</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="card shadow-sm border-0 border-start border-4 border-success">
                      <div class="card-body py-2 d-flex align-items-center justify-content-between">
                         <div>
                           <div class="small text-muted fw-bold">กำไรขั้นต้นจากการขายรถ</div>
                           <div class="h4 fw-bold text-success mb-0" id="reportVehiclesProfitText">0.00 ฿</div>
                         </div>
                         <i class="bi bi-cash-stack fs-1 text-success opacity-25"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="tab-pane fade" id="inventory-pane" role="tabpanel">
            
            <div class="card shadow-sm border-0 mb-4">
              <div class="card-header bg-white py-3 border-0">
                <h2 class="h6 fw-bold mb-0 text-primary">
                  <i class="bi bi-graph-down-arrow me-2"></i>พยากรณ์สต๊อก (Inventory Forecasting)
                </h2>
                <p class="text-muted text-xs mb-0 mt-1">
                  คำนวณจากอัตราการใช้เฉลี่ยรายวันในช่วงเวลาที่เลือก เพื่อคาดการณ์ว่าสินค้าจะหมดในกี่วัน
                </p>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                  <table class="table table-hover align-middle mb-0 small">
                    <thead class="bg-light text-secondary sticky-top">
                      <tr>
                        <th class="ps-3">สินค้า</th>
                        <th class="text-end">คงเหลือ</th>
                        <th class="text-end">ใช้วันละ (ชิ้น)</th>
                        <th class="text-center">หมดภายใน (วัน)</th>
                        <th class="text-center pe-3">ความเสี่ยง</th>
                      </tr>
                    </thead>
                    <tbody id="forecastTbody">
                      <tr><td colspan="5" class="text-center py-4 text-muted">กำลังประมวลผล...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-12 col-lg-4">
                 <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-warning bg-opacity-10 py-3 border-0">
                       <h6 class="fw-bold mb-0 text-warning text-dark-emphasis"><i class="bi bi-exclamation-triangle-fill me-2"></i>ของใกล้หมด (< 5 ชิ้น)</h6>
                    </div>
                    <div class="card-body p-0 small">
                       <div class="table-responsive" style="max-height: 300px;">
                          <table class="table table-sm table-hover mb-0">
                             <tbody id="lowStockTbody">
                                <tr><td class="text-center py-3 text-muted">ไม่มีรายการเตือน</td></tr>
                             </tbody>
                          </table>
                       </div>
                    </div>
                 </div>
              </div>

              <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-header bg-danger bg-opacity-10 py-3 border-0">
                    <h6 class="fw-bold mb-0 text-danger"><i class="bi bi-recycle me-2"></i>Dead Stock (>90 วัน)</h6>
                  </div>
                  <div class="card-body p-0 small">
                    <div class="table-responsive" style="max-height: 300px;">
                      <table class="table table-sm table-hover mb-0">
                        <thead class="text-muted">
                           <tr><th class="ps-3">สินค้า</th><th class="text-end pe-3">คงเหลือ</th></tr>
                        </thead>
                        <tbody id="deadStockTbody">
                          <tr><td colspan="2" class="text-center py-3 text-muted">ไม่มีข้อมูล</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-header bg-success bg-opacity-10 py-3 border-0">
                    <h6 class="fw-bold mb-0 text-success"><i class="bi bi-trophy-fill me-2"></i>สินค้าขายดี (Top 10)</h6>
                  </div>
                  <div class="card-body p-0 small">
                    <div class="table-responsive" style="max-height: 300px;">
                      <table class="table table-sm table-hover mb-0">
                        <thead class="text-muted">
                           <tr><th class="ps-3">สินค้า</th><th class="text-end pe-3">ยอดใช้</th></tr>
                        </thead>
                        <tbody id="topSellingTbody">
                          <tr><td colspan="2" class="text-center py-3 text-muted">ไม่มีข้อมูล</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="profit-pane" role="tabpanel">
            <div class="row g-4">
              <div class="col-12 col-md-6">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body d-flex flex-column align-items-center">
                    <h6 class="fw-bold text-secondary mb-3 w-100 text-center">สัดส่วนกำไรสุทธิ (Estimated Profit)</h6>
                    <div style="height: 280px; width: 100%; position: relative;">
                      <canvas id="profitBreakdownChart"></canvas>
                    </div>
                    <div class="mt-3 text-center small text-muted px-4">
                      *เปรียบเทียบระหว่าง: <strong>รายได้งานซ่อม</strong> และ <strong>กำไรจากการขายรถ</strong> (หมายเหตุ: ยังไม่หักค่าใช้จ่ายดำเนินงานอื่นๆ ของร้าน เช่น ค่าน้ำค่าไฟ)
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <div class="d-flex flex-column gap-3 h-100">
                  <div class="card border-0 shadow-sm p-4 bg-white border-start border-4 border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="text-muted small fw-bold">รายได้จากงานซ่อม (Jobs Revenue)</div>
                        <div class="h3 fw-bold text-dark mb-0" id="analysisJobRevenue">0.00 ฿</div>
                        <div class="text-xs text-muted mt-1">จากทั้งหมด <span id="analysisJobCount" class="fw-bold">0</span> บิล</div>
                      </div>
                      <i class="bi bi-wrench-adjustable-circle fs-1 text-warning opacity-25"></i>
                    </div>
                  </div>

                  <div class="card border-0 shadow-sm p-4 bg-white border-start border-4 border-info">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="text-muted small fw-bold">กำไรจากการขายรถ (Vehicles Profit)</div>
                        <div class="h3 fw-bold text-success mb-0" id="analysisVehicleProfit">0.00 ฿</div>
                        <div class="text-xs text-muted mt-1">คำนวณจาก (ราคาขาย - ราคาซื้อ)</div>
                      </div>
                      <i class="bi bi-car-front-fill fs-1 text-info opacity-25"></i>
                    </div>
                  </div>

                  <div class="card border-0 shadow-sm p-3 bg-danger-subtle">
                     <div class="d-flex align-items-center">
                        <i class="bi bi-wallet2 text-danger fs-3 me-3"></i>
                        <div>
                           <div class="small fw-bold text-danger-emphasis">รายจ่ายอื่นๆ (Transactions)</div>
                           <div class="h5 fw-bold text-danger mb-0" id="analysisOtherExpense">0.00 ฿</div>
                           <div class="text-xs text-muted">ค่าใช้จ่ายทั่วไปที่บันทึกในระบบ</div>
                        </div>
                     </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

        </div> <div style="height: 5rem;"></div>
      </div>
    </main>
	<nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col"><a href="dashboard.html" class="bm-bottom-nav-link"><i class="bi bi-speedometer2 d-block fs-5"></i><span>แดชบอร์ด</span></a></div>
          <div class="col"><a href="open-bill.html" class="bm-bottom-nav-link"><i class="bi bi-receipt-cutoff d-block fs-5"></i><span>เปิดบิล</span></a></div>
          <div class="col"><a href="jobs.html" class="bm-bottom-nav-link"><i class="bi bi-wrench-adjustable-circle d-block fs-5"></i><span>งานซ่อม</span></a></div>
          <div class="col"><a href="vehicles.html" class="bm-bottom-nav-link"><i class="bi bi-truck-front d-block fs-5"></i><span>รถรับซื้อ</span></a></div>
          <div class="col"><a href="stock.html" class="bm-bottom-nav-link"><i class="bi bi-box-seam d-block fs-5"></i><span>สต๊อก</span></a></div>
          <div class="col"><a href="finance.html" class="bm-bottom-nav-link"><i class="bi bi-cash-coin d-block fs-5"></i><span>เงินเข้าออก</span></a></div>
        </div>
      </div>
    </nav>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1090;">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
        <div class="d-flex">
          <div class="toast-body fw-medium" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="ปิด"></button>
        </div>
      </div>
    </div>

    <a href="#" id="hiddenDownloadLink" style="display: none;"></a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      
      // Filter Elements
      const reportsLoadingState = document.getElementById("reportsLoadingState");
      const reportStartDateInput = document.getElementById("reportStartDateInput");
      const reportEndDateInput = document.getElementById("reportEndDateInput");
      const loadReportBtn = document.getElementById("loadReportBtn");
      const loadReportSpinner = document.getElementById("loadReportSpinner");
      const loadReportBtnText = document.getElementById("loadReportBtnText");

      // Overview Tab Elements
      const reportMoneyIncomeText = document.getElementById("reportMoneyIncomeText");
      const reportMoneyExpenseText = document.getElementById("reportMoneyExpenseText");
      const reportMoneyNetText = document.getElementById("reportMoneyNetText");
      const reportMoneyIncomePrevText = document.getElementById("reportMoneyIncomePrevText");
      const reportMoneyExpensePrevText = document.getElementById("reportMoneyExpensePrevText");
      const reportMoneyNetPrevText = document.getElementById("reportMoneyNetPrevText");
      const trendIncomeBadge = document.getElementById("trendIncomeBadge");
      const trendExpenseBadge = document.getElementById("trendExpenseBadge");
      const trendNetBadge = document.getElementById("trendNetBadge");
      const exportReportJsonBtn = document.getElementById("exportReportJsonBtn");
      const exportReportCsvBtn = document.getElementById("exportReportCsvBtn");
      const hiddenDownloadLink = document.getElementById("hiddenDownloadLink");

      // Operations Tab Elements
      const reportJobsCountText = document.getElementById("reportJobsCountText");
      const reportJobsTotalText = document.getElementById("reportJobsTotalText");
      const reportJobsAvgText = document.getElementById("reportJobsAvgText");
      const reportVehiclesBuyCountText = document.getElementById("reportVehiclesBuyCountText");
      const reportVehiclesSoldCountText = document.getElementById("reportVehiclesSoldCountText");
      const reportVehiclesProfitText = document.getElementById("reportVehiclesProfitText");
      const structPartsText = document.getElementById("structPartsText");
      const structLaborText = document.getElementById("structLaborText");
      const topCustomersTbody = document.getElementById("topCustomersTbody");

      // Inventory Tab Elements
      const forecastTbody = document.getElementById("forecastTbody");
      const deadStockTbody = document.getElementById("deadStockTbody");
      const lowStockTbody = document.getElementById("lowStockTbody");
      const topSellingTbody = document.getElementById("topSellingTbody");

      // Profit Tab Elements
      const analysisJobRevenue = document.getElementById("analysisJobRevenue");
      const analysisVehicleProfit = document.getElementById("analysisVehicleProfit");
      const analysisOtherExpense = document.getElementById("analysisOtherExpense");
      const analysisJobCount = document.getElementById("analysisJobCount");

      // Chart Canvases
      const incomeExpenseChartCanvas = document.getElementById("incomeExpenseChart");
      const profitBreakdownChartCanvas = document.getElementById("profitBreakdownChart");
      const jobStructureChartCanvas = document.getElementById("jobStructureChart");

      let currentUser = null;
      let chartInstances = {};

      // Data Stores
      let currentData = {
        transactions: [], jobs: [], vehiclesBuy: [], vehiclesSold: [], start: null, end: null
      };
      let previousData = {
        transactions: [], start: null, end: null
      };
      let allStockItems = [];

      // --- Helpers ---
      function showToast(msg, variant="primary") {
        const toastEl = document.getElementById("mainToast");
        const body = document.getElementById("mainToastBody");
        toastEl.className = `toast align-items-center text-bg-${variant} border-0 shadow`;
        body.textContent = msg;
        bootstrap.Toast.getOrCreateInstance(toastEl).show();
      }

      function formatNumber(num) {
        return Number(num || 0).toLocaleString("th-TH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      function formatInt(num) {
        return Number(num || 0).toLocaleString("th-TH", { maximumFractionDigits: 0 });
      }
      function getTodayISO() {
        return new Date().toISOString().split('T')[0];
      }

      function calculateTrend(current, previous) {
        if (!previous || previous === 0) return { percent: 100, isUp: true, text: "+100%" };
        const diff = current - previous;
        const percent = (diff / previous) * 100;
        return { 
           percent: Math.abs(percent).toFixed(1), 
           isUp: percent >= 0, 
           text: (percent >= 0 ? "+" : "") + percent.toFixed(1) + "%" 
        };
      }

function renderTrendBadge(badgeEl, trend, goodIfUp = true) {
         // Base classes (คลาสพื้นฐาน)
         let finalClass = "badge border rounded-pill";
         let iconHtml = "";

         // ตรวจสอบทิศทาง (ขึ้น/ลง) เพื่อเลือกสีและไอคอน
         if (trend.isUp) {
            // ถ้าขึ้น: ดี=สีเขียว / ไม่ดี=สีแดง
            const colorClass = goodIfUp ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger";
            finalClass += " " + colorClass; 
            iconHtml = `<i class="bi bi-arrow-up-short"></i> ${trend.text}`;
         } else {
            // ถ้าลง: ดี=สีแดง / ไม่ดี=สีเขียว (เช่น รายจ่ายลดลงถือว่าดี)
            // *หมายเหตุ: Logic เดิมของคุณกำหนดไว้แบบนี้ (Good if Up)
            // ถ้า GoodIfUp=true แปลว่า "ขึ้นดี" -> ลงไม่ดี (แดง)
            // ถ้า GoodIfUp=false แปลว่า "ขึ้นไม่ดี" (แดง) -> ลงดี (เขียว)
            const colorClass = goodIfUp ? "bg-danger-subtle text-danger" : "bg-success-subtle text-success";
            finalClass += " " + colorClass;
            iconHtml = `<i class="bi bi-arrow-down-short"></i> ${trend.text}`;
         }

         // กำหนดค่ากลับไปที่ Element ทีเดียวจบ (แก้ Error ตรงนี้)
         badgeEl.className = finalClass;
         badgeEl.innerHTML = iconHtml;
      }

      // --- Main Data Loading ---
      async function loadReports(startStr, endStr) {
         if(!currentUser) return;
         setLoading(true);
         
         currentData.start = startStr; currentData.end = endStr;
         
         // Calculate Previous Period
         const d1 = new Date(startStr); const d2 = new Date(endStr);
         const diffTime = Math.abs(d2 - d1);
         const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
         
         const prevEnd = new Date(d1); prevEnd.setDate(prevEnd.getDate() - 1);
         const prevStart = new Date(prevEnd); prevStart.setDate(prevStart.getDate() - diffDays + 1);
         
         previousData.start = prevStart.toISOString().split('T')[0];
         previousData.end = prevEnd.toISOString().split('T')[0];

         try {
            const branchId = (await getDoc(doc(db, "users", currentUser.uid))).data()?.branchId;

            // 1. Fetch Current Data
            const txQuery = query(collection(db, "transactions"), where("isDeleted","==",false), where("date",">=",startStr), where("date","<=",endStr), ...(branchId?[where("branchId","==",branchId)]:[]), orderBy("date","asc"));
            const jobsQuery = query(collection(db, "jobs"), where("isDeleted","==",false), where("date",">=",startStr), where("date","<=",endStr), ...(branchId?[where("branchId","==",branchId)]:[]));
            const vehBuyQuery = query(collection(db, "vehicles"), where("isDeleted","==",false), where("buyDate",">=",startStr), where("buyDate","<=",endStr), ...(branchId?[where("branchId","==",branchId)]:[]));
            const vehSoldQuery = query(collection(db, "vehicles"), where("isDeleted","==",false), where("status","==","sold"), where("sellDate",">=",startStr), where("sellDate","<=",endStr), ...(branchId?[where("branchId","==",branchId)]:[]));
            
            // 2. Fetch Previous Data (Only Transactions for Trend)
            const prevTxQuery = query(collection(db, "transactions"), where("isDeleted","==",false), where("date",">=",previousData.start), where("date","<=",previousData.end), ...(branchId?[where("branchId","==",branchId)]:[]));

            // 3. Fetch Stock (One time)
            const stockQuery = query(collection(db, "stock"), where("isDeleted","==",false), ...(branchId?[where("branchId","==",branchId)]:[]));

            const [txSnap, jobsSnap, vBuySnap, vSoldSnap, prevTxSnap, stockSnap] = await Promise.all([
               getDocs(txQuery), getDocs(jobsQuery), getDocs(vehBuyQuery), getDocs(vehSoldQuery), getDocs(prevTxQuery), getDocs(stockQuery)
            ]);

            currentData.transactions = txSnap.docs.map(d => ({id:d.id, ...d.data()}));
            currentData.jobs = jobsSnap.docs.map(d => ({id:d.id, ...d.data()}));
            currentData.vehiclesBuy = vBuySnap.docs.map(d => ({id:d.id, ...d.data()}));
            currentData.vehiclesSold = vSoldSnap.docs.map(d => ({id:d.id, ...d.data()}));
            
            previousData.transactions = prevTxSnap.docs.map(d => ({id:d.id, ...d.data()}));
            allStockItems = stockSnap.docs.map(d => ({id:d.id, ...d.data()}));

            // Process All Sections
            renderOverview();
            renderOperations();
            renderInventory();
            renderProfit();
            
            showToast("อัปเดตรายงานเรียบร้อย", "success");

         } catch (error) {
            console.error(error);
            showToast("เกิดข้อผิดพลาด: " + error.message, "danger");
         } finally {
            setLoading(false);
         }
      }

      // --- Rendering Logic ---

      function renderOverview() {
         // Current
         let inc = 0, exp = 0;
         const dailyMap = {};
         
         // Init date range
         let curr = new Date(currentData.start);
         const last = new Date(currentData.end);
         while(curr <= last){
            dailyMap[curr.toISOString().split('T')[0]] = { income: 0, expense: 0 };
            curr.setDate(curr.getDate()+1);
         }

         currentData.transactions.forEach(t => {
            const amt = Number(t.amount||0);
            if(t.type === "income") inc += amt; else exp += amt;
            if(dailyMap[t.date]) {
               if(t.type === "income") dailyMap[t.date].income += amt; else dailyMap[t.date].expense += amt;
            }
         });

         // Previous
         let prevInc = 0, prevExp = 0;
         previousData.transactions.forEach(t => {
            if(t.type === "income") prevInc += Number(t.amount||0); else prevExp += Number(t.amount||0);
         });

         // Update UI Stats
         reportMoneyIncomeText.textContent = formatNumber(inc) + " ฿";
         reportMoneyExpenseText.textContent = formatNumber(exp) + " ฿";
         reportMoneyNetText.textContent = formatNumber(inc - exp) + " ฿";

         reportMoneyIncomePrevText.textContent = `เทียบก่อนหน้า: ${formatNumber(prevInc)} ฿`;
         reportMoneyExpensePrevText.textContent = `เทียบก่อนหน้า: ${formatNumber(prevExp)} ฿`;
         reportMoneyNetPrevText.textContent = `เทียบก่อนหน้า: ${formatNumber(prevInc - prevExp)} ฿`;

         // Trends
         renderTrendBadge(trendIncomeBadge, calculateTrend(inc, prevInc), true);
         renderTrendBadge(trendExpenseBadge, calculateTrend(exp, prevExp), false); // Expense up is bad
         renderTrendBadge(trendNetBadge, calculateTrend(inc-exp, prevInc-prevExp), true);

         // Chart
         const labels = Object.keys(dailyMap).sort();
         const dataInc = labels.map(d => dailyMap[d].income);
         const dataExp = labels.map(d => dailyMap[d].expense);

         if(chartInstances.line) chartInstances.line.destroy();
         chartInstances.line = new Chart(incomeExpenseChartCanvas, {
            type: 'bar',
            data: {
               labels: labels.map(d => d.slice(5)), // MM-DD
               datasets: [
                  { label: 'รายรับ', data: dataInc, backgroundColor: '#198754', borderRadius: 3 },
                  { label: 'รายจ่าย', data: dataExp, backgroundColor: '#dc3545', borderRadius: 3 }
               ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'bottom'} }, scales: { x: { grid: {display: false} } } }
         });
      }

      function renderOperations() {
         // Jobs Stats
         const jobs = currentData.jobs;
         let totalJobRev = 0;
         let totalPartsRev = 0;
         let totalLaborRev = 0;
         const customerMap = {};

         jobs.forEach(j => {
            const total = Number(j.totalAmount||0);
            totalJobRev += total;
            
            // Analyze Items for Structure
            if(j.items && Array.isArray(j.items)) {
               j.items.forEach(item => {
                  const lineTotal = (Number(item.price||0) * Number(item.qty||1));
                  // Check if it's labor (assuming 'isLabor' flag or 'Labor' keyword)
				  const itemName = item.name || "";
                  const isLabor = item.isLabor === true || itemName.toLowerCase().includes('ค่าแรง') || item.type === 'labor';
                  if(isLabor) totalLaborRev += lineTotal;
                  else totalPartsRev += lineTotal;
               });
            } else {
               // Fallback if no items: assume 30% labor
               totalPartsRev += total * 0.7;
               totalLaborRev += total * 0.3;
            }

            // Customer Ranking
            const custName = j.customerName || "ลูกค้าทั่วไป";
            if(!customerMap[custName]) customerMap[custName] = { count: 0, total: 0 };
            customerMap[custName].count++;
            customerMap[custName].total += total;
         });

         reportJobsCountText.textContent = formatInt(jobs.length);
         reportJobsTotalText.textContent = formatNumber(totalJobRev);
         reportJobsAvgText.textContent = formatNumber(jobs.length ? totalJobRev/jobs.length : 0);

         // Structure Chart
         structPartsText.textContent = formatNumber(totalPartsRev) + " ฿";
         structLaborText.textContent = formatNumber(totalLaborRev) + " ฿";

         if(chartInstances.struct) chartInstances.struct.destroy();
         chartInstances.struct = new Chart(jobStructureChartCanvas, {
            type: 'doughnut',
            data: {
               labels: ['ค่าอะไหล่', 'ค่าแรง'],
               datasets: [{ data: [totalPartsRev, totalLaborRev], backgroundColor: ['#0d6efd', '#ffc107'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, cutout: '70%' }
         });

         // Top Customers
         const sortedCust = Object.entries(customerMap)
            .sort(([,a], [,b]) => b.total - a.total)
            .slice(0, 5);
         
         topCustomersTbody.innerHTML = "";
         if(sortedCust.length === 0) topCustomersTbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">ไม่มีข้อมูล</td></tr>`;
         sortedCust.forEach(([name, data], idx) => {
            topCustomersTbody.innerHTML += `
               <tr>
                  <td class="ps-3"><span class="badge bg-light text-dark border rounded-circle" style="width:24px;height:24px;display:flex;align-items:center;justify-content:center;">${idx+1}</span></td>
                  <td class="fw-medium">${name}</td>
                  <td class="text-center text-muted">${data.count}</td>
                  <td class="text-end pe-3 fw-bold text-success">${formatNumber(data.total)}</td>
               </tr>`;
         });

         // Vehicles
         let vProfit = 0;
         currentData.vehiclesSold.forEach(v => {
            vProfit += (typeof v.profit === 'number' ? v.profit : (Number(v.sellPrice||0) - Number(v.buyPrice||0)));
         });
         reportVehiclesBuyCountText.textContent = formatInt(currentData.vehiclesBuy.length);
         reportVehiclesSoldCountText.textContent = formatInt(currentData.vehiclesSold.length);
         reportVehiclesProfitText.textContent = formatNumber(vProfit) + " ฿";
      }

      function renderInventory() {
         const usageMap = {};
         currentData.jobs.forEach(j => {
            if(j.items && Array.isArray(j.items)) {
               j.items.forEach(i => {
                  const k = i.stockId || i.stockName;
                  if(k && i.stockId) usageMap[i.stockId] = (usageMap[i.stockId]||0) + Number(i.qty||0);
               });
            }
         });

         // Forecast & Low Stock
         const daysInRange = Math.max(1, Math.ceil(Math.abs(new Date(currentData.end)-new Date(currentData.start))/(1000*60*60*24)));
         const forecastList = [];
         const lowStockList = [];

         allStockItems.forEach(item => {
            const used = usageMap[item.id] || 0;
            const currentQty = Number(item.qty || 0);
            
            // Forecast logic
            if(currentQty > 0 && used > 0) {
               const rate = used / daysInRange;
               const daysLeft = Math.floor(currentQty / rate);
               forecastList.push({ name: item.name, code: item.code, currentQty, rate, daysLeft });
            }

            // Low Stock logic (< 5)
            if(currentQty <= 5 && currentQty > 0) {
               lowStockList.push(item);
            }
         });

         // Render Forecast
         forecastList.sort((a,b) => a.daysLeft - b.daysLeft);
         forecastTbody.innerHTML = "";
         if(forecastList.length===0) forecastTbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">ข้อมูลไม่เพียงพอในการพยากรณ์</td></tr>`;
         forecastList.slice(0, 20).forEach(i => {
            const badge = i.daysLeft<7 ? `<span class="badge bg-danger">วิกฤต</span>` : (i.daysLeft<30 ? `<span class="badge bg-warning text-dark">เฝ้าระวัง</span>` : `<span class="badge bg-success">ปกติ</span>`);
            forecastTbody.innerHTML += `<tr><td class="ps-3"><div class="fw-bold">${i.name}</div><div class="text-xs text-muted">${i.code||""}</div></td><td class="text-end fw-bold">${formatInt(i.currentQty)}</td><td class="text-end small">${i.rate.toFixed(2)}</td><td class="text-center fw-bold text-primary">${i.daysLeft}</td><td class="text-center pe-3">${badge}</td></tr>`;
         });

         // Render Low Stock
         lowStockTbody.innerHTML = "";
         if(lowStockList.length === 0) lowStockTbody.innerHTML = `<tr><td class="text-center py-3 text-success"><i class="bi bi-check-circle me-1"></i> สต๊อกเพียงพอทุกรายการ</td></tr>`;
         lowStockList.forEach(i => {
            lowStockTbody.innerHTML += `<tr><td class="ps-3 d-flex justify-content-between align-items-center"><span>${i.name}</span><span class="badge bg-danger rounded-pill">${i.qty}</span></td></tr>`;
         });

         // Render Dead Stock (>90 days)
         const ninetyDaysAgo = new Date(); ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
         const deadList = allStockItems.filter(i => {
            const lastUpd = i.updatedAt ? i.updatedAt.toDate() : (i.createdAt ? i.createdAt.toDate() : new Date());
            return Number(i.qty) > 0 && lastUpd < ninetyDaysAgo;
         });
         deadStockTbody.innerHTML = "";
         if(deadList.length===0) deadStockTbody.innerHTML = `<tr><td colspan="2" class="text-center py-3 text-success">เยี่ยม! ไม่พบสินค้าค้างนาน</td></tr>`;
         deadList.slice(0, 10).forEach(i => {
            deadStockTbody.innerHTML += `<tr><td class="ps-3 text-truncate" style="max-width: 150px;">${i.name}</td><td class="text-end pe-3 fw-bold text-danger">${i.qty}</td></tr>`;
         });

         // Render Top Selling
         const topList = Object.keys(usageMap).map(id => {
            const item = allStockItems.find(s => s.id === id);
            return { name: item ? item.name : "สินค้าที่ถูกลบ", qty: usageMap[id] };
         }).sort((a,b) => b.qty - a.qty).slice(0, 10);
         
         topSellingTbody.innerHTML = "";
         if(topList.length===0) topSellingTbody.innerHTML = `<tr><td colspan="2" class="text-center py-3 text-muted">ไม่มีข้อมูล</td></tr>`;
         topList.forEach(i => {
             topSellingTbody.innerHTML += `<tr><td class="ps-3 text-truncate" style="max-width: 150px;">${i.name}</td><td class="text-end pe-3 fw-bold text-success">${i.qty}</td></tr>`;
         });
      }

      function renderProfit() {
         let jobRev = 0;
         currentData.jobs.forEach(j => jobRev += Number(j.totalAmount||0));
         
         let vProfit = 0;
         currentData.vehiclesSold.forEach(v => vProfit += (typeof v.profit === 'number' ? v.profit : (Number(v.sellPrice||0) - Number(v.buyPrice||0))));

         let otherExp = 0;
         currentData.transactions.forEach(t => {
            if(t.type === 'expense') otherExp += Number(t.amount||0);
         });

         analysisJobRevenue.textContent = formatNumber(jobRev) + " ฿";
         analysisJobCount.textContent = formatInt(currentData.jobs.length);
         analysisVehicleProfit.textContent = formatNumber(vProfit) + " ฿";
         analysisOtherExpense.textContent = formatNumber(otherExp) + " ฿";

         if(chartInstances.profit) chartInstances.profit.destroy();
         chartInstances.profit = new Chart(profitBreakdownChartCanvas, {
            type: 'pie',
            data: {
               labels: ['รายได้งานซ่อม', 'กำไรขายรถ'],
               datasets: [{
                  data: [jobRev, vProfit],
                  backgroundColor: ['#ffc107', '#0dcaf0'],
                  hoverOffset: 10
               }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
         });
      }

      function setLoading(isLoading) {
         if(isLoading) {
            loadReportSpinner.classList.remove("d-none");
            loadReportBtn.disabled = true;
            reportsLoadingState.textContent = "กำลังประมวลผล...";
            reportsLoadingState.className = "badge bg-warning text-dark border";
         } else {
            loadReportSpinner.classList.add("d-none");
            loadReportBtn.disabled = false;
            reportsLoadingState.textContent = "ข้อมูลล่าสุด";
            reportsLoadingState.className = "badge bg-success text-white border";
         }
      }

      function setDateRange(key) {
         let start = "", end = getTodayISO();
         const d = new Date();
         if(key === "today") { start = end; }
         else if(key === "yesterday") {
            d.setDate(d.getDate() - 1);
            start = end = d.toISOString().split('T')[0];
         } else if(key === "7d") {
            d.setDate(d.getDate() - 6);
            start = d.toISOString().split('T')[0];
         } else if(key === "30d") {
            d.setDate(d.getDate() - 29);
            start = d.toISOString().split('T')[0];
         } else if(key === "thisMonth") {
            start = new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0];
         }
         
         reportStartDateInput.value = start;
         reportEndDateInput.value = end;
         loadReports(start, end);
      }

      // --- Init ---
      onAuthStateChanged(auth, async (user) => {
         if (!user) { window.location.href = "index.html"; return; }
         currentUser = user;

         // Theme
         const t = localStorage.getItem("bm-theme-" + user.uid) || "light";
         bodyEl.classList.add("bm-theme-" + t);

         // Load Profile
         const snap = await getDoc(doc(db, "users", user.uid));
         if(snap.exists()) {
            const d = snap.data();
            document.getElementById("userDisplayNameText").textContent = d.displayName || "User";
            document.getElementById("userAvatarInitial").textContent = (d.displayName||"U").charAt(0).toUpperCase();
            document.getElementById("userRoleText").textContent = d.role === "admin" ? "Admin" : "Staff";
         }

         // Events
         document.querySelectorAll(".bm-report-range-preset-btn").forEach(b => {
            b.addEventListener("click", () => setDateRange(b.dataset.range));
         });
         
         loadReportBtn.addEventListener("click", () => loadReports(reportStartDateInput.value, reportEndDateInput.value));

         if(logoutBtn) logoutBtn.addEventListener("click", () => signOut(auth).then(()=>window.location.href="index.html"));
         if(themeToggleBtn) themeToggleBtn.addEventListener("click", () => {
           const isDark = bodyEl.classList.contains("bm-theme-dark");
           bodyEl.classList.replace("bm-theme-" + (isDark?"dark":"light"), "bm-theme-" + (isDark?"light":"dark"));
           localStorage.setItem("bm-theme-" + user.uid, isDark ? "light" : "dark");
        });

         // Default Load
         setDateRange("30d");
      });
    </script>
  </body>
</html>