<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – เช็คราคาอะไหล่และค่าแรง</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
    <link rel="manifest" href="img/site.webmanifest" />

    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        
        <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
          <div>
            <h1 class="h5 mb-1 fw-bold text-primary">
              <i class="bi bi-tags-fill me-2"></i>เช็คราคาอะไหล่และค่าแรง
            </h1>
            <p class="small text-muted mb-0">
              ใช้ดูราคาทุน (ราคาส่ง), ราคาขาย/เปลี่ยน และค่าแรงเมื่อ ลูกค้านำอะไหล่มาเอง
            </p>
          </div>
          <span
            class="badge text-bg-secondary text-wrap text-center shadow-sm"
            id="priceCheckBranchLabel"
          >
            กำลังโหลดสาขา...
          </span>
        </div>

        <section class="mb-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="row g-3 align-items-center">
                <div class="col-12 col-lg-5">
                  <label for="priceSearchInput" class="form-label small mb-1 fw-bold text-muted">
                    ค้นหาอย่างรวดเร็ว
                  </label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white border-end-0">
                      <i class="bi bi-search text-muted"></i>
                    </span>
                    <input
                      type="search"
                      id="priceSearchInput"
                      class="form-control border-start-0 ps-0"
                      placeholder="พิมพ์ชื่ออะไหล่ / บริการ / รุ่นรถ / รหัส ฯลฯ"
                      autocomplete="off"
                    />
                  </div>
                  <div class="small text-muted mt-1 text-xs">
                    <i class="bi bi-info-circle me-1"></i>ค้นหาจากชื่อ, รายละเอียด, รุ่นรถ, รหัส และหน่วย
                  </div>
                </div>

                <div class="col-6 col-lg-2">
                  <label for="priceTypeFilter" class="form-label small mb-1 fw-bold text-muted">
                    ประเภท
                  </label>
                  <select id="priceTypeFilter" class="form-select form-select-sm">
                    <option value="all">ทั้งหมด</option>
                    <option value="part">อะไหล่</option>
                    <option value="service">บริการซ่อม</option>
                    <option value="combo">ชุดงาน + อะไหล่</option>
                  </select>
                </div>

                <div class="col-6 col-lg-2">
                  <label for="categoryFilter" class="form-label small mb-1 fw-bold text-muted">
                    หมวด
                  </label>
                  <select id="categoryFilter" class="form-select form-select-sm">
                    <option value="all">ทุกหมวด</option>
                  </select>
                </div>

                <div class="col-6 col-lg-1">
                  <label class="form-label small mb-1 d-none d-lg-block fw-bold text-muted">
                    ดึงข้อมูล
                  </label>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary w-100"
                    id="priceReloadBtn"
                    title="รีโหลดข้อมูลล่าสุด"
                  >
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                  <div class="small text-muted mt-1 text-xs text-nowrap" id="reloadStatusLabel"></div>
                </div>

                <div class="col-6 col-lg-2 text-end text-lg-start">
                  <div class="small text-muted mb-1 text-xs">จำนวนรายการ</div>
                  <div class="h5 mb-0 fw-bold text-success">
                    <span id="totalItemCount">0</span> <span class="fs-6 fw-normal text-muted">รายการ</span>
                  </div>
                  <div class="small text-muted mt-1 text-xs">
                    อัปเดต: <span id="lastUpdatedLabel">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="small text-muted">
              <i class="bi bi-shield-lock me-1"></i>เพิ่ม/แก้ไขได้เฉพาะ <span class="fw-semibold">ผู้ดูแลระบบ (Admin)</span>
            </div>
            <button
              type="button"
              class="btn btn-success btn-sm shadow-sm px-3"
              id="openAddPriceModalBtn"
            >
              <i class="bi bi-plus-lg me-1"></i> เพิ่มรายการราคา
            </button>
          </div>
        </section>

        <section>
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive bm-scroll-soft">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light text-muted small">
                    <tr>
                      <th class="ps-3 py-3" style="min-width: 90px;">รหัส</th>
                      <th class="py-3" style="min-width: 170px;">ชื่อรายการ</th>
                      <th class="py-3" style="min-width: 130px;">หมวด / ประเภท</th>
                      <th class="py-3" style="min-width: 110px;">รุ่นรถ / รายละเอียด</th>
                      <th class="text-end py-3 text-secondary" style="min-width: 110px;">ราคาทุน (ส่ง)</th>
                      <th class="text-end py-3 text-primary fw-bold" style="min-width: 110px;">ราคาขาย/เปลี่ยน</th>
                      <th class="text-end py-3 text-info" style="min-width: 120px;">ค่าแรง (ของลูกค้า)</th>
                      <th class="text-nowrap py-3" style="min-width: 80px;">หน่วย</th>
                      <th class="text-end pe-3 py-3" style="min-width: 90px;">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="priceItemsTbody">
                    <tr>
                      <td colspan="9" class="text-center py-5 text-muted">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        กำลังโหลดข้อมูลราคา...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <div class="small text-muted">
                <i class="bi bi-info-circle me-1"></i>หมายเหตุ: ราคาที่แสดงเป็นราคาที่ใช้ในอู่เท่านั้น ยังไม่รวมส่วนลดพิเศษ/โปรโมชั่น
              </div>
            </div>
          </div>
        </section>

        <div style="height: 5rem;"></div>
      </div>
    </main>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="modal fade"
      id="priceItemModal"
      tabindex="-1"
      aria-labelledby="priceItemModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="priceItemModalLabel">
              <i class="bi bi-tag-fill me-2"></i>เพิ่มรายการราคา
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ปิด"
            ></button>
          </div>
          <div class="modal-body">
            <form id="priceItemForm">
              <input type="hidden" id="priceItemId" />

              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label for="modalKind" class="form-label small mb-1 fw-bold text-muted">
                    ประเภท <span class="text-danger">*</span>
                  </label>
                  <select id="modalKind" class="form-select form-select-sm" required>
                    <option value="part">อะไหล่</option>
                    <option value="service">บริการซ่อม</option>
                    <option value="combo">ชุดงาน + อะไหล่</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="modalCategory" class="form-label small mb-1 fw-bold text-muted">
                    หมวด <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    id="modalCategory"
                    class="form-control form-control-sm"
                    placeholder="เช่น ยาง, โซ่สเตอร์"
                    required
                  />
                </div>
                <div class="col-12 col-md-4">
                  <label for="modalCode" class="form-label small mb-1 fw-bold text-muted">
                    รหัส (ถ้ามี)
                  </label>
                  <input
                    type="text"
                    id="modalCode"
                    class="form-control form-control-sm"
                    placeholder="รหัสภายใน / รหัสผู้ขาย"
                  />
                </div>

                <div class="col-12 col-md-6">
                  <label for="modalName" class="form-label small mb-1 fw-bold text-muted">
                    ชื่อรายการ <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    id="modalName"
                    class="form-control form-control-sm"
                    placeholder="เช่น ยางนอก 12 นิ้ว"
                    required
                  />
                </div>
                <div class="col-12 col-md-6">
                  <label for="modalModel" class="form-label small mb-1 fw-bold text-muted">
                    รุ่นรถ / รายละเอียด
                  </label>
                  <input
                    type="text"
                    id="modalModel"
                    class="form-control form-control-sm"
                    placeholder="เช่น Wave, Click, NMax"
                  />
                </div>

                <div class="col-6 col-md-3">
                  <label for="modalUnit" class="form-label small mb-1 fw-bold text-muted">
                    หน่วย <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    id="modalUnit"
                    class="form-control form-control-sm"
                    placeholder="ชิ้น, คัน, ชุด"
                    value="ชิ้น"
                    required
                  />
                </div>
                <div class="col-6 col-md-3">
                  <label for="modalCostPrice" class="form-label small mb-1 fw-bold text-muted">
                    ราคาทุน (ส่ง)
                  </label>
                  <div class="input-group input-group-sm">
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      id="modalCostPrice"
                      class="form-control"
                      placeholder="0.00"
                    />
                    <span class="input-group-text">฿</span>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <label for="modalSellPrice" class="form-label small mb-1 fw-bold text-success">
                    ราคาขาย / เปลี่ยน
                  </label>
                  <div class="input-group input-group-sm">
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      id="modalSellPrice"
                      class="form-control border-success"
                      placeholder="0.00"
                    />
                    <span class="input-group-text bg-success text-white border-success">฿</span>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <label for="modalLaborPrice" class="form-label small mb-1 fw-bold text-info">
                    ค่าแรง (ของลูกค้า)
                  </label>
                  <div class="input-group input-group-sm">
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      id="modalLaborPrice"
                      class="form-control border-info"
                      placeholder="0.00"
                    />
                    <span class="input-group-text bg-info text-white border-info">฿</span>
                  </div>
                </div>

                <div class="col-12">
                  <label for="modalNote" class="form-label small mb-1 fw-bold text-muted">
                    หมายเหตุ (ถ้ามี)
                  </label>
                  <textarea
                    id="modalNote"
                    rows="2"
                    class="form-control form-control-sm"
                    placeholder="รายละเอียดเพิ่มเติม"
                  ></textarea>
                </div>
                <div class="col-12">
                  <div class="alert alert-warning py-2 px-3 small mb-0 d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <div>การแก้ไขราคานี้จะใช้เป็นข้อมูลอ้างอิงทั้งอู่ กรุณาตรวจสอบให้ถูกต้อง</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer d-flex justify-content-between align-items-center bg-light">
            <div class="small text-muted">
              <i class="bi bi-clock-history me-1"></i><span id="modalAuditLabel">–</span>
            </div>
            <div>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm me-1"
                data-bs-dismiss="modal"
              >
                ยกเลิก
              </button>
              <button
                type="button"
                class="btn btn-primary btn-sm px-4"
                id="savePriceItemBtn"
              >
                บันทึกข้อมูล
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1090;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex">
          <div class="toast-body fw-medium" id="mainToastBody">
            </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="ปิด"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      // ============================================================
      // นำเข้า Firebase SDK แบบ ES Module
      // ============================================================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        query,
        where,
        orderBy,
        limit,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ============================================================
      // ตั้งค่า Firebase
      // ============================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ============================================================
      // DOM References
      // ============================================================
      const bodyEl = document.body;

      // Topbar
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // Header & Filter
      const priceCheckBranchLabel = document.getElementById("priceCheckBranchLabel");
      const priceSearchInput = document.getElementById("priceSearchInput");
      const priceTypeFilter = document.getElementById("priceTypeFilter");
      const categoryFilter = document.getElementById("categoryFilter");
      const priceReloadBtn = document.getElementById("priceReloadBtn");
      const reloadStatusLabel = document.getElementById("reloadStatusLabel");
      const totalItemCountEl = document.getElementById("totalItemCount");
      const lastUpdatedLabel = document.getElementById("lastUpdatedLabel");

      // Table
      const priceItemsTbody = document.getElementById("priceItemsTbody");

      // Modal & Form
      const priceItemModalEl = document.getElementById("priceItemModal");
      const priceItemModal = new bootstrap.Modal(priceItemModalEl);
      const priceItemModalLabel = document.getElementById("priceItemModalLabel");
      const priceItemForm = document.getElementById("priceItemForm");

      const priceItemIdInput = document.getElementById("priceItemId");
      const modalKind = document.getElementById("modalKind");
      const modalCategory = document.getElementById("modalCategory");
      const modalCode = document.getElementById("modalCode");
      const modalName = document.getElementById("modalName");
      const modalModel = document.getElementById("modalModel");
      const modalUnit = document.getElementById("modalUnit");
      const modalCostPrice = document.getElementById("modalCostPrice");
      const modalSellPrice = document.getElementById("modalSellPrice");
      const modalLaborPrice = document.getElementById("modalLaborPrice");
      const modalNote = document.getElementById("modalNote");
      const modalAuditLabel = document.getElementById("modalAuditLabel");

      const openAddPriceModalBtn = document.getElementById("openAddPriceModalBtn");
      const savePriceItemBtn = document.getElementById("savePriceItemBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // ============================================================
      // State Variables
      // ============================================================
      let allPriceItems = [];
      let currentUserProfile = null;
      let currentUserAuth = null;
      let isReloading = false;

      const KIND_LABELS = {
        part: "อะไหล่",
        service: "บริการซ่อม",
        combo: "ชุดงาน + อะไหล่",
      };

      // ============================================================
      // Helper Functions
      // ============================================================
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0 shadow";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      function formatNumber(value) {
        const num = typeof value === "number" ? value : Number(value) || 0;
        return num.toLocaleString("th-TH", { maximumFractionDigits: 2 });
      }

      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDateTimeThai(date) {
        if (!date) return "-";
        const thaiMonths = [
          "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
          "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค.",
        ];
        const d = date;
        const year = d.getFullYear() + 543;
        const month = thaiMonths[d.getMonth()];
        const day = d.getDate();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${day} ${month} ${year} ${hh}:${mm} น.`;
      }

      // ============================================================
      // Theme Management
      // ============================================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);

        const icon = themeToggleBtn?.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-sun", normalized === "dark");
          icon.classList.toggle("bi-moon", normalized === "light");
        }
      }

      function saveThemeForUser(uid, theme) {
        if (!uid) return;
        try {
          localStorage.setItem("bm-theme-" + uid, theme);
        } catch (e) {
          console.warn("ไม่สามารถบันทึกธีมใน localStorage ได้", e);
        }
      }

      function readThemeForUser(uid, fallbackTheme) {
        if (!uid) return fallbackTheme || "light";
        try {
          const stored = localStorage.getItem("bm-theme-" + uid);
          return stored || fallbackTheme || "light";
        } catch (e) {
          return fallbackTheme || "light";
        }
      }

      // ============================================================
      // User Profile Logic
      // ============================================================
      async function ensureUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          return { id: snap.id, ...snap.data() };
        }

        const usersCol = collection(db, "users");
        const q = query(usersCol, limit(1));
        const existingSnap = await getDocs(q);

        const isFirstUser = existingSnap.empty;
        const role = isFirstUser ? "admin" : "staff";
        const defaultDisplayName =
          user.displayName || (user.email ? user.email.split("@")[0] : "ผู้ใช้ใหม่");

        const newUserData = {
          displayName: defaultDisplayName,
          role,
          createdAt: serverTimestamp(),
          branchId: null,
          theme: "light",
          disabled: false,
        };

        await setDoc(userRef, newUserData);
        return { id: user.uid, ...newUserData };
      }

      // ============================================================
      // Core Logic: Load Price Items
      // ============================================================
      async function loadPriceItems(userProfile) {
        allPriceItems = [];
        if (totalItemCountEl) totalItemCountEl.textContent = "0";
        if (priceItemsTbody) {
          priceItemsTbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center py-5 text-muted">
                <span class="spinner-border spinner-border-sm me-2"></span>
                กำลังโหลดข้อมูลราคา...
              </td>
            </tr>
          `;
        }

        const constraints = [where("isDeleted", "==", false)];
        if (userProfile.branchId) {
          constraints.push(where("branchId", "==", userProfile.branchId));
        }

        try {
          const priceQuery = query(
            collection(db, "priceItems"),
            ...constraints,
            orderBy("category"),
            orderBy("name")
          );

          const snap = await getDocs(priceQuery);
          let lastUpdated = null;
          const categoriesSet = new Set();

          snap.forEach((docSnap) => {
            const data = docSnap.data();
            const updatedAt =
              data.updatedAt && data.updatedAt.toDate
                ? data.updatedAt.toDate()
                : data.createdAt && data.createdAt.toDate
                ? data.createdAt.toDate()
                : null;

            const item = {
              id: docSnap.id,
              code: data.code || "",
              name: data.name || "-",
              category: data.category || "-",
              kind: data.kind || "part",
              modelInfo: data.modelInfo || data.model || "",
              unit: data.unit || "ชิ้น",
              costPrice: Number(data.costPrice) || 0,
              sellPrice: Number(data.sellPrice) || 0,
              laborPrice: Number(data.laborPrice) || 0,
              note: data.note || "",
              branchId: data.branchId || null,
              createdBy: data.createdBy || "",
              createdByName: data.createdByName || "",
              createdAt:
                data.createdAt && data.createdAt.toDate
                  ? data.createdAt.toDate()
                  : null,
              updatedAt,
            };

            allPriceItems.push(item);
            categoriesSet.add(item.category);

            if (updatedAt) {
              if (!lastUpdated || updatedAt > lastUpdated) {
                lastUpdated = updatedAt;
              }
            }
          });

          updateCategoryFilterOptions(categoriesSet);
          renderPriceTable("", priceTypeFilter.value, categoryFilter.value);

          if (lastUpdatedLabel) {
            lastUpdatedLabel.textContent = lastUpdated
              ? formatDateTimeThai(lastUpdated)
              : "ยังไม่เคยบันทึก";
          }

          if (reloadStatusLabel && isReloading) {
            reloadStatusLabel.textContent = "ดึงข้อมูลสำเร็จ (" + formatDateTimeThai(new Date()) + ")";
          }
        } catch (error) {
          console.error("โหลด priceItems ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถโหลดข้อมูลราคาได้ (" + (error.code || "error") + ")",
            "danger"
          );
          if (priceItemsTbody) {
            priceItemsTbody.innerHTML = `
              <tr>
                <td colspan="9" class="text-center text-danger py-4">
                  ไม่สามารถโหลดข้อมูลราคาได้
                </td>
              </tr>
            `;
          }
        }
      }

      function updateCategoryFilterOptions(categoriesSet) {
        if (!categoryFilter) return;
        const prevValue = categoryFilter.value || "all";
        categoryFilter.innerHTML = "";
        
        const optAll = document.createElement("option");
        optAll.value = "all";
        optAll.textContent = "ทุกหมวด";
        categoryFilter.appendChild(optAll);

        const sortedCategories = Array.from(categoriesSet).sort((a, b) =>
          a.localeCompare(b, "th", { sensitivity: "base" })
        );
        sortedCategories.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          categoryFilter.appendChild(opt);
        });

        if (sortedCategories.includes(prevValue)) {
          categoryFilter.value = prevValue;
        } else {
          categoryFilter.value = "all";
        }
      }

      function renderPriceTable(searchTerm, filterKind, filterCategory) {
        if (!priceItemsTbody) return;

        const term = (searchTerm || "").trim().toLowerCase();
        const kindFilter = filterKind || "all";
        const catFilter = filterCategory || "all";

        let filtered = allPriceItems.slice();

        if (term) {
          filtered = filtered.filter((item) => {
            const haystack = (
              item.name + " " + item.code + " " + item.category + " " + item.modelInfo + " " + item.unit
            ).toLowerCase().normalize("NFC");
            return haystack.includes(term);
          });
        }

        if (kindFilter !== "all") {
          filtered = filtered.filter((item) => item.kind === kindFilter);
        }

        if (catFilter !== "all") {
          filtered = filtered.filter((item) => item.category === catFilter);
        }

        priceItemsTbody.innerHTML = "";

        if (filtered.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td colspan="9" class="text-center py-5 text-muted">
              <i class="bi bi-search d-block fs-4 mb-2"></i>
              ไม่พบรายการที่ตรงกับเงื่อนไข
            </td>
          `;
          priceItemsTbody.appendChild(tr);
        } else {
          filtered.forEach((item) => {
            const tr = document.createElement("tr");
            const canEdit = currentUserProfile?.role === "admin";
            const kindLabel = KIND_LABELS[item.kind] || "-";
            const profitApprox =
              item.sellPrice > 0 && item.costPrice > 0
                ? item.sellPrice - item.costPrice
                : null;
            const codeText = item.code ? escapeHtml(item.code) : "-";

            tr.innerHTML = `
              <td class="small text-nowrap ps-3 text-muted">${codeText}</td>
              <td class="small fw-semibold">
                ${escapeHtml(item.name)}
                ${item.note ? `<div class="text-muted small text-xs mt-1"><i class="bi bi-info-circle me-1"></i>${escapeHtml(item.note)}</div>` : ""}
              </td>
              <td class="small">
                <span class="badge bg-light text-dark border">${escapeHtml(item.category)}</span>
                <div class="small text-muted mt-1">${escapeHtml(kindLabel)}</div>
              </td>
              <td class="small text-secondary">
                ${item.modelInfo ? escapeHtml(item.modelInfo) : "-"}
              </td>
              <td class="small text-end text-muted font-monospace">
                ${item.costPrice > 0 ? formatNumber(item.costPrice) : "-"}
              </td>
              <td class="small text-end fw-bold text-success font-monospace">
                ${item.sellPrice > 0 ? formatNumber(item.sellPrice) : "-"}
                ${profitApprox !== null ? `<div class="text-xs text-muted fw-normal mt-1">(+${formatNumber(profitApprox)})</div>` : ""}
              </td>
              <td class="small text-end text-info font-monospace">
                ${item.laborPrice > 0 ? formatNumber(item.laborPrice) : "-"}
              </td>
              <td class="small text-nowrap text-center">
                ${escapeHtml(item.unit || "ชิ้น")}
              </td>
              <td class="small text-end pe-3">
                ${
                  canEdit
                    ? `<button type="button" class="btn btn-outline-primary btn-sm rounded-circle shadow-sm" style="width: 32px; height: 32px;" data-action="edit-item" data-id="${item.id}" title="แก้ไข"><i class="bi bi-pencil-fill"></i></button>`
                    : `<i class="bi bi-lock text-muted" title="อ่านอย่างเดียว"></i>`
                }
              </td>
            `;
            priceItemsTbody.appendChild(tr);
          });
        }

        if (totalItemCountEl) {
          totalItemCountEl.textContent = String(filtered.length);
        }
      }

      async function reloadPriceItems() {
        if (!currentUserProfile) return;
        if (isReloading) return;
        isReloading = true;
        try {
          if (priceReloadBtn) priceReloadBtn.disabled = true;
          if (reloadStatusLabel) reloadStatusLabel.textContent = "กำลังโหลด...";
          await loadPriceItems(currentUserProfile);
        } catch (error) {
          console.error("รีโหลดราคาไม่สำเร็จ:", error);
          if (reloadStatusLabel) reloadStatusLabel.textContent = "ล้มเหลว";
          showToast("ไม่สามารถดึงข้อมูลล่าสุดได้", "danger");
        } finally {
          isReloading = false;
          if (priceReloadBtn) priceReloadBtn.disabled = false;
        }
      }

      // ============================================================
      // Modal Logic
      // ============================================================
      function resetPriceItemForm() {
        if (!priceItemForm) return;
        priceItemForm.reset();
        priceItemIdInput.value = "";
        modalKind.value = "part";
        modalUnit.value = "ชิ้น";
        modalAuditLabel.textContent = "–";
      }

      function openAddPriceModal() {
        if (!currentUserProfile || currentUserProfile.role !== "admin") {
          showToast("คุณไม่มีสิทธิ์เพิ่มรายการ", "warning");
          return;
        }
        resetPriceItemForm();
        priceItemModalLabel.innerHTML = '<i class="bi bi-plus-circle-fill me-2 text-success"></i>เพิ่มรายการราคาใหม่';
        modalAuditLabel.textContent = "โดย: " + (currentUserProfile.displayName || "-");
        priceItemModal.show();
      }

      function openEditPriceModal(itemId) {
        if (!currentUserProfile || currentUserProfile.role !== "admin") {
          showToast("คุณไม่มีสิทธิ์แก้ไขรายการ", "warning");
          return;
        }
        const item = allPriceItems.find((p) => p.id === itemId);
        if (!item) {
          showToast("ไม่พบรายการราคาที่เลือก", "danger");
          return;
        }
        resetPriceItemForm();
        priceItemModalLabel.innerHTML = '<i class="bi bi-pencil-square me-2 text-primary"></i>แก้ไขรายการราคา';

        priceItemIdInput.value = item.id;
        modalKind.value = item.kind || "part";
        modalCategory.value = item.category || "";
        modalCode.value = item.code || "";
        modalName.value = item.name || "";
        modalModel.value = item.modelInfo || "";
        modalUnit.value = item.unit || "ชิ้น";
        modalCostPrice.value = item.costPrice && item.costPrice > 0 ? item.costPrice : "";
        modalSellPrice.value = item.sellPrice && item.sellPrice > 0 ? item.sellPrice : "";
        modalLaborPrice.value = item.laborPrice && item.laborPrice > 0 ? item.laborPrice : "";
        modalNote.value = item.note || "";

        const auditParts = [];
        if (item.createdByName) auditParts.push("สร้าง: " + item.createdByName);
        if (item.updatedAt) auditParts.push("ล่าสุด: " + formatDateTimeThai(item.updatedAt));
        modalAuditLabel.textContent = auditParts.length > 0 ? auditParts.join(" / ") : "–";

        priceItemModal.show();
      }

      async function savePriceItem() {
        if (!currentUserProfile || currentUserProfile.role !== "admin") {
          showToast("คุณไม่มีสิทธิ์ทำรายการนี้", "warning");
          return;
        }
        if (!priceItemForm.reportValidity()) {
          showToast("กรุณากรอกข้อมูลที่จำเป็นให้ครบ", "warning");
          return;
        }

        const id = priceItemIdInput.value || null;
        const kind = modalKind.value || "part";
        const category = modalCategory.value.trim();
        const code = modalCode.value.trim();
        const name = modalName.value.trim();
        const modelInfo = modalModel.value.trim();
        const unit = modalUnit.value.trim() || "ชิ้น";
        const note = modalNote.value.trim();
        const costPriceNum = Number(modalCostPrice.value || 0);
        const sellPriceNum = Number(modalSellPrice.value || 0);
        const laborPriceNum = Number(modalLaborPrice.value || 0);

        if (!name) { showToast("กรุณากรอกชื่อรายการ", "warning"); return; }
        if (!category) { showToast("กรุณากรอกหมวด", "warning"); return; }
        if (costPriceNum <= 0 && sellPriceNum <= 0 && laborPriceNum <= 0) {
          showToast("กรุณากรอกอย่างน้อย 1 ราคา", "warning");
          return;
        }

        const now = serverTimestamp();
        const dataToSave = {
          code: code || null,
          name, category, kind,
          modelInfo: modelInfo || null,
          unit,
          costPrice: costPriceNum > 0 ? costPriceNum : null,
          sellPrice: sellPriceNum > 0 ? sellPriceNum : null,
          laborPrice: laborPriceNum > 0 ? laborPriceNum : null,
          note: note || null,
          branchId: currentUserProfile.branchId || null,
          isDeleted: false,
          updatedAt: now,
        };

        if (!id) {
          dataToSave.createdAt = now;
          dataToSave.createdBy = currentUserAuth.uid;
          dataToSave.createdByName = currentUserProfile.displayName || currentUserAuth.email || "";
        }

        try {
          savePriceItemBtn.disabled = true;
          savePriceItemBtn.textContent = "กำลังบันทึก...";
          if (id) {
            await updateDoc(doc(db, "priceItems", id), dataToSave);
          } else {
            await addDoc(collection(db, "priceItems"), dataToSave);
          }
          showToast("บันทึกเรียบร้อย", "success");
          priceItemModal.hide();
          await reloadPriceItems();
        } catch (error) {
          console.error("บันทึกไม่สำเร็จ:", error);
          showToast("บันทึกไม่สำเร็จ (" + error.code + ")", "danger");
        } finally {
          savePriceItemBtn.disabled = false;
          savePriceItemBtn.textContent = "บันทึกข้อมูล";
        }
      }

      // ============================================================
      // Event Listeners
      // ============================================================
      function setupEventListeners() {
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              await signOut(auth);
              showToast("ออกจากระบบแล้ว", "success");
              window.location.href = "index.html";
            } catch (error) {
              console.error("Logout error:", error);
            }
          });
        }

        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", async () => {
            const currentTheme = bodyEl.classList.contains("bm-theme-dark") ? "dark" : "light";
            const nextTheme = currentTheme === "dark" ? "light" : "dark";
            applyTheme(nextTheme);
            if (currentUserAuth) {
              saveThemeForUser(currentUserAuth.uid, nextTheme);
              try {
                await setDoc(doc(db, "users", currentUserAuth.uid), { theme: nextTheme }, { merge: true });
              } catch (e) { console.error("Theme update failed", e); }
            }
          });
        }

        if (openAddPriceModalBtn) openAddPriceModalBtn.addEventListener("click", openAddPriceModal);
        if (savePriceItemBtn) savePriceItemBtn.addEventListener("click", savePriceItem);
        if (priceReloadBtn) priceReloadBtn.addEventListener("click", reloadPriceItems);

        if (priceSearchInput) {
          priceSearchInput.addEventListener("input", (e) => {
            renderPriceTable(e.target.value || "", priceTypeFilter?.value || "all", categoryFilter?.value || "all");
          });
        }

        if (priceTypeFilter) {
          priceTypeFilter.addEventListener("change", (e) => {
            renderPriceTable(priceSearchInput?.value || "", e.target.value || "all", categoryFilter?.value || "all");
          });
        }

        if (categoryFilter) {
          categoryFilter.addEventListener("change", (e) => {
            renderPriceTable(priceSearchInput?.value || "", priceTypeFilter?.value || "all", e.target.value || "all");
          });
        }

        if (priceItemsTbody) {
          priceItemsTbody.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-action='edit-item']");
            if (!btn) return;
            const id = btn.getAttribute("data-id");
            if (id) openEditPriceModal(id);
          });
        }
      }

      // ============================================================
      // Auth & Init
      // ============================================================
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        currentUserAuth = user;

        try {
          const userProfile = await ensureUserProfile(user);
          currentUserProfile = userProfile;

          if (userProfile.disabled === true) {
            await signOut(auth);
            showToast("บัญชีถูกระงับ", "danger");
            window.location.href = "index.html";
            return;
          }

          if (userDisplayNameText) userDisplayNameText.textContent = userProfile.displayName || "-";
          if (userRoleText) userRoleText.textContent = userProfile.role === "admin" ? "Admin" : "Staff";
          if (userAvatarInitial) userAvatarInitial.textContent = (userProfile.displayName || "U").trim().charAt(0).toUpperCase();

          if (settingsMenuItem) {
            settingsMenuItem.classList.toggle("d-none", userProfile.role !== "admin");
          }
          if (openAddPriceModalBtn) {
            openAddPriceModalBtn.classList.toggle("d-none", userProfile.role !== "admin");
          }

          if (priceCheckBranchLabel) {
            priceCheckBranchLabel.textContent = userProfile.branchId ? "สาขา: " + userProfile.branchId : "ทุกสาขา";
          }

          const themeToUse = readThemeForUser(user.uid, userProfile.theme || "light");
          applyTheme(themeToUse);

          setupEventListeners();
          await loadPriceItems(userProfile);
        } catch (error) {
          console.error("Init Error:", error);
          showToast("โหลดข้อมูลล้มเหลว", "danger");
        }
      });
    </script>
  </body>
</html>
