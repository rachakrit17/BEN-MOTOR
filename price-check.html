<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – เช็คราคาอะไหล่และค่าแรง (Pro)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="stylesheet" href="css/style.css" />

    <style>
      @media print {
        .bm-topbar, .bm-bottom-nav, .btn-no-print, .no-print-section { display: none !important; }
        body { padding-top: 0; padding-bottom: 0; background-color: #fff; }
        .bm-main-content { min-height: auto; }
        .card { border: none !important; box-shadow: none !important; }
        .table th, .table td { color: #000 !important; }
      }
      .cursor-pointer { cursor: pointer; }
    </style>
  </head>

  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
            >
              <span class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm" id="userAvatarCircle">
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">Loading...</span><br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li><a class="dropdown-item py-2" href="dashboard.html"><i class="bi bi-speedometer2 me-2"></i> แดชบอร์ด</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><button class="dropdown-item py-2 text-danger" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ</button></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        
        <div class="d-flex justify-content-between align-items-center mb-4 mt-4">
          <div>
            <h1 class="h5 mb-1 fw-bold text-primary">
              <i class="bi bi-tags-fill me-2"></i>เช็คราคา & ค่าบริการ
            </h1>
            <p class="small text-muted mb-0">
              ฐานข้อมูลราคากลาง ค้นหาต้นทุน ราคาขาย และคำนวณกำไรเบื้องต้น
            </p>
          </div>
          <div class="d-flex gap-2">
             <button class="btn btn-outline-dark btn-sm rounded-pill btn-no-print" onclick="window.print()">
               <i class="bi bi-printer me-1"></i> พิมพ์
             </button>
             <span class="badge text-bg-light border text-dark shadow-sm d-flex align-items-center" id="priceCheckBranchLabel">
               <span class="spinner-border spinner-border-sm me-1"></span> รอโหลด...
             </span>
          </div>
        </div>

        <section class="mb-3 no-print-section">
           <div class="row g-2">
              <div class="col-6 col-md-3">
                 <div class="card bm-stat-card h-100">
                    <div class="bm-stat-label">รายการทั้งหมด</div>
                    <div class="bm-stat-value text-primary" id="totalItemCount">0</div>
                    <div class="bm-stat-sub text-muted">รายการในระบบ</div>
                 </div>
              </div>
              <div class="col-6 col-md-3">
                 <div class="card bm-stat-card h-100">
                    <div class="bm-stat-label">หมวดหมู่</div>
                    <div class="bm-stat-value text-secondary" id="totalCategoryCount">0</div>
                    <div class="bm-stat-sub text-muted">ประเภทสินค้า</div>
                 </div>
              </div>
              <div class="col-12 col-md-6">
                 <div class="card bm-stat-card h-100 bg-white border-0 shadow-sm d-flex flex-row align-items-center justify-content-between px-4">
                    <div>
                       <div class="fw-bold text-muted small">อัปเดตล่าสุด</div>
                       <div class="h5 mb-0 text-dark" id="lastUpdatedLabel">-</div>
                    </div>
                    <i class="bi bi-clock-history fs-1 text-secondary opacity-25"></i>
                 </div>
              </div>
           </div>
        </section>

        <section class="mb-4 no-print-section">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="row g-3 align-items-end">
                <div class="col-12 col-lg-5">
                  <label class="form-label small mb-1 fw-bold text-muted">ค้นหาด่วน</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="search" id="priceSearchInput" class="form-control border-start-0 ps-0" placeholder="ชื่อ / รหัส / รุ่นรถ / รายละเอียด..." autocomplete="off" />
                    <button class="btn btn-outline-secondary border-start-0" type="button" id="clearSearchBtn" style="border-color: var(--bm-input-border);"><i class="bi bi-x-lg"></i></button>
                  </div>
                </div>

                <div class="col-6 col-lg-2">
                  <label class="form-label small mb-1 fw-bold text-muted">ประเภท</label>
                  <select id="priceTypeFilter" class="form-select form-select-sm">
                    <option value="all">ทั้งหมด</option>
                    <option value="part">อะไหล่</option>
                    <option value="service">บริการซ่อม</option>
                    <option value="combo">ชุดงาน</option>
                  </select>
                </div>

                <div class="col-6 col-lg-2">
                  <label class="form-label small mb-1 fw-bold text-muted">หมวดหมู่</label>
                  <select id="categoryFilter" class="form-select form-select-sm">
                    <option value="all">ทุกหมวด</option>
                  </select>
                </div>

                <div class="col-6 col-lg-2">
                   <label class="form-label small mb-1 fw-bold text-muted">เรียงลำดับ</label>
                   <select id="sortFilter" class="form-select form-select-sm">
                      <option value="name_asc">ชื่อ (ก-ฮ)</option>
                      <option value="price_desc">ราคาขาย (มาก-น้อย)</option>
                      <option value="price_asc">ราคาขาย (น้อย-มาก)</option>
                      <option value="updated_desc">ล่าสุดก่อน</option>
                   </select>
                </div>

                <div class="col-6 col-lg-1">
                  <button type="button" class="btn btn-sm btn-outline-primary w-100" id="priceReloadBtn" title="รีโหลด">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-3 d-flex justify-content-between align-items-center no-print-section">
            <div class="small text-muted">
              <span id="resultCountLabel" class="fw-semibold text-primary">0</span> รายการที่แสดง
            </div>
            <button type="button" class="btn btn-success btn-sm shadow-sm px-3" id="openAddPriceModalBtn">
              <i class="bi bi-plus-lg me-1"></i> เพิ่มรายการ
            </button>
        </section>

        <section>
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive bm-scroll-soft">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light text-muted small">
                    <tr>
                      <th class="ps-3 py-3" style="width: 10%;">รหัส</th>
                      <th class="py-3" style="width: 25%;">ชื่อรายการ</th>
                      <th class="py-3" style="width: 15%;">หมวด/รุ่น</th>
                      <th class="text-end py-3 text-secondary" style="width: 10%;">ทุน (ส่ง)</th>
                      <th class="text-end py-3 text-primary fw-bold" style="width: 12%;">ราคาขาย</th>
                      <th class="text-end py-3 text-info" style="width: 10%;">ค่าแรง</th>
                      <th class="text-center py-3" style="width: 8%;">หน่วย</th>
                      <th class="text-end pe-3 py-3 no-print-section" style="width: 10%;">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="priceItemsTbody">
                    <tr><td colspan="8" class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm me-2"></span>กำลังโหลด...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer bg-transparent border-top-0 no-print-section">
              <div class="d-flex align-items-center gap-3 small text-muted">
                 <span><i class="bi bi-info-circle me-1"></i> GP = กำไรขั้นต้น (Gross Profit)</span>
                 <span><i class="bi bi-clipboard me-1"></i> = คัดลอก</span>
              </div>
            </div>
          </div>
        </section>

        <div style="height: 5rem;"></div>
      </div>
    </main>
	<nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col"><a href="dashboard.html" class="bm-bottom-nav-link"><i class="bi bi-speedometer2 d-block"></i><span>แดชบอร์ด</span></a></div>
          <div class="col"><a href="open-bill.html" class="bm-bottom-nav-link"><i class="bi bi-receipt-cutoff d-block"></i><span>เปิดบิล</span></a></div>
          <div class="col"><a href="jobs.html" class="bm-bottom-nav-link"><i class="bi bi-wrench-adjustable-circle d-block"></i><span>งานซ่อม</span></a></div>
          <div class="col"><a href="vehicles.html" class="bm-bottom-nav-link"><i class="bi bi-truck-front d-block"></i><span>รถรับซื้อ</span></a></div>
          <div class="col"><a href="stock.html" class="bm-bottom-nav-link"><i class="bi bi-box-seam d-block"></i><span>สต๊อก</span></a></div>
          <div class="col"><a href="finance.html" class="bm-bottom-nav-link"><i class="bi bi-cash-coin d-block"></i><span>เงินเข้าออก</span></a></div>
        </div>
      </div>
    </nav>

    <div class="modal fade" id="priceItemModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow border-0">
          <div class="modal-header bg-light">
            <h5 class="modal-title fw-bold text-primary" id="priceItemModalLabel">เพิ่มรายการ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="priceItemForm">
              <input type="hidden" id="priceItemId" />
              
              <div class="row g-3 mb-3">
                <div class="col-md-4">
                  <label class="form-label small fw-bold text-muted">ประเภท <span class="text-danger">*</span></label>
                  <select id="modalKind" class="form-select form-select-sm bg-light">
                    <option value="part">อะไหล่ (Parts)</option>
                    <option value="service">บริการ (Service)</option>
                    <option value="combo">ชุดงาน (Combo)</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label small fw-bold text-muted">หมวดหมู่ <span class="text-danger">*</span></label>
                  <input type="text" id="modalCategory" class="form-control form-control-sm" placeholder="เช่น ยาง, น้ำมันเครื่อง" required list="categoryList" />
                  <datalist id="categoryList"></datalist>
                </div>
                <div class="col-md-4">
                   <label class="form-label small fw-bold text-muted">รหัสสินค้า</label>
                   <input type="text" id="modalCode" class="form-control form-control-sm" placeholder="SKU / Barcode" />
                </div>
              </div>

              <div class="row g-3 mb-4">
                 <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">ชื่อรายการ <span class="text-danger">*</span></label>
                    <input type="text" id="modalName" class="form-control form-control-sm" required placeholder="ชื่อสินค้า/บริการ" />
                 </div>
                 <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">รุ่นรถ / รุ่นที่รองรับ</label>
                    <input type="text" id="modalModel" class="form-control form-control-sm" placeholder="เช่น Wave110i, PCX, ใช้ได้ทั่วไป" />
                 </div>
              </div>

              <div class="p-3 bg-light rounded-3 border mb-3">
                 <div class="row g-3 align-items-end">
                    <div class="col-12 mb-2">
                       <h6 class="fw-bold small text-secondary mb-0"><i class="bi bi-cash-coin me-1"></i>ตั้งราคา & คำนวณกำไร</h6>
                    </div>
                    <div class="col-4 col-md-3">
                       <label class="form-label small fw-bold text-muted">หน่วยนับ</label>
                       <input type="text" id="modalUnit" class="form-control form-control-sm" value="ชิ้น" required />
                    </div>
                    <div class="col-4 col-md-3">
                       <label class="form-label small fw-bold text-secondary">ทุน (บาท)</label>
                       <input type="number" step="0.01" min="0" id="modalCostPrice" class="form-control form-control-sm" placeholder="0.00" />
                    </div>
                    <div class="col-4 col-md-3">
                       <label class="form-label small fw-bold text-success">ราคาขาย (บาท)</label>
                       <input type="number" step="0.01" min="0" id="modalSellPrice" class="form-control form-control-sm border-success" placeholder="0.00" />
                    </div>
                    <div class="col-12 col-md-3">
                       <div class="card bg-white border h-100 d-flex flex-column justify-content-center px-3 py-2">
                          <div class="text-xs text-muted">กำไร (GP)</div>
                          <div class="fw-bold text-success" id="modalMarginDisplay">0.00 ฿ (0%)</div>
                       </div>
                    </div>
                    <div class="col-12">
                       <div class="d-flex align-items-center gap-2 mt-2">
                          <label class="form-label small fw-bold text-info mb-0 text-nowrap">+ ค่าแรงลูกค้า:</label>
                          <input type="number" step="0.01" min="0" id="modalLaborPrice" class="form-control form-control-sm border-info" placeholder="0.00" style="max-width: 120px;" />
                          <span class="text-xs text-muted ms-1">(กรณีลูกค้าหิ้วของมา)</span>
                       </div>
                    </div>
                 </div>
              </div>

              <div class="mb-3">
                 <label class="form-label small fw-bold text-muted">หมายเหตุ</label>
                 <textarea id="modalNote" class="form-control form-control-sm" rows="2" placeholder="รายละเอียดเพิ่มเติม..."></textarea>
              </div>

            </form>
          </div>
          <div class="modal-footer bg-light justify-content-between">
            <div class="small text-muted" id="modalAuditLabel"></div>
            <div>
              <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3 me-1" data-bs-dismiss="modal">ยกเลิก</button>
              <button type="button" class="btn btn-primary btn-sm rounded-pill px-4" id="savePriceItemBtn"><i class="bi bi-save me-1"></i> บันทึก</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content shadow">
          <div class="modal-body text-center pt-4 pb-3">
            <i class="bi bi-exclamation-circle text-danger display-4 mb-3"></i>
            <h5 class="fw-bold">ยืนยันการลบ?</h5>
            <p class="small text-muted mb-0">รายการนี้จะถูกย้ายไปถังขยะ<br>และจะไม่แสดงในการค้นหา</p>
          </div>
          <div class="modal-footer justify-content-center border-0 pb-4">
            <button type="button" class="btn btn-light btn-sm rounded-pill px-3" data-bs-dismiss="modal">ยกเลิก</button>
            <button type="button" class="btn btn-danger btn-sm rounded-pill px-3" id="confirmDeleteBtn">ลบรายการ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1090;">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="d-flex">
          <div class="toast-body fw-medium" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, query, where, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM Elements
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const priceCheckBranchLabel = document.getElementById("priceCheckBranchLabel");

      // Stats & Lists
      const totalItemCountEl = document.getElementById("totalItemCount");
      const totalCategoryCountEl = document.getElementById("totalCategoryCount");
      const lastUpdatedLabel = document.getElementById("lastUpdatedLabel");
      const resultCountLabel = document.getElementById("resultCountLabel");
      const priceItemsTbody = document.getElementById("priceItemsTbody");

      // Filters
      const priceSearchInput = document.getElementById("priceSearchInput");
      const clearSearchBtn = document.getElementById("clearSearchBtn");
      const priceTypeFilter = document.getElementById("priceTypeFilter");
      const categoryFilter = document.getElementById("categoryFilter");
      const sortFilter = document.getElementById("sortFilter");
      const priceReloadBtn = document.getElementById("priceReloadBtn");
      const categoryList = document.getElementById("categoryList");

      // Modals
      const priceItemModal = new bootstrap.Modal(document.getElementById("priceItemModal"));
      const deleteConfirmModal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
      const savePriceItemBtn = document.getElementById("savePriceItemBtn");
      const openAddPriceModalBtn = document.getElementById("openAddPriceModalBtn");

      // Form Inputs
      const priceItemForm = document.getElementById("priceItemForm");
      const priceItemIdInput = document.getElementById("priceItemId");
      const modalKind = document.getElementById("modalKind");
      const modalCategory = document.getElementById("modalCategory");
      const modalCode = document.getElementById("modalCode");
      const modalName = document.getElementById("modalName");
      const modalModel = document.getElementById("modalModel");
      const modalUnit = document.getElementById("modalUnit");
      const modalCostPrice = document.getElementById("modalCostPrice");
      const modalSellPrice = document.getElementById("modalSellPrice");
      const modalLaborPrice = document.getElementById("modalLaborPrice");
      const modalNote = document.getElementById("modalNote");
      const modalMarginDisplay = document.getElementById("modalMarginDisplay");
      const modalAuditLabel = document.getElementById("modalAuditLabel");

      let allPriceItems = [];
      let currentUser = null;
      let deleteTargetId = null;

      // --- Helper Functions ---
      function showToast(msg, variant = "primary") {
         const toastEl = document.getElementById("mainToast");
         toastEl.className = `toast align-items-center text-bg-${variant} border-0 shadow`;
         document.getElementById("mainToastBody").textContent = msg;
         bootstrap.Toast.getOrCreateInstance(toastEl).show();
      }

      function formatNumber(num) {
         return Number(num || 0).toLocaleString("th-TH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function calculateMargin(sell, cost) {
         sell = Number(sell || 0); cost = Number(cost || 0);
         if (sell <= 0) return { profit: 0, percent: 0 };
         const profit = sell - cost;
         const percent = (profit / sell) * 100;
         return { profit, percent };
      }

      function updateModalMargin() {
         const { profit, percent } = calculateMargin(modalSellPrice.value, modalCostPrice.value);
         modalMarginDisplay.textContent = `${formatNumber(profit)} ฿ (${percent.toFixed(1)}%)`;
         modalMarginDisplay.className = percent < 0 ? "fw-bold text-danger" : (percent > 20 ? "fw-bold text-success" : "fw-bold text-warning");
      }

      // --- Data Loading ---
      async function loadData() {
         if (!currentUser) return;
         
         priceReloadBtn.classList.add("disabled");
         priceReloadBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

         try {
            const branchId = currentUser.branchId;
            let q = query(collection(db, "priceItems"), where("isDeleted", "==", false));
            if (branchId) q = query(q, where("branchId", "==", branchId));
            
            // Note: Ordering multiple fields might require index, fetching all then sorting client-side for flexibility
            const snap = await getDocs(q);
            allPriceItems = [];
            const categories = new Set();
            let lastUpdate = null;

            snap.forEach(doc => {
               const d = doc.data();
               const item = { id: doc.id, ...d };
               allPriceItems.push(item);
               if (item.category) categories.add(item.category);
               
               const t = d.updatedAt?.toDate() || d.createdAt?.toDate();
               if (t && (!lastUpdate || t > lastUpdate)) lastUpdate = t;
            });

            // Update UI Stats
            totalItemCountEl.textContent = allPriceItems.length;
            totalCategoryCountEl.textContent = categories.size;
            lastUpdatedLabel.textContent = lastUpdate ? lastUpdate.toLocaleDateString('th-TH') + ' ' + lastUpdate.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : "-";

            // Update Filters
            updateCategorySelects(categories);
            
            // Render
            renderTable();
            showToast("อัปเดตข้อมูลเรียบร้อย", "success");

         } catch (err) {
            console.error(err);
            showToast("โหลดข้อมูลไม่สำเร็จ", "danger");
         } finally {
            priceReloadBtn.classList.remove("disabled");
            priceReloadBtn.innerHTML = `<i class="bi bi-arrow-clockwise"></i>`;
         }
      }

      function updateCategorySelects(categoriesSet) {
         const sorted = Array.from(categoriesSet).sort();
         
         // Filter Dropdown
         const currentFilter = categoryFilter.value;
         categoryFilter.innerHTML = `<option value="all">ทุกหมวด</option>` + sorted.map(c => `<option value="${c}">${c}</option>`).join("");
         categoryFilter.value = currentFilter && sorted.includes(currentFilter) ? currentFilter : "all";

         // Datalist for Modal
         categoryList.innerHTML = sorted.map(c => `<option value="${c}">`).join("");
      }

      function renderTable() {
         const term = priceSearchInput.value.trim().toLowerCase();
         const type = priceTypeFilter.value;
         const cat = categoryFilter.value;
         const sort = sortFilter.value;

         let filtered = allPriceItems.filter(item => {
             const matchTerm = !term || (item.name+item.code+item.modelInfo+item.category).toLowerCase().includes(term);
             const matchType = type === "all" || item.kind === type;
             const matchCat = cat === "all" || item.category === cat;
             return matchTerm && matchType && matchCat;
         });

         // Sorting
         filtered.sort((a, b) => {
             if (sort === 'name_asc') return a.name.localeCompare(b.name, 'th');
             if (sort === 'price_desc') return (b.sellPrice||0) - (a.sellPrice||0);
             if (sort === 'price_asc') return (a.sellPrice||0) - (b.sellPrice||0);
             if (sort === 'updated_desc') {
                 const dA = a.updatedAt?.toDate() || a.createdAt?.toDate() || new Date(0);
                 const dB = b.updatedAt?.toDate() || b.createdAt?.toDate() || new Date(0);
                 return dB - dA;
             }
             return 0;
         });

         resultCountLabel.textContent = filtered.length;
         priceItemsTbody.innerHTML = "";

         if (filtered.length === 0) {
             priceItemsTbody.innerHTML = `<tr><td colspan="8" class="text-center py-5 text-muted">ไม่พบรายการที่ค้นหา</td></tr>`;
             return;
         }

         const isAdmin = currentUser.role === 'admin';
         filtered.forEach(item => {
             const cost = Number(item.costPrice || 0);
             const sell = Number(item.sellPrice || 0);
             const labor = Number(item.laborPrice || 0);
             const { percent } = calculateMargin(sell, cost);
             
             // Margin Badge Logic
             let marginBadge = "";
             if (sell > 0 && cost > 0) {
                if (percent < 0) marginBadge = `<span class="badge bg-danger-subtle text-danger rounded-pill ms-1 text-xs">${percent.toFixed(0)}%</span>`;
                else if (percent > 40) marginBadge = `<span class="badge bg-success-subtle text-success rounded-pill ms-1 text-xs">+${percent.toFixed(0)}%</span>`;
                else marginBadge = `<span class="badge bg-light text-secondary border rounded-pill ms-1 text-xs">+${percent.toFixed(0)}%</span>`;
             }

             const tr = document.createElement("tr");
             tr.innerHTML = `
                <td class="small text-muted font-monospace">${item.code || "-"}</td>
                <td>
                   <div class="fw-semibold small text-truncate" style="max-width: 200px;">${item.name}</div>
                   ${item.note ? `<div class="text-xs text-muted text-truncate" style="max-width: 200px;"><i class="bi bi-info-circle me-1"></i>${item.note}</div>` : ""}
                </td>
                <td>
                   <span class="badge bg-light text-dark border text-xs">${item.category}</span>
                   <div class="text-xs text-muted mt-1">${item.modelInfo || "-"}</div>
                </td>
                <td class="text-end text-secondary small font-monospace">${cost > 0 ? formatNumber(cost) : "-"}</td>
                <td class="text-end">
                   <div class="fw-bold text-success font-monospace">${sell > 0 ? formatNumber(sell) : "-"}</div>
                   ${marginBadge}
                </td>
                <td class="text-end text-info small font-monospace">${labor > 0 ? formatNumber(labor) : "-"}</td>
                <td class="text-center small">${item.unit}</td>
                <td class="text-end pe-3 no-print-section">
                   <button class="btn btn-sm btn-light text-secondary border rounded-circle shadow-sm me-1" onclick="copyItem('${item.id}')" title="คัดลอก"><i class="bi bi-clipboard"></i></button>
                   ${isAdmin ? `
                   <button class="btn btn-sm btn-light text-primary border rounded-circle shadow-sm me-1" onclick="editItem('${item.id}')" title="แก้ไข"><i class="bi bi-pencil-fill"></i></button>
                   <button class="btn btn-sm btn-light text-danger border rounded-circle shadow-sm" onclick="askDelete('${item.id}')" title="ลบ"><i class="bi bi-trash"></i></button>
                   ` : `<i class="bi bi-lock text-muted opacity-50"></i>`}
                </td>
             `;
             priceItemsTbody.appendChild(tr);
         });
      }

      // --- Actions ---
      window.copyItem = (id) => {
         const item = allPriceItems.find(i => i.id === id);
         if (!item) return;
         const text = `${item.name} (${item.modelInfo||""}) ราคา ${formatNumber(item.sellPrice)} บ.`;
         navigator.clipboard.writeText(text).then(() => showToast("คัดลอกแล้ว: " + text, "success"));
      };

      window.editItem = (id) => {
         const item = allPriceItems.find(i => i.id === id);
         if (!item) return;
         
         priceItemIdInput.value = item.id;
         modalKind.value = item.kind || "part";
         modalCategory.value = item.category;
         modalCode.value = item.code || "";
         modalName.value = item.name;
         modalModel.value = item.modelInfo || "";
         modalUnit.value = item.unit || "ชิ้น";
         modalCostPrice.value = item.costPrice > 0 ? item.costPrice : "";
         modalSellPrice.value = item.sellPrice > 0 ? item.sellPrice : "";
         modalLaborPrice.value = item.laborPrice > 0 ? item.laborPrice : "";
         modalNote.value = item.note || "";
         
         document.getElementById("priceItemModalLabel").innerHTML = `<i class="bi bi-pencil-square me-2"></i>แก้ไขรายการ`;
         modalAuditLabel.textContent = `แก้ไขล่าสุด: ${item.updatedAt ? item.updatedAt.toDate().toLocaleDateString('th-TH') : "-"}`;
         
         updateModalMargin();
         priceItemModal.show();
      };

      window.askDelete = (id) => {
         deleteTargetId = id;
         deleteConfirmModal.show();
      };

      // --- Logic ---
      async function saveData() {
         if (!priceItemForm.checkValidity()) {
             priceItemForm.reportValidity();
             return;
         }

         const id = priceItemIdInput.value;
         const now = serverTimestamp();
         const payload = {
            kind: modalKind.value,
            category: modalCategory.value.trim(),
            code: modalCode.value.trim(),
            name: modalName.value.trim(),
            modelInfo: modalModel.value.trim(),
            unit: modalUnit.value.trim(),
            costPrice: Number(modalCostPrice.value) || 0,
            sellPrice: Number(modalSellPrice.value) || 0,
            laborPrice: Number(modalLaborPrice.value) || 0,
            note: modalNote.value.trim(),
            branchId: currentUser.branchId || null,
            isDeleted: false,
            updatedAt: now
         };

         try {
            savePriceItemBtn.disabled = true;
            if (id) {
               await updateDoc(doc(db, "priceItems", id), payload);
            } else {
               payload.createdAt = now;
               payload.createdBy = currentUser.uid;
               await addDoc(collection(db, "priceItems"), payload);
            }
            priceItemModal.hide();
            showToast("บันทึกเรียบร้อย", "success");
            loadData();
         } catch (e) {
            console.error(e);
            showToast("บันทึกไม่สำเร็จ", "danger");
         } finally {
            savePriceItemBtn.disabled = false;
         }
      }

      async function deleteItem() {
         if (!deleteTargetId) return;
         try {
             await updateDoc(doc(db, "priceItems", deleteTargetId), { isDeleted: true, updatedAt: serverTimestamp() });
             deleteConfirmModal.hide();
             showToast("ลบรายการแล้ว", "success");
             loadData();
         } catch(e) {
             showToast("ลบไม่สำเร็จ", "danger");
         }
      }

      // --- Initialization ---
      onAuthStateChanged(auth, async (user) => {
         if (!user) { window.location.href = "index.html"; return; }
         
         // Load User Profile
         const snap = await getDoc(doc(db, "users", user.uid));
         if (snap.exists()) {
             currentUser = { uid: user.uid, ...snap.data() };
             
             // UI Setup
             userDisplayNameText.textContent = currentUser.displayName || "User";
             userRoleText.textContent = currentUser.role === "admin" ? "Admin" : "Staff";
             userAvatarInitial.textContent = (currentUser.displayName || "U")[0].toUpperCase();
             priceCheckBranchLabel.textContent = currentUser.branchId ? `สาขา: ${currentUser.branchId}` : "ทุกสาขา";
             
             // Theme
             const t = localStorage.getItem("bm-theme-" + user.uid) || "light";
             bodyEl.classList.add("bm-theme-" + t);

             // Permissions
             if (currentUser.role !== "admin") {
                 openAddPriceModalBtn.classList.add("d-none");
             }

             loadData();
         } else {
             // Fallback if no profile
             currentUser = { uid: user.uid, role: 'staff' };
             loadData();
         }

         // Events
         logoutBtn?.addEventListener("click", () => signOut(auth).then(()=>window.location.href="index.html"));
         
         themeToggleBtn?.addEventListener("click", () => {
             const isDark = bodyEl.classList.contains("bm-theme-dark");
             bodyEl.classList.replace("bm-theme-" + (isDark?"dark":"light"), "bm-theme-" + (isDark?"light":"dark"));
             localStorage.setItem("bm-theme-" + user.uid, isDark ? "light" : "dark");
         });

         priceSearchInput.addEventListener("input", renderTable);
         clearSearchBtn.addEventListener("click", () => { priceSearchInput.value = ""; renderTable(); });
         [priceTypeFilter, categoryFilter, sortFilter].forEach(el => el.addEventListener("change", renderTable));
         priceReloadBtn.addEventListener("click", loadData);

         openAddPriceModalBtn.addEventListener("click", () => {
             priceItemForm.reset();
             priceItemIdInput.value = "";
             document.getElementById("priceItemModalLabel").innerHTML = `<i class="bi bi-plus-circle me-2"></i>เพิ่มรายการใหม่`;
             modalAuditLabel.textContent = "";
             modalMarginDisplay.textContent = "0.00 ฿ (0%)";
             priceItemModal.show();
         });

         savePriceItemBtn.addEventListener("click", saveData);
         confirmDeleteBtn.addEventListener("click", deleteItem);
         
         // Auto calculate margin in modal
         [modalSellPrice, modalCostPrice].forEach(el => el.addEventListener("input", updateModalMargin));
      });
    </script>
  </body>
</html>