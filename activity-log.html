<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – ประวัติการทำรายการ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
    <link rel="manifest" href="img/site.webmanifest" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold">BEN MOTOR</span>

        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center" id="themeToggleBtn" type="button" aria-label="สลับโหมดธีม">
            <i class="bi bi-moon"></i>
          </button>

          <div class="dropdown">
            <button class="btn btn-sm btn-outline-primary d-flex align-items-center" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle" id="userAvatarCircle">
                <span id="userAvatarInitial">U</span>
              </span>
              <span class="small text-start">
                <span id="userDisplayNameText">กำลังโหลด...</span><br />
                <span class="text-muted small" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="reports.html"><i class="bi bi-graph-up-arrow me-2"></i> รายงานทั้งหมด</a></li>
              <li><a class="dropdown-item" href="price-check.html"><i class="bi bi-tags me-2"></i> เช็คราคา</a></li>
              <li><a class="dropdown-item" href="customer-history.html"><i class="bi bi-person-lines-fill me-2"></i> ประวัติลูกค้า &amp; รถ</a></li>
              <li><a class="dropdown-item" href="activity-log.html"><i class="bi bi-clock-history me-2"></i> ประวัติการทำรายการ</a></li>
              
              <li><a class="dropdown-item d-none" href="settings.html" id="settingsMenuItem"><i class="bi bi-gear me-2"></i> ตั้งค่าระบบ</a></li>
              
              <li><hr class="dropdown-divider" /></li>
              <li><button class="dropdown-item text-danger" type="button" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ</button></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
          <div>
            <h1 class="h5 mb-1 fw-semibold">ประวัติการทำรายการในระบบ</h1>
            <p class="small text-muted mb-0">ตรวจสอบกิจกรรมที่เกิดขึ้นในระบบ ย้อนหลังได้ทั้งหมด</p>
          </div>
          <div>
            <button class="btn btn-outline-secondary btn-sm" type="button" id="refreshLogBtn">
              <i class="bi bi-arrow-clockwise me-1"></i> รีโหลด
            </button>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body py-2">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-3">
                <label class="form-label small mb-1">กลุ่มข้อมูล</label>
                <select class="form-select form-select-sm" id="refTypeFilter">
                  <option value="">ทั้งหมด</option>
                  <option value="job">งานซ่อม (Job)</option>
                  <option value="stock">สต๊อก (Stock)</option>
                  <option value="vehicle">ซื้อ–ขายรถ (Vehicle)</option>
                  <option value="transaction">การเงิน (Finance)</option>
                  <option value="settings">ตั้งค่า (Settings)</option>
                </select>
              </div>
              <div class="col-12 col-md-5">
                <label class="form-label small mb-1">ค้นหา (ข้อความ/ชื่อผู้ใช้)</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchTextInput" placeholder="เช่น ทะเบียนรถ, ชื่อลูกค้า" />
                </div>
              </div>
              <div class="col-12 col-md-4 text-md-end">
                <span class="small text-muted" id="logSummaryText">พร้อมใช้งาน</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead class="table-light small text-muted text-uppercase">
                  <tr>
                    <th style="width: 150px;">วัน-เวลา</th>
                    <th style="width: 140px;">ผู้ทำรายการ</th>
                    <th style="width: 130px;">กิจกรรม</th>
                    <th>รายละเอียด</th>
                    <th style="width: 100px;" class="text-end">Ref ID</th>
                  </tr>
                </thead>
                <tbody id="activityTableBody" class="small">
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                      <span class="spinner-border spinner-border-sm me-2"></span> กำลังโหลดข้อมูล...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer text-center py-2 bg-white border-top-0">
             <button id="loadMoreBtn" class="btn btn-sm btn-link text-decoration-none text-muted w-100 d-none">
                โหลดรายการเพิ่มเติม...
             </button>
          </div>
        </div>
        
        <div style="height: 4.5rem;"></div>
      </div>
    </main>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
        <div class="container-fluid px-0">
          <div class="row g-0 w-100 text-center small">
            <div class="col"><a href="dashboard.html" class="bm-bottom-nav-link"><i class="bi bi-speedometer2 d-block"></i><span>แดชบอร์ด</span></a></div>
            <div class="col"><a href="open-bill.html" class="bm-bottom-nav-link"><i class="bi bi-receipt-cutoff d-block"></i><span>เปิดบิล</span></a></div>
            <div class="col"><a href="jobs.html" class="bm-bottom-nav-link"><i class="bi bi-wrench-adjustable-circle d-block"></i><span>งานซ่อม</span></a></div>
            <div class="col"><a href="vehicles.html" class="bm-bottom-nav-link"><i class="bi bi-truck-front d-block"></i><span>รถรับซื้อ</span></a></div>
            <div class="col"><a href="stock.html" class="bm-bottom-nav-link"><i class="bi bi-box-seam d-block"></i><span>สต๊อก</span></a></div>
            <div class="col"><a href="finance.html" class="bm-bottom-nav-link"><i class="bi bi-cash-coin d-block"></i><span>เงินเข้าออก</span></a></div>
          </div>
        </div>
    </nav>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="d-flex">
          <div class="toast-body" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, getDoc, getDocs, query, orderBy, limit, startAfter, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Config
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM Elements
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      const activityTableBody = document.getElementById("activityTableBody");
      const loadMoreBtn = document.getElementById("loadMoreBtn");
      const refTypeFilter = document.getElementById("refTypeFilter");
      const searchTextInput = document.getElementById("searchTextInput");
      const logSummaryText = document.getElementById("logSummaryText");
      const refreshLogBtn = document.getElementById("refreshLogBtn");
      
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      let currentUser = null;
      let lastVisible = null;
      let isLogsLoading = false;
      const pageSize = 20;

      // ==========================================
      // Badge Configuration (แปลไทย + ใส่สี)
      // ==========================================
      const LOG_TYPES = {
        'job_created':       { text: 'เปิดบิลซ่อม', color: 'bg-primary' },
        'job_updated':       { text: 'อัปเดตงาน',   color: 'bg-info text-dark' },
        'job_deleted':       { text: 'ลบ/ซ่อนงาน',  color: 'bg-danger' },
        'stock_in':          { text: 'รับของเข้า',  color: 'bg-success' },
        'stock_created':     { text: 'เพิ่มสินค้า',  color: 'bg-success' },
        'stock_updated':     { text: 'แก้ไขสินค้า',  color: 'bg-warning text-dark' },
        'stock_deleted':     { text: 'ลบสินค้า',    color: 'bg-danger' },
        'vehicle_buy':       { text: 'รับซื้อรถ',    color: 'bg-primary' },
        'vehicle_sell':      { text: 'ขายรถออก',   color: 'bg-success' },
        'transaction_manual':{ text: 'บันทึกเงิน',   color: 'bg-secondary' },
      };

      // Helper: Toast
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      // Helper: Format Date Thai
      function formatDateTimeThai(date) {
        if (!date) return "-";
        const d = date.getDate();
        const m = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."][date.getMonth()];
        const y = date.getFullYear() + 543;
        const time = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        return `<span class="fw-semibold">${d} ${m} ${y}</span><br/><span class="text-muted small">${time} น.</span>`;
      }

      // Helper: Create Table Row
      function createRow(data) {
        const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : null;
        const typeInfo = LOG_TYPES[data.type] || { text: data.type || 'ทั่วไป', color: 'bg-light text-dark border' };
        const refIdShort = (data.refId || '').length > 6 ? '...' + (data.refId || '').slice(-6) : (data.refId || '-');
        
        return `
          <tr class="align-middle">
            <td>${formatDateTimeThai(createdAt)}</td>
            <td>
                <div class="fw-medium text-dark">${data.createdByName || 'ไม่ระบุ'}</div>
            </td>
            <td>
                <span class="badge ${typeInfo.color} fw-normal px-2 py-1">
                    ${typeInfo.text}
                </span>
            </td>
            <td class="text-wrap" style="max-width: 400px; line-height: 1.4;">
                ${data.message || '-'}
            </td>
            <td class="text-end text-muted font-monospace small">
                ${refIdShort}
            </td>
          </tr>
        `;
      }

      // ==========================================
      // Load Logs Function
      // ==========================================
      async function loadLogs(reset = false) {
        if (isLogsLoading) return;
        isLogsLoading = true;

        if (reset) {
            lastVisible = null;
            activityTableBody.innerHTML = '';
            loadMoreBtn.classList.add('d-none');
            // แสดง Loading ชั่วคราว
            activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm"></span> กำลังโหลด...</td></tr>`;
        } else {
            loadMoreBtn.textContent = "กำลังโหลด...";
            loadMoreBtn.disabled = true;
        }

        try {
            let constraints = [
                orderBy("createdAt", "desc"),
                limit(pageSize)
            ];

            if (refTypeFilter.value) {
                constraints.unshift(where("refType", "==", refTypeFilter.value));
            }

            if (lastVisible) {
                constraints.push(startAfter(lastVisible));
            }

            const q = query(collection(db, "activityLogs"), ...constraints);
            const snapshot = await getDocs(q);

            // ถ้าเป็นการรีเซ็ต ให้ล้าง Loading ออกก่อน
            if (reset) {
                activityTableBody.innerHTML = '';
            }

            if (snapshot.empty) {
                if (reset) {
                    activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-5"><i class="bi bi-inbox fs-4 d-block mb-2"></i>ไม่พบประวัติการทำรายการ</td></tr>`;
                }
                loadMoreBtn.classList.add('d-none');
            } else {
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                let rowsHtml = '';
                
                // Client-side Search Logic (Simple text match)
                const searchText = searchTextInput.value.toLowerCase().trim();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const searchContent = (data.message + " " + data.createdByName + " " + data.type).toLowerCase();
                    
                    if (!searchText || searchContent.includes(searchText)) {
                        rowsHtml += createRow(data);
                    }
                });

                if (rowsHtml) {
                    activityTableBody.insertAdjacentHTML('beforeend', rowsHtml);
                } else if (reset) {
                     activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">ไม่พบข้อมูลที่ค้นหาในหน้านี้</td></tr>`;
                }
                
                // Show/Hide Load More
                if (snapshot.size < pageSize) {
                    loadMoreBtn.classList.add('d-none');
                } else {
                    loadMoreBtn.classList.remove('d-none');
                    loadMoreBtn.textContent = 'โหลดรายการเพิ่มเติม...';
                    loadMoreBtn.disabled = false;
                }
            }
            
            logSummaryText.textContent = `แสดงผลล่าสุด`;

        } catch (error) {
            console.error(error);
            if (reset) activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-3">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            showToast("โหลดข้อมูลไม่สำเร็จ: " + error.message, "danger");
        } finally {
            isLogsLoading = false;
        }
      }

      // ==========================================
      // Theme & User Profile
      // ==========================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);
        themeToggleBtn.querySelector("i").className = normalized === "dark" ? "bi bi-sun" : "bi bi-moon";
      }

      async function loadUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        let profile = {};
        
        if (snap.exists()) {
            profile = snap.data();
        } else {
            // Fallback display
            profile = { displayName: user.displayName || user.email, role: 'staff', theme: 'light' };
        }

        userDisplayNameText.textContent = profile.displayName || user.email;
        userRoleText.textContent = profile.role === 'admin' ? 'ผู้ดูแลระบบ (Admin)' : 'พนักงาน (Staff)';
        userAvatarInitial.textContent = (profile.displayName || 'U').charAt(0).toUpperCase();

        if (settingsMenuItem && profile.role === 'admin') {
            settingsMenuItem.classList.remove('d-none');
        }

        const savedTheme = localStorage.getItem("bm-theme-" + user.uid) || profile.theme || 'light';
        applyTheme(savedTheme);
      }

      // ==========================================
      // Event Listeners
      // ==========================================
      refTypeFilter.addEventListener('change', () => loadLogs(true));
      loadMoreBtn.addEventListener('click', () => loadLogs(false));
      refreshLogBtn.addEventListener('click', () => loadLogs(true));
      
      let searchTimeout;
      searchTextInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
              loadLogs(true);
          }, 500);
      });

      themeToggleBtn.addEventListener("click", async () => {
          const isDark = bodyEl.classList.contains("bm-theme-dark");
          const next = isDark ? "light" : "dark";
          applyTheme(next);
          if (currentUser) {
              localStorage.setItem("bm-theme-" + currentUser.uid, next);
              try {
                  await updateDoc(doc(db, "users", currentUser.uid), { theme: next });
              } catch(e) {}
          }
      });

      logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            window.location.href = "index.html";
        } catch(e) {
            showToast("ออกจากระบบไม่สำเร็จ", "danger");
        }
      });

      // ==========================================
      // Auth Guard
      // ==========================================
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        currentUser = user;
        loadUserProfile(user);
        loadLogs(true);
      });

    </script>
  </body>
</html>

