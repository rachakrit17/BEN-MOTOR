<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – ประวัติการทำรายการ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
    <link rel="manifest" href="img/site.webmanifest" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 mt-3">
          <div class="mb-3 mb-md-0">
            <h1 class="h5 mb-1 fw-bold text-dark">
                <i class="bi bi-clock-history me-2 text-primary"></i>ประวัติการทำรายการในระบบ
            </h1>
            <p class="small text-muted mb-0 ms-1">ตรวจสอบกิจกรรม (Audit Log) ย้อนหลังเพื่อความโปร่งใส</p>
          </div>
          <div>
            <button class="btn btn-outline-secondary btn-sm bg-white" type="button" id="refreshLogBtn">
              <i class="bi bi-arrow-clockwise me-1"></i> รีโหลดข้อมูล
            </button>
          </div>
        </div>

        <div class="bm-filter-bar mb-3">
            <div class="row g-2 align-items-center">
              <div class="col-12 col-md-3">
                <div class="input-group input-group-sm">
                    <label class="input-group-text bg-transparent border-end-0 text-muted" for="refTypeFilter"><i class="bi bi-filter"></i></label>
                    <select class="form-select border-start-0 ps-0" id="refTypeFilter">
                        <option value="">ทุกประเภทรายการ</option>
                        <option value="job">งานซ่อม (Job)</option>
                        <option value="stock">สต๊อก (Stock)</option>
                        <option value="vehicle">ซื้อ–ขายรถ (Vehicle)</option>
                        <option value="transaction">การเงิน (Finance)</option>
                        <option value="settings">ตั้งค่า (Settings)</option>
                    </select>
                </div>
              </div>
              <div class="col-12 col-md-5">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white text-muted border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-1" id="searchTextInput" placeholder="ค้นหา: ทะเบียนรถ, ชื่อลูกค้า, หรือเลขบิล..." />
                </div>
              </div>
              <div class="col-12 col-md-4 text-md-end">
                <span class="badge bg-secondary bg-opacity-10 text-secondary fw-normal px-3 py-2 rounded-pill" id="logSummaryText">
                    <i class="bi bi-check-circle me-1"></i> ระบบพร้อมใช้งาน
                </span>
              </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 overflow-hidden mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle text-nowrap">
                <thead class="table-light text-muted small text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                  <tr>
                    <th class="ps-3 py-3" style="width: 160px;">วัน-เวลา</th>
                    <th class="py-3" style="width: 160px;">ผู้ทำรายการ</th>
                    <th class="py-3" style="width: 140px;">กิจกรรม</th>
                    <th class="py-3">รายละเอียด</th>
                    <th class="pe-3 py-3 text-end" style="width: 120px;">Ref ID</th>
                  </tr>
                </thead>
                <tbody id="activityTableBody" class="small text-secondary">
                  <tr>
                    <td colspan="5" class="text-center text-muted py-5">
                      <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
                      <div class="small">กำลังโหลดข้อมูล...</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="card-footer text-center py-3 bg-white border-top-0">
             <button id="loadMoreBtn" class="btn btn-sm btn-light text-muted rounded-pill px-4 d-none">
                <i class="bi bi-chevron-down me-1"></i> โหลดรายการเพิ่มเติม
             </button>
          </div>
        </div>
        
        <div style="height: 4.5rem;"></div>
      </div>
    </main>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
        <div class="container-fluid px-0">
          <div class="row g-0 w-100 text-center small">
            <div class="col"><a href="dashboard.html" class="bm-bottom-nav-link"><i class="bi bi-speedometer2 d-block"></i><span>แดชบอร์ด</span></a></div>
            <div class="col"><a href="open-bill.html" class="bm-bottom-nav-link"><i class="bi bi-receipt-cutoff d-block"></i><span>เปิดบิล</span></a></div>
            <div class="col"><a href="jobs.html" class="bm-bottom-nav-link"><i class="bi bi-wrench-adjustable-circle d-block"></i><span>งานซ่อม</span></a></div>
            <div class="col"><a href="vehicles.html" class="bm-bottom-nav-link"><i class="bi bi-truck-front d-block"></i><span>รถรับซื้อ</span></a></div>
            <div class="col"><a href="stock.html" class="bm-bottom-nav-link"><i class="bi bi-box-seam d-block"></i><span>สต๊อก</span></a></div>
            <div class="col"><a href="finance.html" class="bm-bottom-nav-link"><i class="bi bi-cash-coin d-block"></i><span>เงินเข้าออก</span></a></div>
          </div>
        </div>
    </nav>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="d-flex">
          <div class="toast-body" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, doc, getDoc, getDocs, query, orderBy, limit, startAfter, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Config
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM Elements
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      const activityTableBody = document.getElementById("activityTableBody");
      const loadMoreBtn = document.getElementById("loadMoreBtn");
      const refTypeFilter = document.getElementById("refTypeFilter");
      const searchTextInput = document.getElementById("searchTextInput");
      const logSummaryText = document.getElementById("logSummaryText");
      const refreshLogBtn = document.getElementById("refreshLogBtn");
      
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      let currentUser = null;
      let lastVisible = null;
      let isLogsLoading = false;
      const pageSize = 20;

      // ==========================================
      // Badge Configuration
      // ==========================================
      const LOG_TYPES = {
        'job_created':       { text: 'เปิดบิลซ่อม', color: 'bg-primary' },
        'job_updated':       { text: 'อัปเดตงาน',   color: 'bg-info text-dark' },
        'job_deleted':       { text: 'ลบ/ซ่อนงาน',  color: 'bg-danger' },
        'stock_in':          { text: 'รับของเข้า',  color: 'bg-success' },
        'stock_created':     { text: 'เพิ่มสินค้า',  color: 'bg-success' },
        'stock_updated':     { text: 'แก้ไขสินค้า',  color: 'bg-warning text-dark' },
        'stock_deleted':     { text: 'ลบสินค้า',    color: 'bg-danger' },
        'vehicle_buy':       { text: 'รับซื้อรถ',    color: 'bg-primary' },
        'vehicle_sell':      { text: 'ขายรถออก',   color: 'bg-success' },
        'transaction_manual':{ text: 'บันทึกเงิน',   color: 'bg-secondary' },
      };

      // Helper: Toast
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className = "toast align-items-center shadow text-bg-" + variant + " border-0";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      // Helper: Format Date Thai
      function formatDateTimeThai(date) {
        if (!date) return "-";
        const d = date.getDate();
        const m = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."][date.getMonth()];
        const y = date.getFullYear() + 543;
        const time = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        return `<div class="d-flex flex-column lh-sm"><span class="fw-semibold text-dark">${d} ${m} ${y}</span><span class="text-muted small" style="font-size: 0.75rem;">${time} น.</span></div>`;
      }

      // Helper: Create Table Row
      function createRow(data) {
        const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : null;
        const typeInfo = LOG_TYPES[data.type] || { text: data.type || 'ทั่วไป', color: 'bg-light text-dark border' };
        const refIdShort = (data.refId || '').length > 8 ? (data.refId || '').slice(0, 8) + '..' : (data.refId || '-');
        
        return `
          <tr class="align-middle">
            <td class="ps-3">${formatDateTimeThai(createdAt)}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="bm-avatar-circle bg-light text-secondary me-2 d-flex align-items-center justify-content-center small fw-bold" style="width: 24px; height: 24px; font-size: 0.7rem;">
                        ${(data.createdByName || 'U').charAt(0).toUpperCase()}
                    </div>
                    <span class="fw-medium text-dark">${data.createdByName || 'ไม่ระบุ'}</span>
                </div>
            </td>
            <td>
                <span class="badge ${typeInfo.color} fw-normal px-2 py-1 rounded-pill bg-opacity-75">
                    ${typeInfo.text}
                </span>
            </td>
            <td class="text-wrap" style="min-width: 200px; max-width: 350px;">
                <span class="d-block lh-sm text-dark">${data.message || '-'}</span>
            </td>
            <td class="text-end pe-3">
                <span class="badge bg-light text-secondary border font-monospace fw-normal">
                   ${refIdShort}
                </span>
            </td>
          </tr>
        `;
      }

      // ==========================================
      // Load Logs Function
      // ==========================================
      async function loadLogs(reset = false) {
        if (isLogsLoading) return;
        isLogsLoading = true;

        if (reset) {
            lastVisible = null;
            activityTableBody.innerHTML = '';
            loadMoreBtn.classList.add('d-none');
            // แสดง Loading
            activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-5"><div class="spinner-border spinner-border-sm text-primary mb-2"></div><div class="small">กำลังโหลดข้อมูล...</div></td></tr>`;
        } else {
            loadMoreBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> กำลังโหลด...`;
            loadMoreBtn.disabled = true;
        }

        try {
            let constraints = [
                orderBy("createdAt", "desc"),
                limit(pageSize)
            ];

            if (refTypeFilter.value) {
                constraints.unshift(where("refType", "==", refTypeFilter.value));
            }

            if (lastVisible) {
                constraints.push(startAfter(lastVisible));
            }

            const q = query(collection(db, "activityLogs"), ...constraints);
            const snapshot = await getDocs(q);

            // Clear loading if reset
            if (reset) {
                activityTableBody.innerHTML = '';
            }

            if (snapshot.empty) {
                if (reset) {
                    activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-5"><i class="bi bi-inbox fs-1 d-block mb-2 text-secondary opacity-25"></i><span class="small">ไม่พบประวัติการทำรายการ</span></td></tr>`;
                }
                loadMoreBtn.classList.add('d-none');
            } else {
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                let rowsHtml = '';
                
                // Client-side Search Logic
                const searchText = searchTextInput.value.toLowerCase().trim();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const searchContent = (data.message + " " + data.createdByName + " " + data.type).toLowerCase();
                    
                    if (!searchText || searchContent.includes(searchText)) {
                        rowsHtml += createRow(data);
                    }
                });

                if (rowsHtml) {
                    activityTableBody.insertAdjacentHTML('beforeend', rowsHtml);
                } else if (reset) {
                     activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-5"><i class="bi bi-search fs-4 d-block mb-2"></i>ไม่พบข้อมูลที่ค้นหา</td></tr>`;
                }
                
                // Show/Hide Load More
                if (snapshot.size < pageSize) {
                    loadMoreBtn.classList.add('d-none');
                } else {
                    loadMoreBtn.classList.remove('d-none');
                    loadMoreBtn.innerHTML = `<i class="bi bi-chevron-down me-1"></i> โหลดรายการเพิ่มเติม`;
                    loadMoreBtn.disabled = false;
                }
            }
            
            if(reset) {
                logSummaryText.innerHTML = `<i class="bi bi-check-circle me-1"></i> แสดงผลล่าสุด`;
                logSummaryText.className = "badge bg-success bg-opacity-10 text-success fw-normal px-3 py-2 rounded-pill";
            }

        } catch (error) {
            console.error(error);
            if (reset) activityTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4"><i class="bi bi-exclamation-circle me-1"></i> เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            showToast("โหลดข้อมูลไม่สำเร็จ: " + error.message, "danger");
        } finally {
            isLogsLoading = false;
        }
      }

      // ==========================================
      // Theme & User Profile
      // ==========================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);
        themeToggleBtn.querySelector("i").className = normalized === "dark" ? "bi bi-sun" : "bi bi-moon";
      }

      async function loadUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        let profile = {};
        
        if (snap.exists()) {
            profile = snap.data();
        } else {
            profile = { displayName: user.displayName || user.email, role: 'staff', theme: 'light' };
        }

        userDisplayNameText.textContent = profile.displayName || user.email;
        userRoleText.textContent = profile.role === 'admin' ? 'Admin' : 'Staff';
        userAvatarInitial.textContent = (profile.displayName || 'U').charAt(0).toUpperCase();

        if (settingsMenuItem && profile.role === 'admin') {
            settingsMenuItem.classList.remove('d-none');
        }

        const savedTheme = localStorage.getItem("bm-theme-" + user.uid) || profile.theme || 'light';
        applyTheme(savedTheme);
      }

      // ==========================================
      // Event Listeners
      // ==========================================
      refTypeFilter.addEventListener('change', () => loadLogs(true));
      loadMoreBtn.addEventListener('click', () => loadLogs(false));
      refreshLogBtn.addEventListener('click', () => loadLogs(true));
      
      let searchTimeout;
      searchTextInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
              loadLogs(true);
          }, 500);
      });

      themeToggleBtn.addEventListener("click", async () => {
          const isDark = bodyEl.classList.contains("bm-theme-dark");
          const next = isDark ? "light" : "dark";
          applyTheme(next);
          if (currentUser) {
              localStorage.setItem("bm-theme-" + currentUser.uid, next);
              try {
                  await updateDoc(doc(db, "users", currentUser.uid), { theme: next });
              } catch(e) {}
          }
      });

      logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            window.location.href = "index.html";
        } catch(e) {
            showToast("ออกจากระบบไม่สำเร็จ", "danger");
        }
      });

      // ==========================================
      // Auth Guard
      // ==========================================
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        currentUser = user;
        loadUserProfile(user);
        loadLogs(true);
      });

    </script>
  </body>
</html>