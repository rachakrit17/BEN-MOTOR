<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – ระบบการเงิน (Full Version)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="manifest" href="img/site.webmanifest">

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bm-theme-light">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-4">
        
        <div class="d-flex justify-content-between align-items-end mb-4 mt-2">
          <div>
            <h1 class="h5 mb-1 fw-bold text-dark">
              <i class="bi bi-wallet2 text-primary me-2"></i>เงินเข้าออก
            </h1>
            <p class="small text-muted mb-0">
              บริหารจัดการกระแสเงินสด วิเคราะห์รายรับรายจ่าย และกราฟแสดงผล
            </p>
          </div>
          <div>
              <button class="btn btn-sm btn-outline-success rounded-pill px-3" id="refreshBtn">
                  <i class="bi bi-arrow-clockwise me-1"></i> รีโหลด
              </button>
          </div>
        </div>

        <section class="mb-4">
          <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body">
              <div class="row g-3 align-items-center mb-3">
                <div class="col-12 col-md-8">
                  <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="text-muted small fw-semibold me-2"><i class="bi bi-calendar3 me-1"></i>เลือกช่วงเวลา:</span>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-secondary bm-range-preset-btn rounded-pill-start" data-range="today" id="rangePresetTodayBtn">วันนี้</button>
                      <button type="button" class="btn btn-outline-secondary bm-range-preset-btn" data-range="7d" id="rangePreset7dBtn">7 วัน</button>
                      <button type="button" class="btn btn-outline-secondary bm-range-preset-btn" data-range="month" id="rangePresetMonthBtn">เดือนนี้</button>
                      <button type="button" class="btn btn-outline-secondary bm-range-preset-btn rounded-pill-end" data-range="year" id="rangePresetYearBtn">ปีนี้</button>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-4 text-md-end">
                  <div class="small" id="transactionsLoadingState">
                    <span class="spinner-grow spinner-grow-sm text-primary me-1" role="status"></span>
                    กำลังโหลด...
                  </div>
                </div>
              </div>

              <div class="row g-2 align-items-end p-3 bg-light rounded-3 border">
                <div class="col-6 col-md-3">
                  <label for="dateRangeStartInput" class="form-label small mb-1 text-muted">เริ่มต้น</label>
                  <input type="date" class="form-control form-control-sm" id="dateRangeStartInput" />
                </div>
                <div class="col-6 col-md-3">
                  <label for="dateRangeEndInput" class="form-label small mb-1 text-muted">สิ้นสุด</label>
                  <input type="date" class="form-control form-control-sm" id="dateRangeEndInput" />
                </div>
                <div class="col-12 col-md-6">
                  <button type="button" class="btn btn-primary btn-sm w-100 w-md-auto px-4 shadow-sm rounded-pill" id="applyDateRangeBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="applyDateRangeSpinner"></span>
                    <i class="bi bi-search me-2"></i><span id="applyDateRangeBtnText">ดูรายงาน</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-4">
          <div class="row g-3">
            <div class="col-6 col-md-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0">
                <div class="card-body py-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="text-muted small">รายรับ</div>
                      <div class="text-success opacity-50"><i class="bi bi-arrow-down-circle-fill fs-5"></i></div>
                  </div>
                  <div class="h5 mb-0 fw-bold text-success" id="summaryIncomeText">0.00 ฿</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small">รายจ่าย</div>
                        <div class="text-danger opacity-50"><i class="bi bi-arrow-up-circle-fill fs-5"></i></div>
                    </div>
                  <div class="h5 mb-0 fw-bold text-danger" id="summaryExpenseText">0.00 ฿</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small">กำไรสุทธิ (ช่วงที่เลือก)</div>
                        <div class="text-primary opacity-50"><i class="bi bi-graph-up-arrow fs-5"></i></div>
                    </div>
                  <div class="h5 mb-0 fw-bold" id="summaryNetText">0.00 ฿</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bm-stat-card h-100 shadow-sm border-0 bg-primary-subtle border-primary">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-muted small">คงเหลือทั้งหมด (Real-time)</div>
                        <div class="text-dark opacity-50"><i class="bi bi-wallet2 fs-5"></i></div>
                    </div>
                  <div class="h5 mb-0 fw-bold text-primary" id="summaryBalanceText">0.00 ฿</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-4">
            <div class="row g-3">
                <div class="col-12 col-lg-8">
                   <div class="card shadow-sm border-0 rounded-4 h-100">
                      <div class="card-body">
                         <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-bar-chart-line me-2"></i>แนวโน้มการเงิน</h6>
                         <div class="bm-chart-container" style="height: 250px;">
                            <canvas id="financeChart"></canvas>
                         </div>
                      </div>
                   </div>
                </div>
                <div class="col-12 col-lg-4">
                   <div class="card shadow-sm border-0 rounded-4 h-100">
                       <div class="card-body">
                           <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-pie-chart me-2"></i>ค่าใช้จ่ายสูงสุด (Top 5)</h6>
                           <ul class="list-group list-group-flush small" id="topExpenseList">
                               <li class="list-group-item text-center text-muted py-4">ไม่มีข้อมูลรายจ่าย</li>
                           </ul>
                       </div>
                   </div>
                </div>
            </div>
        </section>

        <section class="mb-4">
          <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-transparent border-bottom-0 pt-3 pb-0">
                <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center fw-semibold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseManualForm" aria-expanded="true">
                  <i class="bi bi-pencil-square me-2"></i> เพิ่มรายการเงิน (Manual)
                  <i class="bi bi-chevron-down ms-2 small"></i>
                </button>
            </div>
            <div class="collapse show" id="collapseManualForm">
              <div class="card-body">
                <form id="manualTxnForm" class="row g-3">
                  <div class="col-6 col-md-3">
                    <label class="form-label small mb-1 text-muted">วันที่</label>
                    <input type="date" class="form-control" id="manualDateInput" required />
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label small mb-1 text-muted">ประเภท</label>
                    <select class="form-select" id="manualTypeSelect" required>
                      <option value="income" selected>รายรับ (+)</option>
                      <option value="expense">รายจ่าย (-)</option>
                    </select>
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label small mb-1 text-muted">หมวดหมู่</label>
                    <select class="form-select" id="manualCategorySelect" required>
                      <option value="ค่าซ่อม">ค่าซ่อม</option>
                      <option value="ขายรถ">ขายรถ</option>
                      <option value="ซื้ออะไหล่">ซื้ออะไหล่</option>
                      <option value="ค่าเช่า">ค่าเช่า</option>
                      <option value="ค่าน้ำไฟ">ค่าน้ำไฟ</option>
                      <option value="เงินเดือน">เงินเดือน</option>
                      <option value="อาหาร/เครื่องดื่ม">อาหาร/เครื่องดื่ม</option>
                      <option value="การตลาด">การตลาด</option>
                      <option value="ขนส่ง">ขนส่ง</option>
                      <option value="อื่น ๆ">อื่น ๆ</option>
                    </select>
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label small mb-1 text-muted">วิธีชำระ</label>
                    <select class="form-select" id="manualMethodSelect" required>
                      <option value="cash" selected>เงินสด</option>
                      <option value="transfer">โอน</option>
                      <option value="credit">เครดิต</option>
                    </select>
                  </div>
                  
                  <div class="col-12 col-md-6">
                    <label class="form-label small mb-1 text-muted">รายละเอียดเพิ่มเติม</label>
                    <input type="text" class="form-control" id="manualDescriptionInput" placeholder="เช่น จ่ายค่าเช่าอู่, รับเงินมัดจำ" required />
                  </div>
                  <div class="col-12 col-md-4">
                    <label class="form-label small mb-1 fw-bold text-dark">จำนวนเงิน (บาท)</label>
                    <div class="input-group">
                      <input type="number" min="0" step="0.01" class="form-control border-primary" id="manualAmountInput" placeholder="0.00" required />
                      <span class="input-group-text bg-white border-primary text-primary">฿</span>
                    </div>
                    <div class="d-flex gap-1 mt-1">
                      <button type="button" class="btn btn-outline-secondary bm-quick-amount-btn flex-fill" data-amount="100">+100</button>
                      <button type="button" class="btn btn-outline-secondary bm-quick-amount-btn flex-fill" data-amount="500">+500</button>
                      <button type="button" class="btn btn-outline-secondary bm-quick-amount-btn flex-fill" data-amount="1000">+1k</button>
                    </div>
                  </div>
                  
                  <div class="col-12 col-md-2 d-flex align-items-start pt-md-4 mt-1">
                    <button type="submit" class="btn btn-primary w-100 shadow-sm" id="manualTxnSaveBtn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" id="manualTxnSaveSpinner"></span>
                      <i class="bi bi-save2 me-2"></i>บันทึก
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </section>

        <section class="mb-3">
          <div class="card shadow-sm border-0 overflow-hidden rounded-4">
            <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                <h3 class="h6 fw-bold mb-0 text-secondary">
                    <i class="bi bi-list-ul me-2"></i>รายการเคลื่อนไหว
                </h3>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-success btn-sm rounded-pill" id="exportJsonBtn">
                    <i class="bi bi-filetype-json me-1"></i> JSON
                  </button>
                  <button type="button" class="btn btn-outline-success btn-sm rounded-pill" id="exportCsvBtn">
                    <i class="bi bi-filetype-csv me-1"></i> CSV
                  </button>
                </div>
            </div>
            
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                      <th class="ps-3 py-3" style="min-width: 100px;">วันที่</th>
                      <th class="py-3" style="min-width: 90px;">ประเภท</th>
                      <th class="py-3" style="min-width: 120px;">หมวดหมู่</th>
                      <th class="py-3" style="min-width: 200px;">รายละเอียด</th>
                      <th class="py-3 text-end" style="min-width: 120px;">จำนวนเงิน</th>
                      <th class="py-3 text-center" style="min-width: 80px;">วิธี</th>
                      <th class="py-3 text-muted text-center" style="min-width: 80px;">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody" class="border-top-0">
                    </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center py-3">
                <div class="small text-muted d-none" id="transactionsCountInfo">
                  รวม <span id="transactionsCountNumber" class="fw-bold">0</span> รายการ
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm d-none ms-auto rounded-pill px-3" id="loadMoreTransactionsBtn">
                  <span class="spinner-border spinner-border-sm me-2 d-none" id="loadMoreTransactionsSpinner"></span>
                  <span id="loadMoreTransactionsBtnText">โหลดเพิ่ม</span> <i class="bi bi-chevron-down ms-1"></i>
                </button>
            </div>
          </div>
        </section>

        <div style="height: 4.5rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow-lg border-0" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabOpenBillBtn">
              <i class="bi bi-receipt-cutoff me-3 text-primary"></i> เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2 fw-semibold" type="button" id="fabAddTxnBtn">
              <i class="bi bi-cash-coin me-3 text-success"></i> เพิ่มรายการเงิน
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center py-2" type="button" id="fabStockInBtn">
              <i class="bi bi-box-seam me-3 text-warning"></i> บันทึกซื้ออะไหล่
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link active">
              <i class="bi bi-cash-coin d-block"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="modal fade" id="editTxnModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow border-0 rounded-4">
          <div class="modal-header border-bottom-0">
             <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2 text-warning"></i>แก้ไขรายการ</h5>
             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
             <form id="editTxnForm">
                <input type="hidden" id="editTxnId">
                <div class="mb-2">
                   <label class="form-label small text-muted">วันที่</label>
                   <input type="date" class="form-control" id="editTxnDate" required>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label small text-muted">ประเภท</label>
                        <select class="form-select" id="editTxnType">
                            <option value="income">รายรับ</option>
                            <option value="expense">รายจ่าย</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">หมวดหมู่</label>
                        <select class="form-select" id="editTxnCategory">
                             <option value="ค่าซ่อม">ค่าซ่อม</option>
                             <option value="ขายรถ">ขายรถ</option>
                             <option value="ซื้ออะไหล่">ซื้ออะไหล่</option>
                             <option value="ค่าเช่า">ค่าเช่า</option>
                             <option value="ค่าน้ำไฟ">ค่าน้ำไฟ</option>
                             <option value="เงินเดือน">เงินเดือน</option>
                             <option value="อาหาร/เครื่องดื่ม">อาหาร/เครื่องดื่ม</option>
                             <option value="การตลาด">การตลาด</option>
                             <option value="ขนส่ง">ขนส่ง</option>
                             <option value="อื่น ๆ">อื่น ๆ</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label small text-muted">รายละเอียด</label>
                    <input type="text" class="form-control" id="editTxnDesc" required>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">จำนวนเงิน</label>
                    <input type="number" step="0.01" class="form-control" id="editTxnAmount" required>
                </div>
             </form>
          </div>
          <div class="modal-footer border-top-0 pt-0">
             <button type="button" class="btn btn-secondary btn-sm rounded-pill px-4" data-bs-dismiss="modal">ยกเลิก</button>
             <button type="button" class="btn btn-primary btn-sm rounded-pill px-4" id="saveEditTxnBtn">
                <span class="spinner-border spinner-border-sm me-2 d-none" id="saveEditTxnSpinner"></span>
                บันทึกการแก้ไข
             </button>
          </div>
        </div>
      </div>
    </div>

    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1090;">
      <div id="mainToast" class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
        <div class="d-flex px-2">
          <div class="toast-body d-flex align-items-center" id="mainToastBody"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="ปิด"></button>
        </div>
      </div>
    </div>
    <a href="#" id="hiddenDownloadLink" style="display: none;"></a>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc,
        query, where, orderBy, limit, startAfter, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      
      const transactionsLoadingState = document.getElementById("transactionsLoadingState");
      const dateRangeStartInput = document.getElementById("dateRangeStartInput");
      const dateRangeEndInput = document.getElementById("dateRangeEndInput");
      const applyDateRangeBtn = document.getElementById("applyDateRangeBtn");
      const applyDateRangeSpinner = document.getElementById("applyDateRangeSpinner");
      const refreshBtn = document.getElementById("refreshBtn");

      // Stats
      const summaryIncomeText = document.getElementById("summaryIncomeText");
      const summaryExpenseText = document.getElementById("summaryExpenseText");
      const summaryNetText = document.getElementById("summaryNetText");
      const summaryBalanceText = document.getElementById("summaryBalanceText");
      const topExpenseList = document.getElementById("topExpenseList");

      // Chart
      const chartCanvas = document.getElementById("financeChart");
      let financeChartInstance = null;

      // Manual Form
      const manualTxnForm = document.getElementById("manualTxnForm");
      const manualDateInput = document.getElementById("manualDateInput");
      const manualTypeSelect = document.getElementById("manualTypeSelect");
      const manualCategorySelect = document.getElementById("manualCategorySelect");
      const manualMethodSelect = document.getElementById("manualMethodSelect");
      const manualDescriptionInput = document.getElementById("manualDescriptionInput");
      const manualAmountInput = document.getElementById("manualAmountInput");
      const manualTxnSaveBtn = document.getElementById("manualTxnSaveBtn");
      const manualTxnSaveSpinner = document.getElementById("manualTxnSaveSpinner");
      const manualQuickButtons = document.querySelectorAll(".bm-quick-amount-btn");

      // Edit Modal
      const editTxnModal = new bootstrap.Modal(document.getElementById("editTxnModal"));
      const editTxnId = document.getElementById("editTxnId");
      const editTxnDate = document.getElementById("editTxnDate");
      const editTxnType = document.getElementById("editTxnType");
      const editTxnCategory = document.getElementById("editTxnCategory");
      const editTxnDesc = document.getElementById("editTxnDesc");
      const editTxnAmount = document.getElementById("editTxnAmount");
      const saveEditTxnBtn = document.getElementById("saveEditTxnBtn");
      const saveEditTxnSpinner = document.getElementById("saveEditTxnSpinner");

      // Table & FAB
      const transactionsTableBody = document.getElementById("transactionsTableBody");
      const loadMoreTransactionsBtn = document.getElementById("loadMoreTransactionsBtn");
      const transactionsCountInfo = document.getElementById("transactionsCountInfo");
      const transactionsCountNumber = document.getElementById("transactionsCountNumber");
      
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      const exportJsonBtn = document.getElementById("exportJsonBtn");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // --- State ---
      let currentUser = null;
      let currentUserProfile = null;
      let txnRangeStartDate = null;
      let txnRangeEndDate = null;
      const TXN_PAGE_SIZE = 40;
      let lastVisibleTxn = null;
      let isLoadingTransactions = false;
      let transactionsInRange = [];
      let isSavingManualTxn = false;

      // --- Helpers ---
      function showToast(message, variant = "primary") {
         mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0 shadow-lg rounded-pill";
         mainToastBody.innerHTML = message;
         mainToast.show();
      }
      function formatNumber(val) {
         return (typeof val === "number" && !isNaN(val)) ? val.toLocaleString("th-TH", {minimumFractionDigits:2, maximumFractionDigits:2}) : "0.00";
      }
      function getTodayISO() {
         return new Date().toISOString().split("T")[0];
      }
      function formatDateThai(dateStr) {
        if (!dateStr) return "-";
        const [y, m, d] = dateStr.split("-").map(Number);
        const months = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
        return `${d} ${months[m-1]} ${y+543}`;
      }
      function applyTheme(theme) {
         bodyEl.className = theme === "dark" ? "bm-theme-dark" : "bm-theme-light";
         themeToggleBtn.querySelector("i").className = theme === "dark" ? "bi bi-sun fs-5" : "bi bi-moon fs-5";
         if(financeChartInstance) updateChartTheme(theme);
      }

      // --- Chart Logic ---
      function renderChart(data) {
         // Group data by date
         const dates = {};
         data.forEach(txn => {
            if(!dates[txn.date]) dates[txn.date] = { income: 0, expense: 0 };
            if(txn.type === 'income') dates[txn.date].income += Number(txn.amount);
            else dates[txn.date].expense += Number(txn.amount);
         });

         // Sort dates
         const sortedKeys = Object.keys(dates).sort();
         const labels = sortedKeys.map(d => formatDateThai(d));
         const incomeData = sortedKeys.map(k => dates[k].income);
         const expenseData = sortedKeys.map(k => dates[k].expense);

         if(financeChartInstance) {
            financeChartInstance.destroy();
         }

         const ctx = chartCanvas.getContext('2d');
         financeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
               labels: labels,
               datasets: [
                  {
                     label: 'รายรับ',
                     data: incomeData,
                     backgroundColor: 'rgba(34, 197, 94, 0.7)',
                     borderColor: '#16a34a',
                     borderWidth: 1,
                     borderRadius: 4
                  },
                  {
                     label: 'รายจ่าย',
                     data: expenseData,
                     backgroundColor: 'rgba(239, 68, 68, 0.7)',
                     borderColor: '#dc2626',
                     borderWidth: 1,
                     borderRadius: 4
                  }
               ]
            },
            options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                  legend: { position: 'top' },
                  tooltip: { mode: 'index', intersect: false }
               },
               scales: {
                  y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                  x: { grid: { display: false } }
               }
            }
         });
      }

      function updateChartTheme(theme) {
         // Placeholder for advanced chart theme switching if needed
      }

      function renderTopExpenses() {
          const catMap = {};
          transactionsInRange.filter(t => t.type === 'expense').forEach(t => {
              const cat = t.category || "อื่นๆ";
              catMap[cat] = (catMap[cat] || 0) + Number(t.amount);
          });
          
          const sortedCats = Object.entries(catMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
          topExpenseList.innerHTML = "";
          
          if(sortedCats.length === 0) {
              topExpenseList.innerHTML = `<li class="list-group-item text-center text-muted py-4">ไม่มีข้อมูลรายจ่าย</li>`;
          } else {
              const maxVal = sortedCats[0][1];
              sortedCats.forEach(([cat, val]) => {
                  const pct = (val / maxVal) * 100;
                  topExpenseList.innerHTML += `
                     <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div class="w-100">
                           <div class="d-flex justify-content-between mb-1">
                              <span class="fw-medium text-dark">${cat}</span>
                              <span class="text-danger fw-bold">${formatNumber(val)}</span>
                           </div>
                           <div class="progress" style="height: 6px;">
                              <div class="progress-bar bg-danger" role="progressbar" style="width: ${pct}%" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
                           </div>
                        </div>
                     </li>
                  `;
              });
          }
      }

      // --- Stats & Table ---
      function renderTable() {
         transactionsTableBody.innerHTML = "";
         if(transactionsInRange.length === 0) {
            transactionsTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">ไม่พบรายการในช่วงนี้</td></tr>`;
            return;
         }

         let income = 0, expense = 0;
         transactionsInRange.forEach(txn => {
            if(txn.type === 'income') income += Number(txn.amount);
            else expense += Number(txn.amount);

            const isInc = txn.type === 'income';
            const tr = document.createElement("tr");
            tr.innerHTML = `
               <td class="ps-3 text-muted small text-nowrap">${formatDateThai(txn.date)}</td>
               <td class="small"><span class="badge ${isInc ? 'bg-success-subtle text-success border-success-subtle' : 'bg-danger-subtle text-danger border-danger-subtle'} border">${isInc ? 'รายรับ' : 'รายจ่าย'}</span></td>
               <td class="small"><span class="badge bg-light text-dark border fw-normal">${txn.category}</span></td>
               <td class="small text-dark text-truncate" style="max-width: 200px;">${txn.description}</td>
               <td class="text-end fw-bold ${isInc ? 'text-success' : 'text-danger'}">${isInc ? '+' : '-'}${formatNumber(txn.amount)}</td>
               <td class="text-center small text-muted">${txn.method === 'transfer' ? 'โอน' : 'สด'}</td>
               <td class="text-center">
                   <div class="btn-group btn-group-sm">
                      <button class="btn btn-light border text-warning edit-txn-btn" data-id="${txn.id}"><i class="bi bi-pencil"></i></button>
                      <button class="btn btn-light border text-danger delete-txn-btn" data-id="${txn.id}"><i class="bi bi-trash"></i></button>
                   </div>
               </td>
            `;
            transactionsTableBody.appendChild(tr);
         });

         // Update Summary Cards
         summaryIncomeText.textContent = formatNumber(income) + " ฿";
         summaryExpenseText.textContent = formatNumber(expense) + " ฿";
         const net = income - expense;
         summaryNetText.textContent = (net >= 0 ? "+" : "") + formatNumber(net) + " ฿";
         summaryNetText.className = "h5 mb-0 fw-bold " + (net >= 0 ? "text-success" : "text-danger");
         
         // Update Counts
         if(transactionsCountInfo) {
             transactionsCountInfo.classList.remove("d-none");
             transactionsCountNumber.textContent = transactionsInRange.length;
         }

         // Render Chart & Analysis
         renderChart(transactionsInRange);
         renderTopExpenses();
      }

      async function loadBalance() {
          try {
              const constraints = [where("isDeleted", "==", false)];
              if(currentUserProfile.branchId) constraints.push(where("branchId", "==", currentUserProfile.branchId));
              const q = query(collection(db, "transactions"), ...constraints);
              const snap = await getDocs(q);
              let total = 0;
              snap.forEach(d => {
                  const val = d.data();
                  if(val.type === 'income') total += Number(val.amount);
                  else total -= Number(val.amount);
              });
              summaryBalanceText.textContent = formatNumber(total) + " ฿";
          } catch(e) { console.error(e); }
      }

      async function loadTransactions(reset = false) {
         if(isLoadingTransactions) return;
         if(!currentUserProfile) return;

         // Default Range Today
         if(!txnRangeStartDate) {
             txnRangeStartDate = getTodayISO();
             txnRangeEndDate = getTodayISO();
             dateRangeStartInput.value = txnRangeStartDate;
             dateRangeEndInput.value = txnRangeEndDate;
         }

         if(reset) {
             transactionsInRange = [];
             lastVisibleTxn = null;
         }

         isLoadingTransactions = true;
         transactionsLoadingState.classList.remove("text-danger", "text-success");
         transactionsLoadingState.innerHTML = `<span class="spinner-border spinner-border-sm text-primary"></span> กำลังโหลด...`;
         if(loadMoreTransactionsBtn) loadMoreTransactionsBtn.classList.add("d-none");
         applyDateRangeBtn.disabled = true;

         try {
             const constraints = [
                 where("isDeleted", "==", false),
                 where("date", ">=", txnRangeStartDate),
                 where("date", "<=", txnRangeEndDate)
             ];
             if(currentUserProfile.branchId) constraints.push(where("branchId", "==", currentUserProfile.branchId));
             
             let q = query(collection(db, "transactions"), ...constraints, orderBy("date", "desc"), limit(TXN_PAGE_SIZE));
             if(!reset && lastVisibleTxn) {
                 q = query(collection(db, "transactions"), ...constraints, orderBy("date", "desc"), startAfter(lastVisibleTxn), limit(TXN_PAGE_SIZE));
             }

             const snap = await getDocs(q);
             snap.forEach(d => transactionsInRange.push({ id: d.id, ...d.data() }));

             if(!snap.empty) lastVisibleTxn = snap.docs[snap.docs.length-1];

             if(snap.size === TXN_PAGE_SIZE) loadMoreTransactionsBtn.classList.remove("d-none");
             
             transactionsLoadingState.innerHTML = `<i class="bi bi-check2-all"></i> เรียบร้อย`;
             transactionsLoadingState.classList.add("text-success");
             
             renderTable();
             loadBalance(); // Refresh balance too

         } catch(e) {
             console.error(e);
             showToast("โหลดข้อมูลล้มเหลว", "danger");
             transactionsLoadingState.textContent = "ผิดพลาด";
             transactionsLoadingState.classList.add("text-danger");
         } finally {
             isLoadingTransactions = false;
             applyDateRangeBtn.disabled = false;
         }
      }

      // --- CRUD ---
      async function saveManualTxn(e) {
          e.preventDefault();
          const amount = parseFloat(manualAmountInput.value);
          const date = manualDateInput.value;
          const desc = manualDescriptionInput.value.trim();
          
          if(!amount || !date || !desc) { showToast("กรุณากรอกข้อมูลให้ครบ", "warning"); return; }
          
          manualTxnSaveBtn.disabled = true;
          manualTxnSaveSpinner.classList.remove("d-none");

          try {
              const data = {
                  date, type: manualTypeSelect.value, category: manualCategorySelect.value,
                  method: manualMethodSelect.value, description: desc, amount,
                  sourceType: "manual", isDeleted: false,
                  createdAt: serverTimestamp(), createdBy: currentUser.uid,
                  branchId: currentUserProfile.branchId
              };
              
              const ref = await addDoc(collection(db, "transactions"), data);
              
              // Activity Log
await addDoc(collection(db, "activityLogs"), {
    type: "transaction_manual", message: `เพิ่มรายการ ${desc} (${amount})`,
    refId: ref.id, refType: "transaction", branchId: currentUserProfile.branchId,
    createdAt: serverTimestamp(), 
    createdBy: currentUser.uid,
    createdByName: currentUserProfile.displayName || currentUser.email // <--- เพิ่มบรรทัดนี้
});

              showToast("บันทึกสำเร็จ", "success");
              e.target.reset();
              manualDateInput.value = getTodayISO();
              loadTransactions(true); // reload list

          } catch(err) {
              console.error(err);
              showToast("บันทึกไม่สำเร็จ", "danger");
          } finally {
              manualTxnSaveBtn.disabled = false;
              manualTxnSaveSpinner.classList.add("d-none");
          }
      }

      async function handleDelete(id) {
          if(!confirm("ต้องการลบรายการนี้ใช่หรือไม่?")) return;
          try {
              await updateDoc(doc(db, "transactions", id), { isDeleted: true });
              transactionsInRange = transactionsInRange.filter(t => t.id !== id);
              renderTable();
              loadBalance();
              showToast("ลบรายการแล้ว", "success");
          } catch(e) { showToast("ลบไม่สำเร็จ", "danger"); }
      }

      function openEditModal(id) {
          const txn = transactionsInRange.find(t => t.id === id);
          if(!txn) return;
          
          editTxnId.value = txn.id;
          editTxnDate.value = txn.date;
          editTxnType.value = txn.type;
          editTxnCategory.value = txn.category;
          editTxnDesc.value = txn.description;
          editTxnAmount.value = txn.amount;
          
          editTxnModal.show();
      }

      async function saveEditTxn() {
          const id = editTxnId.value;
          const updates = {
              date: editTxnDate.value,
              type: editTxnType.value,
              category: editTxnCategory.value,
              description: editTxnDesc.value.trim(),
              amount: parseFloat(editTxnAmount.value)
          };
          
          saveEditTxnBtn.disabled = true; saveEditTxnSpinner.classList.remove("d-none");
          try {
              await updateDoc(doc(db, "transactions", id), updates);
              
              // Update local state
              const idx = transactionsInRange.findIndex(t => t.id === id);
              if(idx !== -1) transactionsInRange[idx] = { ...transactionsInRange[idx], ...updates };
              
              renderTable();
              loadBalance();
              showToast("แก้ไขเรียบร้อย", "success");
              editTxnModal.hide();
          } catch(e) {
              console.error(e);
              showToast("แก้ไขไม่สำเร็จ", "danger");
          } finally {
              saveEditTxnBtn.disabled = false; saveEditTxnSpinner.classList.add("d-none");
          }
      }

      function exportToCSV() {
          if(!transactionsInRange.length) return;
          let csv = "\uFEFFวันที่,ประเภท,หมวดหมู่,รายละเอียด,จำนวน,วิธี\n";
          transactionsInRange.forEach(t => {
              csv += `${t.date},${t.type},${t.category},"${t.description}",${t.amount},${t.method}\n`;
          });
          const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `finance_${txnRangeStartDate}.csv`;
          link.click();
      }

      // --- Setup ---
      function setupEvents() {
          logoutBtn.onclick = () => signOut(auth).then(()=>window.location.href="index.html");
          
          // Date Presets
          document.querySelectorAll(".bm-range-preset-btn").forEach(btn => {
              btn.onclick = (e) => {
                  const range = e.target.dataset.range;
                  const today = new Date();
                  let start = getTodayISO();
                  const end = getTodayISO();
                  
                  if(range === '7d') {
                      const d = new Date(); d.setDate(d.getDate()-7);
                      start = d.toISOString().split("T")[0];
                  } else if(range === 'month') {
                      start = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split("T")[0];
                  } else if(range === 'year') {
                      start = new Date(today.getFullYear(), 0, 1).toISOString().split("T")[0];
                  }
                  
                  dateRangeStartInput.value = start;
                  dateRangeEndInput.value = end;
                  txnRangeStartDate = start;
                  txnRangeEndDate = end;
                  loadTransactions(true);
              };
          });

          applyDateRangeBtn.onclick = () => {
              txnRangeStartDate = dateRangeStartInput.value;
              txnRangeEndDate = dateRangeEndInput.value;
              loadTransactions(true);
          };

          refreshBtn.onclick = () => loadTransactions(true);
          loadMoreTransactionsBtn.onclick = () => loadTransactions(false);
          manualTxnForm.onsubmit = saveManualTxn;
          
          // Quick Amount
          manualQuickButtons.forEach(btn => {
              btn.onclick = () => {
                  const curr = parseFloat(manualAmountInput.value)||0;
                  manualAmountInput.value = curr + parseFloat(btn.dataset.amount);
              };
          });

          // Table Actions
          transactionsTableBody.onclick = (e) => {
              const btnEdit = e.target.closest(".edit-txn-btn");
              if(btnEdit) openEditModal(btnEdit.dataset.id);

              const btnDel = e.target.closest(".delete-txn-btn");
              if(btnDel) handleDelete(btnDel.dataset.id);
          };
          
          saveEditTxnBtn.onclick = saveEditTxn;
          exportCsvBtn.onclick = exportToCSV;

          // FAB
          fabOpenBillBtn.onclick = () => window.location.href="open-bill.html";
          fabAddTxnBtn.onclick = () => {
              document.getElementById("manualTxnForm").scrollIntoView({behavior:"smooth"});
          };
          fabStockInBtn.onclick = () => window.location.href="stock.html";
      }

      // --- Main ---
      onAuthStateChanged(auth, async (user) => {
          if(!user) { window.location.href="index.html"; return; }
          currentUser = user;
          
          const userRef = doc(db, "users", user.uid);
          const snap = await getDoc(userRef);
          if(snap.exists()) currentUserProfile = { id: snap.id, ...snap.data() };
          else currentUserProfile = { role: 'staff', branchId: null };

          if(currentUserProfile.disabled) { signOut(auth); return; }

          userDisplayNameText.textContent = currentUserProfile.displayName || user.email;
          userRoleText.textContent = currentUserProfile.role === 'admin' ? "Admin" : "Staff";
          userAvatarInitial.textContent = (currentUserProfile.displayName||"U")[0].toUpperCase();
          if(settingsMenuItem) settingsMenuItem.classList.toggle("d-none", currentUserProfile.role !== 'admin');
          
          applyTheme(localStorage.getItem("bm-theme-"+user.uid)||"light");
          
          setupEvents();
          loadTransactions(true);
      });
    </script>
  </body>
</html>