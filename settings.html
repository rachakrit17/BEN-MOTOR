<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – ตั้งค่าระบบ & ผู้ใช้ & สำรองข้อมูล</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">

    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <div class="px-3 py-2 d-sm-none">
                   <strong id="userDisplayNameTextMobile" class="small">ผู้ใช้งาน</strong>
                </div>
              </li>
              <li><hr class="dropdown-divider d-sm-none"></li>
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content">
      <div class="container py-3">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 mt-3">
          <div class="mb-3 mb-md-0">
            <h1 class="h5 mb-1 fw-bold text-dark">
               <i class="bi bi-sliders me-2 text-primary"></i>ตั้งค่าระบบ & ข้อมูลผู้ใช้
            </h1>
            <p class="small text-muted mb-0 ms-1">
              จัดการโปรไฟล์ของคุณ ปรับธีม เปลี่ยนสิทธิ์ผู้ใช้ และสำรองข้อมูล
            </p>
          </div>
          <div>
            <span
              class="badge rounded-pill bg-white text-secondary border shadow-sm px-3 py-2 fw-normal"
              id="settingsRoleBadge"
            >
              <span class="spinner-border spinner-border-sm" style="width: 0.7rem; height: 0.7rem;"></span> Loading...
            </span>
          </div>
        </div>

        <div class="card border-0 bg-transparent mb-3">
            <ul
            class="nav nav-pills small gap-2"
            id="settingsTabs"
            role="tablist"
            >
            <li class="nav-item" role="presentation">
                <button
                class="nav-link active shadow-sm"
                id="profile-tab"
                data-bs-toggle="pill"
                data-bs-target="#profileTabPane"
                type="button"
                role="tab"
                aria-controls="profileTabPane"
                aria-selected="true"
                >
                <i class="bi bi-person-circle me-1"></i> โปรไฟล์ของฉัน
                </button>
            </li>
            <li class="nav-item" role="presentation" id="usersTabNavItem">
                <button
                class="nav-link shadow-sm"
                id="users-tab"
                data-bs-toggle="pill"
                data-bs-target="#usersTabPane"
                type="button"
                role="tab"
                aria-controls="usersTabPane"
                aria-selected="false"
                >
                <i class="bi bi-people-fill me-1"></i> ผู้ใช้ในระบบ
                <span
                    class="badge bg-danger ms-1 rounded-pill"
                    id="usersCountBadge"
                >0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button
                class="nav-link shadow-sm"
                id="backup-tab"
                data-bs-toggle="pill"
                data-bs-target="#backupTabPane"
                type="button"
                role="tab"
                aria-controls="backupTabPane"
                aria-selected="false"
                >
                <i class="bi bi-cloud-arrow-down me-1"></i> สำรองข้อมูล
                </button>
            </li>
            </ul>
        </div>

        <div class="tab-content" id="settingsTabContent">
          <div
            class="tab-pane fade show active"
            id="profileTabPane"
            role="tabpanel"
            aria-labelledby="profile-tab"
            tabindex="0"
          >
            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <h2 class="h6 fw-bold mb-4 text-primary">
                  <i class="bi bi-person-vcard me-2"></i>ข้อมูลส่วนตัวและการแสดงผล
                </h2>

                <div class="row g-4">
                  <div class="col-12 col-md-6 border-end-md">
                    <h6 class="small fw-bold text-muted text-uppercase mb-3">บัญชีผู้ใช้</h6>
                    
                    <div class="mb-3">
                      <label class="form-label small text-muted">อีเมล (Login Email)</label>
                      <div class="input-group input-group-sm">
                          <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-envelope"></i></span>
                          <input
                            type="email"
                            class="form-control border-start-0 bg-white"
                            id="profileEmailInput"
                            readonly
                          />
                      </div>
                      <div class="form-text text-xs text-muted mt-1">
                        <i class="bi bi-info-circle"></i> อีเมลใช้สำหรับเข้าสู่ระบบเท่านั้น ไม่สามารถเปลี่ยนได้
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label small">ชื่อที่ใช้แสดง (Display Name)</label>
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="profileDisplayNameInput"
                        placeholder="เช่น ช่างเบน, เจ้าของอู่"
                      />
                    </div>

                    <div class="mb-2">
                      <label class="form-label small">สาขาที่สังกัด (Branch ID)</label>
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="profileBranchIdInput"
                        placeholder="Main, Branch01 (เว้นว่างได้)"
                      />
                    </div>
                  </div>

                  <div class="col-12 col-md-6 ps-md-4">
                     <h6 class="small fw-bold text-muted text-uppercase mb-3">รูปลักษณ์ (Appearance)</h6>
                    <div class="mb-3">
                      <label class="form-label small mb-2">ธีมของระบบ</label>
                      <div class="d-flex flex-column gap-2">
                        <div class="form-check p-3 border rounded-3 bg-light">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="profileThemeRadio"
                            id="themeLightRadio"
                            value="light"
                          />
                          <label
                            class="form-check-label small fw-medium w-100 stretched-link"
                            for="themeLightRadio"
                          >
                            <i class="bi bi-sun me-2 text-warning"></i>โหมดสว่าง (Light Mode)
                          </label>
                        </div>
                        <div class="form-check p-3 border rounded-3 bg-dark text-white">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="profileThemeRadio"
                            id="themeDarkRadio"
                            value="dark"
                          />
                          <label
                            class="form-check-label small fw-medium w-100 stretched-link"
                            for="themeDarkRadio"
                          >
                            <i class="bi bi-moon-stars me-2"></i>โหมดมืด (Dark Mode)
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <hr class="my-4 text-muted opacity-25">

                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted" id="profileSaveStatusText">
                    <i class="bi bi-check2-circle"></i> ข้อมูลเป็นปัจจุบัน
                  </small>
                  <div>
                    <button
                      type="button"
                      class="btn btn-primary btn-sm px-4"
                      id="profileSaveBtn"
                    >
                      <span
                        class="spinner-border spinner-border-sm me-2 d-none"
                        id="profileSaveSpinner"
                        role="status"
                        aria-hidden="true"
                      ></span>
                      <span id="profileSaveBtnText"><i class="bi bi-save me-1"></i> บันทึกการเปลี่ยนแปลง</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="tab-pane fade"
            id="usersTabPane"
            role="tabpanel"
            aria-labelledby="users-tab"
            tabindex="0"
          >
            <div class="card shadow-sm border-0">
              <div class="card-body p-0">
                <div class="p-3 border-bottom d-flex flex-column flex-md-row justify-content-between align-items-center bg-light rounded-top">
                    <div>
                        <h2 class="h6 fw-bold mb-0 text-dark">
                            <i class="bi bi-people-fill me-2"></i>จัดการผู้ใช้ (User Management)
                        </h2>
                    </div>
                    <span
                        class="badge bg-warning text-dark small d-none mt-2 mt-md-0"
                        id="usersAdminOnlyBadge"
                    >
                        <i class="bi bi-shield-lock me-1"></i> Admin Area
                    </span>
                </div>

                <div
                  class="alert alert-warning small m-3 d-none"
                  id="usersNotAdminAlert"
                >
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  ขณะนี้คุณยังไม่ได้เป็นผู้ดูแลระบบ (Admin)
                  คุณสามารถดูข้อมูลผู้ใช้คนอื่นได้แต่ไม่สามารถแก้ไขได้
                </div>

                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light small text-muted text-uppercase">
                      <tr>
                        <th class="ps-3 py-3">อีเมล</th>
                        <th class="py-3">ชื่อแสดง</th>
                        <th class="py-3">Role</th>
                        <th class="py-3">สาขา</th>
                        <th class="py-3">สถานะ</th>
                        <th class="text-end pe-3 py-3">จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableTbody" class="small">
                      <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                          <span class="spinner-border spinner-border-sm me-2"></span>กำลังโหลดข้อมูลผู้ใช้...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="p-4 bg-light bg-opacity-50">
                  <div class="card border-0 shadow-sm">
                      <div class="card-body">
                        <h3 class="h6 fw-bold mb-3 text-success">
                            <i class="bi bi-person-plus-fill me-2"></i>สร้างผู้ใช้ใหม่ (Create New User)
                        </h3>
                        <div class="row g-2">
                            <div class="col-12 col-md-3">
                            <label class="form-label small text-muted mb-1" for="newUserEmailInput">อีเมล</label>
                            <input
                                type="email"
                                class="form-control form-control-sm"
                                id="newUserEmailInput"
                                placeholder="user@benmotor.com"
                            />
                            </div>
                            <div class="col-12 col-md-3">
                            <label class="form-label small text-muted mb-1" for="newUserPasswordInput">รหัสผ่าน</label>
                            <input
                                type="password"
                                class="form-control form-control-sm"
                                id="newUserPasswordInput"
                                placeholder="ขั้นต่ำ 6 ตัวอักษร"
                            />
                            </div>
                            <div class="col-12 col-md-3">
                            <label class="form-label small text-muted mb-1" for="newUserDisplayNameInput">ชื่อที่ใช้แสดง</label>
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                id="newUserDisplayNameInput"
                                placeholder="เช่น ช่าง A"
                            />
                            </div>
                            <div class="col-6 col-md-1">
                            <label class="form-label small text-muted mb-1" for="newUserRoleSelect">สิทธิ์</label>
                            <select
                                class="form-select form-select-sm"
                                id="newUserRoleSelect"
                            >
                                <option value="staff">Staff</option>
                                <option value="admin">Admin</option>
                            </select>
                            </div>
                            <div class="col-6 col-md-2">
                            <label class="form-label small text-muted mb-1" for="newUserBranchIdInput">สาขา</label>
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                id="newUserBranchIdInput"
                                placeholder="Optional"
                            />
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="newUserCreateStatusText">
                            <i class="bi bi-info-circle me-1"></i>ระบบจะสร้าง User ใน Firebase Auth และ Collection Users
                            </small>
                            <button
                            type="button"
                            class="btn btn-success btn-sm px-3"
                            id="newUserCreateBtn"
                            >
                            <span
                                class="spinner-border spinner-border-sm me-2 d-none"
                                id="newUserCreateSpinner"
                                role="status"
                                aria-hidden="true"
                            ></span>
                            <span id="newUserCreateBtnText"><i class="bi bi-plus-lg me-1"></i> สร้างผู้ใช้ใหม่</span>
                            </button>
                        </div>
                      </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="tab-pane fade"
            id="backupTabPane"
            role="tabpanel"
            aria-labelledby="backup-tab"
            tabindex="0"
          >
            <div class="card shadow-sm border-0">
              <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3 me-3">
                        <i class="bi bi-database-down fs-4"></i>
                    </div>
                    <div>
                        <h2 class="h6 fw-bold mb-1">สำรองข้อมูล (Data Export)</h2>
                        <p class="text-muted small mb-0">เลือกช่วงวันที่เพื่อดึงข้อมูลออกมาเป็นไฟล์ JSON หรือ CSV</p>
                    </div>
                </div>

                <div class="bm-filter-bar mb-4">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-4">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0 text-muted">เริ่ม</span>
                                <input
                                type="date"
                                class="form-control border-start-0"
                                id="backupStartDateInput"
                                />
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0 text-muted">ถึง</span>
                                <input
                                type="date"
                                class="form-control border-start-0"
                                id="backupEndDateInput"
                                />
                            </div>
                        </div>
                        <div class="col-12 col-md-4 text-md-end">
                            <span class="small fw-medium text-primary" id="backupRangeStatusText">
                            <i class="bi bi-calendar-check me-1"></i> กรุณาเลือกช่วงวันที่
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                  <div class="col-12 col-lg-6">
                    <div class="card h-100 border bg-light bg-opacity-25">
                      <div class="card-body">
                        <h3 class="h6 fw-bold mb-2 text-dark">
                          <i class="bi bi-wrench-adjustable-circle me-2 text-primary"></i>Export Jobs (ใบงานซ่อม)
                        </h3>
                        <p class="small text-muted mb-3">
                          ข้อมูลใบงานซ่อมทั้งหมด สถานะ ราคา และรายละเอียดรถ
                        </p>
                        <div class="d-flex gap-2">
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm flex-fill bg-white"
                            id="backupJobsJsonBtn"
                          >
                            <i class="bi bi-filetype-json me-1 text-warning"></i> JSON
                          </button>
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm flex-fill bg-white"
                            id="backupJobsCsvBtn"
                          >
                            <i class="bi bi-filetype-csv me-1 text-success"></i> CSV (Excel)
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-lg-6">
                    <div class="card h-100 border bg-light bg-opacity-25">
                      <div class="card-body">
                        <h3 class="h6 fw-bold mb-2 text-dark">
                          <i class="bi bi-cash-stack me-2 text-success"></i>Export Transactions (การเงิน)
                        </h3>
                        <p class="small text-muted mb-3">
                          ข้อมูลรายรับ-รายจ่าย ทั้งจากงานซ่อมและการบันทึกเอง
                        </p>
                        <div class="d-flex gap-2">
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm flex-fill bg-white"
                            id="backupTxJsonBtn"
                          >
                            <i class="bi bi-filetype-json me-1 text-warning"></i> JSON
                          </button>
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm flex-fill bg-white"
                            id="backupTxCsvBtn"
                          >
                            <i class="bi bi-filetype-csv me-1 text-success"></i> CSV (Excel)
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-2">
                  <label for="backupResultTextarea" class="form-label small fw-bold text-muted">
                    <i class="bi bi-code-square me-1"></i>Log Preview (JSON Result)
                  </label>
                  <textarea
                    class="form-control form-control-sm font-monospace bg-light text-secondary"
                    id="backupResultTextarea"
                    rows="6"
                    readonly
                    style="font-size: 0.75rem;"
                    placeholder="พื้นที่แสดงตัวอย่างข้อมูลเมื่อกด Export แบบ JSON..."
                  ></textarea>
                </div>
                <div class="alert alert-info py-2 px-3 small border-0 bg-info bg-opacity-10 text-info mb-0">
                  <i class="bi bi-shield-check me-2"></i>แนะนำให้เก็บไฟล์ Backup ไว้ในที่ปลอดภัย (เช่น Google Drive) อย่างสม่ำเสมอ
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="height: 4.5rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">
        <button
          class="btn btn-primary rounded-circle shadow bm-fab-btn"
          type="button"
          id="fabDropdownButton"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="bi bi-plus"></i>
        </button>
        <ul
          class="dropdown-menu dropdown-menu-end mb-2 shadow border-0"
          aria-labelledby="fabDropdownButton"
        >
          <li>
            <button
              class="dropdown-item d-flex align-items-center py-2"
              type="button"
              id="fabOpenBillBtn"
            >
              <i class="bi bi-receipt-cutoff me-2 text-primary"></i> เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button
              class="dropdown-item d-flex align-items-center py-2"
              type="button"
              id="fabAddTxnBtn"
            >
              <i class="bi bi-cash-coin me-2 text-success"></i> เพิ่มรายการเงิน (Manual)
            </button>
          </li>
          <li>
            <button
              class="dropdown-item d-flex align-items-center py-2"
              type="button"
              id="fabStockInBtn"
            >
              <i class="bi bi-box-seam me-2 text-warning"></i> บันทึกซื้ออะไหล่เข้า
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link">
              <i class="bi bi-wrench-adjustable-circle d-block"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1080;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex">
          <div class="toast-body" id="mainToastBody">
            </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="ปิด"
          ></button>
        </div>
      </div>
    </div>

    <a href="#" id="hiddenDownloadLink" style="display: none;"></a>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      // ============================================================
      // นำเข้า Firebase SDK แบบ ES Module ใช้เหมือนกันทุกหน้า
      // ============================================================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        sendPasswordResetEmail
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        limit,
        startAfter,
        serverTimestamp,
        onSnapshot
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ============================================================
      // ตั้งค่า Firebase ใช้เหมือนกันทุกหน้า
      // ============================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ============================================================
      // DOM Elements หลักที่ใช้ในหน้านี้
      // ============================================================
      const bodyEl = document.body;

      // Topbar / User
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");
      const settingsRoleBadge = document.getElementById("settingsRoleBadge");

      // Tabs
      const usersTabNavItem = document.getElementById("usersTabNavItem");
      const usersAdminOnlyBadge = document.getElementById("usersAdminOnlyBadge");
      const usersNotAdminAlert = document.getElementById("usersNotAdminAlert");
      const usersCountBadge = document.getElementById("usersCountBadge");

      // Toast
      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");

      // ซ่อนลิงก์ดาวน์โหลด
      const hiddenDownloadLink = document.getElementById("hiddenDownloadLink");

      // --------- Profile Tab Elements ---------
      const profileEmailInput = document.getElementById("profileEmailInput");
      const profileDisplayNameInput = document.getElementById(
        "profileDisplayNameInput"
      );
      const profileBranchIdInput = document.getElementById("profileBranchIdInput");
      const themeLightRadio = document.getElementById("themeLightRadio");
      const themeDarkRadio = document.getElementById("themeDarkRadio");
      const profileSaveBtn = document.getElementById("profileSaveBtn");
      const profileSaveSpinner = document.getElementById("profileSaveSpinner");
      const profileSaveBtnText = document.getElementById("profileSaveBtnText");
      const profileSaveStatusText = document.getElementById(
        "profileSaveStatusText"
      );

      // --------- Users Tab Elements ---------
      const usersTableTbody = document.getElementById("usersTableTbody");
      const newUserEmailInput = document.getElementById("newUserEmailInput");
      const newUserPasswordInput = document.getElementById(
        "newUserPasswordInput"
      );
      const newUserDisplayNameInput = document.getElementById(
        "newUserDisplayNameInput"
      );
      const newUserRoleSelect = document.getElementById("newUserRoleSelect");
      const newUserBranchIdInput = document.getElementById("newUserBranchIdInput");
      const newUserCreateBtn = document.getElementById("newUserCreateBtn");
      const newUserCreateSpinner = document.getElementById(
        "newUserCreateSpinner"
      );
      const newUserCreateBtnText = document.getElementById(
        "newUserCreateBtnText"
      );
      const newUserCreateStatusText = document.getElementById(
        "newUserCreateStatusText"
      );

      // --------- Backup Tab Elements ---------
      const backupStartDateInput = document.getElementById(
        "backupStartDateInput"
      );
      const backupEndDateInput = document.getElementById("backupEndDateInput");
      const backupRangeStatusText = document.getElementById(
        "backupRangeStatusText"
      );
      const backupJobsJsonBtn = document.getElementById("backupJobsJsonBtn");
      const backupJobsCsvBtn = document.getElementById("backupJobsCsvBtn");
      const backupTxJsonBtn = document.getElementById("backupTxJsonBtn");
      const backupTxCsvBtn = document.getElementById("backupTxCsvBtn");
      const backupResultTextarea = document.getElementById(
        "backupResultTextarea"
      );

      // ============================================================
      // สถานะภายใน
      // ============================================================
      let currentUser = null;
      let currentUserProfile = null;

      let isSavingProfile = false;
      let isLoadingUsers = false;
      let isCreatingNewUser = false;
      let isExportingBackup = false;

      let allUsers = [];

      // ============================================================
      // ฟังก์ชันช่วย: Toast ภาษาไทย
      // ============================================================
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className =
          "toast align-items-center shadow text-bg-" + variant + " border-0";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      // ============================================================
      // ฟังก์ชันช่วย: Format ตัวเลข & วันที่
      // ============================================================
      function formatNumber(value) {
        if (typeof value !== "number" || isNaN(value)) return "0.00";
        return value.toLocaleString("th-TH", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function getTodayISODateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function formatDateThaiFromString(dateStr) {
        if (!dateStr) return "-";
        const [year, month, day] = dateStr.split("-").map((v) => parseInt(v, 10));
        if (!year || !month || !day) return dateStr;
        const d = new Date(year, month - 1, day);
        const thaiMonths = [
          "ม.ค.",
          "ก.พ.",
          "มี.ค.",
          "เม.ย.",
          "พ.ค.",
          "มิ.ย.",
          "ก.ค.",
          "ส.ค.",
          "ก.ย.",
          "ต.ค.",
          "พ.ย.",
          "ธ.ค.",
        ];
        const thaiYear = d.getFullYear() + 543;
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${thaiYear}`;
      }

      // ============================================================
      // ธีม Light / Dark (ใช้ร่วมกับทั้งระบบ)
      // ============================================================
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);

        const icon = themeToggleBtn?.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-sun", normalized === "dark");
          icon.classList.toggle("bi-moon", normalized === "light");
        }

        // อัปเดต radio/button ใน Tab โปรไฟล์
        if (normalized === "dark") {
          if (themeDarkRadio) themeDarkRadio.checked = true;
        } else {
          if (themeLightRadio) themeLightRadio.checked = true;
        }
      }

      function saveThemeForUser(uid, theme) {
        if (!uid) return;
        try {
          localStorage.setItem("bm-theme-" + uid, theme);
        } catch (error) {
          console.warn("ไม่สามารถบันทึกธีมใน localStorage ได้", error);
        }
      }

      function readThemeForUser(uid, fallbackTheme) {
        if (!uid) return fallbackTheme || "light";
        try {
          const stored = localStorage.getItem("bm-theme-" + uid);
          return stored || fallbackTheme || "light";
        } catch (error) {
          return fallbackTheme || "light";
        }
      }

      // ============================================================
      // ฟังก์ชัน: ตรวจสอบ/สร้างเอกสารผู้ใช้ใน collection users
      // ============================================================
      async function ensureUserProfile(user) {
        // ถ้ายังไม่มีเอกสาร /users/{uid} ให้สร้าง
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          return { id: snap.id, ...snap.data() };
        }

        const usersCol = collection(db, "users");
        const qUsers = query(usersCol, limit(1));
        const existingSnap = await getDocs(qUsers);

        const isFirstUser = existingSnap.empty;
        const role = isFirstUser ? "admin" : "staff";
        const defaultDisplayName =
          user.displayName || (user.email ? user.email.split("@")[0] : "ผู้ใช้ใหม่");

        const newUserData = {
          displayName: defaultDisplayName,
          role,
          createdAt: serverTimestamp(),
          branchId: null,
          theme: "light",
          disabled: false,
        };

        await setDoc(userRef, newUserData);
        return { id: user.uid, ...newUserData };
      }

      // ============================================================
      // ฟังก์ชัน: Logout
      // ============================================================
      async function handleLogout() {
        try {
          await signOut(auth);
          showToast("ออกจากระบบเรียบร้อยแล้ว", "success");
          window.location.href = "index.html";
        } catch (error) {
          console.error("Logout error:", error);
          showToast(
            "ไม่สามารถออกจากระบบได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        }
      }

      // ============================================================
      // ฟังก์ชัน: อัปเดต UI โปรไฟล์จาก currentUserProfile
      // ============================================================
      function updateProfileTabUI() {
        if (!currentUser || !currentUserProfile) return;

        if (profileEmailInput) {
          profileEmailInput.value = currentUser.email || "";
        }
        if (profileDisplayNameInput) {
          profileDisplayNameInput.value = currentUserProfile.displayName || "";
        }
        if (profileBranchIdInput) {
          profileBranchIdInput.value = currentUserProfile.branchId || "";
        }

        const theme = readThemeForUser(
          currentUser.uid,
          currentUserProfile.theme || "light"
        );
        applyTheme(theme);

        if (profileSaveStatusText) {
            profileSaveStatusText.innerHTML = '<i class="bi bi-check2-circle"></i> ข้อมูลเป็นปัจจุบัน';
            profileSaveStatusText.className = "text-success small";
        }
      }

      // ============================================================
      // ฟังก์ชัน: บันทึกข้อมูลโปรไฟล์ (ชื่อแสดง + สาขา + ธีม)
      // ============================================================
      async function handleSaveProfile() {
        if (!currentUser || !currentUserProfile) return;
        if (isSavingProfile) return;

        const newDisplayName = profileDisplayNameInput.value.trim();
        const newBranchId = profileBranchIdInput.value.trim() || null;
        let newTheme = "light";
        if (themeDarkRadio?.checked) newTheme = "dark";
        if (themeLightRadio?.checked) newTheme = "light";

        if (!newDisplayName) {
          showToast("กรุณาระบุชื่อที่ใช้แสดงก่อนบันทึก", "warning");
          return;
        }

        isSavingProfile = true;
        profileSaveSpinner.classList.remove("d-none");
        profileSaveBtnText.textContent = "กำลังบันทึก...";
        profileSaveBtn.disabled = true;

        try {
          const userRef = doc(db, "users", currentUser.uid);
          await updateDoc(userRef, {
            displayName: newDisplayName,
            branchId: newBranchId,
            theme: newTheme,
          });

          currentUserProfile.displayName = newDisplayName;
          currentUserProfile.branchId = newBranchId;
          currentUserProfile.theme = newTheme;

          if (userDisplayNameText) {
            userDisplayNameText.textContent = newDisplayName;
          }

          if (userAvatarInitial) {
            userAvatarInitial.textContent =
              newDisplayName.trim().charAt(0).toUpperCase() || "U";
          }

          saveThemeForUser(currentUser.uid, newTheme);
          applyTheme(newTheme);

          if (profileSaveStatusText) {
            profileSaveStatusText.innerHTML = '<i class="bi bi-check-circle-fill"></i> บันทึกเรียบร้อยแล้ว';
            profileSaveStatusText.className = "text-success small fw-bold";
          }

          showToast("บันทึกโปรไฟล์เรียบร้อยแล้ว", "success");
        } catch (error) {
          console.error("บันทึกโปรไฟล์ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถบันทึกโปรไฟล์ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
          if (profileSaveStatusText) {
            profileSaveStatusText.textContent =
              "บันทึกไม่สำเร็จ: " + (error.code || "error");
            profileSaveStatusText.className = "text-danger small";
          }
        } finally {
          isSavingProfile = false;
          profileSaveSpinner.classList.add("d-none");
          profileSaveBtnText.innerHTML = '<i class="bi bi-save me-1"></i> บันทึกการเปลี่ยนแปลง';
          profileSaveBtn.disabled = false;
        }
      }

      // ============================================================
      // ฟังก์ชัน: โหลดผู้ใช้ทั้งหมด (สำหรับ admin)
      // ============================================================
      async function loadAllUsers() {
        if (isLoadingUsers) return;
        isLoadingUsers = true;

        if (usersTableTbody) {
          usersTableTbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center small text-muted py-5">
                <span class="spinner-border spinner-border-sm me-2"></span>กำลังโหลดข้อมูลผู้ใช้...
              </td>
            </tr>
          `;
        }

        try {
          const usersCol = collection(db, "users");
          const qUsers = query(usersCol, orderBy("createdAt", "asc"));
          // หมายเหตุ: หาก Firestore แจ้งให้สร้าง Index ให้ทำตามลิงก์ที่แจ้งเตือน (ครั้งแรกเท่านั้น)
          const snap = await getDocs(qUsers);

          const results = [];
          snap.forEach((docSnap) => {
            const data = docSnap.data();
            results.push({
              id: docSnap.id,
              displayName: data.displayName || "",
              role: data.role || "staff",
              branchId: data.branchId || null,
              theme: data.theme || "light",
              disabled: !!data.disabled,
              email: data.email || null, // อาจจะไม่เก็บ email ใน users เสมอไป
            });
          });

          allUsers = results;

          if (usersCountBadge) {
            usersCountBadge.textContent = String(allUsers.length || 0);
          }

          renderUsersTable();
        } catch (error) {
          console.error("โหลดข้อมูลผู้ใช้ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถโหลดรายชื่อผู้ใช้ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
          if (usersTableTbody) {
            usersTableTbody.innerHTML = `
              <tr>
                <td colspan="6" class="text-center small text-danger py-4">
                  <i class="bi bi-exclamation-circle me-1"></i> ไม่สามารถโหลดรายชื่อผู้ใช้ได้ (${error.code || "error"})
                </td>
              </tr>
            `;
          }
        } finally {
          isLoadingUsers = false;
        }
      }

      // ============================================================
      // ฟังก์ชัน: แสดงตารางผู้ใช้
      // ============================================================
      function renderUsersTable() {
        if (!usersTableTbody) return;

        usersTableTbody.innerHTML = "";

        if (!allUsers || allUsers.length === 0) {
          usersTableTbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center small text-muted py-5">
                <i class="bi bi-people text-secondary opacity-25 fs-1 d-block mb-2"></i>
                ยังไม่มีข้อมูลผู้ใช้ในระบบ
              </td>
            </tr>
          `;
          return;
        }

        allUsers.forEach((u) => {
          const tr = document.createElement("tr");

          const isCurrent = currentUser && currentUser.uid === u.id;

          const emailText = u.email || '<span class="text-muted fst-italic">(ไม่ระบุ)</span>';
          const disabledBadge = u.disabled
            ? '<span class="badge rounded-pill text-bg-danger bg-opacity-75"><i class="bi bi-slash-circle me-1"></i>ถูกระงับ</span>'
            : '<span class="badge rounded-pill text-bg-success bg-opacity-75"><i class="bi bi-check-circle me-1"></i>ปกติ</span>';

          tr.innerHTML = `
            <td class="small ps-3 fw-medium text-dark">${emailText}</td>
            <td class="small">
              <input
                type="text"
                class="form-control form-control-sm users-displayname-input border-0 bg-light"
                data-uid="${u.id}"
                value="${u.displayName || ""}"
              />
            </td>
            <td class="small">
              <select
                class="form-select form-select-sm users-role-select border-0 bg-light"
                data-uid="${u.id}"
              >
                <option value="staff" ${
                  u.role === "staff" ? "selected" : ""
                }>Staff</option>
                <option value="admin" ${
                  u.role === "admin" ? "selected" : ""
                }>Admin</option>
              </select>
            </td>
            <td class="small">
              <input
                type="text"
                class="form-control form-control-sm users-branch-input border-0 bg-light"
                data-uid="${u.id}"
                value="${u.branchId || ""}"
              />
            </td>
            <td class="small">
              <div class="form-check form-switch d-flex align-items-center gap-2">
                <input
                  class="form-check-input users-disabled-switch"
                  type="checkbox"
                  role="switch"
                  data-uid="${u.id}"
                  ${u.disabled ? "" : "checked"}
                />
                <label class="form-check-label small">
                  ${disabledBadge}
                </label>
              </div>
            </td>
            <td class="small text-end pe-3">
              <button
                type="button"
                class="btn btn-outline-primary btn-sm users-save-btn rounded-pill px-3"
                data-uid="${u.id}"
              >
                <i class="bi bi-save"></i>
              </button>
            </td>
          `;

          // ถ้าเป็น user ปัจจุบัน ให้ใส่พื้นหลังเบา ๆ
          if (isCurrent) {
            tr.classList.add("table-primary", "table-opacity-10");
          }

          usersTableTbody.appendChild(tr);
        });

        // ผูก Event ให้ปุ่มบันทึกของแต่ละแถว
        const saveButtons = usersTableTbody.querySelectorAll(".users-save-btn");
        saveButtons.forEach((btn) => {
          btn.addEventListener("click", async (event) => {
            const uid = event.currentTarget.getAttribute("data-uid");
            await handleSaveUserRow(uid);
          });
        });
      }

      // ============================================================
      // ฟังก์ชัน: บันทึกผู้ใช้ในแต่ละแถว (เปลี่ยน role / สถานะ / branchId / displayName)
      // ============================================================
      async function handleSaveUserRow(uid) {
        if (!currentUserProfile || currentUserProfile.role !== "admin") {
          showToast("คุณไม่มีสิทธิ์ทำรายการนี้ (เฉพาะผู้ดูแลระบบ)", "danger");
          return;
        }

        const row = usersTableTbody?.querySelector(
          `.users-save-btn[data-uid="${uid}"]`
        )?.closest("tr");
        if (!row) return;

        const dnInput = row.querySelector(
          '.users-displayname-input[data-uid="' + uid + '"]'
        );
        const roleSelect = row.querySelector(
          '.users-role-select[data-uid="' + uid + '"]'
        );
        const branchInput = row.querySelector(
          '.users-branch-input[data-uid="' + uid + '"]'
        );
        const disabledSwitch = row.querySelector(
          '.users-disabled-switch[data-uid="' + uid + '"]'
        );
        const saveBtn = row.querySelector(
          '.users-save-btn[data-uid="' + uid + '"]'
        );

        if (!dnInput || !roleSelect || !branchInput || !disabledSwitch || !saveBtn) {
          return;
        }

        const dn = dnInput.value.trim();
        const role = roleSelect.value;
        const branchId = branchInput.value.trim() || null;
        const isEnabled = disabledSwitch.checked;
        const disabled = !isEnabled;

        if (!dn) {
          showToast("กรุณาระบุชื่อแสดงของผู้ใช้ก่อนบันทึก", "warning");
          return;
        }

        saveBtn.disabled = true;
        const originalHtml = saveBtn.innerHTML;
        saveBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        try {
          const userRef = doc(db, "users", uid);
          await updateDoc(userRef, {
            displayName: dn,
            role,
            branchId,
            disabled,
          });

          const targetIndex = allUsers.findIndex((u) => u.id === uid);
          if (targetIndex >= 0) {
            allUsers[targetIndex].displayName = dn;
            allUsers[targetIndex].role = role;
            allUsers[targetIndex].branchId = branchId;
            allUsers[targetIndex].disabled = disabled;
          }

          renderUsersTable();

          showToast("บันทึกข้อมูลผู้ใช้เรียบร้อยแล้ว", "success");
        } catch (error) {
          console.error("บันทึกข้อมูลผู้ใช้ล้มเหลว:", error);
          showToast(
            "ไม่สามารถบันทึกข้อมูลผู้ใช้ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalHtml;
        }
      }

      // ============================================================
      // ฟังก์ชัน: สร้างผู้ใช้ใหม่ (ใช้ Auth App แยกเพื่อไม่ให้ logout admin)
      // ============================================================
      async function handleCreateNewUser() {
        if (!currentUserProfile || currentUserProfile.role !== "admin") {
          showToast("คุณไม่มีสิทธิ์สร้างผู้ใช้ใหม่ (เฉพาะผู้ดูแลระบบ)", "danger");
          return;
        }
        if (isCreatingNewUser) return;

        const email = newUserEmailInput.value.trim();
        const password = newUserPasswordInput.value;
        const displayName = newUserDisplayNameInput.value.trim();
        const role = newUserRoleSelect.value;
        const branchId = newUserBranchIdInput.value.trim() || null;

        if (!email || !password || !displayName) {
          showToast("กรุณากรอกอีเมล รหัสผ่าน และชื่อแสดงให้ครบ", "warning");
          return;
        }
        if (password.length < 6) {
          showToast("รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร", "warning");
          return;
        }

        isCreatingNewUser = true;
        newUserCreateSpinner.classList.remove("d-none");
        newUserCreateBtnText.textContent = "กำลังสร้าง...";
        newUserCreateBtn.disabled = true;
        newUserCreateStatusText.textContent = "กำลังสร้างผู้ใช้ใหม่...";
        newUserCreateStatusText.className = "text-primary small";

        try {
          // ใช้ Secondary App เพื่อสร้างผู้ใช้ใหม่โดยไม่กระทบ session ปัจจุบัน
          const secondaryApp = initializeApp(firebaseConfig, "admin-create-user");
          const secondaryAuth = getAuth(secondaryApp);

          const userCredential = await createUserWithEmailAndPassword(
            secondaryAuth,
            email,
            password
          );
          const newUser = userCredential.user;

          // สร้างเอกสาร users สำหรับผู้ใช้ใหม่
          const userRef = doc(db, "users", newUser.uid);
          await setDoc(userRef, {
            displayName,
            role,
            createdAt: serverTimestamp(),
            branchId,
            theme: "light",
            disabled: false,
            email, // บันทึก email เผื่อใช้ในตาราง
          });

          // ปิด secondaryApp session (ถ้าจำเป็น)
          try {
            await signOut(secondaryAuth);
          } catch (e) {
            console.warn("signOut secondary auth ไม่สำเร็จแต่ไม่เป็นอันตราย:", e);
          }

          // เคลียร์ฟอร์ม
          newUserEmailInput.value = "";
          newUserPasswordInput.value = "";
          newUserDisplayNameInput.value = "";
          newUserBranchIdInput.value = "";
          newUserRoleSelect.value = "staff";

          newUserCreateStatusText.innerHTML = '<i class="bi bi-check-circle me-1"></i> สร้างผู้ใช้ใหม่สำเร็จแล้ว';
          newUserCreateStatusText.className = "text-success small";
          showToast("สร้างผู้ใช้ใหม่สำเร็จแล้ว", "success");

          // โหลด users ใหม่
          await loadAllUsers();
        } catch (error) {
          console.error("สร้างผู้ใช้ใหม่ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถสร้างผู้ใช้ใหม่ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
          newUserCreateStatusText.textContent =
            "ไม่สามารถสร้างผู้ใช้ใหม่ได้: " + (error.code || "error");
          newUserCreateStatusText.className = "text-danger small";
        } finally {
          isCreatingNewUser = false;
          newUserCreateSpinner.classList.add("d-none");
          newUserCreateBtnText.innerHTML = '<i class="bi bi-plus-lg me-1"></i> สร้างผู้ใช้ใหม่';
          newUserCreateBtn.disabled = false;
        }
      }

      // ============================================================
      // ฟังก์ชัน: ตรวจสอบช่วงวันที่สำหรับ Backup
      // ============================================================
      function validateBackupRange() {
        const startStr = backupStartDateInput.value;
        const endStr = backupEndDateInput.value;

        if (!startStr || !endStr) {
          backupRangeStatusText.textContent =
            "กรุณาเลือกวันที่เริ่มต้นและสิ้นสุดให้ครบก่อน Export";
          backupRangeStatusText.classList.remove("text-success", "text-danger", "text-primary");
          backupRangeStatusText.classList.add("text-warning");
          return null;
        }

        if (startStr > endStr) {
          backupRangeStatusText.textContent =
            "วันที่เริ่มต้นต้องไม่มากกว่าวันที่สิ้นสุด";
          backupRangeStatusText.classList.remove("text-success", "text-primary");
          backupRangeStatusText.classList.add("text-danger");
          return null;
        }

        backupRangeStatusText.innerHTML =
          '<i class="bi bi-check-circle-fill me-1"></i> ช่วงวันที่: ' +
          formatDateThaiFromString(startStr) +
          " - " +
          formatDateThaiFromString(endStr);
        backupRangeStatusText.classList.remove("text-danger", "text-warning", "text-primary");
        backupRangeStatusText.classList.add("text-success");

        return { startStr, endStr };
      }

      // ============================================================
      // ฟังก์ชัน: ดึง Jobs ตามช่วงวันที่ (Backup)
      // ============================================================
      async function loadJobsForBackup(startStr, endStr, branchId) {
        const constraints = [
          where("isDeleted", "==", false),
          where("date", ">=", startStr),
          where("date", "<=", endStr),
        ];
        if (branchId) {
          constraints.push(where("branchId", "==", branchId));
        }

        const jobsCol = collection(db, "jobs");
        const qJobs = query(
          jobsCol,
          ...constraints,
          orderBy("date", "asc")
        );

        // หมายเหตุ: หากมี error เรื่อง Index ให้ไปสร้าง Index ตามลิงก์ที่ Firestore แจ้งครั้งแรก
        const snap = await getDocs(qJobs);

        const results = [];
        snap.forEach((docSnap) => {
          results.push({
            id: docSnap.id,
            ...docSnap.data(),
          });
        });

        return results;
      }

      // ============================================================
      // ฟังก์ชัน: ดึง Transactions ตามช่วงวันที่ (Backup)
      // ============================================================
      async function loadTransactionsForBackup(startStr, endStr, branchId) {
        const constraints = [
          where("isDeleted", "==", false),
          where("date", ">=", startStr),
          where("date", "<=", endStr),
        ];
        if (branchId) {
          constraints.push(where("branchId", "==", branchId));
        }

        const txCol = collection(db, "transactions");
        const qTx = query(
          txCol,
          ...constraints,
          orderBy("date", "asc")
        );

        // หมายเหตุ: หาก Firestore แจ้งให้สร้าง Index ให้สร้างตามลิงก์ (ครั้งแรกเท่านั้น)
        const snap = await getDocs(qTx);

        const results = [];
        snap.forEach((docSnap) => {
          results.push({
            id: docSnap.id,
            ...docSnap.data(),
          });
        });

        return results;
      }

      // ============================================================
      // ฟังก์ชัน: Trigger ดาวน์โหลดไฟล์
      // ============================================================
      function triggerDownloadFile(filename, content, mimeType) {
        if (!hiddenDownloadLink) return;

        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);

        hiddenDownloadLink.href = url;
        hiddenDownloadLink.download = filename;
        hiddenDownloadLink.click();

        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 1000);
      }

      // ============================================================
      // ฟังก์ชัน: Export Jobs JSON / CSV
      // ============================================================
      async function handleExportJobsJson() {
        if (!currentUserProfile) return;
        if (isExportingBackup) return;

        const range = validateBackupRange();
        if (!range) {
          showToast("กรุณาเลือกช่วงวันที่ให้ถูกต้องก่อน Export Jobs", "warning");
          return;
        }

        isExportingBackup = true;
        try {
          const branchId = currentUserProfile.branchId || null;
          const jobs = await loadJobsForBackup(
            range.startStr,
            range.endStr,
            branchId
          );

          const payload = {
            type: "jobs",
            range,
            count: jobs.length,
            docs: jobs,
          };

          const jsonStr = JSON.stringify(payload, null, 2);
          const filename = `ben-motor-backup-jobs-${range.startStr}-${range.endStr}.json`;
          triggerDownloadFile(filename, jsonStr, "application/json");

          if (backupResultTextarea) {
            backupResultTextarea.value = jsonStr;
          }

          showToast("Export Jobs (JSON) สำเร็จ", "success");
        } catch (error) {
          console.error("Export Jobs JSON ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถ Export Jobs (JSON) ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        } finally {
          isExportingBackup = false;
        }
      }

      async function handleExportJobsCsv() {
        if (!currentUserProfile) return;
        if (isExportingBackup) return;

        const range = validateBackupRange();
        if (!range) {
          showToast("กรุณาเลือกช่วงวันที่ให้ถูกต้องก่อน Export Jobs", "warning");
          return;
        }

        isExportingBackup = true;
        try {
          const branchId = currentUserProfile.branchId || null;
          const jobs = await loadJobsForBackup(
            range.startStr,
            range.endStr,
            branchId
          );

          // header หลัก (ไม่รวม items/laborItems ในเชิงลึก)
          const header = [
            "id",
            "date",
            "customerName",
            "customerPhone",
            "plate",
            "brand",
            "model",
            "mileage",
            "problem",
            "status",
            "priority",
            "partsTotal",
            "laborTotal",
            "totalAmount",
            "createdBy",
            "createdByName",
            "branchId",
          ];

          const rows = jobs.map((job) => [
            job.id || "",
            job.date || "",
            job.customerName || "",
            job.customerPhone || "",
            job.plate || "",
            job.brand || "",
            job.model || "",
            job.mileage != null ? String(job.mileage) : "",
            job.problem || "",
            job.status || "",
            job.priority || "",
            job.partsTotal != null ? String(job.partsTotal) : "",
            job.laborTotal != null ? String(job.laborTotal) : "",
            job.totalAmount != null ? String(job.totalAmount) : "",
            job.createdBy || "",
            job.createdByName || "",
            job.branchId || "",
          ]);

          const csvLines = [];
          csvLines.push(header.join(","));
          rows.forEach((row) => {
            const line = row
              .map((value) => {
                const text = String(value ?? "");
                if (
                  text.includes(",") ||
                  text.includes('"') ||
                  text.includes("\n")
                ) {
                  return `"${text.replace(/"/g, '""')}"`;
                }
                return text;
              })
              .join(",");
            csvLines.push(line);
          });

          const csvContent = csvLines.join("\r\n");
          const filename = `ben-motor-backup-jobs-${range.startStr}-${range.endStr}.csv`;
          triggerDownloadFile(
            filename,
            csvContent,
            "text/csv;charset=utf-8;"
          );

          showToast("Export Jobs (CSV) สำเร็จ", "success");
        } catch (error) {
          console.error("Export Jobs CSV ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถ Export Jobs (CSV) ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        } finally {
          isExportingBackup = false;
        }
      }

      // ============================================================
      // ฟังก์ชัน: Export Transactions JSON / CSV
      // ============================================================
      async function handleExportTxJson() {
        if (!currentUserProfile) return;
        if (isExportingBackup) return;

        const range = validateBackupRange();
        if (!range) {
          showToast(
            "กรุณาเลือกช่วงวันที่ให้ถูกต้องก่อน Export Transactions",
            "warning"
          );
          return;
        }

        isExportingBackup = true;
        try {
          const branchId = currentUserProfile.branchId || null;
          const txns = await loadTransactionsForBackup(
            range.startStr,
            range.endStr,
            branchId
          );

          const payload = {
            type: "transactions",
            range,
            count: txns.length,
            docs: txns,
          };

          const jsonStr = JSON.stringify(payload, null, 2);
          const filename = `ben-motor-backup-transactions-${range.startStr}-${range.endStr}.json`;
          triggerDownloadFile(filename, jsonStr, "application/json");

          if (backupResultTextarea) {
            backupResultTextarea.value = jsonStr;
          }

          showToast("Export Transactions (JSON) สำเร็จ", "success");
        } catch (error) {
          console.error("Export Transactions JSON ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถ Export Transactions (JSON) ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        } finally {
          isExportingBackup = false;
        }
      }

      async function handleExportTxCsv() {
        if (!currentUserProfile) return;
        if (isExportingBackup) return;

        const range = validateBackupRange();
        if (!range) {
          showToast(
            "กรุณาเลือกช่วงวันที่ให้ถูกต้องก่อน Export Transactions",
            "warning"
          );
          return;
        }

        isExportingBackup = true;
        try {
          const branchId = currentUserProfile.branchId || null;
          const txns = await loadTransactionsForBackup(
            range.startStr,
            range.endStr,
            branchId
          );

          const header = [
            "id",
            "date",
            "type",
            "category",
            "description",
            "amount",
            "method",
            "sourceType",
            "sourceId",
            "createdBy",
            "createdByName",
            "branchId",
          ];

          const rows = txns.map((t) => [
            t.id || "",
            t.date || "",
            t.type || "",
            t.category || "",
            t.description || "",
            t.amount != null ? String(t.amount) : "",
            t.method || "",
            t.sourceType || "",
            t.sourceId || "",
            t.createdBy || "",
            t.createdByName || "",
            t.branchId || "",
          ]);

          const csvLines = [];
          csvLines.push(header.join(","));
          rows.forEach((row) => {
            const line = row
              .map((value) => {
                const text = String(value ?? "");
                if (
                  text.includes(",") ||
                  text.includes('"') ||
                  text.includes("\n")
                ) {
                  return `"${text.replace(/"/g, '""')}"`;
                }
                return text;
              })
              .join(",");
            csvLines.push(line);
          });

          const csvContent = csvLines.join("\r\n");
          const filename = `ben-motor-backup-transactions-${range.startStr}-${range.endStr}.csv`;
          triggerDownloadFile(
            filename,
            csvContent,
            "text/csv;charset=utf-8;"
          );

          showToast("Export Transactions (CSV) สำเร็จ", "success");
        } catch (error) {
          console.error("Export Transactions CSV ไม่สำเร็จ:", error);
          showToast(
            "ไม่สามารถ Export Transactions (CSV) ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        } finally {
          isExportingBackup = false;
        }
      }

      // ============================================================
      // ตั้งค่า Event Listeners สำหรับหน้านี้
      // ============================================================
      function setupEventListenersForPage() {
        // Logout
        logoutBtn?.addEventListener("click", () => {
          handleLogout();
        });

        // สลับธีมผ่านปุ่มบน Topbar
        themeToggleBtn?.addEventListener("click", async () => {
          const currentTheme = bodyEl.classList.contains("bm-theme-dark")
            ? "dark"
            : "light";
          const nextTheme = currentTheme === "dark" ? "light" : "dark";
          applyTheme(nextTheme);
          if (currentUser) {
            saveThemeForUser(currentUser.uid, nextTheme);
            try {
              const userRef = doc(db, "users", currentUser.uid);
              await updateDoc(userRef, { theme: nextTheme });
            } catch (error) {
              console.error("อัปเดตธีมใน Firestore ไม่สำเร็จ:", error);
            }
          }
        });

        // บันทึกโปรไฟล์
        profileSaveBtn?.addEventListener("click", () => {
          handleSaveProfile();
        });

        // Enter บางส่วนของฟอร์มโปรไฟล์
        [profileDisplayNameInput, profileBranchIdInput].forEach((input) => {
          input?.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              handleSaveProfile();
            }
          });
        });

        // เปลี่ยน radio theme ในโปรไฟล์แล้วให้ mark ว่ามีการเปลี่ยน
        [themeLightRadio, themeDarkRadio].forEach((radio) => {
          radio?.addEventListener("change", () => {
            if (profileSaveStatusText) {
              profileSaveStatusText.innerHTML =
                '<i class="bi bi-info-circle"></i> มีการเปลี่ยนแปลงธีมแล้ว แต่ยังไม่ได้บันทึก';
              profileSaveStatusText.className = "text-warning small";
            }
          });
        });

        // สร้างผู้ใช้ใหม่
        newUserCreateBtn?.addEventListener("click", () => {
          handleCreateNewUser();
        });

        [newUserEmailInput, newUserPasswordInput, newUserDisplayNameInput].forEach(
          (input) => {
            input?.addEventListener("keypress", (event) => {
              if (event.key === "Enter") {
                event.preventDefault();
                handleCreateNewUser();
              }
            });
          }
        );

        // Backup Export ปุ่ม
        backupJobsJsonBtn?.addEventListener("click", () => {
          handleExportJobsJson();
        });
        backupJobsCsvBtn?.addEventListener("click", () => {
          handleExportJobsCsv();
        });
        backupTxJsonBtn?.addEventListener("click", () => {
          handleExportTxJson();
        });
        backupTxCsvBtn?.addEventListener("click", () => {
          handleExportTxCsv();
        });

        // กด Enter ใน input วันที่ backup
        [backupStartDateInput, backupEndDateInput].forEach((input) => {
          input?.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              validateBackupRange();
            }
          });
        });

        // FAB เมนูด่วน
        fabOpenBillBtn?.addEventListener("click", () => {
          window.location.href = "open-bill.html";
        });
        fabAddTxnBtn?.addEventListener("click", () => {
          window.location.href = "finance.html";
        });
        fabStockInBtn?.addEventListener("click", () => {
          window.location.href = "stock.html";
        });
      }

      // ============================================================
      // Auth Guard ของหน้า settings.html
      // ============================================================
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        currentUser = user;

        try {
          const userProfile = await ensureUserProfile(user);
          currentUserProfile = userProfile;

          // ถ้าบัญชีถูกระงับ
          if (userProfile.disabled === true) {
            await signOut(auth);
            showToast(
              "บัญชีนี้ถูกระงับการใช้งาน กรุณาติดต่อผู้ดูแลระบบ",
              "danger"
            );
            window.location.href = "index.html";
            return;
          }

          // อัปเดต Topbar
          if (userDisplayNameText) {
            userDisplayNameText.textContent = userProfile.displayName || "-";
          }
          if (userAvatarInitial) {
            const dn = userProfile.displayName || "U";
            userAvatarInitial.textContent = dn.trim().charAt(0).toUpperCase();
          }

          if (userRoleText) {
            const roleLabel =
              userProfile.role === "admin" ? "Admin" : "Staff";
            userRoleText.textContent = roleLabel;
          }

          if (settingsRoleBadge) {
            settingsRoleBadge.innerHTML = `<i class="bi bi-shield-lock-fill me-1 ${userProfile.role === 'admin' ? 'text-danger' : 'text-primary'}"></i>Role: ${userProfile.role || "staff"}`;
          }

          // เมนูตั้งค่าระบบ: ตามสเปกให้แสดงเฉพาะ admin
          if (settingsMenuItem) {
            if (userProfile.role === "admin") {
              settingsMenuItem.classList.remove("d-none");
            } else {
              settingsMenuItem.classList.add("d-none");
            }
          }

          // การควบคุม Tab ผู้ใช้ในระบบ
          if (userProfile.role === "admin") {
            usersTabNavItem?.classList.remove("d-none");
            usersAdminOnlyBadge?.classList.remove("d-none");
            usersNotAdminAlert?.classList.add("d-none");
          } else {
            // ซ่อน Tab ผู้ใช้ในระบบจาก Staff ตามสเปก
            usersTabNavItem?.classList.add("d-none");
            usersAdminOnlyBadge?.classList.add("d-none");
            usersNotAdminAlert?.classList.remove("d-none");
          }

          // ธีม
          const baseTheme = userProfile.theme || "light";
          const themeToUse = readThemeForUser(user.uid, baseTheme);
          applyTheme(themeToUse);

          // ตั้งค่าวันเริ่มต้นของ Backup เป็นวันนี้
          const todayStr = getTodayISODateString();
          if (backupStartDateInput) backupStartDateInput.value = todayStr;
          if (backupEndDateInput) backupEndDateInput.value = todayStr;

          updateProfileTabUI();
          setupEventListenersForPage();

          // ถ้าเป็น admin ให้โหลดรายชื่อผู้ใช้ทั้งหมด
          if (userProfile.role === "admin") {
            await loadAllUsers();
          }
        } catch (error) {
          console.error("เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้:", error);
          showToast(
            "ไม่สามารถโหลดข้อมูลผู้ใช้ได้ กรุณาลองใหม่อีกครั้ง (" +
              (error.code || "error") +
              ")",
            "danger"
          );
        }
      });
    </script>
  </body>
</html>