<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>BEN MOTOR – รายการงานซ่อม</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="manifest" href="img/site.webmanifest">
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="bm-theme-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary shadow-sm fixed-top bm-topbar">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 fw-bold text-success">
          <i class="bi bi-speedometer2 me-1"></i> BEN MOTOR
        </span>

        <div class="d-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center border-0 bg-transparent"
            id="themeToggleBtn"
            type="button"
            aria-label="สลับโหมดธีม"
            style="width: 2.5rem; height: 2.5rem;"
          >
            <i class="bi bi-moon fs-5"></i>
          </button>

          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-light text-dark border-0 d-flex align-items-center pe-0"
              type="button"
              id="userMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <span
                class="rounded-circle bg-gradient bg-success text-white d-inline-flex align-items-center justify-content-center me-2 bm-avatar-circle shadow-sm"
                id="userAvatarCircle"
              >
                <span id="userAvatarInitial" class="fw-bold">U</span>
              </span>
              <span class="small text-start d-none d-sm-block">
                <span id="userDisplayNameText" class="fw-semibold">กำลังโหลด...</span>
                <br />
                <span class="text-muted text-xs" id="userRoleText">-</span>
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 mt-2 rounded-4">
              <li>
                <a class="dropdown-item py-2" href="reports.html">
                  <i class="bi bi-graph-up-arrow me-2 text-primary"></i> รายงานทั้งหมด
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="price-check.html">
                  <i class="bi bi-tags me-2 text-warning"></i> เช็คราคา
                </a>
              </li>
              <li>
                <a class="dropdown-item py-2" href="customer-history.html">
                  <i class="bi bi-person-lines-fill me-2 text-info"></i> ประวัติลูกค้า &amp; รถ
                </a>
              </li>              
              <li>
                <a class="dropdown-item py-2" href="activity-log.html">
                  <i class="bi bi-clock-history me-2 text-secondary"></i> ประวัติการทำรายการ
                </a>
              </li>              
              <li>
                <a
                  class="dropdown-item py-2 d-none"
                  href="settings.html"
                  id="settingsMenuItem"
                >
                  <i class="bi bi-gear me-2"></i> ตั้งค่าระบบ
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button
                  class="dropdown-item py-2 text-danger"
                  type="button"
                  id="logoutBtn"
                >
                  <i class="bi bi-box-arrow-right me-2"></i> ออกจากระบบ
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="bm-main-content pb-5">
      <div class="container py-4">
        <div class="d-flex justify-content-between align-items-end mb-4 mt-2">
          <div>
            <h1 class="h4 mb-1 fw-bold text-dark">งานซ่อมย้อนหลัง</h1>
            <p class="small text-muted mb-0">
              จัดการรายการซ่อม ตรวจสอบสถานะ และดูยอดเงินรวม
            </p>
          </div>
          <div class="text-end">
            <span class="badge bg-white text-dark border shadow-sm px-3 py-2 rounded-pill fw-normal" id="jobsDateRangeSummary">
              -
            </span>
          </div>
        </div>

        <section class="mb-4">
           <div class="bm-dashboard-grid">
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">จำนวนงานที่พบ</div>
                 <div class="bm-stat-value text-primary" id="statTotalJobs">0</div>
                 <div class="bm-stat-sub text-muted">รายการ</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">ยอดรวมทั้งหมด</div>
                 <div class="bm-stat-value text-success" id="statTotalRevenue">0</div>
                 <div class="bm-stat-sub text-muted">บาท</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">เฉลี่ยต่อคัน</div>
                 <div class="bm-stat-value text-dark" id="statAvgRevenue">0</div>
                 <div class="bm-stat-sub text-muted">บาท/คัน</div>
              </div>
              <div class="bm-stat-card shadow-sm">
                 <div class="bm-stat-label mb-1">กำลังซ่อม</div>
                 <div class="bm-stat-value text-warning" id="statPendingJobs">0</div>
                 <div class="bm-stat-sub text-muted">คัน</div>
              </div>
           </div>
        </section>

        <section class="mb-4">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                 <h2 class="h6 fw-bold text-success mb-0">
                   <i class="bi bi-funnel-fill me-2"></i> ตัวกรองค้นหา
                 </h2>
                 <button class="btn btn-sm btn-outline-success rounded-pill px-3" id="exportCsvBtn">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> ส่งออก CSV
                 </button>
              </div>
              
              <form id="jobsFilterForm" class="row g-3 align-items-end">
                <div class="col-6 col-md-3">
                  <label for="jobsStartDate" class="form-label small text-muted mb-1">วันที่เริ่มต้น</label>
                  <input type="date" class="form-control form-control-sm bg-light" id="jobsStartDate" />
                </div>
                <div class="col-6 col-md-3">
                  <label for="jobsEndDate" class="form-label small text-muted mb-1">วันที่สิ้นสุด</label>
                  <input type="date" class="form-control form-control-sm bg-light" id="jobsEndDate" />
                </div>
                <div class="col-6 col-md-2">
                  <label for="jobsStatusFilter" class="form-label small text-muted mb-1">สถานะงาน</label>
                  <select id="jobsStatusFilter" class="form-select form-select-sm bg-light">
                    <option value="all" selected>ทั้งหมด</option>
                    <option value="repairing">กำลังซ่อมอยู่</option>
                    <option value="done">ซ่อมเสร็จแล้ว</option>
                    <option value="picked_up">ลูกค้ารับรถแล้ว</option>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label for="jobsSearchInput" class="form-label small text-muted mb-1">ค้นหา (ชื่อ, ทะเบียน, ยี่ห้อ, ปัญหา)</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control bg-light border-start-0 ps-0" id="jobsSearchInput" placeholder="พิมพ์คำค้น..." />
                    <button type="submit" class="btn btn-success px-3" id="jobsSearchBtn">ค้นหา</button>
                  </div>
                </div>
              </form>

              <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 pt-2 border-top gap-3">
                <div class="d-flex align-items-center gap-2 w-100 w-md-auto overflow-auto pb-1 pb-md-0">
                   <span class="small text-muted me-1 text-nowrap">ช่วงเวลา:</span>
                   <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3 text-nowrap" id="presetTodayBtn">วันนี้</button>
                   <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3 text-nowrap" id="preset7DaysBtn">7 วัน</button>
                   <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3 text-nowrap" id="preset30DaysBtn">30 วัน</button>
                   <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3 text-nowrap" id="presetAllBtn">ทั้งหมด</button>
                </div>

                <div class="d-flex align-items-center gap-2 ms-md-auto">
                    <span class="small text-muted me-1">มุมมอง:</span>
                    <div class="btn-group btn-group-sm bg-light p-1 rounded-pill border" role="group">
                        <button type="button" class="btn btn-sm btn-light rounded-pill border-0 px-3 active text-success fw-bold" id="tableViewBtn">
                            <i class="bi bi-table"></i> ตาราง
                        </button>
                        <button type="button" class="btn btn-sm btn-light rounded-pill border-0 px-3 text-success" id="cardViewBtn">
                            <i class="bi bi-grid-fill"></i> การ์ด
                        </button>
                    </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <section class="mb-3 d-flex justify-content-between align-items-center px-2">
           <div id="jobsCountInfo" class="small text-muted d-none">
              </div>
           <div id="jobsLoadingState" class="small text-primary d-none">
              <span class="spinner-border spinner-border-sm me-2" role="status"></span> กำลังโหลดข้อมูล...
           </div>
        </section>

        <section id="jobsTableView" class="mb-4">
          <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="bg-light text-secondary small text-uppercase">
                    <tr>
                      <th class="ps-4 py-3 fw-normal" style="min-width: 110px;">วันที่</th>
                      <th class="py-3 fw-normal" style="min-width: 150px;">ลูกค้า</th>
                      <th class="py-3 fw-normal" style="min-width: 100px;">ทะเบียน</th>
                      <th class="py-3 fw-normal" style="min-width: 160px;">ยี่ห้อ / รุ่น</th>
                      <th class="py-3 fw-normal" style="min-width: 130px;">สถานะ</th>
                      <th class="text-end py-3 fw-normal" style="min-width: 110px;">ยอดรวม (฿)</th>
                      <th class="text-center py-3 fw-normal" style="min-width: 80px;">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="jobsTableBody" class="border-top-0">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <section id="jobsCardView" class="mb-4 d-none">
          <div id="jobsCardContainer" class="row g-3">
            </div>
        </section>

        <section class="mb-5 text-center">
          <button
            type="button"
            class="btn btn-white border shadow-sm rounded-pill px-4 py-2 text-muted d-none"
            id="loadMoreJobsBtn"
          >
            <span
              class="spinner-border spinner-border-sm me-2 d-none"
              id="loadMoreJobsSpinner"
              role="status"
              aria-hidden="true"
            ></span>
            <span id="loadMoreJobsBtnText">โหลดเพิ่มเติม</span>
            <i class="bi bi-chevron-down ms-1"></i>
          </button>
        </section>

        <div style="height: 3rem;"></div>
      </div>
    </main>

    <div class="bm-fab-container">
      <div class="dropdown dropup">

        <ul class="dropdown-menu dropdown-menu-end mb-2 shadow rounded-4 border-0 p-2" aria-labelledby="fabDropdownButton">
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabOpenBillBtn">
              <span class="bg-primary bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-receipt-cutoff text-primary"></i></span>
              เปิดบิลซ่อมใหม่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddTxnBtn">
              <span class="bg-success bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-cash-coin text-success"></i></span>
              เพิ่มรายการเงิน
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabStockInBtn">
              <span class="bg-warning bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-box-seam text-warning"></i></span>
              บันทึกซื้ออะไหล่
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center rounded-3 py-2" type="button" id="fabAddVehicleBtn">
              <span class="bg-info bg-opacity-10 rounded-circle p-1 me-2 d-flex"><i class="bi bi-truck-front text-info"></i></span>
              เพิ่มรถรับซื้อเข้า
            </button>
          </li>
        </ul>
      </div>
    </div>

    <nav class="navbar navbar-light bg-body-tertiary border-top bm-bottom-nav fixed-bottom">
      <div class="container-fluid px-0">
        <div class="row g-0 w-100 text-center small">
          <div class="col">
            <a href="dashboard.html" class="bm-bottom-nav-link">
              <i class="bi bi-speedometer2 d-block fs-5"></i>
              <span>แดชบอร์ด</span>
            </a>
          </div>
          <div class="col">
            <a href="open-bill.html" class="bm-bottom-nav-link">
              <i class="bi bi-receipt-cutoff d-block fs-5"></i>
              <span>เปิดบิล</span>
            </a>
          </div>
          <div class="col">
            <a href="jobs.html" class="bm-bottom-nav-link active">
              <i class="bi bi-wrench-adjustable-circle d-block fs-5"></i>
              <span>งานซ่อม</span>
            </a>
          </div>
          <div class="col">
            <a href="vehicles.html" class="bm-bottom-nav-link">
              <i class="bi bi-truck-front d-block fs-5"></i>
              <span>รถรับซื้อ</span>
            </a>
          </div>
          <div class="col">
            <a href="stock.html" class="bm-bottom-nav-link">
              <i class="bi bi-box-seam d-block fs-5"></i>
              <span>สต๊อก</span>
            </a>
          </div>
          <div class="col">
            <a href="finance.html" class="bm-bottom-nav-link">
              <i class="bi bi-cash-coin d-block fs-5"></i>
              <span>เงินเข้าออก</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="modal fade"
      id="jobDetailModal"
      tabindex="-1"
      aria-labelledby="jobDetailModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
          <div class="modal-header border-bottom-0 pb-0">
            <h1 class="modal-title fs-5 fw-bold text-primary" id="jobDetailModalLabel">
              <i class="bi bi-file-earmark-text me-2"></i> รายละเอียดงานซ่อม
            </h1>
            <div class="ms-auto d-flex gap-2">
                 <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" id="jobDetailPrintBtn" title="พิมพ์ใบงาน">
                    <i class="bi bi-printer-fill"></i> <span class="d-none d-sm-inline ms-1">พิมพ์</span>
                 </button>
                 <button
                   type="button"
                   class="btn-close ms-0"
                   data-bs-dismiss="modal"
                   aria-label="ปิด"
                 ></button>
            </div>
          </div>
          <div class="modal-body pt-3">
            <div id="jobDetailLoadingState" class="alert alert-light border text-center text-muted small py-3 d-none">
              <div class="spinner-border spinner-border-sm me-2" role="status"></div> กำลังโหลดรายละเอียด...
            </div>

            <div class="card border-0 bg-light rounded-4 mb-3">
              <div class="card-body">
                <div class="row g-3 small">
                  <div class="col-12 col-md-6 border-end-md">
                    <div class="mb-2"><span class="text-muted d-block text-xs">วันที่รับงาน</span> <span id="jobDetailDate" class="fw-semibold text-dark fs-6">-</span></div>
                    <div class="mb-2"><span class="text-muted d-block text-xs">ลูกค้า</span> <span id="jobDetailCustomerName" class="fw-medium">-</span></div>
                    <div><span class="text-muted d-block text-xs">เบอร์โทรศัพท์</span> <span id="jobDetailCustomerPhone">-</span></div>
                  </div>
                  <div class="col-12 col-md-6 ps-md-3">
                    <div class="mb-2"><span class="text-muted d-block text-xs">ทะเบียนรถ</span> <span id="jobDetailPlate" class="fw-semibold text-primary fs-6">-</span></div>
                    <div class="mb-2"><span class="text-muted d-block text-xs">ยี่ห้อ / รุ่น</span> <span id="jobDetailBrandModel">-</span></div>
                    <div><span class="text-muted d-block text-xs">เลขไมล์</span> <span id="jobDetailMileage">-</span></div>
                  </div>
                  <div class="col-12 pt-2 border-top">
                     <span class="text-muted d-block text-xs mb-1">อาการ / ปัญหา</span>
                     <div id="jobDetailProblem" class="bg-white p-2 rounded border-0 text-dark">-</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card border border-warning-subtle bg-warning bg-opacity-10 rounded-4 mb-3">
               <div class="card-body py-3">
                  <div class="row align-items-center g-3">
                     <div class="col-12 col-md-6">
                        <div class="small text-muted mb-1">สถานะปัจจุบัน</div>
                        <div class="d-flex align-items-center gap-2">
                           <span id="jobDetailStatusBadge" class="badge rounded-pill px-3 py-2">-</span>
                           <span id="jobDetailPriorityBadge" class="badge rounded-pill px-3 py-2">-</span>
                        </div>
                        <div class="text-xs text-muted mt-2">
                           เปิดบิลโดย: <span id="jobDetailCreatedBy" class="fw-medium">-</span>
                        </div>
                     </div>
                     <div class="col-12 col-md-6">
                        <label for="jobDetailStatusSelect" class="form-label small text-dark fw-semibold mb-1">อัปเดตสถานะงาน</label>
                        <div class="input-group input-group-sm">
                           <select id="jobDetailStatusSelect" class="form-select border-warning-subtle">
                              <option value="repairing">กำลังซ่อมอยู่</option>
                              <option value="done">ซ่อมเสร็จแล้ว</option>
                              <option value="picked_up">ลูกค้ารับรถแล้ว</option>
                           </select>
                           <button type="button" class="btn btn-warning text-dark" id="jobDetailSaveStatusBtn">
                              <span class="spinner-border spinner-border-sm me-1 d-none" id="jobDetailSaveStatusSpinner"></span>
                              <span id="jobDetailSaveStatusBtnText">บันทึก</span>
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 mb-3 overflow-hidden">
               <div class="card-header bg-white border-bottom py-2">
                  <span class="fw-bold text-dark small"><i class="bi bi-list-check me-1"></i> รายการซ่อม</span>
               </div>
               <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                     <thead class="bg-light text-secondary">
                        <tr>
                           <th class="ps-3 border-0 fw-normal">รายการ (อะไหล่/ค่าแรง)</th>
                           <th class="text-end border-0 fw-normal">จำนวน</th>
                           <th class="text-end border-0 fw-normal">หน่วยละ</th>
                           <th class="text-end pe-3 border-0 fw-normal">รวม</th>
                        </tr>
                     </thead>
                     <tbody id="jobDetailPartsTbody"></tbody>
                     <tbody id="jobDetailLaborTbody" class="border-top-0"></tbody>
                     <tfoot class="bg-light">
                        <tr>
                           <td colspan="3" class="text-end small text-muted py-2">รวมค่าอะไหล่</td>
                           <td class="text-end pe-3 small fw-medium py-2" id="jobDetailPartsTotal">0.00 ฿</td>
                        </tr>
                        <tr>
                           <td colspan="3" class="text-end small text-muted py-2 border-0">รวมค่าแรง</td>
                           <td class="text-end pe-3 small fw-medium py-2 border-0" id="jobDetailLaborTotal">0.00 ฿</td>
                        </tr>
                        <tr class="table-primary border-primary">
                           <td colspan="3" class="text-end fw-bold text-primary py-2 border-0">ยอดรวมสุทธิ</td>
                           <td class="text-end pe-3 fw-bold text-primary fs-6 py-2 border-0" id="jobDetailGrandTotal">0.00 ฿</td>
                        </tr>
                     </tfoot>
                  </table>
               </div>
            </div>

            <div class="accordion accordion-flush rounded-4 border overflow-hidden" id="accordionLogs">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed small py-2 bg-light text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseLogs">
                    <i class="bi bi-clock-history me-2"></i> ประวัติกิจกรรม
                  </button>
                </h2>
                <div id="flush-collapseLogs" class="accordion-collapse collapse" data-bs-parent="#accordionLogs">
                  <div class="accordion-body p-0">
                     <ul class="list-group list-group-flush small" id="jobDetailLogsList">
                        <li class="list-group-item text-center text-muted">กำลังโหลด...</li>
                     </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer border-top-0 pt-0 pb-3">
             <button
               type="button"
               class="btn btn-link btn-sm text-danger text-decoration-none me-auto d-none"
               id="jobDetailSoftDeleteBtn"
             >
               <i class="bi bi-trash me-1"></i> ซ่อนบิล (Admin)
             </button>
             
             <button type="button" class="btn btn-sm btn-outline-primary rounded-pill d-none" id="jobDetailEditBtn">
                <i class="bi bi-pencil-square me-1"></i> แก้ไข
             </button>

            <button
              type="button"
              class="btn btn-light rounded-pill px-4"
              data-bs-dismiss="modal"
            >
              ปิด
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="position-fixed top-0 start-50 translate-middle-x p-3"
      style="z-index: 1080;"
    >
      <div
        id="mainToast"
        class="toast align-items-center text-bg-primary border-0 shadow-lg rounded-pill"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="4000"
      >
        <div class="d-flex px-2">
          <div class="toast-body" id="mainToastBody">
            </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="ปิด"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import {
        getAuth, onAuthStateChanged, signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, query, where, orderBy, limit, startAfter, serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBZuJ0Gpsz61oF0yrmKcreBsOfpJqPffYo",
        authDomain: "ben-motor.firebaseapp.com",
        projectId: "ben-motor",
        storageBucket: "ben-motor.firebasestorage.app",
        messagingSenderId: "814162692446",
        appId: "1:814162692446:web:7753156248d76938fce7cf",
        measurementId: "G-TVDDW82Q5B"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- DOM Elements ---
      const bodyEl = document.body;
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      
      // User Menu
      const userDisplayNameText = document.getElementById("userDisplayNameText");
      const userRoleText = document.getElementById("userRoleText");
      const userAvatarInitial = document.getElementById("userAvatarInitial");
      const settingsMenuItem = document.getElementById("settingsMenuItem");
      const logoutBtn = document.getElementById("logoutBtn");

      // Filter Inputs
      const jobsFilterForm = document.getElementById("jobsFilterForm");
      const jobsStartDateInput = document.getElementById("jobsStartDate");
      const jobsEndDateInput = document.getElementById("jobsEndDate");
      const jobsStatusFilterSelect = document.getElementById("jobsStatusFilter");
      const jobsSearchInput = document.getElementById("jobsSearchInput");
      const jobsSearchBtn = document.getElementById("jobsSearchBtn");
      const exportCsvBtn = document.getElementById("exportCsvBtn");

      // Presets
      const presetTodayBtn = document.getElementById("presetTodayBtn");
      const preset7DaysBtn = document.getElementById("preset7DaysBtn");
      const preset30DaysBtn = document.getElementById("preset30DaysBtn");
      const presetAllBtn = document.getElementById("presetAllBtn");
      const jobsDateRangeSummary = document.getElementById("jobsDateRangeSummary");

      // Stats Elements
      const statTotalJobs = document.getElementById("statTotalJobs");
      const statTotalRevenue = document.getElementById("statTotalRevenue");
      const statAvgRevenue = document.getElementById("statAvgRevenue");
      const statPendingJobs = document.getElementById("statPendingJobs");

      // View Toggles
      const tableViewBtn = document.getElementById("tableViewBtn");
      const cardViewBtn = document.getElementById("cardViewBtn");
      const jobsTableView = document.getElementById("jobsTableView");
      const jobsCardView = document.getElementById("jobsCardView");

      // List Rendering
      const jobsLoadingState = document.getElementById("jobsLoadingState");
      const jobsCountInfo = document.getElementById("jobsCountInfo");
      const jobsTableBody = document.getElementById("jobsTableBody");
      const jobsCardContainer = document.getElementById("jobsCardContainer");
      const loadMoreJobsBtn = document.getElementById("loadMoreJobsBtn");
      const loadMoreJobsSpinner = document.getElementById("loadMoreJobsSpinner");
      const loadMoreJobsBtnText = document.getElementById("loadMoreJobsBtnText");

      // FAB
      const fabOpenBillBtn = document.getElementById("fabOpenBillBtn");
      const fabAddTxnBtn = document.getElementById("fabAddTxnBtn");
      const fabStockInBtn = document.getElementById("fabStockInBtn");
      const fabAddVehicleBtn = document.getElementById("fabAddVehicleBtn");

      // Modal Elements
      const jobDetailModalEl = document.getElementById("jobDetailModal");
      const jobDetailModalLabel = document.getElementById("jobDetailModalLabel");
      const jobDetailLoadingState = document.getElementById("jobDetailLoadingState");
      const jobDetailPrintBtn = document.getElementById("jobDetailPrintBtn");
      
      const jobDetailDate = document.getElementById("jobDetailDate");
      const jobDetailCustomerName = document.getElementById("jobDetailCustomerName");
      const jobDetailCustomerPhone = document.getElementById("jobDetailCustomerPhone");
      const jobDetailPlate = document.getElementById("jobDetailPlate");
      const jobDetailBrandModel = document.getElementById("jobDetailBrandModel");
      const jobDetailMileage = document.getElementById("jobDetailMileage");
      const jobDetailProblem = document.getElementById("jobDetailProblem");
      
      const jobDetailStatusBadge = document.getElementById("jobDetailStatusBadge");
      const jobDetailPriorityBadge = document.getElementById("jobDetailPriorityBadge");
      const jobDetailCreatedBy = document.getElementById("jobDetailCreatedBy");
      const jobDetailStatusSelect = document.getElementById("jobDetailStatusSelect");
      
      const jobDetailPartsTbody = document.getElementById("jobDetailPartsTbody");
      const jobDetailLaborTbody = document.getElementById("jobDetailLaborTbody");
      const jobDetailPartsTotal = document.getElementById("jobDetailPartsTotal");
      const jobDetailLaborTotal = document.getElementById("jobDetailLaborTotal");
      const jobDetailGrandTotal = document.getElementById("jobDetailGrandTotal");
      
      const jobDetailLogsList = document.getElementById("jobDetailLogsList");
      const jobDetailSaveStatusBtn = document.getElementById("jobDetailSaveStatusBtn");
      const jobDetailSaveStatusSpinner = document.getElementById("jobDetailSaveStatusSpinner");
      const jobDetailSaveStatusBtnText = document.getElementById("jobDetailSaveStatusBtnText");
      
      const jobDetailSoftDeleteBtn = document.getElementById("jobDetailSoftDeleteBtn");
      const jobDetailEditBtn = document.getElementById("jobDetailEditBtn");

      const mainToastEl = document.getElementById("mainToast");
      const mainToastBody = document.getElementById("mainToastBody");
      const mainToast = bootstrap.Toast.getOrCreateInstance(mainToastEl);
      const jobDetailModal = bootstrap.Modal.getOrCreateInstance(jobDetailModalEl);

      // --- Variables ---
      let currentUser = null;
      let currentUserProfile = null;
      const JOBS_PAGE_SIZE = 25; // เพิ่มจำนวนต่อหน้าเล็กน้อย
      let jobsLastVisible = null;
      let isLoadingJobs = false;
      let loadedJobs = []; // เก็บข้อมูลทั้งหมดที่โหลดมาแล้วใน session นี้
      let currentFilter = { startDate: "", endDate: "", status: "all", searchText: "" };
      let currentJobDetailId = null;
      let currentJobDetailData = null;
      let isSavingJobStatus = false;

      // --- Helpers ---
      function showToast(message, variant = "primary") {
        if (!mainToastEl || !mainToastBody) return;
        mainToastEl.className = "toast align-items-center text-bg-" + variant + " border-0 shadow-lg rounded-pill";
        mainToastBody.textContent = message;
        mainToast.show();
      }

      function formatNumber(value) {
        if (typeof value !== "number" || isNaN(value)) return "0.00";
        return value.toLocaleString("th-TH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatDateThaiFromString(dateStr) {
        if (!dateStr) return "-";
        const [year, month, day] = dateStr.split("-").map((v) => parseInt(v, 10));
        if (!year || !month || !day) return dateStr;
        const d = new Date(year, month - 1, day);
        const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        const thaiYear = d.getFullYear() + 543;
        return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${thaiYear}`;
      }

      function formatDateTimeFromTimestamp(ts) {
        if (!ts || !ts.toDate) return "-";
        const d = ts.toDate();
        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
        const timeStr = `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
        return `${formatDateThaiFromString(dateStr)} ${timeStr} น.`;
      }

      function getTodayISODateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function getPastISODateString(daysAgo) {
        const now = new Date();
        now.setDate(now.getDate() - daysAgo);
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // --- Theme ---
      function applyTheme(theme) {
        const normalized = theme === "dark" ? "dark" : "light";
        bodyEl.classList.remove("bm-theme-light", "bm-theme-dark");
        bodyEl.classList.add("bm-theme-" + normalized);
        const icon = themeToggleBtn?.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-sun", normalized === "dark");
          icon.classList.toggle("bi-moon", normalized === "light");
        }
      }
      function saveThemeForUser(uid, theme) {
        if (!uid) return;
        try { localStorage.setItem("bm-theme-" + uid, theme); } catch (e) {}
      }
      function readThemeForUser(uid, fallbackTheme) {
        if (!uid) return fallbackTheme || "light";
        try { return localStorage.getItem("bm-theme-" + uid) || fallbackTheme || "light"; } catch (e) { return fallbackTheme || "light"; }
      }

      // --- Auth / Profile ---
      async function ensureUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) return { id: snap.id, ...snap.data() };
        const usersCol = collection(db, "users");
        const qUsers = query(usersCol, limit(1));
        const existingSnap = await getDocs(qUsers);
        const isFirstUser = existingSnap.empty;
        const role = isFirstUser ? "admin" : "staff";
        const newUserData = {
          displayName: user.displayName || (user.email ? user.email.split("@")[0] : "ผู้ใช้ใหม่"),
          role, createdAt: serverTimestamp(), branchId: null, theme: "light", disabled: false,
        };
        await setDoc(userRef, newUserData);
        return { id: user.uid, ...newUserData };
      }

      // --- Status & UI Helpers ---
      function getStatusInfo(status) {
        switch (status) {
          case "repairing": return { text: "กำลังซ่อม", className: "bg-warning-subtle text-warning-emphasis fw-medium border border-warning-subtle", icon: "bi-wrench" };
          case "done": return { text: "ซ่อมเสร็จ", className: "bg-info-subtle text-info-emphasis fw-medium border border-info-subtle", icon: "bi-check-circle" };
          case "picked_up": return { text: "รับรถแล้ว", className: "bg-success-subtle text-success-emphasis fw-medium border border-success-subtle", icon: "bi-emoji-smile" };
          default: return { text: "ไม่ทราบ", className: "bg-secondary", icon: "bi-question" };
        }
      }
      function getPriorityInfo(priority) {
        switch (priority) {
          case "high": return { text: "ด่วนมาก", className: "bg-danger text-white" };
          case "normal": return { text: "ปกติ", className: "bg-light text-muted border" };
          case "low": return { text: "ไม่ด่วน", className: "bg-light text-muted border" };
          default: return { text: "-", className: "bg-light text-muted" };
        }
      }

      // --- Filter Logic ---
      function setDatePreset(days) {
        const today = getTodayISODateString();
        if (days === 'all') {
          jobsStartDateInput.value = "";
          jobsEndDateInput.value = "";
        } else {
          const start = getPastISODateString(days - 1);
          jobsStartDateInput.value = start;
          jobsEndDateInput.value = today;
        }
        updateDateRangeSummary();
      }

      function updateDateRangeSummary() {
        const start = jobsStartDateInput.value;
        const end = jobsEndDateInput.value;
        if (!start && !end) jobsDateRangeSummary.textContent = "ทั้งหมด";
        else if (start && end) jobsDateRangeSummary.textContent = formatDateThaiFromString(start) + " - " + formatDateThaiFromString(end);
        else if (start) jobsDateRangeSummary.textContent = "ตั้งแต่ " + formatDateThaiFromString(start);
        else if (end) jobsDateRangeSummary.textContent = "ถึง " + formatDateThaiFromString(end);
      }

      // --- Render Logic ---
      function setJobsLoadingState(isLoading, isFirstPage = false) {
        isLoadingJobs = isLoading;
        if (jobsLoadingState) {
          if (isLoading && isFirstPage) {
             jobsLoadingState.classList.remove("d-none");
             jobsLoadingState.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span> กำลังโหลด...`;
          } else if (!isLoading) {
             jobsLoadingState.classList.add("d-none");
          }
        }
        if (loadMoreJobsBtn) {
          if (isLoading && !isFirstPage) {
            loadMoreJobsSpinner.classList.remove("d-none");
            loadMoreJobsBtnText.textContent = "กำลังโหลด...";
            loadMoreJobsBtn.disabled = true;
          } else {
            loadMoreJobsSpinner.classList.add("d-none");
            loadMoreJobsBtnText.textContent = "โหลดเพิ่มเติม";
            loadMoreJobsBtn.disabled = false;
          }
        }
      }

      // NEW: Calculate Stats based on Loaded Jobs
      function calculateStats(jobs) {
         let total = 0;
         let revenue = 0;
         let pending = 0;
         
         total = jobs.length;
         jobs.forEach(j => {
            revenue += Number(j.totalAmount) || 0;
            if (j.status === "repairing") pending++;
         });
         
         const avg = total > 0 ? revenue / total : 0;
         
         statTotalJobs.textContent = total.toLocaleString();
         statTotalRevenue.textContent = formatNumber(revenue);
         statAvgRevenue.textContent = formatNumber(avg);
         statPendingJobs.textContent = pending.toLocaleString();
      }

      function renderJobs(searchText) {
        const keyword = (searchText || "").trim().toLowerCase();
        let filteredJobs = loadedJobs;

        // Client-side filtering for search text
        if (keyword) {
          filteredJobs = loadedJobs.filter((job) => [
             job.customerName, job.customerPhone, job.plate, job.brand, job.model, job.problem
          ].some(f => (f||"").toLowerCase().includes(keyword)));
        }

        // Update counts and stats
        if (jobsCountInfo) {
          jobsCountInfo.classList.remove("d-none");
          jobsCountInfo.innerHTML = `<i class="bi bi-info-circle me-1"></i> พบงานซ่อม <span class="fw-bold text-dark">${filteredJobs.length}</span> งาน`;
        }
        calculateStats(filteredJobs);

        // Render Table
        if (jobsTableBody) {
          jobsTableBody.innerHTML = "";
          if (filteredJobs.length === 0) {
            jobsTableBody.innerHTML = `<tr><td colspan="7" class="text-center small text-muted py-5"><i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>ไม่พบข้อมูลงานซ่อมตามเงื่อนไข</td></tr>`;
          } else {
            filteredJobs.forEach((job) => {
              const statusInfo = getStatusInfo(job.status);
              const priorityInfo = getPriorityInfo(job.priority);
              const tr = document.createElement("tr");
              
              // Hightlight row logic can be added here
              
              tr.innerHTML = `
                <td class="ps-4 text-muted small">${formatDateThaiFromString(job.date)}</td>
                <td class="fw-medium text-dark">${job.customerName || "-"}</td>
                <td><span class="badge bg-light text-dark border fw-normal">${job.plate || "-"}</span></td>
                <td class="small text-muted">${(job.brand || "-") + " " + (job.model || "-")}</td>
                <td>
                  <span class="badge ${statusInfo.className} rounded-pill px-2 py-1 small fw-normal">
                     <i class="bi ${statusInfo.icon} me-1"></i>${statusInfo.text}
                  </span>
                  ${job.priority === 'high' ? `<span class="badge ${priorityInfo.className} rounded-pill ms-1 small">ด่วน</span>` : ""}
                </td>
                <td class="text-end fw-bold text-dark">${formatNumber(job.totalAmount || 0)}</td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-light border text-primary job-detail-btn rounded-circle" data-job-id="${job.id}" title="ดูรายละเอียด">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </td>
              `;
              jobsTableBody.appendChild(tr);
            });
          }
        }

        // Render Cards
        if (jobsCardContainer) {
          jobsCardContainer.innerHTML = "";
          if (filteredJobs.length === 0) {
            jobsCardContainer.innerHTML = `<div class="col-12"><div class="alert alert-light text-center border py-4 text-muted">ไม่พบข้อมูล</div></div>`;
          } else {
            filteredJobs.forEach((job) => {
              const statusInfo = getStatusInfo(job.status);
              const col = document.createElement("div");
              col.className = "col-12 col-md-6 col-lg-4";
              col.innerHTML = `
                <div class="card h-100 border shadow-sm rounded-4 bm-list-card job-detail-btn cursor-pointer position-relative overflow-hidden" data-job-id="${job.id}" style="cursor: pointer;">
                  ${job.priority === 'high' ? '<div class="position-absolute top-0 end-0 p-2"><span class="badge bg-danger rounded-circle p-1" style="width:10px;height:10px;"> </span></div>' : ''}
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="fw-bold text-primary mb-0 fs-5">${job.plate || "-"}</h6>
                      <span class="badge ${statusInfo.className} rounded-pill">${statusInfo.text}</span>
                    </div>
                    <div class="small text-dark fw-medium mb-1"><i class="bi bi-person me-1 text-muted"></i> ${job.customerName || "-"}</div>
                    <div class="small text-muted mb-2 ps-3">${(job.brand || "-")} ${(job.model || "-")}</div>
                    
                    <div class="bg-light rounded p-2 small text-muted mb-2 text-truncate border border-light">
                       <i class="bi bi-wrench me-1"></i> ${job.problem || "-"}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-end mt-2 pt-2 border-top border-light opacity-75">
                       <span class="small text-muted"><i class="bi bi-calendar3"></i> ${formatDateThaiFromString(job.date)}</span>
                       <span class="fw-bold text-dark fs-6">${formatNumber(job.totalAmount)} ฿</span>
                    </div>
                  </div>
                </div>
              `;
              jobsCardContainer.appendChild(col);
            });
          }
        }
      }

      // --- Data Loading ---
      async function loadJobsWithFilter(reset = false) {
        if (isLoadingJobs) return;
        if (!currentUserProfile) return;
        const branchId = currentUserProfile.branchId || null;
        const startDate = jobsStartDateInput.value;
        const endDate = jobsEndDateInput.value;
        const status = jobsStatusFilterSelect.value;
        const searchText = jobsSearchInput.value;

        if (reset) {
          currentFilter = { startDate, endDate, status, searchText };
          loadedJobs = [];
          jobsLastVisible = null;
        } else {
          currentFilter.searchText = searchText;
        }

        const isFirstPage = reset || !jobsLastVisible;
        setJobsLoadingState(true, isFirstPage);

        try {
          const jobsCol = collection(db, "jobs");
          const constraints = [where("isDeleted", "==", false)];
          if (branchId) constraints.push(where("branchId", "==", branchId));
          if (startDate) constraints.push(where("date", ">=", startDate));
          if (endDate) constraints.push(where("date", "<=", endDate));
          if (status && status !== "all") constraints.push(where("status", "==", status));

          let qJobs = query(jobsCol, ...constraints, orderBy("date", "desc"), limit(JOBS_PAGE_SIZE));
          if (!isFirstPage && jobsLastVisible) {
            qJobs = query(jobsCol, ...constraints, orderBy("date", "desc"), startAfter(jobsLastVisible), limit(JOBS_PAGE_SIZE));
          }

          const snap = await getDocs(qJobs);
          
          if (snap.empty && isFirstPage) {
            loadedJobs = [];
            renderJobs(currentFilter.searchText);
            if (loadMoreJobsBtn) loadMoreJobsBtn.classList.add("d-none");
            setJobsLoadingState(false, isFirstPage);
            return;
          }

          const newJobs = [];
          snap.forEach((docSnap) => {
            newJobs.push({ id: docSnap.id, ...docSnap.data() });
          });

          if (reset) loadedJobs = newJobs;
          else loadedJobs = loadedJobs.concat(newJobs);

          if (!snap.empty) jobsLastVisible = snap.docs[snap.docs.length - 1];

          if (loadMoreJobsBtn) {
            // Check if we likely have more by seeing if we got a full page
            if (snap.size === JOBS_PAGE_SIZE) loadMoreJobsBtn.classList.remove("d-none");
            else loadMoreJobsBtn.classList.add("d-none");
          }

          renderJobs(currentFilter.searchText);
        } catch (error) {
          console.error("Load Jobs Error:", error);
          showToast("โหลดข้อมูลล้มเหลว กรุณาลองใหม่", "danger");
        } finally {
          setJobsLoadingState(false, isFirstPage);
        }
      }

      // --- Export CSV ---
      function exportToCSV() {
         if(!loadedJobs || loadedJobs.length === 0) {
            showToast("ไม่มีข้อมูลสำหรับส่งออก", "warning");
            return;
         }

         const bom = "\uFEFF";
         let csvContent = "data:text/csv;charset=utf-8," + bom;
         csvContent += "วันที่,ลูกค้า,เบอร์โทร,ทะเบียน,ยี่ห้อ/รุ่น,อาการ,สถานะ,ยอดรวม\n";

         loadedJobs.forEach(job => {
            const row = [
               job.date || "",
               `"${(job.customerName || "").replace(/"/g, '""')}"`,
               `"${(job.customerPhone || "").replace(/"/g, '""')}"`,
               `"${(job.plate || "").replace(/"/g, '""')}"`,
               `"${(job.brand || "")} ${(job.model || "")}"`,
               `"${(job.problem || "").replace(/"/g, '""')}"`,
               getStatusInfo(job.status).text,
               job.totalAmount || 0
            ];
            csvContent += row.join(",") + "\n";
         });

         const encodedUri = encodeURI(csvContent);
         const link = document.createElement("a");
         link.setAttribute("href", encodedUri);
         link.setAttribute("download", `job_report_${getTodayISODateString()}.csv`);
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
      }

      // --- Detail Modal ---
      async function openJobDetail(jobId) {
        if (!jobId || !currentUserProfile) return;
        currentJobDetailId = jobId;
        currentJobDetailData = null;

        if (jobDetailLoadingState) jobDetailLoadingState.classList.remove("d-none");
        
        // Reset UI
        jobDetailModalLabel.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i> รายละเอียดงานซ่อม`;
        jobDetailDate.textContent = "-";
        jobDetailCustomerName.textContent = "-";
        jobDetailCustomerPhone.textContent = "-";
        jobDetailPlate.textContent = "-";
        jobDetailBrandModel.textContent = "-";
        jobDetailMileage.textContent = "-";
        jobDetailProblem.textContent = "-";
        
        jobDetailStatusBadge.textContent = "-";
        jobDetailStatusBadge.className = "badge bg-secondary rounded-pill px-3 py-2";
        jobDetailPriorityBadge.textContent = "";
        
        jobDetailCreatedBy.textContent = "-";
        
        jobDetailPartsTbody.innerHTML = "";
        jobDetailLaborTbody.innerHTML = "";
        jobDetailPartsTotal.textContent = "0.00 ฿";
        jobDetailLaborTotal.textContent = "0.00 ฿";
        jobDetailGrandTotal.textContent = "0.00 ฿";
        jobDetailLogsList.innerHTML = `<li class="list-group-item text-center small text-muted">กำลังโหลด...</li>`;

        if (jobDetailEditBtn) jobDetailEditBtn.classList.add("d-none"); // Hide first

        jobDetailModal.show();

        try {
          const jobSnap = await getDoc(doc(db, "jobs", jobId));
          if (!jobSnap.exists()) {
            showToast("ไม่พบข้อมูลใบงาน", "warning");
            jobDetailModal.hide();
            return;
          }

          const data = jobSnap.data();
          currentJobDetailData = { id: jobId, ...data };

          const dateThai = formatDateThaiFromString(data.date);
          const statusInfo = getStatusInfo(data.status || "repairing");
          
          jobDetailModalLabel.innerHTML = `<i class="bi bi-file-earmark-text me-2"></i> ใบงาน: ${data.plate || "-"}`;
          jobDetailDate.textContent = dateThai;
          jobDetailCustomerName.textContent = data.customerName || "-";
          jobDetailCustomerPhone.textContent = data.customerPhone || "-";
          jobDetailPlate.textContent = data.plate || "-";
          jobDetailBrandModel.textContent = (data.brand || "-") + " " + (data.model || "-");
          jobDetailMileage.textContent = data.mileage ? `${Number(data.mileage).toLocaleString()} กม.` : "-";
          jobDetailProblem.textContent = data.problem || "-";

          jobDetailStatusBadge.textContent = statusInfo.text;
          jobDetailStatusBadge.className = "badge " + statusInfo.className + " rounded-pill px-3 py-2";
          
          if(data.priority === 'high') {
             jobDetailPriorityBadge.textContent = "ด่วนมาก";
             jobDetailPriorityBadge.className = "badge bg-danger rounded-pill px-3 py-2 ms-1";
          } else {
             jobDetailPriorityBadge.textContent = "";
             jobDetailPriorityBadge.className = "d-none";
          }

          jobDetailCreatedBy.textContent = data.createdByName || "ไม่ทราบ";
          jobDetailStatusSelect.value = data.status || "repairing";

          // Items
          const items = data.items || [];
          jobDetailPartsTbody.innerHTML = items.length ? "" : `<tr><td colspan="4" class="text-center small text-muted py-2">ไม่มีรายการอะไหล่</td></tr>`;
          items.forEach(item => {
             jobDetailPartsTbody.innerHTML += `
                <tr>
                   <td class="ps-3">${item.stockName || "-"}</td>
                   <td class="text-end">${item.qty ?? "-"}</td>
                   <td class="text-end">${formatNumber(item.unitPrice ?? 0)}</td>
                   <td class="text-end pe-3">${formatNumber(item.lineTotal ?? 0)}</td>
                </tr>`;
          });

          // Labor
          const laborItems = data.laborItems || [];
          jobDetailLaborTbody.innerHTML = laborItems.length ? "" : `<tr><td colspan="4" class="text-center small text-muted py-2">ไม่มีค่าแรง</td></tr>`;
          laborItems.forEach(li => {
             jobDetailLaborTbody.innerHTML += `
                <tr>
                   <td class="ps-3">${li.name || "-"}</td>
                   <td class="text-end" colspan="2"></td>
                   <td class="text-end pe-3">${formatNumber(li.price ?? 0)}</td>
                </tr>`;
          });

          jobDetailPartsTotal.textContent = formatNumber(Number(data.partsTotal) || 0) + " ฿";
          jobDetailLaborTotal.textContent = formatNumber(Number(data.laborTotal) || 0) + " ฿";
          jobDetailGrandTotal.textContent = formatNumber(Number(data.totalAmount) || 0) + " ฿";

          // Admin Controls
          if (jobDetailSoftDeleteBtn) {
            jobDetailSoftDeleteBtn.classList.toggle("d-none", currentUserProfile.role !== "admin");
          }
          
          // Edit Button (Link to open-bill)
          if (jobDetailEditBtn) {
             jobDetailEditBtn.classList.remove("d-none");
             jobDetailEditBtn.onclick = () => {
                 window.location.href = `open-bill.html?edit=${jobId}`;
             };
          }

          await loadJobActivityLogs(jobId, currentUserProfile.branchId);
        } catch (error) {
          console.error("Job Detail Error:", error);
          showToast("โหลดรายละเอียดไม่สำเร็จ", "danger");
        } finally {
          if (jobDetailLoadingState) jobDetailLoadingState.classList.add("d-none");
        }
      }

      async function loadJobActivityLogs(jobId, branchId) {
        try {
          const logsCol = collection(db, "activityLogs");
          const constraints = [where("refType", "==", "job"), where("refId", "==", jobId)];
          if (branchId) constraints.push(where("branchId", "==", branchId));
          const logsQuery = query(logsCol, ...constraints, orderBy("createdAt", "desc"), limit(20));
          const logsSnap = await getDocs(logsQuery);
          
          jobDetailLogsList.innerHTML = "";
          if (logsSnap.empty) {
            jobDetailLogsList.innerHTML = `<li class="list-group-item text-center text-muted small py-3">ไม่มีประวัติกิจกรรม</li>`;
          } else {
            logsSnap.forEach((docSnap) => {
              const log = docSnap.data();
              const li = document.createElement("li");
              li.className = "list-group-item small px-0";
              li.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                   <span class="fw-medium text-dark">${log.message || "-"}</span>
                   <span class="text-xs text-muted bg-light border rounded px-1">${formatDateTimeFromTimestamp(log.createdAt)}</span>
                </div>
                <div class="text-muted text-xs"><i class="bi bi-person me-1"></i> ${log.createdByName || "ระบบ"}</div>
              `;
              jobDetailLogsList.appendChild(li);
            });
          }
        } catch (error) {
           console.error(error);
           jobDetailLogsList.innerHTML = `<li class="list-group-item text-danger text-center small">โหลด Log ไม่สำเร็จ</li>`;
        }
      }

      // --- Actions: Status Update ---
      async function handleUpdateJobStatus() {
        if (!currentJobDetailId || !currentJobDetailData || isSavingJobStatus) return;
        const newStatus = jobDetailStatusSelect.value;
        const oldStatus = currentJobDetailData.status || "repairing";

        if (newStatus === oldStatus) return;
        if (currentUserProfile.role !== "admin" && oldStatus === "picked_up" && newStatus !== "picked_up") {
          showToast("ไม่มีสิทธิ์เปลี่ยนสถานะงานที่รับรถแล้ว", "warning");
          return;
        }

        isSavingJobStatus = true;
        jobDetailSaveStatusSpinner.classList.remove("d-none");
        jobDetailSaveStatusBtnText.textContent = "บันทึก...";

        try {
          await updateDoc(doc(db, "jobs", currentJobDetailId), { status: newStatus, updatedAt: serverTimestamp() });
          
          const statusInfoNew = getStatusInfo(newStatus);
          const statusInfoOld = getStatusInfo(oldStatus);
          
          await addDoc(collection(db, "activityLogs"), {
            createdAt: serverTimestamp(), createdBy: currentUser.uid, createdByName: currentUserProfile.displayName,
            type: "job_updated", message: `เปลี่ยนสถานะ: ${statusInfoOld.text} -> ${statusInfoNew.text}`,
            refType: "job", refId: currentJobDetailId, branchId: currentUserProfile.branchId
          });

          // Update local data
          loadedJobs = loadedJobs.map(j => j.id === currentJobDetailId ? { ...j, status: newStatus } : j);
          currentJobDetailData.status = newStatus;
          
          jobDetailStatusBadge.textContent = statusInfoNew.text;
          jobDetailStatusBadge.className = "badge " + statusInfoNew.className + " rounded-pill px-3 py-2";

          showToast("บันทึกสถานะเรียบร้อย", "success");
          renderJobs(currentFilter.searchText); // Re-render list
          loadJobActivityLogs(currentJobDetailId, currentUserProfile.branchId);
        } catch (error) {
          console.error(error);
          showToast("บันทึกไม่สำเร็จ", "danger");
        } finally {
          isSavingJobStatus = false;
          jobDetailSaveStatusSpinner.classList.add("d-none");
          jobDetailSaveStatusBtnText.textContent = "บันทึก";
        }
      }

      // --- Actions: Delete ---
      async function handleSoftDeleteJob() {
        if (!currentJobDetailId || currentUserProfile.role !== "admin") return;
        if (!confirm("ต้องการซ่อนบิลนี้ใช่หรือไม่? \n(สามารถดูได้ในฐานข้อมูลเท่านั้น)")) return;
        try {
          await updateDoc(doc(db, "jobs", currentJobDetailId), { isDeleted: true, updatedAt: serverTimestamp() });
          await addDoc(collection(db, "activityLogs"), {
             createdAt: serverTimestamp(), createdBy: currentUser.uid, createdByName: currentUserProfile.displayName,
             type: "job_deleted", message: "ลบ/ซ่อน ใบงาน", refType: "job", refId: currentJobDetailId, branchId: currentUserProfile.branchId
          });
          showToast("ซ่อนบิลแล้ว", "success");
          loadedJobs = loadedJobs.filter(j => j.id !== currentJobDetailId);
          renderJobs(currentFilter.searchText);
          jobDetailModal.hide();
        } catch (e) { showToast("เกิดข้อผิดพลาด", "danger"); }
      }

      // --- Actions: Print ---
      function printCurrentJob() {
         if(!currentJobDetailData) return;
         const d = currentJobDetailData;
         
         const printWindow = window.open('', '_blank');
         
         let itemsHtml = '';
         (d.items || []).forEach(item => {
             itemsHtml += `<tr><td>${item.stockName}</td><td align="right">${item.qty}</td><td align="right">${formatNumber(item.lineTotal)}</td></tr>`;
         });
         (d.laborItems || []).forEach(item => {
             itemsHtml += `<tr><td>${item.name} (ค่าแรง)</td><td align="right">-</td><td align="right">${formatNumber(item.price)}</td></tr>`;
         });

         printWindow.document.write(`
            <html>
            <head>
               <title>ใบเสร็จ/ใบงาน - ${d.plate}</title>
               <style>
                  body { font-family: 'Sarabun', sans-serif; padding: 20px; color: #000; }
                  .header { text-align: center; margin-bottom: 20px; }
                  .h-title { font-size: 1.2rem; font-weight: bold; }
                  .meta { font-size: 0.9rem; margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
                  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
                  th { border-bottom: 1px solid #000; text-align: left; padding: 5px 0; }
                  td { padding: 5px 0; border-bottom: 1px dotted #eee; }
                  .totals { margin-top: 15px; border-top: 1px solid #000; padding-top: 5px; }
                  .total-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1rem; }
                  .footer { margin-top: 30px; text-align: center; font-size: 0.8rem; color: #555; }
                  @media print { .no-print { display: none; } }
               </style>
            </head>
            <body>
               <div class="header">
                  <div class="h-title">BEN MOTOR</div>
                  <div>บริการซ่อมรถจักรยานยนต์</div>
               </div>
               <div class="meta">
                  <div><b>วันที่:</b> ${formatDateThaiFromString(d.date)}</div>
                  <div><b>ลูกค้า:</b> ${d.customerName} (${d.customerPhone})</div>
                  <div><b>รถ:</b> ${d.plate} ${d.brand} ${d.model}</div>
                  <div><b>เลขไมล์:</b> ${d.mileage || '-'}</div>
               </div>
               <table>
                  <thead><tr><th>รายการ</th><th align="right">จำนวน</th><th align="right">รวม</th></tr></thead>
                  <tbody>${itemsHtml}</tbody>
               </table>
               <div class="totals">
                  <div class="total-row">
                     <span>ยอดรวมสุทธิ</span>
                     <span>${formatNumber(d.totalAmount)} บาท</span>
                  </div>
               </div>
               <div class="footer">
                  <p>ขอบคุณที่ใช้บริการ</p>
               </div>
               <script>
                  window.onload = function() { window.print(); window.close(); }
               <\/script>
            </body>
            </html>
         `);
         printWindow.document.close();
      }

      // --- Setup ---
      function setupEventListenersForPage() {
        if (logoutBtn) logoutBtn.addEventListener("click", () => signOut(auth).then(()=>window.location.href="index.html"));
        
        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", () => {
             const t = bodyEl.classList.contains("bm-theme-dark") ? "light" : "dark";
             applyTheme(t);
             if(currentUser) saveThemeForUser(currentUser.uid, t);
          });
        }

        // FAB Navigation
        if (fabOpenBillBtn) fabOpenBillBtn.addEventListener("click", () => window.location.href = "open-bill.html");
        if (fabAddTxnBtn) fabAddTxnBtn.addEventListener("click", () => window.location.href = "finance.html");
        if (fabStockInBtn) fabStockInBtn.addEventListener("click", () => window.location.href = "stock.html");
        if (fabAddVehicleBtn) fabAddVehicleBtn.addEventListener("click", () => window.location.href = "vehicles.html");

        // Filter Presets
        presetTodayBtn?.addEventListener("click", () => { setDatePreset(1); loadJobsWithFilter(true); });
        preset7DaysBtn?.addEventListener("click", () => { setDatePreset(7); loadJobsWithFilter(true); });
        preset30DaysBtn?.addEventListener("click", () => { setDatePreset(30); loadJobsWithFilter(true); });
        presetAllBtn?.addEventListener("click", () => { setDatePreset('all'); loadJobsWithFilter(true); });

        // Filter Form
        jobsFilterForm?.addEventListener("submit", (e) => {
           e.preventDefault();
           updateDateRangeSummary();
           loadJobsWithFilter(true);
        });

        // View Toggles
        tableViewBtn?.addEventListener("click", () => {
           tableViewBtn.classList.add("active", "text-primary", "fw-bold"); tableViewBtn.classList.remove("text-secondary");
           cardViewBtn.classList.remove("active", "text-primary", "fw-bold"); cardViewBtn.classList.add("text-secondary");
           jobsTableView.classList.remove("d-none");
           jobsCardView.classList.add("d-none");
        });
        cardViewBtn?.addEventListener("click", () => {
           cardViewBtn.classList.add("active", "text-primary", "fw-bold"); cardViewBtn.classList.remove("text-secondary");
           tableViewBtn.classList.remove("active", "text-primary", "fw-bold"); tableViewBtn.classList.add("text-secondary");
           jobsCardView.classList.remove("d-none");
           jobsTableView.classList.add("d-none");
        });

        loadMoreJobsBtn?.addEventListener("click", () => loadJobsWithFilter(false));

        // Click on Row/Card to open detail
        const handleDetailClick = (e) => {
           const btn = e.target.closest(".job-detail-btn");
           if(btn) openJobDetail(btn.dataset.jobId);
        };
        jobsTableBody?.addEventListener("click", handleDetailClick);
        jobsCardContainer?.addEventListener("click", handleDetailClick);

        // Modal Actions
        jobDetailSaveStatusBtn?.addEventListener("click", handleUpdateJobStatus);
        jobDetailSoftDeleteBtn?.addEventListener("click", handleSoftDeleteJob);
        jobDetailPrintBtn?.addEventListener("click", printCurrentJob);
        
        // Export
        exportCsvBtn?.addEventListener("click", exportToCSV);
      }

      // --- Main Execution ---
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "index.html"; return; }
        currentUser = user;
        try {
           const profile = await ensureUserProfile(user);
           currentUserProfile = profile;
           if (profile.disabled) { await signOut(auth); window.location.href = "index.html"; return; }
           
           // Set User Info
           if (userDisplayNameText) userDisplayNameText.textContent = profile.displayName || "-";
           if (userRoleText) userRoleText.textContent = profile.role === "admin" ? "Admin" : "Staff";
           if (userAvatarInitial) userAvatarInitial.textContent = (profile.displayName || "U").trim()[0].toUpperCase();
           if (settingsMenuItem) settingsMenuItem.classList.toggle("d-none", profile.role !== "admin");

           applyTheme(readThemeForUser(user.uid, profile.theme));
           setupEventListenersForPage();
           
           // Initial Load (Default: Last 30 days or 7 days as preferred)
           setDatePreset(30); 
           loadJobsWithFilter(true);
        } catch (error) {
           console.error(error);
           showToast("เกิดข้อผิดพลาดในการโหลดข้อมูล", "danger");
        }
      });
    </script>
  </body>
</html>